{"remainingRequest":"D:\\GitHubRepo\\cjmLearn\\webpack\\性能优化\\模块解析\\node_modules\\.pnpm\\babel-loader@9.2.1_@babel+core@7.26.0_webpack@5.96.1\\node_modules\\babel-loader\\lib\\index.js!D:\\GitHubRepo\\cjmLearn\\webpack\\性能优化\\模块解析\\node_modules\\.pnpm\\jquery@3.7.1\\node_modules\\jquery\\dist\\jquery.js","dependencies":[{"path":"D:\\GitHubRepo\\cjmLearn\\webpack\\性能优化\\模块解析\\node_modules\\.pnpm\\jquery@3.7.1\\node_modules\\jquery\\dist\\jquery.js","mtime":1732017931149},{"path":"D:\\GitHubRepo\\cjmLearn\\webpack\\性能优化\\模块解析\\node_modules\\.pnpm\\cache-loader@4.1.0_webpack@5.96.1\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1732202223604},{"path":"D:\\GitHubRepo\\cjmLearn\\webpack\\性能优化\\模块解析\\node_modules\\.pnpm\\babel-loader@9.2.1_@babel+core@7.26.0_webpack@5.96.1\\node_modules\\babel-loader\\lib\\index.js","mtime":1730377096190}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjMuNy4xCiAqIGh0dHBzOi8vanF1ZXJ5LmNvbS8KICoKICogQ29weXJpZ2h0IE9wZW5KUyBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHBzOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIERhdGU6IDIwMjMtMDgtMjhUMTM6MzdaCiAqLwooZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gIm9iamVjdCIpIHsKICAgIC8vIEZvciBDb21tb25KUyBhbmQgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgd2hlcmUgYSBwcm9wZXIgYHdpbmRvd2AKICAgIC8vIGlzIHByZXNlbnQsIGV4ZWN1dGUgdGhlIGZhY3RvcnkgYW5kIGdldCBqUXVlcnkuCiAgICAvLyBGb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IGhhdmUgYSBgd2luZG93YCB3aXRoIGEgYGRvY3VtZW50YAogICAgLy8gKHN1Y2ggYXMgTm9kZS5qcyksIGV4cG9zZSBhIGZhY3RvcnkgYXMgbW9kdWxlLmV4cG9ydHMuCiAgICAvLyBUaGlzIGFjY2VudHVhdGVzIHRoZSBuZWVkIGZvciB0aGUgY3JlYXRpb24gb2YgYSByZWFsIGB3aW5kb3dgLgogICAgLy8gZS5nLiB2YXIgalF1ZXJ5ID0gcmVxdWlyZSgianF1ZXJ5Iikod2luZG93KTsKICAgIC8vIFNlZSB0aWNrZXQgdHJhYy0xNDU0OSBmb3IgbW9yZSBpbmZvLgogICAgbW9kdWxlLmV4cG9ydHMgPSBnbG9iYWwuZG9jdW1lbnQgPyBmYWN0b3J5KGdsb2JhbCwgdHJ1ZSkgOiBmdW5jdGlvbiAodykgewogICAgICBpZiAoIXcuZG9jdW1lbnQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImpRdWVyeSByZXF1aXJlcyBhIHdpbmRvdyB3aXRoIGEgZG9jdW1lbnQiKTsKICAgICAgfQogICAgICByZXR1cm4gZmFjdG9yeSh3KTsKICAgIH07CiAgfSBlbHNlIHsKICAgIGZhY3RvcnkoZ2xvYmFsKTsKICB9CgogIC8vIFBhc3MgdGhpcyBpZiB3aW5kb3cgaXMgbm90IGRlZmluZWQgeWV0Cn0pKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDogdGhpcywgZnVuY3Rpb24gKHdpbmRvdywgbm9HbG9iYWwpIHsKICAvLyBFZGdlIDw9IDEyIC0gMTMrLCBGaXJlZm94IDw9MTggLSA0NSssIElFIDEwIC0gMTEsIFNhZmFyaSA1LjEgLSA5KywgaU9TIDYgLSA5LjEKICAvLyB0aHJvdyBleGNlcHRpb25zIHdoZW4gbm9uLXN0cmljdCBjb2RlIChlLmcuLCBBU1AuTkVUIDQuNSkgYWNjZXNzZXMgc3RyaWN0IG1vZGUKICAvLyBhcmd1bWVudHMuY2FsbGVlLmNhbGxlciAodHJhYy0xMzMzNSkuIEJ1dCBhcyBvZiBqUXVlcnkgMy4wICgyMDE2KSwgc3RyaWN0IG1vZGUgc2hvdWxkIGJlIGNvbW1vbgogIC8vIGVub3VnaCB0aGF0IGFsbCBzdWNoIGF0dGVtcHRzIGFyZSBndWFyZGVkIGluIGEgdHJ5IGJsb2NrLgogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGFyciA9IFtdOwogIHZhciBnZXRQcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKICB2YXIgc2xpY2UgPSBhcnIuc2xpY2U7CiAgdmFyIGZsYXQgPSBhcnIuZmxhdCA/IGZ1bmN0aW9uIChhcnJheSkgewogICAgcmV0dXJuIGFyci5mbGF0LmNhbGwoYXJyYXkpOwogIH0gOiBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHJldHVybiBhcnIuY29uY2F0LmFwcGx5KFtdLCBhcnJheSk7CiAgfTsKICB2YXIgcHVzaCA9IGFyci5wdXNoOwogIHZhciBpbmRleE9mID0gYXJyLmluZGV4T2Y7CiAgdmFyIGNsYXNzMnR5cGUgPSB7fTsKICB2YXIgdG9TdHJpbmcgPSBjbGFzczJ0eXBlLnRvU3RyaW5nOwogIHZhciBoYXNPd24gPSBjbGFzczJ0eXBlLmhhc093blByb3BlcnR5OwogIHZhciBmblRvU3RyaW5nID0gaGFzT3duLnRvU3RyaW5nOwogIHZhciBPYmplY3RGdW5jdGlvblN0cmluZyA9IGZuVG9TdHJpbmcuY2FsbChPYmplY3QpOwogIHZhciBzdXBwb3J0ID0ge307CiAgdmFyIGlzRnVuY3Rpb24gPSBmdW5jdGlvbiBpc0Z1bmN0aW9uKG9iaikgewogICAgLy8gU3VwcG9ydDogQ2hyb21lIDw9NTcsIEZpcmVmb3ggPD01MgogICAgLy8gSW4gc29tZSBicm93c2VycywgdHlwZW9mIHJldHVybnMgImZ1bmN0aW9uIiBmb3IgSFRNTCA8b2JqZWN0PiBlbGVtZW50cwogICAgLy8gKGkuZS4sIGB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIm9iamVjdCIgKSA9PT0gImZ1bmN0aW9uImApLgogICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBjbGFzc2lmeSAqYW55KiBET00gbm9kZSBhcyBhIGZ1bmN0aW9uLgogICAgLy8gU3VwcG9ydDogUXRXZWIgPD0zLjguNSwgV2ViS2l0IDw9NTM0LjM0LCB3a2h0bWx0b3BkZiB0b29sIDw9MC4xMi41CiAgICAvLyBQbHVzIGZvciBvbGQgV2ViS2l0LCB0eXBlb2YgcmV0dXJucyAiZnVuY3Rpb24iIGZvciBIVE1MIGNvbGxlY3Rpb25zCiAgICAvLyAoZS5nLiwgYHR5cGVvZiBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZGl2IikgPT09ICJmdW5jdGlvbiJgKS4gKGdoLTQ3NTYpCiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2Ygb2JqLm5vZGVUeXBlICE9PSAibnVtYmVyIiAmJiB0eXBlb2Ygb2JqLml0ZW0gIT09ICJmdW5jdGlvbiI7CiAgfTsKICB2YXIgaXNXaW5kb3cgPSBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7CiAgfTsKICB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7CiAgdmFyIHByZXNlcnZlZFNjcmlwdEF0dHJpYnV0ZXMgPSB7CiAgICB0eXBlOiB0cnVlLAogICAgc3JjOiB0cnVlLAogICAgbm9uY2U6IHRydWUsCiAgICBub01vZHVsZTogdHJ1ZQogIH07CiAgZnVuY3Rpb24gRE9NRXZhbChjb2RlLCBub2RlLCBkb2MpIHsKICAgIGRvYyA9IGRvYyB8fCBkb2N1bWVudDsKICAgIHZhciBpLAogICAgICB2YWwsCiAgICAgIHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgIHNjcmlwdC50ZXh0ID0gY29kZTsKICAgIGlmIChub2RlKSB7CiAgICAgIGZvciAoaSBpbiBwcmVzZXJ2ZWRTY3JpcHRBdHRyaWJ1dGVzKSB7CiAgICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCA2NCssIEVkZ2UgMTgrCiAgICAgICAgLy8gU29tZSBicm93c2VycyBkb24ndCBzdXBwb3J0IHRoZSAibm9uY2UiIHByb3BlcnR5IG9uIHNjcmlwdHMuCiAgICAgICAgLy8gT24gdGhlIG90aGVyIGhhbmQsIGp1c3QgdXNpbmcgYGdldEF0dHJpYnV0ZWAgaXMgbm90IGVub3VnaCBhcwogICAgICAgIC8vIHRoZSBgbm9uY2VgIGF0dHJpYnV0ZSBpcyByZXNldCB0byBhbiBlbXB0eSBzdHJpbmcgd2hlbmV2ZXIgaXQKICAgICAgICAvLyBiZWNvbWVzIGJyb3dzaW5nLWNvbnRleHQgY29ubmVjdGVkLgogICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vd2hhdHdnL2h0bWwvaXNzdWVzLzIzNjkKICAgICAgICAvLyBTZWUgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy8jbm9uY2UtYXR0cmlidXRlcwogICAgICAgIC8vIFRoZSBgbm9kZS5nZXRBdHRyaWJ1dGVgIGNoZWNrIHdhcyBhZGRlZCBmb3IgdGhlIHNha2Ugb2YKICAgICAgICAvLyBgalF1ZXJ5Lmdsb2JhbEV2YWxgIHNvIHRoYXQgaXQgY2FuIGZha2UgYSBub25jZS1jb250YWluaW5nIG5vZGUKICAgICAgICAvLyB2aWEgYW4gb2JqZWN0LgogICAgICAgIHZhbCA9IG5vZGVbaV0gfHwgbm9kZS5nZXRBdHRyaWJ1dGUgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoaSk7CiAgICAgICAgaWYgKHZhbCkgewogICAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZShpLCB2YWwpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgfQogIGZ1bmN0aW9uIHRvVHlwZShvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgewogICAgICByZXR1cm4gb2JqICsgIiI7CiAgICB9CgogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTIuMyBvbmx5IChmdW5jdGlvbmlzaCBSZWdFeHApCiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiA/IGNsYXNzMnR5cGVbdG9TdHJpbmcuY2FsbChvYmopXSB8fCAib2JqZWN0IiA6IHR5cGVvZiBvYmo7CiAgfQogIC8qIGdsb2JhbCBTeW1ib2wgKi8KICAvLyBEZWZpbmluZyB0aGlzIGdsb2JhbCBpbiAuZXNsaW50cmMuanNvbiB3b3VsZCBjcmVhdGUgYSBkYW5nZXIgb2YgdXNpbmcgdGhlIGdsb2JhbAogIC8vIHVuZ3VhcmRlZCBpbiBhbm90aGVyIHBsYWNlLCBpdCBzZWVtcyBzYWZlciB0byBkZWZpbmUgZ2xvYmFsIG9ubHkgZm9yIHRoaXMgbW9kdWxlCgogIHZhciB2ZXJzaW9uID0gIjMuNy4xIiwKICAgIHJodG1sU3VmZml4ID0gL0hUTUwkL2ksCiAgICAvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQogICAgalF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgIC8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwogICAgICAvLyBOZWVkIGluaXQgaWYgalF1ZXJ5IGlzIGNhbGxlZCAoanVzdCBhbGxvdyBlcnJvciB0byBiZSB0aHJvd24gaWYgbm90IGluY2x1ZGVkKQogICAgICByZXR1cm4gbmV3IGpRdWVyeS5mbi5pbml0KHNlbGVjdG9yLCBjb250ZXh0KTsKICAgIH07CiAgalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKICAgIC8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKICAgIGpxdWVyeTogdmVyc2lvbiwKICAgIGNvbnN0cnVjdG9yOiBqUXVlcnksCiAgICAvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKICAgIGxlbmd0aDogMCwKICAgIHRvQXJyYXk6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwodGhpcyk7CiAgICB9LAogICAgLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgogICAgLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkKICAgIGdldDogZnVuY3Rpb24gKG51bSkgewogICAgICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBpbiBhIGNsZWFuIGFycmF5CiAgICAgIGlmIChudW0gPT0gbnVsbCkgewogICAgICAgIHJldHVybiBzbGljZS5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICAvLyBSZXR1cm4ganVzdCB0aGUgb25lIGVsZW1lbnQgZnJvbSB0aGUgc2V0CiAgICAgIHJldHVybiBudW0gPCAwID8gdGhpc1tudW0gKyB0aGlzLmxlbmd0aF0gOiB0aGlzW251bV07CiAgICB9LAogICAgLy8gVGFrZSBhbiBhcnJheSBvZiBlbGVtZW50cyBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGFjawogICAgLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uIChlbGVtcykgewogICAgICAvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAogICAgICB2YXIgcmV0ID0galF1ZXJ5Lm1lcmdlKHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMpOwoKICAgICAgLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkKICAgICAgcmV0LnByZXZPYmplY3QgPSB0aGlzOwoKICAgICAgLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgogICAgZWFjaDogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZWFjaCh0aGlzLCBjYWxsYmFjayk7CiAgICB9LAogICAgbWFwOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChlbGVtLCBpLCBlbGVtKTsKICAgICAgfSkpOwogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0sCiAgICBmaXJzdDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5lcSgwKTsKICAgIH0sCiAgICBsYXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmVxKC0xKTsKICAgIH0sCiAgICBldmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkuZ3JlcCh0aGlzLCBmdW5jdGlvbiAoX2VsZW0sIGkpIHsKICAgICAgICByZXR1cm4gKGkgKyAxKSAlIDI7CiAgICAgIH0pKTsKICAgIH0sCiAgICBvZGQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS5ncmVwKHRoaXMsIGZ1bmN0aW9uIChfZWxlbSwgaSkgewogICAgICAgIHJldHVybiBpICUgMjsKICAgICAgfSkpOwogICAgfSwKICAgIGVxOiBmdW5jdGlvbiAoaSkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgsCiAgICAgICAgaiA9ICtpICsgKGkgPCAwID8gbGVuIDogMCk7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqID49IDAgJiYgaiA8IGxlbiA/IFt0aGlzW2pdXSA6IFtdKTsKICAgIH0sCiAgICBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucHJldk9iamVjdCB8fCB0aGlzLmNvbnN0cnVjdG9yKCk7CiAgICB9LAogICAgLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgogICAgLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCiAgICBwdXNoOiBwdXNoLAogICAgc29ydDogYXJyLnNvcnQsCiAgICBzcGxpY2U6IGFyci5zcGxpY2UKICB9OwogIGpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIG9wdGlvbnMsCiAgICAgIG5hbWUsCiAgICAgIHNyYywKICAgICAgY29weSwKICAgICAgY29weUlzQXJyYXksCiAgICAgIGNsb25lLAogICAgICB0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCiAgICAgIGkgPSAxLAogICAgICBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICBkZWVwID0gZmFsc2U7CgogICAgLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgogICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIikgewogICAgICBkZWVwID0gdGFyZ2V0OwoKICAgICAgLy8gU2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAogICAgICB0YXJnZXQgPSBhcmd1bWVudHNbaV0gfHwge307CiAgICAgIGkrKzsKICAgIH0KCiAgICAvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhaXNGdW5jdGlvbih0YXJnZXQpKSB7CiAgICAgIHRhcmdldCA9IHt9OwogICAgfQoKICAgIC8vIEV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogICAgaWYgKGkgPT09IGxlbmd0aCkgewogICAgICB0YXJnZXQgPSB0aGlzOwogICAgICBpLS07CiAgICB9CiAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKICAgICAgaWYgKChvcHRpb25zID0gYXJndW1lbnRzW2ldKSAhPSBudWxsKSB7CiAgICAgICAgLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAogICAgICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgICBjb3B5ID0gb3B0aW9uc1tuYW1lXTsKCiAgICAgICAgICAvLyBQcmV2ZW50IE9iamVjdC5wcm90b3R5cGUgcG9sbHV0aW9uCiAgICAgICAgICAvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCiAgICAgICAgICBpZiAobmFtZSA9PT0gIl9fcHJvdG9fXyIgfHwgdGFyZ2V0ID09PSBjb3B5KSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgICAgaWYgKGRlZXAgJiYgY29weSAmJiAoalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0gQXJyYXkuaXNBcnJheShjb3B5KSkpKSB7CiAgICAgICAgICAgIHNyYyA9IHRhcmdldFtuYW1lXTsKCiAgICAgICAgICAgIC8vIEVuc3VyZSBwcm9wZXIgdHlwZSBmb3IgdGhlIHNvdXJjZSB2YWx1ZQogICAgICAgICAgICBpZiAoY29weUlzQXJyYXkgJiYgIUFycmF5LmlzQXJyYXkoc3JjKSkgewogICAgICAgICAgICAgIGNsb25lID0gW107CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWNvcHlJc0FycmF5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpKSB7CiAgICAgICAgICAgICAgY2xvbmUgPSB7fTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjbG9uZSA9IHNyYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCiAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGpRdWVyeS5leHRlbmQoZGVlcCwgY2xvbmUsIGNvcHkpOwoKICAgICAgICAgICAgLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwogICAgICAgICAgfSBlbHNlIGlmIChjb3B5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGFyZ2V0W25hbWVdID0gY29weTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAogICAgcmV0dXJuIHRhcmdldDsKICB9OwogIGpRdWVyeS5leHRlbmQoewogICAgLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCiAgICBleHBhbmRvOiAialF1ZXJ5IiArICh2ZXJzaW9uICsgTWF0aC5yYW5kb20oKSkucmVwbGFjZSgvXEQvZywgIiIpLAogICAgLy8gQXNzdW1lIGpRdWVyeSBpcyByZWFkeSB3aXRob3V0IHRoZSByZWFkeSBtb2R1bGUKICAgIGlzUmVhZHk6IHRydWUsCiAgICBlcnJvcjogZnVuY3Rpb24gKG1zZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgIH0sCiAgICBub29wOiBmdW5jdGlvbiAoKSB7fSwKICAgIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgdmFyIHByb3RvLCBDdG9yOwoKICAgICAgLy8gRGV0ZWN0IG9idmlvdXMgbmVnYXRpdmVzCiAgICAgIC8vIFVzZSB0b1N0cmluZyBpbnN0ZWFkIG9mIGpRdWVyeS50eXBlIHRvIGNhdGNoIGhvc3Qgb2JqZWN0cwogICAgICBpZiAoIW9iaiB8fCB0b1N0cmluZy5jYWxsKG9iaikgIT09ICJbb2JqZWN0IE9iamVjdF0iKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHByb3RvID0gZ2V0UHJvdG8ob2JqKTsKCiAgICAgIC8vIE9iamVjdHMgd2l0aCBubyBwcm90b3R5cGUgKGUuZy4sIGBPYmplY3QuY3JlYXRlKCBudWxsIClgKSBhcmUgcGxhaW4KICAgICAgaWYgKCFwcm90bykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICAvLyBPYmplY3RzIHdpdGggcHJvdG90eXBlIGFyZSBwbGFpbiBpZmYgdGhleSB3ZXJlIGNvbnN0cnVjdGVkIGJ5IGEgZ2xvYmFsIE9iamVjdCBmdW5jdGlvbgogICAgICBDdG9yID0gaGFzT3duLmNhbGwocHJvdG8sICJjb25zdHJ1Y3RvciIpICYmIHByb3RvLmNvbnN0cnVjdG9yOwogICAgICByZXR1cm4gdHlwZW9mIEN0b3IgPT09ICJmdW5jdGlvbiIgJiYgZm5Ub1N0cmluZy5jYWxsKEN0b3IpID09PSBPYmplY3RGdW5jdGlvblN0cmluZzsKICAgIH0sCiAgICBpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHZhciBuYW1lOwogICAgICBmb3IgKG5hbWUgaW4gb2JqKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIC8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIHByb3ZpZGVkIGNvbnRleHQ7IGZhbGxzIGJhY2sgdG8gdGhlIGdsb2JhbCBvbmUKICAgIC8vIGlmIG5vdCBzcGVjaWZpZWQuCiAgICBnbG9iYWxFdmFsOiBmdW5jdGlvbiAoY29kZSwgb3B0aW9ucywgZG9jKSB7CiAgICAgIERPTUV2YWwoY29kZSwgewogICAgICAgIG5vbmNlOiBvcHRpb25zICYmIG9wdGlvbnMubm9uY2UKICAgICAgfSwgZG9jKTsKICAgIH0sCiAgICBlYWNoOiBmdW5jdGlvbiAob2JqLCBjYWxsYmFjaykgewogICAgICB2YXIgbGVuZ3RoLAogICAgICAgIGkgPSAwOwogICAgICBpZiAoaXNBcnJheUxpa2Uob2JqKSkgewogICAgICAgIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGNhbGxiYWNrLmNhbGwob2JqW2ldLCBpLCBvYmpbaV0pID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChpIGluIG9iaikgewogICAgICAgICAgaWYgKGNhbGxiYWNrLmNhbGwob2JqW2ldLCBpLCBvYmpbaV0pID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgIHRleHQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBub2RlLAogICAgICAgIHJldCA9ICIiLAogICAgICAgIGkgPSAwLAogICAgICAgIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgaWYgKCFub2RlVHlwZSkgewogICAgICAgIC8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5CiAgICAgICAgd2hpbGUgKG5vZGUgPSBlbGVtW2krK10pIHsKICAgICAgICAgIC8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCiAgICAgICAgICByZXQgKz0galF1ZXJ5LnRleHQobm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChub2RlVHlwZSA9PT0gMSB8fCBub2RlVHlwZSA9PT0gMTEpIHsKICAgICAgICByZXR1cm4gZWxlbS50ZXh0Q29udGVudDsKICAgICAgfQogICAgICBpZiAobm9kZVR5cGUgPT09IDkpIHsKICAgICAgICByZXR1cm4gZWxlbS5kb2N1bWVudEVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAgIH0KICAgICAgaWYgKG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0KSB7CiAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVZhbHVlOwogICAgICB9CgogICAgICAvLyBEbyBub3QgaW5jbHVkZSBjb21tZW50IG9yIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb24gbm9kZXMKCiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgbWFrZUFycmF5OiBmdW5jdGlvbiAoYXJyLCByZXN1bHRzKSB7CiAgICAgIHZhciByZXQgPSByZXN1bHRzIHx8IFtdOwogICAgICBpZiAoYXJyICE9IG51bGwpIHsKICAgICAgICBpZiAoaXNBcnJheUxpa2UoT2JqZWN0KGFycikpKSB7CiAgICAgICAgICBqUXVlcnkubWVyZ2UocmV0LCB0eXBlb2YgYXJyID09PSAic3RyaW5nIiA/IFthcnJdIDogYXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHVzaC5jYWxsKHJldCwgYXJyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICBpbkFycmF5OiBmdW5jdGlvbiAoZWxlbSwgYXJyLCBpKSB7CiAgICAgIHJldHVybiBhcnIgPT0gbnVsbCA/IC0xIDogaW5kZXhPZi5jYWxsKGFyciwgZWxlbSwgaSk7CiAgICB9LAogICAgaXNYTUxEb2M6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBuYW1lc3BhY2UgPSBlbGVtICYmIGVsZW0ubmFtZXNwYWNlVVJJLAogICAgICAgIGRvY0VsZW0gPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgLy8gQXNzdW1lIEhUTUwgd2hlbiBkb2N1bWVudEVsZW1lbnQgZG9lc24ndCB5ZXQgZXhpc3QsIHN1Y2ggYXMgaW5zaWRlCiAgICAgIC8vIGRvY3VtZW50IGZyYWdtZW50cy4KICAgICAgcmV0dXJuICFyaHRtbFN1ZmZpeC50ZXN0KG5hbWVzcGFjZSB8fCBkb2NFbGVtICYmIGRvY0VsZW0ubm9kZU5hbWUgfHwgIkhUTUwiKTsKICAgIH0sCiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKICAgIC8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKICAgIG1lcmdlOiBmdW5jdGlvbiAoZmlyc3QsIHNlY29uZCkgewogICAgICB2YXIgbGVuID0gK3NlY29uZC5sZW5ndGgsCiAgICAgICAgaiA9IDAsCiAgICAgICAgaSA9IGZpcnN0Lmxlbmd0aDsKICAgICAgZm9yICg7IGogPCBsZW47IGorKykgewogICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbal07CiAgICAgIH0KICAgICAgZmlyc3QubGVuZ3RoID0gaTsKICAgICAgcmV0dXJuIGZpcnN0OwogICAgfSwKICAgIGdyZXA6IGZ1bmN0aW9uIChlbGVtcywgY2FsbGJhY2ssIGludmVydCkgewogICAgICB2YXIgY2FsbGJhY2tJbnZlcnNlLAogICAgICAgIG1hdGNoZXMgPSBbXSwKICAgICAgICBpID0gMCwKICAgICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGgsCiAgICAgICAgY2FsbGJhY2tFeHBlY3QgPSAhaW52ZXJ0OwoKICAgICAgLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwogICAgICAvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgogICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgY2FsbGJhY2tJbnZlcnNlID0gIWNhbGxiYWNrKGVsZW1zW2ldLCBpKTsKICAgICAgICBpZiAoY2FsbGJhY2tJbnZlcnNlICE9PSBjYWxsYmFja0V4cGVjdCkgewogICAgICAgICAgbWF0Y2hlcy5wdXNoKGVsZW1zW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICB9LAogICAgLy8gYXJnIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICBtYXA6IGZ1bmN0aW9uIChlbGVtcywgY2FsbGJhY2ssIGFyZykgewogICAgICB2YXIgbGVuZ3RoLAogICAgICAgIHZhbHVlLAogICAgICAgIGkgPSAwLAogICAgICAgIHJldCA9IFtdOwoKICAgICAgLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyIG5ldyB2YWx1ZXMKICAgICAgaWYgKGlzQXJyYXlMaWtlKGVsZW1zKSkgewogICAgICAgIGxlbmd0aCA9IGVsZW1zLmxlbmd0aDsKICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1zW2ldLCBpLCBhcmcpOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0LnB1c2godmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGkgaW4gZWxlbXMpIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbXNbaV0sIGksIGFyZyk7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICByZXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCiAgICAgIHJldHVybiBmbGF0KHJldCk7CiAgICB9LAogICAgLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCiAgICBndWlkOiAxLAogICAgLy8galF1ZXJ5LnN1cHBvcnQgaXMgbm90IHVzZWQgaW4gQ29yZSBidXQgb3RoZXIgcHJvamVjdHMgYXR0YWNoIHRoZWlyCiAgICAvLyBwcm9wZXJ0aWVzIHRvIGl0IHNvIGl0IG5lZWRzIHRvIGV4aXN0LgogICAgc3VwcG9ydDogc3VwcG9ydAogIH0pOwogIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iKSB7CiAgICBqUXVlcnkuZm5bU3ltYm9sLml0ZXJhdG9yXSA9IGFycltTeW1ib2wuaXRlcmF0b3JdOwogIH0KCiAgLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCiAgalF1ZXJ5LmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QgRXJyb3IgU3ltYm9sIi5zcGxpdCgiICIpLCBmdW5jdGlvbiAoX2ksIG5hbWUpIHsKICAgIGNsYXNzMnR5cGVbIltvYmplY3QgIiArIG5hbWUgKyAiXSJdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogIH0pOwogIGZ1bmN0aW9uIGlzQXJyYXlMaWtlKG9iaikgewogICAgLy8gU3VwcG9ydDogcmVhbCBpT1MgOC4yIG9ubHkgKG5vdCByZXByb2R1Y2libGUgaW4gc2ltdWxhdG9yKQogICAgLy8gYGluYCBjaGVjayB1c2VkIHRvIHByZXZlbnQgSklUIGVycm9yIChnaC0yMTQ1KQogICAgLy8gaGFzT3duIGlzbid0IHVzZWQgaGVyZSBkdWUgdG8gZmFsc2UgbmVnYXRpdmVzCiAgICAvLyByZWdhcmRpbmcgTm9kZWxpc3QgbGVuZ3RoIGluIElFCiAgICB2YXIgbGVuZ3RoID0gISFvYmogJiYgImxlbmd0aCIgaW4gb2JqICYmIG9iai5sZW5ndGgsCiAgICAgIHR5cGUgPSB0b1R5cGUob2JqKTsKICAgIGlmIChpc0Z1bmN0aW9uKG9iaikgfHwgaXNXaW5kb3cob2JqKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHlwZSA9PT0gImFycmF5IiB8fCBsZW5ndGggPT09IDAgfHwgdHlwZW9mIGxlbmd0aCA9PT0gIm51bWJlciIgJiYgbGVuZ3RoID4gMCAmJiBsZW5ndGggLSAxIGluIG9iajsKICB9CiAgZnVuY3Rpb24gbm9kZU5hbWUoZWxlbSwgbmFtZSkgewogICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgfQogIHZhciBwb3AgPSBhcnIucG9wOwogIHZhciBzb3J0ID0gYXJyLnNvcnQ7CiAgdmFyIHNwbGljZSA9IGFyci5zcGxpY2U7CiAgdmFyIHdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSI7CiAgdmFyIHJ0cmltQ1NTID0gbmV3IFJlZ0V4cCgiXiIgKyB3aGl0ZXNwYWNlICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyB3aGl0ZXNwYWNlICsgIiskIiwgImciKTsKCiAgLy8gTm90ZTogYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgogIGpRdWVyeS5jb250YWlucyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICB2YXIgYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICByZXR1cm4gYSA9PT0gYnVwIHx8ICEhKGJ1cCAmJiBidXAubm9kZVR5cGUgPT09IDEgJiYgKAogICAgLy8gU3VwcG9ydDogSUUgOSAtIDExKwogICAgLy8gSUUgZG9lc24ndCBoYXZlIGBjb250YWluc2Agb24gU1ZHLgogICAgYS5jb250YWlucyA/IGEuY29udGFpbnMoYnVwKSA6IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihidXApICYgMTYpKTsKICB9OwoKICAvLyBDU1Mgc3RyaW5nL2lkZW50aWZpZXIgc2VyaWFsaXphdGlvbgogIC8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9jc3NvbS8jY29tbW9uLXNlcmlhbGl6aW5nLWlkaW9tcwogIHZhciByY3NzZXNjYXBlID0gLyhbXDAtXHgxZlx4N2ZdfF4tP1xkKXxeLSR8W15ceDgwLVx1RkZGRlx3LV0vZzsKICBmdW5jdGlvbiBmY3NzZXNjYXBlKGNoLCBhc0NvZGVQb2ludCkgewogICAgaWYgKGFzQ29kZVBvaW50KSB7CiAgICAgIC8vIFUrMDAwMCBOVUxMIGJlY29tZXMgVStGRkZEIFJFUExBQ0VNRU5UIENIQVJBQ1RFUgogICAgICBpZiAoY2ggPT09ICJcMCIpIHsKICAgICAgICByZXR1cm4gIlx1RkZGRCI7CiAgICAgIH0KCiAgICAgIC8vIENvbnRyb2wgY2hhcmFjdGVycyBhbmQgKGRlcGVuZGVudCB1cG9uIHBvc2l0aW9uKSBudW1iZXJzIGdldCBlc2NhcGVkIGFzIGNvZGUgcG9pbnRzCiAgICAgIHJldHVybiBjaC5zbGljZSgwLCAtMSkgKyAiXFwiICsgY2guY2hhckNvZGVBdChjaC5sZW5ndGggLSAxKS50b1N0cmluZygxNikgKyAiICI7CiAgICB9CgogICAgLy8gT3RoZXIgcG90ZW50aWFsbHktc3BlY2lhbCBBU0NJSSBjaGFyYWN0ZXJzIGdldCBiYWNrc2xhc2gtZXNjYXBlZAogICAgcmV0dXJuICJcXCIgKyBjaDsKICB9CiAgalF1ZXJ5LmVzY2FwZVNlbGVjdG9yID0gZnVuY3Rpb24gKHNlbCkgewogICAgcmV0dXJuIChzZWwgKyAiIikucmVwbGFjZShyY3NzZXNjYXBlLCBmY3NzZXNjYXBlKTsKICB9OwogIHZhciBwcmVmZXJyZWREb2MgPSBkb2N1bWVudCwKICAgIHB1c2hOYXRpdmUgPSBwdXNoOwogIChmdW5jdGlvbiAoKSB7CiAgICB2YXIgaSwKICAgICAgRXhwciwKICAgICAgb3V0ZXJtb3N0Q29udGV4dCwKICAgICAgc29ydElucHV0LAogICAgICBoYXNEdXBsaWNhdGUsCiAgICAgIHB1c2ggPSBwdXNoTmF0aXZlLAogICAgICAvLyBMb2NhbCBkb2N1bWVudCB2YXJzCiAgICAgIGRvY3VtZW50LAogICAgICBkb2N1bWVudEVsZW1lbnQsCiAgICAgIGRvY3VtZW50SXNIVE1MLAogICAgICByYnVnZ3lRU0EsCiAgICAgIG1hdGNoZXMsCiAgICAgIC8vIEluc3RhbmNlLXNwZWNpZmljIGRhdGEKICAgICAgZXhwYW5kbyA9IGpRdWVyeS5leHBhbmRvLAogICAgICBkaXJydW5zID0gMCwKICAgICAgZG9uZSA9IDAsCiAgICAgIGNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAogICAgICB0b2tlbkNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICAgICAgY29tcGlsZXJDYWNoZSA9IGNyZWF0ZUNhY2hlKCksCiAgICAgIG5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAogICAgICBzb3J0T3JkZXIgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgICAgfSwKICAgICAgYm9vbGVhbnMgPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufGlzbWFwfCIgKyAibG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZCIsCiAgICAgIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKCiAgICAgIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9jc3Mtc3ludGF4LTMvI2lkZW50LXRva2VuLWRpYWdyYW0KICAgICAgaWRlbnRpZmllciA9ICIoPzpcXFxcW1xcZGEtZkEtRl17MSw2fSIgKyB3aGl0ZXNwYWNlICsgIj98XFxcXFteXFxyXFxuXFxmXXxbXFx3LV18W15cMC1cXHg3Zl0pKyIsCiAgICAgIC8vIEF0dHJpYnV0ZSBzZWxlY3RvcnM6IGh0dHBzOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKICAgICAgYXR0cmlidXRlcyA9ICJcXFsiICsgd2hpdGVzcGFjZSArICIqKCIgKyBpZGVudGlmaWVyICsgIikoPzoiICsgd2hpdGVzcGFjZSArCiAgICAgIC8vIE9wZXJhdG9yIChjYXB0dXJlIDIpCiAgICAgICIqKFsqXiR8IX5dPz0pIiArIHdoaXRlc3BhY2UgKwogICAgICAvLyAiQXR0cmlidXRlIHZhbHVlcyBtdXN0IGJlIENTUyBpZGVudGlmaWVycyBbY2FwdHVyZSA1XSBvciBzdHJpbmdzIFtjYXB0dXJlIDMgb3IgY2FwdHVyZSA0XSIKICAgICAgIiooPzonKCg/OlxcXFwufFteXFxcXCddKSopJ3xcIigoPzpcXFxcLnxbXlxcXFxcIl0pKilcInwoIiArIGlkZW50aWZpZXIgKyAiKSl8KSIgKyB3aGl0ZXNwYWNlICsgIipcXF0iLAogICAgICBwc2V1ZG9zID0gIjooIiArIGlkZW50aWZpZXIgKyAiKSg/OlxcKCgiICsKICAgICAgLy8gVG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIHByZUZpbHRlciwgcHJlZmVyIGFyZ3VtZW50czoKICAgICAgLy8gMS4gcXVvdGVkIChjYXB0dXJlIDM7IGNhcHR1cmUgNCBvciBjYXB0dXJlIDUpCiAgICAgICIoJygoPzpcXFxcLnxbXlxcXFwnXSkqKSd8XCIoKD86XFxcXC58W15cXFxcXCJdKSopXCIpfCIgKwogICAgICAvLyAyLiBzaW1wbGUgKGNhcHR1cmUgNikKICAgICAgIigoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzICsgIikqKXwiICsKICAgICAgLy8gMy4gYW55dGhpbmcgZWxzZSAoY2FwdHVyZSAyKQogICAgICAiLioiICsgIilcXCl8KSIsCiAgICAgIC8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKICAgICAgcndoaXRlc3BhY2UgPSBuZXcgUmVnRXhwKHdoaXRlc3BhY2UgKyAiKyIsICJnIiksCiAgICAgIHJjb21tYSA9IG5ldyBSZWdFeHAoIl4iICsgd2hpdGVzcGFjZSArICIqLCIgKyB3aGl0ZXNwYWNlICsgIioiKSwKICAgICAgcmxlYWRpbmdDb21iaW5hdG9yID0gbmV3IFJlZ0V4cCgiXiIgKyB3aGl0ZXNwYWNlICsgIiooWz4rfl18IiArIHdoaXRlc3BhY2UgKyAiKSIgKyB3aGl0ZXNwYWNlICsgIioiKSwKICAgICAgcmRlc2NlbmQgPSBuZXcgUmVnRXhwKHdoaXRlc3BhY2UgKyAifD4iKSwKICAgICAgcnBzZXVkbyA9IG5ldyBSZWdFeHAocHNldWRvcyksCiAgICAgIHJpZGVudGlmaWVyID0gbmV3IFJlZ0V4cCgiXiIgKyBpZGVudGlmaWVyICsgIiQiKSwKICAgICAgbWF0Y2hFeHByID0gewogICAgICAgIElEOiBuZXcgUmVnRXhwKCJeIygiICsgaWRlbnRpZmllciArICIpIiksCiAgICAgICAgQ0xBU1M6IG5ldyBSZWdFeHAoIl5cXC4oIiArIGlkZW50aWZpZXIgKyAiKSIpLAogICAgICAgIFRBRzogbmV3IFJlZ0V4cCgiXigiICsgaWRlbnRpZmllciArICJ8WypdKSIpLAogICAgICAgIEFUVFI6IG5ldyBSZWdFeHAoIl4iICsgYXR0cmlidXRlcyksCiAgICAgICAgUFNFVURPOiBuZXcgUmVnRXhwKCJeIiArIHBzZXVkb3MpLAogICAgICAgIENISUxEOiBuZXcgUmVnRXhwKCJeOihvbmx5fGZpcnN0fGxhc3R8bnRofG50aC1sYXN0KS0oY2hpbGR8b2YtdHlwZSkoPzpcXCgiICsgd2hpdGVzcGFjZSArICIqKGV2ZW58b2RkfCgoWystXXwpKFxcZCopbnwpIiArIHdoaXRlc3BhY2UgKyAiKig/OihbKy1dfCkiICsgd2hpdGVzcGFjZSArICIqKFxcZCspfCkpIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpIiwgImkiKSwKICAgICAgICBib29sOiBuZXcgUmVnRXhwKCJeKD86IiArIGJvb2xlYW5zICsgIikkIiwgImkiKSwKICAgICAgICAvLyBGb3IgdXNlIGluIGxpYnJhcmllcyBpbXBsZW1lbnRpbmcgLmlzKCkKICAgICAgICAvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCiAgICAgICAgbmVlZHNDb250ZXh0OiBuZXcgUmVnRXhwKCJeIiArIHdoaXRlc3BhY2UgKyAiKls+K35dfDooZXZlbnxvZGR8ZXF8Z3R8bHR8bnRofGZpcnN0fGxhc3QpKD86XFwoIiArIHdoaXRlc3BhY2UgKyAiKigoPzotXFxkKT9cXGQqKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSg/PVteLV18JCkiLCAiaSIpCiAgICAgIH0sCiAgICAgIHJpbnB1dHMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAogICAgICByaGVhZGVyID0gL15oXGQkL2ksCiAgICAgIC8vIEVhc2lseS1wYXJzZWFibGUvcmV0cmlldmFibGUgSUQgb3IgVEFHIG9yIENMQVNTIHNlbGVjdG9ycwogICAgICBycXVpY2tFeHByID0gL14oPzojKFtcdy1dKyl8KFx3Kyl8XC4oW1x3LV0rKSkkLywKICAgICAgcnNpYmxpbmcgPSAvWyt+XS8sCiAgICAgIC8vIENTUyBlc2NhcGVzCiAgICAgIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjZXNjYXBlZC1jaGFyYWN0ZXJzCiAgICAgIHJ1bmVzY2FwZSA9IG5ldyBSZWdFeHAoIlxcXFxbXFxkYS1mQS1GXXsxLDZ9IiArIHdoaXRlc3BhY2UgKyAiP3xcXFxcKFteXFxyXFxuXFxmXSkiLCAiZyIpLAogICAgICBmdW5lc2NhcGUgPSBmdW5jdGlvbiAoZXNjYXBlLCBub25IZXgpIHsKICAgICAgICB2YXIgaGlnaCA9ICIweCIgKyBlc2NhcGUuc2xpY2UoMSkgLSAweDEwMDAwOwogICAgICAgIGlmIChub25IZXgpIHsKICAgICAgICAgIC8vIFN0cmlwIHRoZSBiYWNrc2xhc2ggcHJlZml4IGZyb20gYSBub24taGV4IGVzY2FwZSBzZXF1ZW5jZQogICAgICAgICAgcmV0dXJuIG5vbkhleDsKICAgICAgICB9CgogICAgICAgIC8vIFJlcGxhY2UgYSBoZXhhZGVjaW1hbCBlc2NhcGUgc2VxdWVuY2Ugd2l0aCB0aGUgZW5jb2RlZCBVbmljb2RlIGNvZGUgcG9pbnQKICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTExKwogICAgICAgIC8vIEZvciB2YWx1ZXMgb3V0c2lkZSB0aGUgQmFzaWMgTXVsdGlsaW5ndWFsIFBsYW5lIChCTVApLCBtYW51YWxseSBjb25zdHJ1Y3QgYQogICAgICAgIC8vIHN1cnJvZ2F0ZSBwYWlyCiAgICAgICAgcmV0dXJuIGhpZ2ggPCAwID8gU3RyaW5nLmZyb21DaGFyQ29kZShoaWdoICsgMHgxMDAwMCkgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGhpZ2ggPj4gMTAgfCAweEQ4MDAsIGhpZ2ggJiAweDNGRiB8IDB4REMwMCk7CiAgICAgIH0sCiAgICAgIC8vIFVzZWQgZm9yIGlmcmFtZXM7IHNlZSBgc2V0RG9jdW1lbnRgLgogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErLCBFZGdlIDEyIC0gMTgrCiAgICAgIC8vIFJlbW92aW5nIHRoZSBmdW5jdGlvbiB3cmFwcGVyIGNhdXNlcyBhICJQZXJtaXNzaW9uIERlbmllZCIKICAgICAgLy8gZXJyb3IgaW4gSUUvRWRnZS4KICAgICAgdW5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBzZXREb2N1bWVudCgpOwogICAgICB9LAogICAgICBpbkRpc2FibGVkRmllbGRzZXQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWUgJiYgbm9kZU5hbWUoZWxlbSwgImZpZWxkc2V0Iik7CiAgICAgIH0sIHsKICAgICAgICBkaXI6ICJwYXJlbnROb2RlIiwKICAgICAgICBuZXh0OiAibGVnZW5kIgogICAgICB9KTsKCiAgICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogICAgLy8gQWNjZXNzaW5nIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgY2FuIHRocm93IHVuZXhwZWN0ZWRseQogICAgLy8gaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzkzCiAgICBmdW5jdGlvbiBzYWZlQWN0aXZlRWxlbWVudCgpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgICAgfSBjYXRjaCAoZXJyKSB7fQogICAgfQoKICAgIC8vIE9wdGltaXplIGZvciBwdXNoLmFwcGx5KCBfLCBOb2RlTGlzdCApCiAgICB0cnkgewogICAgICBwdXNoLmFwcGx5KGFyciA9IHNsaWNlLmNhbGwocHJlZmVycmVkRG9jLmNoaWxkTm9kZXMpLCBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcyk7CgogICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wCiAgICAgIC8vIERldGVjdCBzaWxlbnRseSBmYWlsaW5nIHB1c2guYXBwbHkKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC1leHByZXNzaW9ucwogICAgICBhcnJbcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMubGVuZ3RoXS5ub2RlVHlwZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcHVzaCA9IHsKICAgICAgICBhcHBseTogZnVuY3Rpb24gKHRhcmdldCwgZWxzKSB7CiAgICAgICAgICBwdXNoTmF0aXZlLmFwcGx5KHRhcmdldCwgc2xpY2UuY2FsbChlbHMpKTsKICAgICAgICB9LAogICAgICAgIGNhbGw6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgICAgIHB1c2hOYXRpdmUuYXBwbHkodGFyZ2V0LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGZpbmQoc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKICAgICAgdmFyIG0sCiAgICAgICAgaSwKICAgICAgICBlbGVtLAogICAgICAgIG5pZCwKICAgICAgICBtYXRjaCwKICAgICAgICBncm91cHMsCiAgICAgICAgbmV3U2VsZWN0b3IsCiAgICAgICAgbmV3Q29udGV4dCA9IGNvbnRleHQgJiYgY29udGV4dC5vd25lckRvY3VtZW50LAogICAgICAgIC8vIG5vZGVUeXBlIGRlZmF1bHRzIHRvIDksIHNpbmNlIGNvbnRleHQgZGVmYXVsdHMgdG8gZG9jdW1lbnQKICAgICAgICBub2RlVHlwZSA9IGNvbnRleHQgPyBjb250ZXh0Lm5vZGVUeXBlIDogOTsKICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CgogICAgICAvLyBSZXR1cm4gZWFybHkgZnJvbSBjYWxscyB3aXRoIGludmFsaWQgc2VsZWN0b3Igb3IgY29udGV4dAogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiB8fCAhc2VsZWN0b3IgfHwgbm9kZVR5cGUgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgJiYgbm9kZVR5cGUgIT09IDExKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH0KCiAgICAgIC8vIFRyeSB0byBzaG9ydGN1dCBmaW5kIG9wZXJhdGlvbnMgKGFzIG9wcG9zZWQgdG8gZmlsdGVycykgaW4gSFRNTCBkb2N1bWVudHMKICAgICAgaWYgKCFzZWVkKSB7CiAgICAgICAgc2V0RG9jdW1lbnQoY29udGV4dCk7CiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICAgICAgaWYgKGRvY3VtZW50SXNIVE1MKSB7CiAgICAgICAgICAvLyBJZiB0aGUgc2VsZWN0b3IgaXMgc3VmZmljaWVudGx5IHNpbXBsZSwgdHJ5IHVzaW5nIGEgImdldCpCeSoiIERPTSBtZXRob2QKICAgICAgICAgIC8vIChleGNlcHRpbmcgRG9jdW1lbnRGcmFnbWVudCBjb250ZXh0LCB3aGVyZSB0aGUgbWV0aG9kcyBkb24ndCBleGlzdCkKICAgICAgICAgIGlmIChub2RlVHlwZSAhPT0gMTEgJiYgKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKHNlbGVjdG9yKSkpIHsKICAgICAgICAgICAgLy8gSUQgc2VsZWN0b3IKICAgICAgICAgICAgaWYgKG0gPSBtYXRjaFsxXSkgewogICAgICAgICAgICAgIC8vIERvY3VtZW50IGNvbnRleHQKICAgICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtKSkgewogICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA5IG9ubHkKICAgICAgICAgICAgICAgICAgLy8gZ2V0RWxlbWVudEJ5SWQgY2FuIG1hdGNoIGVsZW1lbnRzIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAogICAgICAgICAgICAgICAgICBpZiAoZWxlbS5pZCA9PT0gbSkgewogICAgICAgICAgICAgICAgICAgIHB1c2guY2FsbChyZXN1bHRzLCBlbGVtKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRWxlbWVudCBjb250ZXh0CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDkgb25seQogICAgICAgICAgICAgICAgLy8gZ2V0RWxlbWVudEJ5SWQgY2FuIG1hdGNoIGVsZW1lbnRzIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAogICAgICAgICAgICAgICAgaWYgKG5ld0NvbnRleHQgJiYgKGVsZW0gPSBuZXdDb250ZXh0LmdldEVsZW1lbnRCeUlkKG0pKSAmJiBmaW5kLmNvbnRhaW5zKGNvbnRleHQsIGVsZW0pICYmIGVsZW0uaWQgPT09IG0pIHsKICAgICAgICAgICAgICAgICAgcHVzaC5jYWxsKHJlc3VsdHMsIGVsZW0pOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIFR5cGUgc2VsZWN0b3IKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3RvcikpOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwoKICAgICAgICAgICAgICAvLyBDbGFzcyBzZWxlY3RvcgogICAgICAgICAgICB9IGVsc2UgaWYgKChtID0gbWF0Y2hbM10pICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKG0pKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRha2UgYWR2YW50YWdlIG9mIHF1ZXJ5U2VsZWN0b3JBbGwKICAgICAgICAgIGlmICghbm9ubmF0aXZlU2VsZWN0b3JDYWNoZVtzZWxlY3RvciArICIgIl0gJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KHNlbGVjdG9yKSkpIHsKICAgICAgICAgICAgbmV3U2VsZWN0b3IgPSBzZWxlY3RvcjsKICAgICAgICAgICAgbmV3Q29udGV4dCA9IGNvbnRleHQ7CgogICAgICAgICAgICAvLyBxU0EgY29uc2lkZXJzIGVsZW1lbnRzIG91dHNpZGUgYSBzY29waW5nIHJvb3Qgd2hlbiBldmFsdWF0aW5nIGNoaWxkIG9yCiAgICAgICAgICAgIC8vIGRlc2NlbmRhbnQgY29tYmluYXRvcnMsIHdoaWNoIGlzIG5vdCB3aGF0IHdlIHdhbnQuCiAgICAgICAgICAgIC8vIEluIHN1Y2ggY2FzZXMsIHdlIHdvcmsgYXJvdW5kIHRoZSBiZWhhdmlvciBieSBwcmVmaXhpbmcgZXZlcnkgc2VsZWN0b3IgaW4gdGhlCiAgICAgICAgICAgIC8vIGxpc3Qgd2l0aCBhbiBJRCBzZWxlY3RvciByZWZlcmVuY2luZyB0aGUgc2NvcGUgY29udGV4dC4KICAgICAgICAgICAgLy8gVGhlIHRlY2huaXF1ZSBoYXMgdG8gYmUgdXNlZCBhcyB3ZWxsIHdoZW4gYSBsZWFkaW5nIGNvbWJpbmF0b3IgaXMgdXNlZAogICAgICAgICAgICAvLyBhcyBzdWNoIHNlbGVjdG9ycyBhcmUgbm90IHJlY29nbml6ZWQgYnkgcXVlcnlTZWxlY3RvckFsbC4KICAgICAgICAgICAgLy8gVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoaXMgdGVjaG5pcXVlLgogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDEgJiYgKHJkZXNjZW5kLnRlc3Qoc2VsZWN0b3IpIHx8IHJsZWFkaW5nQ29tYmluYXRvci50ZXN0KHNlbGVjdG9yKSkpIHsKICAgICAgICAgICAgICAvLyBFeHBhbmQgY29udGV4dCBmb3Igc2libGluZyBzZWxlY3RvcnMKICAgICAgICAgICAgICBuZXdDb250ZXh0ID0gcnNpYmxpbmcudGVzdChzZWxlY3RvcikgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0OwoKICAgICAgICAgICAgICAvLyBXZSBjYW4gdXNlIDpzY29wZSBpbnN0ZWFkIG9mIHRoZSBJRCBoYWNrIGlmIHRoZSBicm93c2VyCiAgICAgICAgICAgICAgLy8gc3VwcG9ydHMgaXQgJiBpZiB3ZSdyZSBub3QgY2hhbmdpbmcgdGhlIGNvbnRleHQuCiAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4KICAgICAgICAgICAgICAvLyBzdHJpY3QtY29tcGFyaW5nIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgICAgICAgaWYgKG5ld0NvbnRleHQgIT0gY29udGV4dCB8fCAhc3VwcG9ydC5zY29wZSkgewogICAgICAgICAgICAgICAgLy8gQ2FwdHVyZSB0aGUgY29udGV4dCBJRCwgc2V0dGluZyBpdCBmaXJzdCBpZiBuZWNlc3NhcnkKICAgICAgICAgICAgICAgIGlmIChuaWQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgiaWQiKSkgewogICAgICAgICAgICAgICAgICBuaWQgPSBqUXVlcnkuZXNjYXBlU2VsZWN0b3IobmlkKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuc2V0QXR0cmlidXRlKCJpZCIsIG5pZCA9IGV4cGFuZG8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gUHJlZml4IGV2ZXJ5IHNlbGVjdG9yIGluIHRoZSBsaXN0CiAgICAgICAgICAgICAgZ3JvdXBzID0gdG9rZW5pemUoc2VsZWN0b3IpOwogICAgICAgICAgICAgIGkgPSBncm91cHMubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGdyb3Vwc1tpXSA9IChuaWQgPyAiIyIgKyBuaWQgOiAiOnNjb3BlIikgKyAiICIgKyB0b1NlbGVjdG9yKGdyb3Vwc1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5ld1NlbGVjdG9yID0gZ3JvdXBzLmpvaW4oIiwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKG5ld1NlbGVjdG9yKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgIH0gY2F0Y2ggKHFzYUVycm9yKSB7CiAgICAgICAgICAgICAgbm9ubmF0aXZlU2VsZWN0b3JDYWNoZShzZWxlY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKG5pZCA9PT0gZXhwYW5kbykgewogICAgICAgICAgICAgICAgY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoImlkIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBBbGwgb3RoZXJzCiAgICAgIHJldHVybiBzZWxlY3Qoc2VsZWN0b3IucmVwbGFjZShydHJpbUNTUywgIiQxIiksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlIGtleS12YWx1ZSBjYWNoZXMgb2YgbGltaXRlZCBzaXplCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nLCBvYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAgICAgKglwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQogICAgICoJZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVDYWNoZSgpIHsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgZnVuY3Rpb24gY2FjaGUoa2V5LCB2YWx1ZSkgewogICAgICAgIC8vIFVzZSAoa2V5ICsgIiAiKSB0byBhdm9pZCBjb2xsaXNpb24gd2l0aCBuYXRpdmUgcHJvdG90eXBlIHByb3BlcnRpZXMKICAgICAgICAvLyAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvc2l6emxlL2lzc3Vlcy8xNTcpCiAgICAgICAgaWYgKGtleXMucHVzaChrZXkgKyAiICIpID4gRXhwci5jYWNoZUxlbmd0aCkgewogICAgICAgICAgLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCiAgICAgICAgICBkZWxldGUgY2FjaGVba2V5cy5zaGlmdCgpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlW2tleSArICIgIl0gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBNYXJrIGEgZnVuY3Rpb24gZm9yIHNwZWNpYWwgdXNlIGJ5IGpRdWVyeSBzZWxlY3RvciBtb2R1bGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBtYXJrCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcmtGdW5jdGlvbihmbikgewogICAgICBmbltleHBhbmRvXSA9IHRydWU7CiAgICAgIHJldHVybiBmbjsKICAgIH0KCiAgICAvKioKICAgICAqIFN1cHBvcnQgdGVzdGluZyB1c2luZyBhbiBlbGVtZW50CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBQYXNzZWQgdGhlIGNyZWF0ZWQgZWxlbWVudCBhbmQgcmV0dXJucyBhIGJvb2xlYW4gcmVzdWx0CiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydChmbikgewogICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmaWVsZHNldCIpOwogICAgICB0cnkgewogICAgICAgIHJldHVybiAhIWZuKGVsKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAvLyBSZW1vdmUgZnJvbSBpdHMgcGFyZW50IGJ5IGRlZmF1bHQKICAgICAgICBpZiAoZWwucGFyZW50Tm9kZSkgewogICAgICAgICAgZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbCk7CiAgICAgICAgfQoKICAgICAgICAvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQogICAgICAgIGVsID0gbnVsbDsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlSW5wdXRQc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICByZXR1cm4gbm9kZU5hbWUoZWxlbSwgImlucHV0IikgJiYgZWxlbS50eXBlID09PSB0eXBlOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICByZXR1cm4gKG5vZGVOYW1lKGVsZW0sICJpbnB1dCIpIHx8IG5vZGVOYW1lKGVsZW0sICJidXR0b24iKSkgJiYgZWxlbS50eXBlID09PSB0eXBlOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciA6ZW5hYmxlZC86ZGlzYWJsZWQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGlzYWJsZWQgdHJ1ZSBmb3IgOmRpc2FibGVkOyBmYWxzZSBmb3IgOmVuYWJsZWQKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlRGlzYWJsZWRQc2V1ZG8oZGlzYWJsZWQpIHsKICAgICAgLy8gS25vd24gOmRpc2FibGVkIGZhbHNlIHBvc2l0aXZlczogZmllbGRzZXRbZGlzYWJsZWRdID4gbGVnZW5kOm50aC1vZi10eXBlKG4rMikgOmNhbi1kaXNhYmxlCiAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIC8vIE9ubHkgY2VydGFpbiBlbGVtZW50cyBjYW4gbWF0Y2ggOmVuYWJsZWQgb3IgOmRpc2FibGVkCiAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc2NyaXB0aW5nLmh0bWwjc2VsZWN0b3ItZW5hYmxlZAogICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3NjcmlwdGluZy5odG1sI3NlbGVjdG9yLWRpc2FibGVkCiAgICAgICAgaWYgKCJmb3JtIiBpbiBlbGVtKSB7CiAgICAgICAgICAvLyBDaGVjayBmb3IgaW5oZXJpdGVkIGRpc2FibGVkbmVzcyBvbiByZWxldmFudCBub24tZGlzYWJsZWQgZWxlbWVudHM6CiAgICAgICAgICAvLyAqIGxpc3RlZCBmb3JtLWFzc29jaWF0ZWQgZWxlbWVudHMgaW4gYSBkaXNhYmxlZCBmaWVsZHNldAogICAgICAgICAgLy8gICBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9mb3Jtcy5odG1sI2NhdGVnb3J5LWxpc3RlZAogICAgICAgICAgLy8gICBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9mb3Jtcy5odG1sI2NvbmNlcHQtZmUtZGlzYWJsZWQKICAgICAgICAgIC8vICogb3B0aW9uIGVsZW1lbnRzIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXAKICAgICAgICAgIC8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjb25jZXB0LW9wdGlvbi1kaXNhYmxlZAogICAgICAgICAgLy8gQWxsIHN1Y2ggZWxlbWVudHMgaGF2ZSBhICJmb3JtIiBwcm9wZXJ0eS4KICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUgJiYgZWxlbS5kaXNhYmxlZCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgLy8gT3B0aW9uIGVsZW1lbnRzIGRlZmVyIHRvIGEgcGFyZW50IG9wdGdyb3VwIGlmIHByZXNlbnQKICAgICAgICAgICAgaWYgKCJsYWJlbCIgaW4gZWxlbSkgewogICAgICAgICAgICAgIGlmICgibGFiZWwiIGluIGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ucGFyZW50Tm9kZS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDYgLSAxMSsKICAgICAgICAgICAgLy8gVXNlIHRoZSBpc0Rpc2FibGVkIHNob3J0Y3V0IHByb3BlcnR5IHRvIGNoZWNrIGZvciBkaXNhYmxlZCBmaWVsZHNldCBhbmNlc3RvcnMKICAgICAgICAgICAgcmV0dXJuIGVsZW0uaXNEaXNhYmxlZCA9PT0gZGlzYWJsZWQgfHwKICAgICAgICAgICAgLy8gV2hlcmUgdGhlcmUgaXMgbm8gaXNEaXNhYmxlZCwgY2hlY2sgbWFudWFsbHkKICAgICAgICAgICAgZWxlbS5pc0Rpc2FibGVkICE9PSAhZGlzYWJsZWQgJiYgaW5EaXNhYmxlZEZpZWxkc2V0KGVsZW0pID09PSBkaXNhYmxlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsKCiAgICAgICAgICAvLyBUcnkgdG8gd2lubm93IG91dCBlbGVtZW50cyB0aGF0IGNhbid0IGJlIGRpc2FibGVkIGJlZm9yZSB0cnVzdGluZyB0aGUgZGlzYWJsZWQgcHJvcGVydHkuCiAgICAgICAgICAvLyBTb21lIHZpY3RpbXMgZ2V0IGNhdWdodCBpbiBvdXIgbmV0IChsYWJlbCwgbGVnZW5kLCBtZW51LCB0cmFjayksIGJ1dCBpdCBzaG91bGRuJ3QKICAgICAgICAgIC8vIGV2ZW4gZXhpc3Qgb24gdGhlbSwgbGV0IGFsb25lIGhhdmUgYSBib29sZWFuIHZhbHVlLgogICAgICAgIH0gZWxzZSBpZiAoImxhYmVsIiBpbiBlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CiAgICAgICAgfQoKICAgICAgICAvLyBSZW1haW5pbmcgZWxlbWVudHMgYXJlIG5laXRoZXIgOmVuYWJsZWQgbm9yIDpkaXNhYmxlZAogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgcG9zaXRpb25hbHMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZm4pIHsKICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoYXJndW1lbnQpIHsKICAgICAgICBhcmd1bWVudCA9ICthcmd1bWVudDsKICAgICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICB2YXIgaiwKICAgICAgICAgICAgbWF0Y2hJbmRleGVzID0gZm4oW10sIHNlZWQubGVuZ3RoLCBhcmd1bWVudCksCiAgICAgICAgICAgIGkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwoKICAgICAgICAgIC8vIE1hdGNoIGVsZW1lbnRzIGZvdW5kIGF0IHRoZSBzcGVjaWZpZWQgaW5kZXhlcwogICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICBpZiAoc2VlZFtqID0gbWF0Y2hJbmRleGVzW2ldXSkgewogICAgICAgICAgICAgIHNlZWRbal0gPSAhKG1hdGNoZXNbal0gPSBzZWVkW2pdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBhIG5vZGUgZm9yIHZhbGlkaXR5IGFzIGEgalF1ZXJ5IHNlbGVjdG9yIGNvbnRleHQKICAgICAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3Q9fSBjb250ZXh0CiAgICAgKiBAcmV0dXJucyB7RWxlbWVudHxPYmplY3R8Qm9vbGVhbn0gVGhlIGlucHV0IG5vZGUgaWYgYWNjZXB0YWJsZSwgb3RoZXJ3aXNlIGEgZmFsc3kgdmFsdWUKICAgICAqLwogICAgZnVuY3Rpb24gdGVzdENvbnRleHQoY29udGV4dCkgewogICAgICByZXR1cm4gY29udGV4dCAmJiB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgJiYgY29udGV4dDsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogICAgICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gW25vZGVdIEFuIGVsZW1lbnQgb3IgZG9jdW1lbnQgb2JqZWN0IHRvIHVzZSB0byBzZXQgdGhlIGRvY3VtZW50CiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldERvY3VtZW50KG5vZGUpIHsKICAgICAgdmFyIHN1YldpbmRvdywKICAgICAgICBkb2MgPSBub2RlID8gbm9kZS5vd25lckRvY3VtZW50IHx8IG5vZGUgOiBwcmVmZXJyZWREb2M7CgogICAgICAvLyBSZXR1cm4gZWFybHkgaWYgZG9jIGlzIGludmFsaWQgb3IgYWxyZWFkeSBzZWxlY3RlZAogICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgaWYgKGRvYyA9PSBkb2N1bWVudCB8fCBkb2Mubm9kZVR5cGUgIT09IDkgfHwgIWRvYy5kb2N1bWVudEVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQ7CiAgICAgIH0KCiAgICAgIC8vIFVwZGF0ZSBnbG9iYWwgdmFyaWFibGVzCiAgICAgIGRvY3VtZW50ID0gZG9jOwogICAgICBkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgIGRvY3VtZW50SXNIVE1MID0gIWpRdWVyeS5pc1hNTERvYyhkb2N1bWVudCk7CgogICAgICAvLyBTdXBwb3J0OiBpT1MgNyBvbmx5LCBJRSA5IC0gMTErCiAgICAgIC8vIE9sZGVyIGJyb3dzZXJzIGRpZG4ndCBzdXBwb3J0IHVucHJlZml4ZWQgYG1hdGNoZXNgLgogICAgICBtYXRjaGVzID0gZG9jdW1lbnRFbGVtZW50Lm1hdGNoZXMgfHwgZG9jdW1lbnRFbGVtZW50LndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fCBkb2N1bWVudEVsZW1lbnQubXNNYXRjaGVzU2VsZWN0b3I7CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErLCBFZGdlIDEyIC0gMTgrCiAgICAgIC8vIEFjY2Vzc2luZyBpZnJhbWUgZG9jdW1lbnRzIGFmdGVyIHVubG9hZCB0aHJvd3MgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvcnMKICAgICAgLy8gKHNlZSB0cmFjLTEzOTM2KS4KICAgICAgLy8gTGltaXQgdGhlIGZpeCB0byBJRSAmIEVkZ2UgTGVnYWN5OyBkZXNwaXRlIEVkZ2UgMTUrIGltcGxlbWVudGluZyBgbWF0Y2hlc2AsCiAgICAgIC8vIGFsbCBJRSA5KyBhbmQgRWRnZSBMZWdhY3kgdmVyc2lvbnMgaW1wbGVtZW50IGBtc01hdGNoZXNTZWxlY3RvcmAgYXMgd2VsbC4KICAgICAgaWYgKGRvY3VtZW50RWxlbWVudC5tc01hdGNoZXNTZWxlY3RvciAmJgogICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgcHJlZmVycmVkRG9jICE9IGRvY3VtZW50ICYmIChzdWJXaW5kb3cgPSBkb2N1bWVudC5kZWZhdWx0VmlldykgJiYgc3ViV2luZG93LnRvcCAhPT0gc3ViV2luZG93KSB7CiAgICAgICAgLy8gU3VwcG9ydDogSUUgOSAtIDExKywgRWRnZSAxMiAtIDE4KwogICAgICAgIHN1YldpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ1bmxvYWQiLCB1bmxvYWRIYW5kbGVyKTsKICAgICAgfQoKICAgICAgLy8gU3VwcG9ydDogSUUgPDEwCiAgICAgIC8vIENoZWNrIGlmIGdldEVsZW1lbnRCeUlkIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZQogICAgICAvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtbWF0aWNhbGx5LXNldCBuYW1lcywKICAgICAgLy8gc28gdXNlIGEgcm91bmRhYm91dCBnZXRFbGVtZW50c0J5TmFtZSB0ZXN0CiAgICAgIHN1cHBvcnQuZ2V0QnlJZCA9IGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgICBkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoZWwpLmlkID0galF1ZXJ5LmV4cGFuZG87CiAgICAgICAgcmV0dXJuICFkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSB8fCAhZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoalF1ZXJ5LmV4cGFuZG8pLmxlbmd0aDsKICAgICAgfSk7CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IG9ubHkKICAgICAgLy8gQ2hlY2sgdG8gc2VlIGlmIGl0J3MgcG9zc2libGUgdG8gZG8gbWF0Y2hlc1NlbGVjdG9yCiAgICAgIC8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUuCiAgICAgIHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggPSBhc3NlcnQoZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZXMuY2FsbChlbCwgIioiKTsKICAgICAgfSk7CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErLCBFZGdlIDEyIC0gMTgrCiAgICAgIC8vIElFL0VkZ2UgZG9uJ3Qgc3VwcG9ydCB0aGUgOnNjb3BlIHBzZXVkby1jbGFzcy4KICAgICAgc3VwcG9ydC5zY29wZSA9IGFzc2VydChmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIjpzY29wZSIpOwogICAgICB9KTsKCiAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSAxMDUgLSAxMTEgb25seSwgU2FmYXJpIDE1LjQgLSAxNi4zIG9ubHkKICAgICAgLy8gTWFrZSBzdXJlIHRoZSBgOmhhcygpYCBhcmd1bWVudCBpcyBwYXJzZWQgdW5mb3JnaXZpbmdseS4KICAgICAgLy8gV2UgaW5jbHVkZSBgKmAgaW4gdGhlIHRlc3QgdG8gZGV0ZWN0IGJ1Z2d5IGltcGxlbWVudGF0aW9ucyB0aGF0IGFyZQogICAgICAvLyBfc2VsZWN0aXZlbHlfIGZvcmdpdmluZyAoc3BlY2lmaWNhbGx5IHdoZW4gdGhlIGxpc3QgaW5jbHVkZXMgYXQgbGVhc3QKICAgICAgLy8gb25lIHZhbGlkIHNlbGVjdG9yKS4KICAgICAgLy8gTm90ZSB0aGF0IHdlIHRyZWF0IGNvbXBsZXRlIGxhY2sgb2Ygc3VwcG9ydCBmb3IgYDpoYXMoKWAgYXMgaWYgaXQgd2VyZQogICAgICAvLyBzcGVjLWNvbXBsaWFudCBzdXBwb3J0LCB3aGljaCBpcyBmaW5lIGJlY2F1c2UgdXNlIG9mIGA6aGFzKClgIGluIHN1Y2gKICAgICAgLy8gZW52aXJvbm1lbnRzIHdpbGwgZmFpbCBpbiB0aGUgcVNBIHBhdGggYW5kIGZhbGwgYmFjayB0byBqUXVlcnkgdHJhdmVyc2FsCiAgICAgIC8vIGFueXdheS4KICAgICAgc3VwcG9ydC5jc3NIYXMgPSBhc3NlcnQoZnVuY3Rpb24gKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCI6aGFzKCosOmpxZmFrZSkiKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gSUQgZmlsdGVyIGFuZCBmaW5kCiAgICAgIGlmIChzdXBwb3J0LmdldEJ5SWQpIHsKICAgICAgICBFeHByLmZpbHRlci5JRCA9IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaWQiKSA9PT0gYXR0cklkOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIEV4cHIuZmluZC5JRCA9IGZ1bmN0aW9uIChpZCwgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgICB2YXIgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICByZXR1cm4gZWxlbSA/IFtlbGVtXSA6IFtdOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgRXhwci5maWx0ZXIuSUQgPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09ICJ1bmRlZmluZWQiICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gYXR0cklkOwogICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICAvLyBTdXBwb3J0OiBJRSA2IC0gNyBvbmx5CiAgICAgICAgLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dAogICAgICAgIEV4cHIuZmluZC5JRCA9IGZ1bmN0aW9uIChpZCwgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgICB2YXIgbm9kZSwKICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgIGVsZW1zLAogICAgICAgICAgICAgIGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAvLyBWZXJpZnkgdGhlIGlkIGF0dHJpYnV0ZQogICAgICAgICAgICAgIG5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CiAgICAgICAgICAgICAgaWYgKG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gaWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbZWxlbV07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBGYWxsIGJhY2sgb24gZ2V0RWxlbWVudHNCeU5hbWUKICAgICAgICAgICAgICBlbGVtcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUoaWQpOwogICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgIHdoaWxlIChlbGVtID0gZWxlbXNbaSsrXSkgewogICAgICAgICAgICAgICAgbm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKICAgICAgICAgICAgICAgIGlmIChub2RlICYmIG5vZGUudmFsdWUgPT09IGlkKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBbZWxlbV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CgogICAgICAvLyBUYWcKICAgICAgRXhwci5maW5kLlRBRyA9IGZ1bmN0aW9uICh0YWcsIGNvbnRleHQpIHsKICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICByZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoKICAgICAgICAgIC8vIERvY3VtZW50RnJhZ21lbnQgbm9kZXMgZG9uJ3QgaGF2ZSBnRUJUTgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHRhZyk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgLy8gQ2xhc3MKICAgICAgRXhwci5maW5kLkNMQVNTID0gZnVuY3Rpb24gKGNsYXNzTmFtZSwgY29udGV4dCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIC8qIFFTQS9tYXRjaGVzU2VsZWN0b3IKICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKICAgICAgLy8gUVNBIGFuZCBtYXRjaGVzU2VsZWN0b3Igc3VwcG9ydAoKICAgICAgcmJ1Z2d5UVNBID0gW107CgogICAgICAvLyBCdWlsZCBRU0EgcmVnZXgKICAgICAgLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQogICAgICBhc3NlcnQoZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgdmFyIGlucHV0OwogICAgICAgIGRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZChlbCkuaW5uZXJIVE1MID0gIjxhIGlkPSciICsgZXhwYW5kbyArICInIGhyZWY9JycgZGlzYWJsZWQ9J2Rpc2FibGVkJz48L2E+IiArICI8c2VsZWN0IGlkPSciICsgZXhwYW5kbyArICItXHJcXCcgZGlzYWJsZWQ9J2Rpc2FibGVkJz4iICsgIjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCiAgICAgICAgLy8gU3VwcG9ydDogaU9TIDw9NyAtIDggb25seQogICAgICAgIC8vIEJvb2xlYW4gYXR0cmlidXRlcyBhbmQgInZhbHVlIiBhcmUgbm90IHRyZWF0ZWQgY29ycmVjdGx5IGluIHNvbWUgWE1MIGRvY3VtZW50cwogICAgICAgIGlmICghZWwucXVlcnlTZWxlY3RvckFsbCgiW3NlbGVjdGVkXSIpLmxlbmd0aCkgewogICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooPzp2YWx1ZXwiICsgYm9vbGVhbnMgKyAiKSIpOwogICAgICAgIH0KCiAgICAgICAgLy8gU3VwcG9ydDogaU9TIDw9NyAtIDggb25seQogICAgICAgIGlmICghZWwucXVlcnlTZWxlY3RvckFsbCgiW2lkfj0iICsgZXhwYW5kbyArICItXSIpLmxlbmd0aCkgewogICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIn49Iik7CiAgICAgICAgfQoKICAgICAgICAvLyBTdXBwb3J0OiBpT1MgOCBvbmx5CiAgICAgICAgLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNjg1MQogICAgICAgIC8vIEluLXBhZ2UgYHNlbGVjdG9yI2lkIHNpYmxpbmctY29tYmluYXRvciBzZWxlY3RvcmAgZmFpbHMKICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoImEjIiArIGV4cGFuZG8gKyAiKyoiKS5sZW5ndGgpIHsKICAgICAgICAgIHJidWdneVFTQS5wdXNoKCIuIy4rWyt+XSIpOwogICAgICAgIH0KCiAgICAgICAgLy8gU3VwcG9ydDogQ2hyb21lIDw9MTA1KywgRmlyZWZveCA8PTEwNCssIFNhZmFyaSA8PTE1LjQrCiAgICAgICAgLy8gSW4gc29tZSBvZiB0aGUgZG9jdW1lbnQga2luZHMsIHRoZXNlIHNlbGVjdG9ycyB3b3VsZG4ndCB3b3JrIG5hdGl2ZWx5LgogICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgT0sgYnV0IGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3ZSB3YW50IHRvIG1haW50YWluCiAgICAgICAgLy8gaGFuZGxpbmcgdGhlbSB0aHJvdWdoIGpRdWVyeSB0cmF2ZXJzYWwgaW4galF1ZXJ5IDMueC4KICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIjpjaGVja2VkIikubGVuZ3RoKSB7CiAgICAgICAgICByYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKICAgICAgICB9CgogICAgICAgIC8vIFN1cHBvcnQ6IFdpbmRvd3MgOCBOYXRpdmUgQXBwcwogICAgICAgIC8vIFRoZSB0eXBlIGFuZCBuYW1lIGF0dHJpYnV0ZXMgYXJlIHJlc3RyaWN0ZWQgZHVyaW5nIC5pbm5lckhUTUwgYXNzaWdubWVudAogICAgICAgIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAiaGlkZGVuIik7CiAgICAgICAgZWwuYXBwZW5kQ2hpbGQoaW5wdXQpLnNldEF0dHJpYnV0ZSgibmFtZSIsICJEIik7CgogICAgICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSsKICAgICAgICAvLyBJRSdzIDpkaXNhYmxlZCBzZWxlY3RvciBkb2VzIG5vdCBwaWNrIHVwIHRoZSBjaGlsZHJlbiBvZiBkaXNhYmxlZCBmaWVsZHNldHMKICAgICAgICAvLyBTdXBwb3J0OiBDaHJvbWUgPD0xMDUrLCBGaXJlZm94IDw9MTA0KywgU2FmYXJpIDw9MTUuNCsKICAgICAgICAvLyBJbiBzb21lIG9mIHRoZSBkb2N1bWVudCBraW5kcywgdGhlc2Ugc2VsZWN0b3JzIHdvdWxkbid0IHdvcmsgbmF0aXZlbHkuCiAgICAgICAgLy8gVGhpcyBpcyBwcm9iYWJseSBPSyBidXQgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdlIHdhbnQgdG8gbWFpbnRhaW4KICAgICAgICAvLyBoYW5kbGluZyB0aGVtIHRocm91Z2ggalF1ZXJ5IHRyYXZlcnNhbCBpbiBqUXVlcnkgMy54LgogICAgICAgIGRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZChlbCkuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIGlmIChlbC5xdWVyeVNlbGVjdG9yQWxsKCI6ZGlzYWJsZWQiKS5sZW5ndGggIT09IDIpIHsKICAgICAgICAgIHJidWdneVFTQS5wdXNoKCI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiKTsKICAgICAgICB9CgogICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNSAtIDE4KwogICAgICAgIC8vIElFIDExL0VkZ2UgZG9uJ3QgZmluZCBlbGVtZW50cyBvbiBhIGBbbmFtZT0nJ11gIHF1ZXJ5IGluIHNvbWUgY2FzZXMuCiAgICAgICAgLy8gQWRkaW5nIGEgdGVtcG9yYXJ5IGF0dHJpYnV0ZSB0byB0aGUgZG9jdW1lbnQgYmVmb3JlIHRoZSBzZWxlY3Rpb24gd29ya3MKICAgICAgICAvLyBhcm91bmQgdGhlIGlzc3VlLgogICAgICAgIC8vIEludGVyZXN0aW5nbHksIElFIDEwICYgb2xkZXIgZG9uJ3Qgc2VlbSB0byBoYXZlIHRoZSBpc3N1ZS4KICAgICAgICBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCJuYW1lIiwgIiIpOwogICAgICAgIGVsLmFwcGVuZENoaWxkKGlucHV0KTsKICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIltuYW1lPScnXSIpLmxlbmd0aCkgewogICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIlxcWyIgKyB3aGl0ZXNwYWNlICsgIipuYW1lIiArIHdoaXRlc3BhY2UgKyAiKj0iICsgd2hpdGVzcGFjZSArICIqKD86Jyd8XCJcIikiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBpZiAoIXN1cHBvcnQuY3NzSGFzKSB7CiAgICAgICAgLy8gU3VwcG9ydDogQ2hyb21lIDEwNSAtIDExMCssIFNhZmFyaSAxNS40IC0gMTYuMysKICAgICAgICAvLyBPdXIgcmVndWxhciBgdHJ5LWNhdGNoYCBtZWNoYW5pc20gZmFpbHMgdG8gZGV0ZWN0IG5hdGl2ZWx5LXVuc3VwcG9ydGVkCiAgICAgICAgLy8gcHNldWRvLWNsYXNzZXMgaW5zaWRlIGA6aGFzKClgIChzdWNoIGFzIGA6aGFzKDpjb250YWlucygiRm9vIikpYCkKICAgICAgICAvLyBpbiBicm93c2VycyB0aGF0IHBhcnNlIHRoZSBgOmhhcygpYCBhcmd1bWVudCBhcyBhIGZvcmdpdmluZyBzZWxlY3RvciBsaXN0LgogICAgICAgIC8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9zZWxlY3RvcnMvI3JlbGF0aW9uYWwgbm93IHJlcXVpcmVzIHRoZSBhcmd1bWVudAogICAgICAgIC8vIHRvIGJlIHBhcnNlZCB1bmZvcmdpdmluZ2x5LCBidXQgYnJvd3NlcnMgaGF2ZSBub3QgeWV0IGZ1bGx5IGFkanVzdGVkLgogICAgICAgIHJidWdneVFTQS5wdXNoKCI6aGFzIik7CiAgICAgIH0KICAgICAgcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKHJidWdneVFTQS5qb2luKCJ8IikpOwoKICAgICAgLyogU29ydGluZwogICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgogICAgICAvLyBEb2N1bWVudCBvcmRlciBzb3J0aW5nCiAgICAgIHNvcnRPcmRlciA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgLy8gRmxhZyBmb3IgZHVwbGljYXRlIHJlbW92YWwKICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgLy8gU29ydCBvbiBtZXRob2QgZXhpc3RlbmNlIGlmIG9ubHkgb25lIGlucHV0IGhhcyBjb21wYXJlRG9jdW1lbnRQb3NpdGlvbgogICAgICAgIHZhciBjb21wYXJlID0gIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gLSAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbjsKICAgICAgICBpZiAoY29tcGFyZSkgewogICAgICAgICAgcmV0dXJuIGNvbXBhcmU7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUgcG9zaXRpb24gaWYgYm90aCBpbnB1dHMgYmVsb25nIHRvIHRoZSBzYW1lIGRvY3VtZW50CiAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgY29tcGFyZSA9IChhLm93bmVyRG9jdW1lbnQgfHwgYSkgPT0gKGIub3duZXJEb2N1bWVudCB8fCBiKSA/IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgOgogICAgICAgIC8vIE90aGVyd2lzZSB3ZSBrbm93IHRoZXkgYXJlIGRpc2Nvbm5lY3RlZAogICAgICAgIDE7CgogICAgICAgIC8vIERpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgIGlmIChjb21wYXJlICYgMSB8fCAhc3VwcG9ydC5zb3J0RGV0YWNoZWQgJiYgYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihhKSA9PT0gY29tcGFyZSkgewogICAgICAgICAgLy8gQ2hvb3NlIHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgaXMgcmVsYXRlZCB0byBvdXIgcHJlZmVycmVkIGRvY3VtZW50CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgICAgIGlmIChhID09PSBkb2N1bWVudCB8fCBhLm93bmVyRG9jdW1lbnQgPT0gcHJlZmVycmVkRG9jICYmIGZpbmQuY29udGFpbnMocHJlZmVycmVkRG9jLCBhKSkgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgICBpZiAoYiA9PT0gZG9jdW1lbnQgfHwgYi5vd25lckRvY3VtZW50ID09IHByZWZlcnJlZERvYyAmJiBmaW5kLmNvbnRhaW5zKHByZWZlcnJlZERvYywgYikpIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXIKICAgICAgICAgIHJldHVybiBzb3J0SW5wdXQgPyBpbmRleE9mLmNhbGwoc29ydElucHV0LCBhKSAtIGluZGV4T2YuY2FsbChzb3J0SW5wdXQsIGIpIDogMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOwogICAgICB9OwogICAgICByZXR1cm4gZG9jdW1lbnQ7CiAgICB9CiAgICBmaW5kLm1hdGNoZXMgPSBmdW5jdGlvbiAoZXhwciwgZWxlbWVudHMpIHsKICAgICAgcmV0dXJuIGZpbmQoZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMpOwogICAgfTsKICAgIGZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24gKGVsZW0sIGV4cHIpIHsKICAgICAgc2V0RG9jdW1lbnQoZWxlbSk7CiAgICAgIGlmIChkb2N1bWVudElzSFRNTCAmJiAhbm9ubmF0aXZlU2VsZWN0b3JDYWNoZVtleHByICsgIiAiXSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoZXhwcikpKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXQgPSBtYXRjaGVzLmNhbGwoZWxlbSwgZXhwcik7CgogICAgICAgICAgLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgICAgaWYgKHJldCB8fCBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoIHx8CiAgICAgICAgICAvLyBBcyB3ZWxsLCBkaXNjb25uZWN0ZWQgbm9kZXMgYXJlIHNhaWQgdG8gYmUgaW4gYSBkb2N1bWVudAogICAgICAgICAgLy8gZnJhZ21lbnQgaW4gSUUgOQogICAgICAgICAgZWxlbS5kb2N1bWVudCAmJiBlbGVtLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIG5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGUoZXhwciwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmaW5kKGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0pLmxlbmd0aCA+IDA7CiAgICB9OwogICAgZmluZC5jb250YWlucyA9IGZ1bmN0aW9uIChjb250ZXh0LCBlbGVtKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgaWYgKChjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCkgIT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChjb250ZXh0KTsKICAgICAgfQogICAgICByZXR1cm4galF1ZXJ5LmNvbnRhaW5zKGNvbnRleHQsIGVsZW0pOwogICAgfTsKICAgIGZpbmQuYXR0ciA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgaWYgKChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkgIT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChlbGVtKTsKICAgICAgfQogICAgICB2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbbmFtZS50b0xvd2VyQ2FzZSgpXSwKICAgICAgICAvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoc2VlIHRyYWMtMTM4MDcpCiAgICAgICAgdmFsID0gZm4gJiYgaGFzT3duLmNhbGwoRXhwci5hdHRySGFuZGxlLCBuYW1lLnRvTG93ZXJDYXNlKCkpID8gZm4oZWxlbSwgbmFtZSwgIWRvY3VtZW50SXNIVE1MKSA6IHVuZGVmaW5lZDsKICAgICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfQogICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICB9OwogICAgZmluZC5lcnJvciA9IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzCiAgICAgKiBAcGFyYW0ge0FycmF5TGlrZX0gcmVzdWx0cwogICAgICovCiAgICBqUXVlcnkudW5pcXVlU29ydCA9IGZ1bmN0aW9uIChyZXN1bHRzKSB7CiAgICAgIHZhciBlbGVtLAogICAgICAgIGR1cGxpY2F0ZXMgPSBbXSwKICAgICAgICBqID0gMCwKICAgICAgICBpID0gMDsKCiAgICAgIC8vIFVubGVzcyB3ZSAqa25vdyogd2UgY2FuIGRldGVjdCBkdXBsaWNhdGVzLCBhc3N1bWUgdGhlaXIgcHJlc2VuY2UKICAgICAgLy8KICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCsKICAgICAgLy8gVGVzdGluZyBmb3IgZGV0ZWN0aW5nIGR1cGxpY2F0ZXMgaXMgdW5wcmVkaWN0YWJsZSBzbyBpbnN0ZWFkIGFzc3VtZSB3ZSBjYW4ndAogICAgICAvLyBkZXBlbmQgb24gZHVwbGljYXRlIGRldGVjdGlvbiBpbiBhbGwgYnJvd3NlcnMgd2l0aG91dCBhIHN0YWJsZSBzb3J0LgogICAgICBoYXNEdXBsaWNhdGUgPSAhc3VwcG9ydC5zb3J0U3RhYmxlOwogICAgICBzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHNsaWNlLmNhbGwocmVzdWx0cywgMCk7CiAgICAgIHNvcnQuY2FsbChyZXN1bHRzLCBzb3J0T3JkZXIpOwogICAgICBpZiAoaGFzRHVwbGljYXRlKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSByZXN1bHRzW2krK10pIHsKICAgICAgICAgIGlmIChlbGVtID09PSByZXN1bHRzW2ldKSB7CiAgICAgICAgICAgIGogPSBkdXBsaWNhdGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgIHNwbGljZS5jYWxsKHJlc3VsdHMsIGR1cGxpY2F0ZXNbal0sIDEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ2xlYXIgaW5wdXQgYWZ0ZXIgc29ydGluZyB0byByZWxlYXNlIG9iamVjdHMKICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvc2l6emxlL3B1bGwvMjI1CiAgICAgIHNvcnRJbnB1dCA9IG51bGw7CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfTsKICAgIGpRdWVyeS5mbi51bmlxdWVTb3J0ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soalF1ZXJ5LnVuaXF1ZVNvcnQoc2xpY2UuYXBwbHkodGhpcykpKTsKICAgIH07CiAgICBFeHByID0galF1ZXJ5LmV4cHIgPSB7CiAgICAgIC8vIENhbiBiZSBhZGp1c3RlZCBieSB0aGUgdXNlcgogICAgICBjYWNoZUxlbmd0aDogNTAsCiAgICAgIGNyZWF0ZVBzZXVkbzogbWFya0Z1bmN0aW9uLAogICAgICBtYXRjaDogbWF0Y2hFeHByLAogICAgICBhdHRySGFuZGxlOiB7fSwKICAgICAgZmluZDoge30sCiAgICAgIHJlbGF0aXZlOiB7CiAgICAgICAgIj4iOiB7CiAgICAgICAgICBkaXI6ICJwYXJlbnROb2RlIiwKICAgICAgICAgIGZpcnN0OiB0cnVlCiAgICAgICAgfSwKICAgICAgICAiICI6IHsKICAgICAgICAgIGRpcjogInBhcmVudE5vZGUiCiAgICAgICAgfSwKICAgICAgICAiKyI6IHsKICAgICAgICAgIGRpcjogInByZXZpb3VzU2libGluZyIsCiAgICAgICAgICBmaXJzdDogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgIn4iOiB7CiAgICAgICAgICBkaXI6ICJwcmV2aW91c1NpYmxpbmciCiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVGaWx0ZXI6IHsKICAgICAgICBBVFRSOiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgIG1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CgogICAgICAgICAgLy8gTW92ZSB0aGUgZ2l2ZW4gdmFsdWUgdG8gbWF0Y2hbM10gd2hldGhlciBxdW90ZWQgb3IgdW5xdW90ZWQKICAgICAgICAgIG1hdGNoWzNdID0gKG1hdGNoWzNdIHx8IG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICIiKS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIGlmIChtYXRjaFsyXSA9PT0gIn49IikgewogICAgICAgICAgICBtYXRjaFszXSA9ICIgIiArIG1hdGNoWzNdICsgIiAiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoLnNsaWNlKDAsIDQpOwogICAgICAgIH0sCiAgICAgICAgQ0hJTEQ6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgLyogbWF0Y2hlcyBmcm9tIG1hdGNoRXhwclsiQ0hJTEQiXQogICAgICAgICAgCTEgdHlwZSAob25seXxudGh8Li4uKQogICAgICAgICAgCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKICAgICAgICAgIAkzIGFyZ3VtZW50IChldmVufG9kZHxcZCp8XGQqbihbKy1dXGQrKT98Li4uKQogICAgICAgICAgCTQgeG4tY29tcG9uZW50IG9mIHhuK3kgYXJndW1lbnQgKFsrLV0/XGQqbnwpCiAgICAgICAgICAJNSBzaWduIG9mIHhuLWNvbXBvbmVudAogICAgICAgICAgCTYgeCBvZiB4bi1jb21wb25lbnQKICAgICAgICAgIAk3IHNpZ24gb2YgeS1jb21wb25lbnQKICAgICAgICAgIAk4IHkgb2YgeS1jb21wb25lbnQKICAgICAgICAgICovCiAgICAgICAgICBtYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAobWF0Y2hbMV0uc2xpY2UoMCwgMykgPT09ICJudGgiKSB7CiAgICAgICAgICAgIC8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CiAgICAgICAgICAgIGlmICghbWF0Y2hbM10pIHsKICAgICAgICAgICAgICBmaW5kLmVycm9yKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECiAgICAgICAgICAgIC8vIHJlbWVtYmVyIHRoYXQgZmFsc2UvdHJ1ZSBjYXN0IHJlc3BlY3RpdmVseSB0byAwLzEKICAgICAgICAgICAgbWF0Y2hbNF0gPSArKG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKG1hdGNoWzNdID09PSAiZXZlbiIgfHwgbWF0Y2hbM10gPT09ICJvZGQiKSk7CiAgICAgICAgICAgIG1hdGNoWzVdID0gKyhtYXRjaFs3XSArIG1hdGNoWzhdIHx8IG1hdGNoWzNdID09PSAib2RkIik7CgogICAgICAgICAgICAvLyBvdGhlciB0eXBlcyBwcm9oaWJpdCBhcmd1bWVudHMKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbM10pIHsKICAgICAgICAgICAgZmluZC5lcnJvcihtYXRjaFswXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfSwKICAgICAgICBQU0VVRE86IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgdmFyIGV4Y2VzcywKICAgICAgICAgICAgdW5xdW90ZWQgPSAhbWF0Y2hbNl0gJiYgbWF0Y2hbMl07CiAgICAgICAgICBpZiAobWF0Y2hFeHByLkNISUxELnRlc3QobWF0Y2hbMF0pKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEFjY2VwdCBxdW90ZWQgYXJndW1lbnRzIGFzLWlzCiAgICAgICAgICBpZiAobWF0Y2hbM10pIHsKICAgICAgICAgICAgbWF0Y2hbMl0gPSBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIjsKCiAgICAgICAgICAgIC8vIFN0cmlwIGV4Y2VzcyBjaGFyYWN0ZXJzIGZyb20gdW5xdW90ZWQgYXJndW1lbnRzCiAgICAgICAgICB9IGVsc2UgaWYgKHVucXVvdGVkICYmIHJwc2V1ZG8udGVzdCh1bnF1b3RlZCkgJiYgKAogICAgICAgICAgLy8gR2V0IGV4Y2VzcyBmcm9tIHRva2VuaXplIChyZWN1cnNpdmVseSkKICAgICAgICAgIGV4Y2VzcyA9IHRva2VuaXplKHVucXVvdGVkLCB0cnVlKSkgJiYgKAogICAgICAgICAgLy8gYWR2YW5jZSB0byB0aGUgbmV4dCBjbG9zaW5nIHBhcmVudGhlc2lzCiAgICAgICAgICBleGNlc3MgPSB1bnF1b3RlZC5pbmRleE9mKCIpIiwgdW5xdW90ZWQubGVuZ3RoIC0gZXhjZXNzKSAtIHVucXVvdGVkLmxlbmd0aCkpIHsKICAgICAgICAgICAgLy8gZXhjZXNzIGlzIGEgbmVnYXRpdmUgaW5kZXgKICAgICAgICAgICAgbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSgwLCBleGNlc3MpOwogICAgICAgICAgICBtYXRjaFsyXSA9IHVucXVvdGVkLnNsaWNlKDAsIGV4Y2Vzcyk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUmV0dXJuIG9ubHkgY2FwdHVyZXMgbmVlZGVkIGJ5IHRoZSBwc2V1ZG8gZmlsdGVyIG1ldGhvZCAodHlwZSBhbmQgYXJndW1lbnQpCiAgICAgICAgICByZXR1cm4gbWF0Y2guc2xpY2UoMCwgMyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmaWx0ZXI6IHsKICAgICAgICBUQUc6IGZ1bmN0aW9uIChub2RlTmFtZVNlbGVjdG9yKSB7CiAgICAgICAgICB2YXIgZXhwZWN0ZWROb2RlTmFtZSA9IG5vZGVOYW1lU2VsZWN0b3IucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZVNlbGVjdG9yID09PSAiKiIgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSA6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlTmFtZShlbGVtLCBleHBlY3RlZE5vZGVOYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBDTEFTUzogZnVuY3Rpb24gKGNsYXNzTmFtZSkgewogICAgICAgICAgdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlW2NsYXNzTmFtZSArICIgIl07CiAgICAgICAgICByZXR1cm4gcGF0dGVybiB8fCAocGF0dGVybiA9IG5ldyBSZWdFeHAoIihefCIgKyB3aGl0ZXNwYWNlICsgIikiICsgY2xhc3NOYW1lICsgIigiICsgd2hpdGVzcGFjZSArICJ8JCkiKSkgJiYgY2xhc3NDYWNoZShjbGFzc05hbWUsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBwYXR0ZXJuLnRlc3QodHlwZW9mIGVsZW0uY2xhc3NOYW1lID09PSAic3RyaW5nIiAmJiBlbGVtLmNsYXNzTmFtZSB8fCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09ICJ1bmRlZmluZWQiICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgQVRUUjogZnVuY3Rpb24gKG5hbWUsIG9wZXJhdG9yLCBjaGVjaykgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBmaW5kLmF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBvcGVyYXRvciA9PT0gIiE9IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW9wZXJhdG9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ICs9ICIiOwogICAgICAgICAgICBpZiAob3BlcmF0b3IgPT09ICI9IikgewogICAgICAgICAgICAgIHJldHVybiByZXN1bHQgPT09IGNoZWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PT0gIiE9IikgewogICAgICAgICAgICAgIHJldHVybiByZXN1bHQgIT09IGNoZWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PT0gIl49IikgewogICAgICAgICAgICAgIHJldHVybiBjaGVjayAmJiByZXN1bHQuaW5kZXhPZihjaGVjaykgPT09IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wZXJhdG9yID09PSAiKj0iKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKGNoZWNrKSA+IC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PT0gIiQ9IikgewogICAgICAgICAgICAgIHJldHVybiBjaGVjayAmJiByZXN1bHQuc2xpY2UoLWNoZWNrLmxlbmd0aCkgPT09IGNoZWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PT0gIn49IikgewogICAgICAgICAgICAgIHJldHVybiAoIiAiICsgcmVzdWx0LnJlcGxhY2UocndoaXRlc3BhY2UsICIgIikgKyAiICIpLmluZGV4T2YoY2hlY2spID4gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wZXJhdG9yID09PSAifD0iKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gY2hlY2sgfHwgcmVzdWx0LnNsaWNlKDAsIGNoZWNrLmxlbmd0aCArIDEpID09PSBjaGVjayArICItIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgQ0hJTEQ6IGZ1bmN0aW9uICh0eXBlLCB3aGF0LCBfYXJndW1lbnQsIGZpcnN0LCBsYXN0KSB7CiAgICAgICAgICB2YXIgc2ltcGxlID0gdHlwZS5zbGljZSgwLCAzKSAhPT0gIm50aCIsCiAgICAgICAgICAgIGZvcndhcmQgPSB0eXBlLnNsaWNlKC00KSAhPT0gImxhc3QiLAogICAgICAgICAgICBvZlR5cGUgPSB3aGF0ID09PSAib2YtdHlwZSI7CiAgICAgICAgICByZXR1cm4gZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCA/CiAgICAgICAgICAvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pCiAgICAgICAgICBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gISFlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGVsZW0sIF9jb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgdmFyIGNhY2hlLAogICAgICAgICAgICAgIG91dGVyQ2FjaGUsCiAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICBub2RlSW5kZXgsCiAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLAogICAgICAgICAgICAgIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZSwKICAgICAgICAgICAgICBuYW1lID0gb2ZUeXBlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICB1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZSwKICAgICAgICAgICAgICBkaWZmID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAvLyA6KGZpcnN0fGxhc3R8b25seSktKGNoaWxkfG9mLXR5cGUpCiAgICAgICAgICAgICAgaWYgKHNpbXBsZSkgewogICAgICAgICAgICAgICAgd2hpbGUgKGRpcikgewogICAgICAgICAgICAgICAgICBub2RlID0gZWxlbTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSBub2RlW2Rpcl0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2ZUeXBlID8gbm9kZU5hbWUobm9kZSwgbmFtZSkgOiBub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBSZXZlcnNlIGRpcmVjdGlvbiBmb3IgOm9ubHktKiAoaWYgd2UgaGF2ZW4ndCB5ZXQgZG9uZSBzbykKICAgICAgICAgICAgICAgICAgc3RhcnQgPSBkaXIgPSB0eXBlID09PSAib25seSIgJiYgIXN0YXJ0ICYmICJuZXh0U2libGluZyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhcnQgPSBbZm9yd2FyZCA/IHBhcmVudC5maXJzdENoaWxkIDogcGFyZW50Lmxhc3RDaGlsZF07CgogICAgICAgICAgICAgIC8vIG5vbi14bWwgOm50aC1jaGlsZCguLi4pIHN0b3JlcyBjYWNoZSBkYXRhIG9uIGBwYXJlbnRgCiAgICAgICAgICAgICAgaWYgKGZvcndhcmQgJiYgdXNlQ2FjaGUpIHsKICAgICAgICAgICAgICAgIC8vIFNlZWsgYGVsZW1gIGZyb20gYSBwcmV2aW91c2x5LWNhY2hlZCBpbmRleAogICAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IHBhcmVudFtleHBhbmRvXSB8fCAocGFyZW50W2V4cGFuZG9dID0ge30pOwogICAgICAgICAgICAgICAgY2FjaGUgPSBvdXRlckNhY2hlW3R5cGVdIHx8IFtdOwogICAgICAgICAgICAgICAgbm9kZUluZGV4ID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMV07CiAgICAgICAgICAgICAgICBkaWZmID0gbm9kZUluZGV4ICYmIGNhY2hlWzJdOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1tub2RlSW5kZXhdOwogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbZGlyXSB8fCAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBzZWVraW5nIGBlbGVtYCBmcm9tIHRoZSBzdGFydAogICAgICAgICAgICAgICAgZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSB7CiAgICAgICAgICAgICAgICAgIC8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCiAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxICYmICsrZGlmZiAmJiBub2RlID09PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0ZXJDYWNoZVt0eXBlXSA9IFtkaXJydW5zLCBub2RlSW5kZXgsIGRpZmZdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgKHVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAgIG91dGVyQ2FjaGUgPSBlbGVtW2V4cGFuZG9dIHx8IChlbGVtW2V4cGFuZG9dID0ge30pOwogICAgICAgICAgICAgICAgICBjYWNoZSA9IG91dGVyQ2FjaGVbdHlwZV0gfHwgW107CiAgICAgICAgICAgICAgICAgIG5vZGVJbmRleCA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzFdOwogICAgICAgICAgICAgICAgICBkaWZmID0gbm9kZUluZGV4OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHhtbCA6bnRoLWNoaWxkKC4uLikKICAgICAgICAgICAgICAgIC8vIG9yIDpudGgtbGFzdC1jaGlsZCguLi4pIG9yIDpudGgoLWxhc3QpPy1vZi10eXBlKC4uLikKICAgICAgICAgICAgICAgIGlmIChkaWZmID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIHNhbWUgbG9vcCBhcyBhYm92ZSB0byBzZWVrIGBlbGVtYCBmcm9tIHRoZSBzdGFydAogICAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVtkaXJdIHx8IChkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKG9mVHlwZSA/IG5vZGVOYW1lKG5vZGUsIG5hbWUpIDogbm9kZS5ub2RlVHlwZSA9PT0gMSkgJiYgKytkaWZmKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBDYWNoZSB0aGUgaW5kZXggb2YgZWFjaCBlbmNvdW50ZXJlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IG5vZGVbZXhwYW5kb10gfHwgKG5vZGVbZXhwYW5kb10gPSB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVbdHlwZV0gPSBbZGlycnVucywgZGlmZl07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIEluY29ycG9yYXRlIHRoZSBvZmZzZXQsIHRoZW4gY2hlY2sgYWdhaW5zdCBjeWNsZSBzaXplCiAgICAgICAgICAgICAgZGlmZiAtPSBsYXN0OwogICAgICAgICAgICAgIHJldHVybiBkaWZmID09PSBmaXJzdCB8fCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBQU0VVRE86IGZ1bmN0aW9uIChwc2V1ZG8sIGFyZ3VtZW50KSB7CiAgICAgICAgICAvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUKICAgICAgICAgIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI3BzZXVkby1jbGFzc2VzCiAgICAgICAgICAvLyBQcmlvcml0aXplIGJ5IGNhc2Ugc2Vuc2l0aXZpdHkgaW4gY2FzZSBjdXN0b20gcHNldWRvcyBhcmUgYWRkZWQgd2l0aCB1cHBlcmNhc2UgbGV0dGVycwogICAgICAgICAgLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwogICAgICAgICAgdmFyIGFyZ3MsCiAgICAgICAgICAgIGZuID0gRXhwci5wc2V1ZG9zW3BzZXVkb10gfHwgRXhwci5zZXRGaWx0ZXJzW3BzZXVkby50b0xvd2VyQ2FzZSgpXSB8fCBmaW5kLmVycm9yKCJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBwc2V1ZG8pOwoKICAgICAgICAgIC8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKICAgICAgICAgIC8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgICAgICAvLyBqdXN0IGFzIGpRdWVyeSBkb2VzCiAgICAgICAgICBpZiAoZm5bZXhwYW5kb10pIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3VtZW50KTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBCdXQgbWFpbnRhaW4gc3VwcG9ydCBmb3Igb2xkIHNpZ25hdHVyZXMKICAgICAgICAgIGlmIChmbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGFyZ3MgPSBbcHNldWRvLCBwc2V1ZG8sICIiLCBhcmd1bWVudF07CiAgICAgICAgICAgIHJldHVybiBFeHByLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkocHNldWRvLnRvTG93ZXJDYXNlKCkpID8gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICAgICAgdmFyIGlkeCwKICAgICAgICAgICAgICAgIG1hdGNoZWQgPSBmbihzZWVkLCBhcmd1bWVudCksCiAgICAgICAgICAgICAgICBpID0gbWF0Y2hlZC5sZW5ndGg7CiAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgaWR4ID0gaW5kZXhPZi5jYWxsKHNlZWQsIG1hdGNoZWRbaV0pOwogICAgICAgICAgICAgICAgc2VlZFtpZHhdID0gIShtYXRjaGVzW2lkeF0gPSBtYXRjaGVkW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pIDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gZm4oZWxlbSwgMCwgYXJncyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfQogICAgICB9LAogICAgICBwc2V1ZG9zOiB7CiAgICAgICAgLy8gUG90ZW50aWFsbHkgY29tcGxleCBwc2V1ZG9zCiAgICAgICAgbm90OiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAvLyBUcmltIHRoZSBzZWxlY3RvciBwYXNzZWQgdG8gY29tcGlsZQogICAgICAgICAgLy8gdG8gYXZvaWQgdHJlYXRpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcKICAgICAgICAgIC8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwogICAgICAgICAgdmFyIGlucHV0ID0gW10sCiAgICAgICAgICAgIHJlc3VsdHMgPSBbXSwKICAgICAgICAgICAgbWF0Y2hlciA9IGNvbXBpbGUoc2VsZWN0b3IucmVwbGFjZShydHJpbUNTUywgIiQxIikpOwogICAgICAgICAgcmV0dXJuIG1hdGNoZXJbZXhwYW5kb10gPyBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlZWQsIG1hdGNoZXMsIF9jb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgdmFyIGVsZW0sCiAgICAgICAgICAgICAgdW5tYXRjaGVkID0gbWF0Y2hlcihzZWVkLCBudWxsLCB4bWwsIFtdKSwKICAgICAgICAgICAgICBpID0gc2VlZC5sZW5ndGg7CgogICAgICAgICAgICAvLyBNYXRjaCBlbGVtZW50cyB1bm1hdGNoZWQgYnkgYG1hdGNoZXJgCiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICBpZiAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgewogICAgICAgICAgICAgICAgc2VlZFtpXSA9ICEobWF0Y2hlc1tpXSA9IGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSkgOiBmdW5jdGlvbiAoZWxlbSwgX2NvbnRleHQsIHhtbCkgewogICAgICAgICAgICBpbnB1dFswXSA9IGVsZW07CiAgICAgICAgICAgIG1hdGNoZXIoaW5wdXQsIG51bGwsIHhtbCwgcmVzdWx0cyk7CgogICAgICAgICAgICAvLyBEb24ndCBrZWVwIHRoZSBlbGVtZW50CiAgICAgICAgICAgIC8vIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9zaXp6bGUvaXNzdWVzLzI5OSkKICAgICAgICAgICAgaW5wdXRbMF0gPSBudWxsOwogICAgICAgICAgICByZXR1cm4gIXJlc3VsdHMucG9wKCk7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIGhhczogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBmaW5kKHNlbGVjdG9yLCBlbGVtKS5sZW5ndGggPiAwOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICBjb250YWluczogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gKGVsZW0udGV4dENvbnRlbnQgfHwgalF1ZXJ5LnRleHQoZWxlbSkpLmluZGV4T2YodGV4dCkgPiAtMTsKICAgICAgICAgIH07CiAgICAgICAgfSksCiAgICAgICAgLy8gIldoZXRoZXIgYW4gZWxlbWVudCBpcyByZXByZXNlbnRlZCBieSBhIDpsYW5nKCkgc2VsZWN0b3IKICAgICAgICAvLyBpcyBiYXNlZCBzb2xlbHkgb24gdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZQogICAgICAgIC8vIGJlaW5nIGVxdWFsIHRvIHRoZSBpZGVudGlmaWVyIEMsCiAgICAgICAgLy8gb3IgYmVnaW5uaW5nIHdpdGggdGhlIGlkZW50aWZpZXIgQyBpbW1lZGlhdGVseSBmb2xsb3dlZCBieSAiLSIuCiAgICAgICAgLy8gVGhlIG1hdGNoaW5nIG9mIEMgYWdhaW5zdCB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlIGlzIHBlcmZvcm1lZCBjYXNlLWluc2Vuc2l0aXZlbHkuCiAgICAgICAgLy8gVGhlIGlkZW50aWZpZXIgQyBkb2VzIG5vdCBoYXZlIHRvIGJlIGEgdmFsaWQgbGFuZ3VhZ2UgbmFtZS4iCiAgICAgICAgLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KICAgICAgICBsYW5nOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICAgIC8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKICAgICAgICAgIGlmICghcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICIiKSkgewogICAgICAgICAgICBmaW5kLmVycm9yKCJ1bnN1cHBvcnRlZCBsYW5nOiAiICsgbGFuZyk7CiAgICAgICAgICB9CiAgICAgICAgICBsYW5nID0gbGFuZy5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHZhciBlbGVtTGFuZzsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmIChlbGVtTGFuZyA9IGRvY3VtZW50SXNIVE1MID8gZWxlbS5sYW5nIDogZWxlbS5nZXRBdHRyaWJ1dGUoInhtbDpsYW5nIikgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoImxhbmciKSkgewogICAgICAgICAgICAgICAgZWxlbUxhbmcgPSBlbGVtTGFuZy50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1MYW5nID09PSBsYW5nIHx8IGVsZW1MYW5nLmluZGV4T2YobGFuZyArICItIikgPT09IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlICgoZWxlbSA9IGVsZW0ucGFyZW50Tm9kZSkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgfSksCiAgICAgICAgLy8gTWlzY2VsbGFuZW91cwogICAgICAgIHRhcmdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgICAgICAgcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSgxKSA9PT0gZWxlbS5pZDsKICAgICAgICB9LAogICAgICAgIHJvb3Q6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnRFbGVtZW50OwogICAgICAgIH0sCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiBkb2N1bWVudC5oYXNGb2N1cygpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwogICAgICAgIH0sCiAgICAgICAgLy8gQm9vbGVhbiBwcm9wZXJ0aWVzCiAgICAgICAgZW5hYmxlZDogY3JlYXRlRGlzYWJsZWRQc2V1ZG8oZmFsc2UpLAogICAgICAgIGRpc2FibGVkOiBjcmVhdGVEaXNhYmxlZFBzZXVkbyh0cnVlKSwKICAgICAgICBjaGVja2VkOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCiAgICAgICAgICAvLyBodHRwczovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKICAgICAgICAgIHJldHVybiBub2RlTmFtZShlbGVtLCAiaW5wdXQiKSAmJiAhIWVsZW0uY2hlY2tlZCB8fCBub2RlTmFtZShlbGVtLCAib3B0aW9uIikgJiYgISFlbGVtLnNlbGVjdGVkOwogICAgICAgIH0sCiAgICAgICAgc2VsZWN0ZWQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTExKwogICAgICAgICAgLy8gQWNjZXNzaW5nIHRoZSBzZWxlY3RlZEluZGV4IHByb3BlcnR5CiAgICAgICAgICAvLyBmb3JjZXMgdGhlIGJyb3dzZXIgdG8gdHJlYXQgdGhlIGRlZmF1bHQgb3B0aW9uIGFzCiAgICAgICAgICAvLyBzZWxlY3RlZCB3aGVuIGluIGFuIG9wdGdyb3VwLgogICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLWV4cHJlc3Npb25zCiAgICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CiAgICAgICAgfSwKICAgICAgICAvLyBDb250ZW50cwogICAgICAgIGVtcHR5OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCiAgICAgICAgICAvLyA6ZW1wdHkgaXMgbmVnYXRlZCBieSBlbGVtZW50ICgxKSBvciBjb250ZW50IG5vZGVzICh0ZXh0OiAzOyBjZGF0YTogNDsgZW50aXR5IHJlZjogNSksCiAgICAgICAgICAvLyAgIGJ1dCBub3QgYnkgb3RoZXJzIChjb21tZW50OiA4OyBwcm9jZXNzaW5nIGluc3RydWN0aW9uOiA3OyBldGMuKQogICAgICAgICAgLy8gbm9kZVR5cGUgPCA2IHdvcmtzIGJlY2F1c2UgYXR0cmlidXRlcyAoMikgZG8gbm90IGFwcGVhciBhcyBjaGlsZHJlbgogICAgICAgICAgZm9yIChlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA8IDYpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgcGFyZW50OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuICFFeHByLnBzZXVkb3MuZW1wdHkoZWxlbSk7CiAgICAgICAgfSwKICAgICAgICAvLyBFbGVtZW50L2lucHV0IHR5cGVzCiAgICAgICAgaGVhZGVyOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIHJoZWFkZXIudGVzdChlbGVtLm5vZGVOYW1lKTsKICAgICAgICB9LAogICAgICAgIGlucHV0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIHJpbnB1dHMudGVzdChlbGVtLm5vZGVOYW1lKTsKICAgICAgICB9LAogICAgICAgIGJ1dHRvbjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBub2RlTmFtZShlbGVtLCAiaW5wdXQiKSAmJiBlbGVtLnR5cGUgPT09ICJidXR0b24iIHx8IG5vZGVOYW1lKGVsZW0sICJidXR0b24iKTsKICAgICAgICB9LAogICAgICAgIHRleHQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgYXR0cjsKICAgICAgICAgIHJldHVybiBub2RlTmFtZShlbGVtLCAiaW5wdXQiKSAmJiBlbGVtLnR5cGUgPT09ICJ0ZXh0IiAmJiAoCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8MTAgb25seQogICAgICAgICAgLy8gTmV3IEhUTUw1IGF0dHJpYnV0ZSB2YWx1ZXMgKGUuZy4sICJzZWFyY2giKSBhcHBlYXIKICAgICAgICAgIC8vIHdpdGggZWxlbS50eXBlID09PSAidGV4dCIKICAgICAgICAgIChhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSkgPT0gbnVsbCB8fCBhdHRyLnRvTG93ZXJDYXNlKCkgPT09ICJ0ZXh0Iik7CiAgICAgICAgfSwKICAgICAgICAvLyBQb3NpdGlvbi1pbi1jb2xsZWN0aW9uCiAgICAgICAgZmlyc3Q6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIFswXTsKICAgICAgICB9KSwKICAgICAgICBsYXN0OiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChfbWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBbbGVuZ3RoIC0gMV07CiAgICAgICAgfSksCiAgICAgICAgZXE6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKF9tYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHJldHVybiBbYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudF07CiAgICAgICAgfSksCiAgICAgICAgZXZlbjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgIG9kZDogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBpID0gMTsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgIGx0OiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHZhciBpOwogICAgICAgICAgaWYgKGFyZ3VtZW50IDwgMCkgewogICAgICAgICAgICBpID0gYXJndW1lbnQgKyBsZW5ndGg7CiAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50ID4gbGVuZ3RoKSB7CiAgICAgICAgICAgIGkgPSBsZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpID0gYXJndW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgLS1pID49IDA7KSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KSwKICAgICAgICBndDogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CiAgICAgICAgICBmb3IgKDsgKytpIDwgbGVuZ3RoOykgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSkKICAgICAgfQogICAgfTsKICAgIEV4cHIucHNldWRvcy5udGggPSBFeHByLnBzZXVkb3MuZXE7CgogICAgLy8gQWRkIGJ1dHRvbi9pbnB1dCB0eXBlIHBzZXVkb3MKICAgIGZvciAoaSBpbiB7CiAgICAgIHJhZGlvOiB0cnVlLAogICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgZmlsZTogdHJ1ZSwKICAgICAgcGFzc3dvcmQ6IHRydWUsCiAgICAgIGltYWdlOiB0cnVlCiAgICB9KSB7CiAgICAgIEV4cHIucHNldWRvc1tpXSA9IGNyZWF0ZUlucHV0UHNldWRvKGkpOwogICAgfQogICAgZm9yIChpIGluIHsKICAgICAgc3VibWl0OiB0cnVlLAogICAgICByZXNldDogdHJ1ZQogICAgfSkgewogICAgICBFeHByLnBzZXVkb3NbaV0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oaSk7CiAgICB9CgogICAgLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzCiAgICBmdW5jdGlvbiBzZXRGaWx0ZXJzKCkge30KICAgIHNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5maWx0ZXJzID0gRXhwci5wc2V1ZG9zOwogICAgRXhwci5zZXRGaWx0ZXJzID0gbmV3IHNldEZpbHRlcnMoKTsKICAgIGZ1bmN0aW9uIHRva2VuaXplKHNlbGVjdG9yLCBwYXJzZU9ubHkpIHsKICAgICAgdmFyIG1hdGNoZWQsCiAgICAgICAgbWF0Y2gsCiAgICAgICAgdG9rZW5zLAogICAgICAgIHR5cGUsCiAgICAgICAgc29GYXIsCiAgICAgICAgZ3JvdXBzLAogICAgICAgIHByZUZpbHRlcnMsCiAgICAgICAgY2FjaGVkID0gdG9rZW5DYWNoZVtzZWxlY3RvciArICIgIl07CiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICByZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSgwKTsKICAgICAgfQogICAgICBzb0ZhciA9IHNlbGVjdG9yOwogICAgICBncm91cHMgPSBbXTsKICAgICAgcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwogICAgICB3aGlsZSAoc29GYXIpIHsKICAgICAgICAvLyBDb21tYSBhbmQgZmlyc3QgcnVuCiAgICAgICAgaWYgKCFtYXRjaGVkIHx8IChtYXRjaCA9IHJjb21tYS5leGVjKHNvRmFyKSkpIHsKICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAvLyBEb24ndCBjb25zdW1lIHRyYWlsaW5nIGNvbW1hcyBhcyB2YWxpZAogICAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoWzBdLmxlbmd0aCkgfHwgc29GYXI7CiAgICAgICAgICB9CiAgICAgICAgICBncm91cHMucHVzaCh0b2tlbnMgPSBbXSk7CiAgICAgICAgfQogICAgICAgIG1hdGNoZWQgPSBmYWxzZTsKCiAgICAgICAgLy8gQ29tYmluYXRvcnMKICAgICAgICBpZiAobWF0Y2ggPSBybGVhZGluZ0NvbWJpbmF0b3IuZXhlYyhzb0ZhcikpIHsKICAgICAgICAgIG1hdGNoZWQgPSBtYXRjaC5zaGlmdCgpOwogICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICB2YWx1ZTogbWF0Y2hlZCwKICAgICAgICAgICAgLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCiAgICAgICAgICAgIHR5cGU6IG1hdGNoWzBdLnJlcGxhY2UocnRyaW1DU1MsICIgIikKICAgICAgICAgIH0pOwogICAgICAgICAgc29GYXIgPSBzb0Zhci5zbGljZShtYXRjaGVkLmxlbmd0aCk7CiAgICAgICAgfQoKICAgICAgICAvLyBGaWx0ZXJzCiAgICAgICAgZm9yICh0eXBlIGluIEV4cHIuZmlsdGVyKSB7CiAgICAgICAgICBpZiAoKG1hdGNoID0gbWF0Y2hFeHByW3R5cGVdLmV4ZWMoc29GYXIpKSAmJiAoIXByZUZpbHRlcnNbdHlwZV0gfHwgKG1hdGNoID0gcHJlRmlsdGVyc1t0eXBlXShtYXRjaCkpKSkgewogICAgICAgICAgICBtYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgbWF0Y2hlczogbWF0Y2gKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hlZC5sZW5ndGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIW1hdGNoZWQpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmV0dXJuIHRoZSBsZW5ndGggb2YgdGhlIGludmFsaWQgZXhjZXNzCiAgICAgIC8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwogICAgICAvLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yIG9yIHJldHVybiB0b2tlbnMKICAgICAgaWYgKHBhcnNlT25seSkgewogICAgICAgIHJldHVybiBzb0Zhci5sZW5ndGg7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvRmFyID8gZmluZC5lcnJvcihzZWxlY3RvcikgOgogICAgICAvLyBDYWNoZSB0aGUgdG9rZW5zCiAgICAgIHRva2VuQ2FjaGUoc2VsZWN0b3IsIGdyb3Vwcykuc2xpY2UoMCk7CiAgICB9CiAgICBmdW5jdGlvbiB0b1NlbGVjdG9yKHRva2VucykgewogICAgICB2YXIgaSA9IDAsCiAgICAgICAgbGVuID0gdG9rZW5zLmxlbmd0aCwKICAgICAgICBzZWxlY3RvciA9ICIiOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgc2VsZWN0b3IgKz0gdG9rZW5zW2ldLnZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBzZWxlY3RvcjsKICAgIH0KICAgIGZ1bmN0aW9uIGFkZENvbWJpbmF0b3IobWF0Y2hlciwgY29tYmluYXRvciwgYmFzZSkgewogICAgICB2YXIgZGlyID0gY29tYmluYXRvci5kaXIsCiAgICAgICAgc2tpcCA9IGNvbWJpbmF0b3IubmV4dCwKICAgICAgICBrZXkgPSBza2lwIHx8IGRpciwKICAgICAgICBjaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBrZXkgPT09ICJwYXJlbnROb2RlIiwKICAgICAgICBkb25lTmFtZSA9IGRvbmUrKzsKICAgICAgcmV0dXJuIGNvbWJpbmF0b3IuZmlyc3QgPwogICAgICAvLyBDaGVjayBhZ2FpbnN0IGNsb3Nlc3QgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnQKICAgICAgZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgIHdoaWxlIChlbGVtID0gZWxlbVtkaXJdKSB7CiAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSA6CiAgICAgIC8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cwogICAgICBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIG9sZENhY2hlLAogICAgICAgICAgb3V0ZXJDYWNoZSwKICAgICAgICAgIG5ld0NhY2hlID0gW2RpcnJ1bnMsIGRvbmVOYW1lXTsKCiAgICAgICAgLy8gV2UgY2FuJ3Qgc2V0IGFyYml0cmFyeSBkYXRhIG9uIFhNTCBub2Rlcywgc28gdGhleSBkb24ndCBiZW5lZml0IGZyb20gY29tYmluYXRvciBjYWNoaW5nCiAgICAgICAgaWYgKHhtbCkgewogICAgICAgICAgd2hpbGUgKGVsZW0gPSBlbGVtW2Rpcl0pIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cykgewogICAgICAgICAgICAgIGlmIChtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IGVsZW1bZXhwYW5kb10gfHwgKGVsZW1bZXhwYW5kb10gPSB7fSk7CiAgICAgICAgICAgICAgaWYgKHNraXAgJiYgbm9kZU5hbWUoZWxlbSwgc2tpcCkpIHsKICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtW2Rpcl0gfHwgZWxlbTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKChvbGRDYWNoZSA9IG91dGVyQ2FjaGVba2V5XSkgJiYgb2xkQ2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgb2xkQ2FjaGVbMV0gPT09IGRvbmVOYW1lKSB7CiAgICAgICAgICAgICAgICAvLyBBc3NpZ24gdG8gbmV3Q2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwogICAgICAgICAgICAgICAgcmV0dXJuIG5ld0NhY2hlWzJdID0gb2xkQ2FjaGVbMl07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJldXNlIG5ld2NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVba2V5XSA9IG5ld0NhY2hlOwoKICAgICAgICAgICAgICAgIC8vIEEgbWF0Y2ggbWVhbnMgd2UncmUgZG9uZTsgYSBmYWlsIG1lYW5zIHdlIGhhdmUgdG8ga2VlcCBjaGVja2luZwogICAgICAgICAgICAgICAgaWYgKG5ld0NhY2hlWzJdID0gbWF0Y2hlcihlbGVtLCBjb250ZXh0LCB4bWwpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycykgewogICAgICByZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/IGZ1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBpZiAoIW1hdGNoZXJzW2ldKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSA6IG1hdGNoZXJzWzBdOwogICAgfQogICAgZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyhzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMpIHsKICAgICAgdmFyIGkgPSAwLAogICAgICAgIGxlbiA9IGNvbnRleHRzLmxlbmd0aDsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGZpbmQoc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KICAgIGZ1bmN0aW9uIGNvbmRlbnNlKHVubWF0Y2hlZCwgbWFwLCBmaWx0ZXIsIGNvbnRleHQsIHhtbCkgewogICAgICB2YXIgZWxlbSwKICAgICAgICBuZXdVbm1hdGNoZWQgPSBbXSwKICAgICAgICBpID0gMCwKICAgICAgICBsZW4gPSB1bm1hdGNoZWQubGVuZ3RoLAogICAgICAgIG1hcHBlZCA9IG1hcCAhPSBudWxsOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGVsZW0gPSB1bm1hdGNoZWRbaV0pIHsKICAgICAgICAgIGlmICghZmlsdGVyIHx8IGZpbHRlcihlbGVtLCBjb250ZXh0LCB4bWwpKSB7CiAgICAgICAgICAgIG5ld1VubWF0Y2hlZC5wdXNoKGVsZW0pOwogICAgICAgICAgICBpZiAobWFwcGVkKSB7CiAgICAgICAgICAgICAgbWFwLnB1c2goaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG5ld1VubWF0Y2hlZDsKICAgIH0KICAgIGZ1bmN0aW9uIHNldE1hdGNoZXIocHJlRmlsdGVyLCBzZWxlY3RvciwgbWF0Y2hlciwgcG9zdEZpbHRlciwgcG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yKSB7CiAgICAgIGlmIChwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyW2V4cGFuZG9dKSB7CiAgICAgICAgcG9zdEZpbHRlciA9IHNldE1hdGNoZXIocG9zdEZpbHRlcik7CiAgICAgIH0KICAgICAgaWYgKHBvc3RGaW5kZXIgJiYgIXBvc3RGaW5kZXJbZXhwYW5kb10pIHsKICAgICAgICBwb3N0RmluZGVyID0gc2V0TWF0Y2hlcihwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IpOwogICAgICB9CiAgICAgIHJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlZWQsIHJlc3VsdHMsIGNvbnRleHQsIHhtbCkgewogICAgICAgIHZhciB0ZW1wLAogICAgICAgICAgaSwKICAgICAgICAgIGVsZW0sCiAgICAgICAgICBtYXRjaGVyT3V0LAogICAgICAgICAgcHJlTWFwID0gW10sCiAgICAgICAgICBwb3N0TWFwID0gW10sCiAgICAgICAgICBwcmVleGlzdGluZyA9IHJlc3VsdHMubGVuZ3RoLAogICAgICAgICAgLy8gR2V0IGluaXRpYWwgZWxlbWVudHMgZnJvbSBzZWVkIG9yIGNvbnRleHQKICAgICAgICAgIGVsZW1zID0gc2VlZCB8fCBtdWx0aXBsZUNvbnRleHRzKHNlbGVjdG9yIHx8ICIqIiwgY29udGV4dC5ub2RlVHlwZSA/IFtjb250ZXh0XSA6IGNvbnRleHQsIFtdKSwKICAgICAgICAgIC8vIFByZWZpbHRlciB0byBnZXQgbWF0Y2hlciBpbnB1dCwgcHJlc2VydmluZyBhIG1hcCBmb3Igc2VlZC1yZXN1bHRzIHN5bmNocm9uaXphdGlvbgogICAgICAgICAgbWF0Y2hlckluID0gcHJlRmlsdGVyICYmIChzZWVkIHx8ICFzZWxlY3RvcikgPyBjb25kZW5zZShlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCkgOiBlbGVtczsKICAgICAgICBpZiAobWF0Y2hlcikgewogICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIHBvc3RGaW5kZXIsIG9yIGZpbHRlcmVkIHNlZWQsIG9yIG5vbi1zZWVkIHBvc3RGaWx0ZXIKICAgICAgICAgIC8vIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsCiAgICAgICAgICBtYXRjaGVyT3V0ID0gcG9zdEZpbmRlciB8fCAoc2VlZCA/IHByZUZpbHRlciA6IHByZWV4aXN0aW5nIHx8IHBvc3RGaWx0ZXIpID8KICAgICAgICAgIC8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQogICAgICAgICAgW10gOgogICAgICAgICAgLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5CiAgICAgICAgICByZXN1bHRzOwoKICAgICAgICAgIC8vIEZpbmQgcHJpbWFyeSBtYXRjaGVzCiAgICAgICAgICBtYXRjaGVyKG1hdGNoZXJJbiwgbWF0Y2hlck91dCwgY29udGV4dCwgeG1sKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlck91dCA9IG1hdGNoZXJJbjsKICAgICAgICB9CgogICAgICAgIC8vIEFwcGx5IHBvc3RGaWx0ZXIKICAgICAgICBpZiAocG9zdEZpbHRlcikgewogICAgICAgICAgdGVtcCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQsIHBvc3RNYXApOwogICAgICAgICAgcG9zdEZpbHRlcih0ZW1wLCBbXSwgY29udGV4dCwgeG1sKTsKCiAgICAgICAgICAvLyBVbi1tYXRjaCBmYWlsaW5nIGVsZW1lbnRzIGJ5IG1vdmluZyB0aGVtIGJhY2sgdG8gbWF0Y2hlckluCiAgICAgICAgICBpID0gdGVtcC5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIGlmIChlbGVtID0gdGVtcFtpXSkgewogICAgICAgICAgICAgIG1hdGNoZXJPdXRbcG9zdE1hcFtpXV0gPSAhKG1hdGNoZXJJbltwb3N0TWFwW2ldXSA9IGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICBpZiAocG9zdEZpbmRlciB8fCBwcmVGaWx0ZXIpIHsKICAgICAgICAgICAgaWYgKHBvc3RGaW5kZXIpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMKICAgICAgICAgICAgICB0ZW1wID0gW107CiAgICAgICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtID0gbWF0Y2hlck91dFtpXSkgewogICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAogICAgICAgICAgICAgICAgICB0ZW1wLnB1c2gobWF0Y2hlckluW2ldID0gZWxlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBvc3RGaW5kZXIobnVsbCwgbWF0Y2hlck91dCA9IFtdLCB0ZW1wLCB4bWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb3ZlIG1hdGNoZWQgZWxlbWVudHMgZnJvbSBzZWVkIHRvIHJlc3VsdHMgdG8ga2VlcCB0aGVtIHN5bmNocm9uaXplZAogICAgICAgICAgICBpID0gbWF0Y2hlck91dC5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICBpZiAoKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSAmJiAodGVtcCA9IHBvc3RGaW5kZXIgPyBpbmRleE9mLmNhbGwoc2VlZCwgZWxlbSkgOiBwcmVNYXBbaV0pID4gLTEpIHsKICAgICAgICAgICAgICAgIHNlZWRbdGVtcF0gPSAhKHJlc3VsdHNbdGVtcF0gPSBlbGVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlck91dCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPyBtYXRjaGVyT3V0LnNwbGljZShwcmVleGlzdGluZywgbWF0Y2hlck91dC5sZW5ndGgpIDogbWF0Y2hlck91dCk7CiAgICAgICAgICBpZiAocG9zdEZpbmRlcikgewogICAgICAgICAgICBwb3N0RmluZGVyKG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIG1hdGNoZXJPdXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMpIHsKICAgICAgdmFyIGNoZWNrQ29udGV4dCwKICAgICAgICBtYXRjaGVyLAogICAgICAgIGosCiAgICAgICAgbGVuID0gdG9rZW5zLmxlbmd0aCwKICAgICAgICBsZWFkaW5nUmVsYXRpdmUgPSBFeHByLnJlbGF0aXZlW3Rva2Vuc1swXS50eXBlXSwKICAgICAgICBpbXBsaWNpdFJlbGF0aXZlID0gbGVhZGluZ1JlbGF0aXZlIHx8IEV4cHIucmVsYXRpdmVbIiAiXSwKICAgICAgICBpID0gbGVhZGluZ1JlbGF0aXZlID8gMSA6IDAsCiAgICAgICAgLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKICAgICAgICBtYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gY2hlY2tDb250ZXh0OwogICAgICAgIH0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUpLAogICAgICAgIG1hdGNoQW55Q29udGV4dCA9IGFkZENvbWJpbmF0b3IoZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBpbmRleE9mLmNhbGwoY2hlY2tDb250ZXh0LCBlbGVtKSA+IC0xOwogICAgICAgIH0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUpLAogICAgICAgIG1hdGNoZXJzID0gW2Z1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgICAgLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLgogICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICAgICAgdmFyIHJldCA9ICFsZWFkaW5nUmVsYXRpdmUgJiYgKHhtbCB8fCBjb250ZXh0ICE9IG91dGVybW9zdENvbnRleHQpIHx8ICgoY2hlY2tDb250ZXh0ID0gY29udGV4dCkubm9kZVR5cGUgPyBtYXRjaENvbnRleHQoZWxlbSwgY29udGV4dCwgeG1sKSA6IG1hdGNoQW55Q29udGV4dChlbGVtLCBjb250ZXh0LCB4bWwpKTsKCiAgICAgICAgICAvLyBBdm9pZCBoYW5naW5nIG9udG8gZWxlbWVudAogICAgICAgICAgLy8gKHNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L3NpenpsZS9pc3N1ZXMvMjk5KQogICAgICAgICAgY2hlY2tDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfV07CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAobWF0Y2hlciA9IEV4cHIucmVsYXRpdmVbdG9rZW5zW2ldLnR5cGVdKSB7CiAgICAgICAgICBtYXRjaGVycyA9IFthZGRDb21iaW5hdG9yKGVsZW1lbnRNYXRjaGVyKG1hdGNoZXJzKSwgbWF0Y2hlcildOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRjaGVyID0gRXhwci5maWx0ZXJbdG9rZW5zW2ldLnR5cGVdLmFwcGx5KG51bGwsIHRva2Vuc1tpXS5tYXRjaGVzKTsKCiAgICAgICAgICAvLyBSZXR1cm4gc3BlY2lhbCB1cG9uIHNlZWluZyBhIHBvc2l0aW9uYWwgbWF0Y2hlcgogICAgICAgICAgaWYgKG1hdGNoZXJbZXhwYW5kb10pIHsKICAgICAgICAgICAgLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCiAgICAgICAgICAgIGogPSArK2k7CiAgICAgICAgICAgIGZvciAoOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICBpZiAoRXhwci5yZWxhdGl2ZVt0b2tlbnNbal0udHlwZV0pIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2V0TWF0Y2hlcihpID4gMSAmJiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycyksIGkgPiAxICYmIHRvU2VsZWN0b3IoCiAgICAgICAgICAgIC8vIElmIHRoZSBwcmVjZWRpbmcgdG9rZW4gd2FzIGEgZGVzY2VuZGFudCBjb21iaW5hdG9yLCBpbnNlcnQgYW4gaW1wbGljaXQgYW55LWVsZW1lbnQgYCpgCiAgICAgICAgICAgIHRva2Vucy5zbGljZSgwLCBpIC0gMSkuY29uY2F0KHsKICAgICAgICAgICAgICB2YWx1ZTogdG9rZW5zW2kgLSAyXS50eXBlID09PSAiICIgPyAiKiIgOiAiIgogICAgICAgICAgICB9KSkucmVwbGFjZShydHJpbUNTUywgIiQxIiksIG1hdGNoZXIsIGkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKHRva2Vucy5zbGljZShpLCBqKSksIGogPCBsZW4gJiYgbWF0Y2hlckZyb21Ub2tlbnModG9rZW5zID0gdG9rZW5zLnNsaWNlKGopKSwgaiA8IGxlbiAmJiB0b1NlbGVjdG9yKHRva2VucykpOwogICAgICAgICAgfQogICAgICAgICAgbWF0Y2hlcnMucHVzaChtYXRjaGVyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW1lbnRNYXRjaGVyKG1hdGNoZXJzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyhlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzKSB7CiAgICAgIHZhciBieVNldCA9IHNldE1hdGNoZXJzLmxlbmd0aCA+IDAsCiAgICAgICAgYnlFbGVtZW50ID0gZWxlbWVudE1hdGNoZXJzLmxlbmd0aCA+IDAsCiAgICAgICAgc3VwZXJNYXRjaGVyID0gZnVuY3Rpb24gKHNlZWQsIGNvbnRleHQsIHhtbCwgcmVzdWx0cywgb3V0ZXJtb3N0KSB7CiAgICAgICAgICB2YXIgZWxlbSwKICAgICAgICAgICAgaiwKICAgICAgICAgICAgbWF0Y2hlciwKICAgICAgICAgICAgbWF0Y2hlZENvdW50ID0gMCwKICAgICAgICAgICAgaSA9ICIwIiwKICAgICAgICAgICAgdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwKICAgICAgICAgICAgc2V0TWF0Y2hlZCA9IFtdLAogICAgICAgICAgICBjb250ZXh0QmFja3VwID0gb3V0ZXJtb3N0Q29udGV4dCwKICAgICAgICAgICAgLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBvdXRlcm1vc3QgY29udGV4dAogICAgICAgICAgICBlbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZC5UQUcoIioiLCBvdXRlcm1vc3QpLAogICAgICAgICAgICAvLyBVc2UgaW50ZWdlciBkaXJydW5zIGlmZiB0aGlzIGlzIHRoZSBvdXRlcm1vc3QgbWF0Y2hlcgogICAgICAgICAgICBkaXJydW5zVW5pcXVlID0gZGlycnVucyArPSBjb250ZXh0QmFja3VwID09IG51bGwgPyAxIDogTWF0aC5yYW5kb20oKSB8fCAwLjEsCiAgICAgICAgICAgIGxlbiA9IGVsZW1zLmxlbmd0aDsKICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgICAgICAgLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLgogICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgICAgIG91dGVybW9zdENvbnRleHQgPSBjb250ZXh0ID09IGRvY3VtZW50IHx8IGNvbnRleHQgfHwgb3V0ZXJtb3N0OwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEFkZCBlbGVtZW50cyBwYXNzaW5nIGVsZW1lbnRNYXRjaGVycyBkaXJlY3RseSB0byByZXN1bHRzCiAgICAgICAgICAvLyBTdXBwb3J0OiBpT1MgPD03IC0gOSBvbmx5CiAgICAgICAgICAvLyBUb2xlcmF0ZSBOb2RlTGlzdCBwcm9wZXJ0aWVzIChJRTogImxlbmd0aCI7IFNhZmFyaTogPG51bWJlcj4pIG1hdGNoaW5nCiAgICAgICAgICAvLyBlbGVtZW50cyBieSBpZC4gKHNlZSB0cmFjLTE0MTQyKQogICAgICAgICAgZm9yICg7IGkgIT09IGxlbiAmJiAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgaWYgKGJ5RWxlbWVudCAmJiBlbGVtKSB7CiAgICAgICAgICAgICAgaiA9IDA7CgogICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAgICAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgICAgICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICAgICAgICAgIGlmICghY29udGV4dCAmJiBlbGVtLm93bmVyRG9jdW1lbnQgIT0gZG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIHNldERvY3VtZW50KGVsZW0pOwogICAgICAgICAgICAgICAgeG1sID0gIWRvY3VtZW50SXNIVE1MOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcihlbGVtLCBjb250ZXh0IHx8IGRvY3VtZW50LCB4bWwpKSB7CiAgICAgICAgICAgICAgICAgIHB1c2guY2FsbChyZXN1bHRzLCBlbGVtKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycwogICAgICAgICAgICBpZiAoYnlTZXQpIHsKICAgICAgICAgICAgICAvLyBUaGV5IHdpbGwgaGF2ZSBnb25lIHRocm91Z2ggYWxsIHBvc3NpYmxlIG1hdGNoZXJzCiAgICAgICAgICAgICAgaWYgKGVsZW0gPSAhbWF0Y2hlciAmJiBlbGVtKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkQ291bnQtLTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKICAgICAgICAgICAgICBpZiAoc2VlZCkgewogICAgICAgICAgICAgICAgdW5tYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gYGlgIGlzIG5vdyB0aGUgY291bnQgb2YgZWxlbWVudHMgdmlzaXRlZCBhYm92ZSwgYW5kIGFkZGluZyBpdCB0byBgbWF0Y2hlZENvdW50YAogICAgICAgICAgLy8gbWFrZXMgdGhlIGxhdHRlciBub25uZWdhdGl2ZS4KICAgICAgICAgIG1hdGNoZWRDb3VudCArPSBpOwoKICAgICAgICAgIC8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cwogICAgICAgICAgLy8gTk9URTogVGhpcyBjYW4gYmUgc2tpcHBlZCBpZiB0aGVyZSBhcmUgbm8gdW5tYXRjaGVkIGVsZW1lbnRzIChpLmUuLCBgbWF0Y2hlZENvdW50YAogICAgICAgICAgLy8gZXF1YWxzIGBpYCksIHVubGVzcyB3ZSBkaWRuJ3QgdmlzaXQgX2FueV8gZWxlbWVudHMgaW4gdGhlIGFib3ZlIGxvb3AgYmVjYXVzZSB3ZSBoYXZlCiAgICAgICAgICAvLyBubyBlbGVtZW50IG1hdGNoZXJzIGFuZCBubyBzZWVkLgogICAgICAgICAgLy8gSW5jcmVtZW50aW5nIGFuIGluaXRpYWxseS1zdHJpbmcgIjAiIGBpYCBhbGxvd3MgYGlgIHRvIHJlbWFpbiBhIHN0cmluZyBvbmx5IGluIHRoYXQKICAgICAgICAgIC8vIGNhc2UsIHdoaWNoIHdpbGwgcmVzdWx0IGluIGEgIjAwIiBgbWF0Y2hlZENvdW50YCB0aGF0IGRpZmZlcnMgZnJvbSBgaWAgYnV0IGlzIGFsc28KICAgICAgICAgIC8vIG51bWVyaWNhbGx5IHplcm8uCiAgICAgICAgICBpZiAoYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50KSB7CiAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICB3aGlsZSAobWF0Y2hlciA9IHNldE1hdGNoZXJzW2orK10pIHsKICAgICAgICAgICAgICBtYXRjaGVyKHVubWF0Y2hlZCwgc2V0TWF0Y2hlZCwgY29udGV4dCwgeG1sKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2VlZCkgewogICAgICAgICAgICAgIC8vIFJlaW50ZWdyYXRlIGVsZW1lbnQgbWF0Y2hlcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHNvcnRpbmcKICAgICAgICAgICAgICBpZiAobWF0Y2hlZENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgICBpZiAoISh1bm1hdGNoZWRbaV0gfHwgc2V0TWF0Y2hlZFtpXSkpIHsKICAgICAgICAgICAgICAgICAgICBzZXRNYXRjaGVkW2ldID0gcG9wLmNhbGwocmVzdWx0cyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIERpc2NhcmQgaW5kZXggcGxhY2Vob2xkZXIgdmFsdWVzIHRvIGdldCBvbmx5IGFjdHVhbCBtYXRjaGVzCiAgICAgICAgICAgICAgc2V0TWF0Y2hlZCA9IGNvbmRlbnNlKHNldE1hdGNoZWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBZGQgbWF0Y2hlcyB0byByZXN1bHRzCiAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgc2V0TWF0Y2hlZCk7CgogICAgICAgICAgICAvLyBTZWVkbGVzcyBzZXQgbWF0Y2hlcyBzdWNjZWVkaW5nIG11bHRpcGxlIHN1Y2Nlc3NmdWwgbWF0Y2hlcnMgc3RpcHVsYXRlIHNvcnRpbmcKICAgICAgICAgICAgaWYgKG91dGVybW9zdCAmJiAhc2VlZCAmJiBzZXRNYXRjaGVkLmxlbmd0aCA+IDAgJiYgbWF0Y2hlZENvdW50ICsgc2V0TWF0Y2hlcnMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIGpRdWVyeS51bmlxdWVTb3J0KHJlc3VsdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzCiAgICAgICAgICBpZiAob3V0ZXJtb3N0KSB7CiAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1bm1hdGNoZWQ7CiAgICAgICAgfTsKICAgICAgcmV0dXJuIGJ5U2V0ID8gbWFya0Z1bmN0aW9uKHN1cGVyTWF0Y2hlcikgOiBzdXBlck1hdGNoZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjb21waWxlKHNlbGVjdG9yLCBtYXRjaCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLykgewogICAgICB2YXIgaSwKICAgICAgICBzZXRNYXRjaGVycyA9IFtdLAogICAgICAgIGVsZW1lbnRNYXRjaGVycyA9IFtdLAogICAgICAgIGNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbc2VsZWN0b3IgKyAiICJdOwogICAgICBpZiAoIWNhY2hlZCkgewogICAgICAgIC8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAogICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgIG1hdGNoID0gdG9rZW5pemUoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICBpID0gbWF0Y2gubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGNhY2hlZCA9IG1hdGNoZXJGcm9tVG9rZW5zKG1hdGNoW2ldKTsKICAgICAgICAgIGlmIChjYWNoZWRbZXhwYW5kb10pIHsKICAgICAgICAgICAgc2V0TWF0Y2hlcnMucHVzaChjYWNoZWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudE1hdGNoZXJzLnB1c2goY2FjaGVkKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIENhY2hlIHRoZSBjb21waWxlZCBmdW5jdGlvbgogICAgICAgIGNhY2hlZCA9IGNvbXBpbGVyQ2FjaGUoc2VsZWN0b3IsIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyhlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzKSk7CgogICAgICAgIC8vIFNhdmUgc2VsZWN0b3IgYW5kIHRva2VuaXphdGlvbgogICAgICAgIGNhY2hlZC5zZWxlY3RvciA9IHNlbGVjdG9yOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIGxvdy1sZXZlbCBzZWxlY3Rpb24gZnVuY3Rpb24gdGhhdCB3b3JrcyB3aXRoIGpRdWVyeSdzIGNvbXBpbGVkCiAgICAgKiAgc2VsZWN0b3IgZnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZAogICAgICogIHNlbGVjdG9yIGZ1bmN0aW9uIGJ1aWx0IHdpdGggalF1ZXJ5IHNlbGVjdG9yIGNvbXBpbGUKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gY29udGV4dAogICAgICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc2VlZF0gQSBzZXQgb2YgZWxlbWVudHMgdG8gbWF0Y2ggYWdhaW5zdAogICAgICovCiAgICBmdW5jdGlvbiBzZWxlY3Qoc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKICAgICAgdmFyIGksCiAgICAgICAgdG9rZW5zLAogICAgICAgIHRva2VuLAogICAgICAgIHR5cGUsCiAgICAgICAgZmluZCwKICAgICAgICBjb21waWxlZCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIiAmJiBzZWxlY3RvciwKICAgICAgICBtYXRjaCA9ICFzZWVkICYmIHRva2VuaXplKHNlbGVjdG9yID0gY29tcGlsZWQuc2VsZWN0b3IgfHwgc2VsZWN0b3IpOwogICAgICByZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCiAgICAgIC8vIFRyeSB0byBtaW5pbWl6ZSBvcGVyYXRpb25zIGlmIHRoZXJlIGlzIG9ubHkgb25lIHNlbGVjdG9yIGluIHRoZSBsaXN0IGFuZCBubyBzZWVkCiAgICAgIC8vICh0aGUgbGF0dGVyIG9mIHdoaWNoIGd1YXJhbnRlZXMgdXMgY29udGV4dCkKICAgICAgaWYgKG1hdGNoLmxlbmd0aCA9PT0gMSkgewogICAgICAgIC8vIFJlZHVjZSBjb250ZXh0IGlmIHRoZSBsZWFkaW5nIGNvbXBvdW5kIHNlbGVjdG9yIGlzIGFuIElECiAgICAgICAgdG9rZW5zID0gbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSgwKTsKICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDIgJiYgKHRva2VuID0gdG9rZW5zWzBdKS50eXBlID09PSAiSUQiICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgZG9jdW1lbnRJc0hUTUwgJiYgRXhwci5yZWxhdGl2ZVt0b2tlbnNbMV0udHlwZV0pIHsKICAgICAgICAgIGNvbnRleHQgPSAoRXhwci5maW5kLklEKHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIGNvbnRleHQpIHx8IFtdKVswXTsKICAgICAgICAgIGlmICghY29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKCiAgICAgICAgICAgIC8vIFByZWNvbXBpbGVkIG1hdGNoZXJzIHdpbGwgc3RpbGwgdmVyaWZ5IGFuY2VzdHJ5LCBzbyBzdGVwIHVwIGEgbGV2ZWwKICAgICAgICAgIH0gZWxzZSBpZiAoY29tcGlsZWQpIHsKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UodG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoKTsKICAgICAgICB9CgogICAgICAgIC8vIEZldGNoIGEgc2VlZCBzZXQgZm9yIHJpZ2h0LXRvLWxlZnQgbWF0Y2hpbmcKICAgICAgICBpID0gbWF0Y2hFeHByLm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9yKSA/IDAgOiB0b2tlbnMubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIHRva2VuID0gdG9rZW5zW2ldOwoKICAgICAgICAgIC8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKICAgICAgICAgIGlmIChFeHByLnJlbGF0aXZlW3R5cGUgPSB0b2tlbi50eXBlXSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5kID0gRXhwci5maW5kW3R5cGVdKSB7CiAgICAgICAgICAgIC8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwogICAgICAgICAgICBpZiAoc2VlZCA9IGZpbmQodG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgcnNpYmxpbmcudGVzdCh0b2tlbnNbMF0udHlwZSkgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgIC8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQogICAgICAgICAgICAgIHRva2Vucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWVkLmxlbmd0aCAmJiB0b1NlbGVjdG9yKHRva2Vucyk7CiAgICAgICAgICAgICAgaWYgKCFzZWxlY3RvcikgewogICAgICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBzZWVkKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29tcGlsZSBhbmQgZXhlY3V0ZSBhIGZpbHRlcmluZyBmdW5jdGlvbiBpZiBvbmUgaXMgbm90IHByb3ZpZGVkCiAgICAgIC8vIFByb3ZpZGUgYG1hdGNoYCB0byBhdm9pZCByZXRva2VuaXphdGlvbiBpZiB3ZSBtb2RpZmllZCB0aGUgc2VsZWN0b3IgYWJvdmUKICAgICAgKGNvbXBpbGVkIHx8IGNvbXBpbGUoc2VsZWN0b3IsIG1hdGNoKSkoc2VlZCwgY29udGV4dCwgIWRvY3VtZW50SXNIVE1MLCByZXN1bHRzLCAhY29udGV4dCB8fCByc2libGluZy50ZXN0KHNlbGVjdG9yKSAmJiB0ZXN0Q29udGV4dChjb250ZXh0LnBhcmVudE5vZGUpIHx8IGNvbnRleHQpOwogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KCiAgICAvLyBPbmUtdGltZSBhc3NpZ25tZW50cwoKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgLSA0LjErCiAgICAvLyBTb3J0IHN0YWJpbGl0eQogICAgc3VwcG9ydC5zb3J0U3RhYmxlID0gZXhwYW5kby5zcGxpdCgiIikuc29ydChzb3J0T3JkZXIpLmpvaW4oIiIpID09PSBleHBhbmRvOwoKICAgIC8vIEluaXRpYWxpemUgYWdhaW5zdCB0aGUgZGVmYXVsdCBkb2N1bWVudAogICAgc2V0RG9jdW1lbnQoKTsKCiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIC0gNC4xKwogICAgLy8gRGV0YWNoZWQgbm9kZXMgY29uZm91bmRpbmdseSBmb2xsb3cgKmVhY2ggb3RoZXIqCiAgICBzdXBwb3J0LnNvcnREZXRhY2hlZCA9IGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgLy8gU2hvdWxkIHJldHVybiAxLCBidXQgcmV0dXJucyA0IChmb2xsb3dpbmcpCiAgICAgIHJldHVybiBlbC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmaWVsZHNldCIpKSAmIDE7CiAgICB9KTsKICAgIGpRdWVyeS5maW5kID0gZmluZDsKCiAgICAvLyBEZXByZWNhdGVkCiAgICBqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKICAgIGpRdWVyeS51bmlxdWUgPSBqUXVlcnkudW5pcXVlU29ydDsKCiAgICAvLyBUaGVzZSBoYXZlIGFsd2F5cyBiZWVuIHByaXZhdGUsIGJ1dCB0aGV5IHVzZWQgdG8gYmUgZG9jdW1lbnRlZCBhcyBwYXJ0IG9mCiAgICAvLyBTaXp6bGUgc28gbGV0J3MgbWFpbnRhaW4gdGhlbSBmb3Igbm93IGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBwdXJwb3Nlcy4KICAgIGZpbmQuY29tcGlsZSA9IGNvbXBpbGU7CiAgICBmaW5kLnNlbGVjdCA9IHNlbGVjdDsKICAgIGZpbmQuc2V0RG9jdW1lbnQgPSBzZXREb2N1bWVudDsKICAgIGZpbmQudG9rZW5pemUgPSB0b2tlbml6ZTsKICAgIGZpbmQuZXNjYXBlID0galF1ZXJ5LmVzY2FwZVNlbGVjdG9yOwogICAgZmluZC5nZXRUZXh0ID0galF1ZXJ5LnRleHQ7CiAgICBmaW5kLmlzWE1MID0galF1ZXJ5LmlzWE1MRG9jOwogICAgZmluZC5zZWxlY3RvcnMgPSBqUXVlcnkuZXhwcjsKICAgIGZpbmQuc3VwcG9ydCA9IGpRdWVyeS5zdXBwb3J0OwogICAgZmluZC51bmlxdWVTb3J0ID0galF1ZXJ5LnVuaXF1ZVNvcnQ7CgogICAgLyogZXNsaW50LWVuYWJsZSAqLwogIH0pKCk7CiAgdmFyIGRpciA9IGZ1bmN0aW9uIChlbGVtLCBkaXIsIHVudGlsKSB7CiAgICB2YXIgbWF0Y2hlZCA9IFtdLAogICAgICB0cnVuY2F0ZSA9IHVudGlsICE9PSB1bmRlZmluZWQ7CiAgICB3aGlsZSAoKGVsZW0gPSBlbGVtW2Rpcl0pICYmIGVsZW0ubm9kZVR5cGUgIT09IDkpIHsKICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICBpZiAodHJ1bmNhdGUgJiYgalF1ZXJ5KGVsZW0pLmlzKHVudGlsKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIG1hdGNoZWQucHVzaChlbGVtKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1hdGNoZWQ7CiAgfTsKICB2YXIgc2libGluZ3MgPSBmdW5jdGlvbiAobiwgZWxlbSkgewogICAgdmFyIG1hdGNoZWQgPSBbXTsKICAgIGZvciAoOyBuOyBuID0gbi5uZXh0U2libGluZykgewogICAgICBpZiAobi5ub2RlVHlwZSA9PT0gMSAmJiBuICE9PSBlbGVtKSB7CiAgICAgICAgbWF0Y2hlZC5wdXNoKG4pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbWF0Y2hlZDsKICB9OwogIHZhciBybmVlZHNDb250ZXh0ID0galF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0OwogIHZhciByc2luZ2xlVGFnID0gL148KFthLXpdW15cL1wwPjpceDIwXHRcclxuXGZdKilbXHgyMFx0XHJcblxmXSpcLz8+KD86PFwvXDE+fCkkL2k7CgogIC8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90CiAgZnVuY3Rpb24gd2lubm93KGVsZW1lbnRzLCBxdWFsaWZpZXIsIG5vdCkgewogICAgaWYgKGlzRnVuY3Rpb24ocXVhbGlmaWVyKSkgewogICAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtLCBpKSB7CiAgICAgICAgcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoZWxlbSwgaSwgZWxlbSkgIT09IG5vdDsKICAgICAgfSk7CiAgICB9CgogICAgLy8gU2luZ2xlIGVsZW1lbnQKICAgIGlmIChxdWFsaWZpZXIubm9kZVR5cGUpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHJldHVybiBlbGVtID09PSBxdWFsaWZpZXIgIT09IG5vdDsKICAgICAgfSk7CiAgICB9CgogICAgLy8gQXJyYXlsaWtlIG9mIGVsZW1lbnRzIChqUXVlcnksIGFyZ3VtZW50cywgQXJyYXkpCiAgICBpZiAodHlwZW9mIHF1YWxpZmllciAhPT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHJldHVybiBpbmRleE9mLmNhbGwocXVhbGlmaWVyLCBlbGVtKSA+IC0xICE9PSBub3Q7CiAgICAgIH0pOwogICAgfQoKICAgIC8vIEZpbHRlcmVkIGRpcmVjdGx5IGZvciBib3RoIHNpbXBsZSBhbmQgY29tcGxleCBzZWxlY3RvcnMKICAgIHJldHVybiBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZWxlbWVudHMsIG5vdCk7CiAgfQogIGpRdWVyeS5maWx0ZXIgPSBmdW5jdGlvbiAoZXhwciwgZWxlbXMsIG5vdCkgewogICAgdmFyIGVsZW0gPSBlbGVtc1swXTsKICAgIGlmIChub3QpIHsKICAgICAgZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOwogICAgfQogICAgaWYgKGVsZW1zLmxlbmd0aCA9PT0gMSAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoZWxlbSwgZXhwcikgPyBbZWxlbV0gOiBbXTsKICAgIH0KICAgIHJldHVybiBqUXVlcnkuZmluZC5tYXRjaGVzKGV4cHIsIGpRdWVyeS5ncmVwKGVsZW1zLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKICAgIH0pKTsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZmluZDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBpLAogICAgICAgIHJldCwKICAgICAgICBsZW4gPSB0aGlzLmxlbmd0aCwKICAgICAgICBzZWxmID0gdGhpczsKICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIpIHsKICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soalF1ZXJ5KHNlbGVjdG9yKS5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChqUXVlcnkuY29udGFpbnMoc2VsZltpXSwgdGhpcykpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfQogICAgICByZXQgPSB0aGlzLnB1c2hTdGFjayhbXSk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGpRdWVyeS5maW5kKHNlbGVjdG9yLCBzZWxmW2ldLCByZXQpOwogICAgICB9CiAgICAgIHJldHVybiBsZW4gPiAxID8galF1ZXJ5LnVuaXF1ZVNvcnQocmV0KSA6IHJldDsKICAgIH0sCiAgICBmaWx0ZXI6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sod2lubm93KHRoaXMsIHNlbGVjdG9yIHx8IFtdLCBmYWxzZSkpOwogICAgfSwKICAgIG5vdDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIHRydWUpKTsKICAgIH0sCiAgICBpczogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiAhIXdpbm5vdyh0aGlzLAogICAgICAvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CiAgICAgIC8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4KICAgICAgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiAmJiBybmVlZHNDb250ZXh0LnRlc3Qoc2VsZWN0b3IpID8galF1ZXJ5KHNlbGVjdG9yKSA6IHNlbGVjdG9yIHx8IFtdLCBmYWxzZSkubGVuZ3RoOwogICAgfQogIH0pOwoKICAvLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdAoKICAvLyBBIGNlbnRyYWwgcmVmZXJlbmNlIHRvIHRoZSByb290IGpRdWVyeShkb2N1bWVudCkKICB2YXIgcm9vdGpRdWVyeSwKICAgIC8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzCiAgICAvLyBQcmlvcml0aXplICNpZCBvdmVyIDx0YWc+IHRvIGF2b2lkIFhTUyB2aWEgbG9jYXRpb24uaGFzaCAodHJhYy05NTIxKQogICAgLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKHRyYWMtMTEyOTA6IG11c3Qgc3RhcnQgd2l0aCA8KQogICAgLy8gU2hvcnRjdXQgc2ltcGxlICNpZCBjYXNlIGZvciBzcGVlZAogICAgcnF1aWNrRXhwciA9IC9eKD86XHMqKDxbXHdcV10rPilbXj5dKnwjKFtcdy1dKykpJC8sCiAgICBpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQsIHJvb3QpIHsKICAgICAgdmFyIG1hdGNoLCBlbGVtOwoKICAgICAgLy8gSEFORExFOiAkKCIiKSwgJChudWxsKSwgJCh1bmRlZmluZWQpLCAkKGZhbHNlKQogICAgICBpZiAoIXNlbGVjdG9yKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIC8vIE1ldGhvZCBpbml0KCkgYWNjZXB0cyBhbiBhbHRlcm5hdGUgcm9vdGpRdWVyeQogICAgICAvLyBzbyBtaWdyYXRlIGNhbiBzdXBwb3J0IGpRdWVyeS5zdWIgKGdoLTIxMDEpCiAgICAgIHJvb3QgPSByb290IHx8IHJvb3RqUXVlcnk7CgogICAgICAvLyBIYW5kbGUgSFRNTCBzdHJpbmdzCiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciKSB7CiAgICAgICAgaWYgKHNlbGVjdG9yWzBdID09PSAiPCIgJiYgc2VsZWN0b3Jbc2VsZWN0b3IubGVuZ3RoIC0gMV0gPT09ICI+IiAmJiBzZWxlY3Rvci5sZW5ndGggPj0gMykgewogICAgICAgICAgLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKICAgICAgICAgIG1hdGNoID0gW251bGwsIHNlbGVjdG9yLCBudWxsXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoc2VsZWN0b3IpOwogICAgICAgIH0KCiAgICAgICAgLy8gTWF0Y2ggaHRtbCBvciBtYWtlIHN1cmUgbm8gY29udGV4dCBpcyBzcGVjaWZpZWQgZm9yICNpZAogICAgICAgIGlmIChtYXRjaCAmJiAobWF0Y2hbMV0gfHwgIWNvbnRleHQpKSB7CiAgICAgICAgICAvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKICAgICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSA/IGNvbnRleHRbMF0gOiBjb250ZXh0OwoKICAgICAgICAgICAgLy8gT3B0aW9uIHRvIHJ1biBzY3JpcHRzIGlzIHRydWUgZm9yIGJhY2stY29tcGF0CiAgICAgICAgICAgIC8vIEludGVudGlvbmFsbHkgbGV0IHRoZSBlcnJvciBiZSB0aHJvd24gaWYgcGFyc2VIVE1MIGlzIG5vdCBwcmVzZW50CiAgICAgICAgICAgIGpRdWVyeS5tZXJnZSh0aGlzLCBqUXVlcnkucGFyc2VIVE1MKG1hdGNoWzFdLCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IGRvY3VtZW50LCB0cnVlKSk7CgogICAgICAgICAgICAvLyBIQU5ETEU6ICQoaHRtbCwgcHJvcHMpCiAgICAgICAgICAgIGlmIChyc2luZ2xlVGFnLnRlc3QobWF0Y2hbMV0pICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgZm9yIChtYXRjaCBpbiBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAvLyBQcm9wZXJ0aWVzIG9mIGNvbnRleHQgYXJlIGNhbGxlZCBhcyBtZXRob2RzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbih0aGlzW21hdGNoXSkpIHsKICAgICAgICAgICAgICAgICAgdGhpc1ttYXRjaF0oY29udGV4dFttYXRjaF0pOwoKICAgICAgICAgICAgICAgICAgLy8gLi4uYW5kIG90aGVyd2lzZSBzZXQgYXMgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5hdHRyKG1hdGNoLCBjb250ZXh0W21hdGNoXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwoKICAgICAgICAgICAgLy8gSEFORExFOiAkKCNpZCkKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChtYXRjaFsyXSk7CiAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgLy8gSW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QKICAgICAgICAgICAgICB0aGlzWzBdID0gZWxlbTsKICAgICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKICAgICAgICB9IGVsc2UgaWYgKCFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5KSB7CiAgICAgICAgICByZXR1cm4gKGNvbnRleHQgfHwgcm9vdCkuZmluZChzZWxlY3Rvcik7CgogICAgICAgICAgLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCiAgICAgICAgICAvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoY29udGV4dCkuZmluZChzZWxlY3Rvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBIQU5ETEU6ICQoRE9NRWxlbWVudCkKICAgICAgfSBlbHNlIGlmIChzZWxlY3Rvci5ub2RlVHlwZSkgewogICAgICAgIHRoaXNbMF0gPSBzZWxlY3RvcjsKICAgICAgICB0aGlzLmxlbmd0aCA9IDE7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgICAgIC8vIEhBTkRMRTogJChmdW5jdGlvbikKICAgICAgICAvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHNlbGVjdG9yKSkgewogICAgICAgIHJldHVybiByb290LnJlYWR5ICE9PSB1bmRlZmluZWQgPyByb290LnJlYWR5KHNlbGVjdG9yKSA6CiAgICAgICAgLy8gRXhlY3V0ZSBpbW1lZGlhdGVseSBpZiByZWFkeSBpcyBub3QgcHJlc2VudAogICAgICAgIHNlbGVjdG9yKGpRdWVyeSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGpRdWVyeS5tYWtlQXJyYXkoc2VsZWN0b3IsIHRoaXMpOwogICAgfTsKCiAgLy8gR2l2ZSB0aGUgaW5pdCBmdW5jdGlvbiB0aGUgalF1ZXJ5IHByb3RvdHlwZSBmb3IgbGF0ZXIgaW5zdGFudGlhdGlvbgogIGluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwoKICAvLyBJbml0aWFsaXplIGNlbnRyYWwgcmVmZXJlbmNlCiAgcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7CiAgdmFyIHJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAogICAgLy8gTWV0aG9kcyBndWFyYW50ZWVkIHRvIHByb2R1Y2UgYSB1bmlxdWUgc2V0IHdoZW4gc3RhcnRpbmcgZnJvbSBhIHVuaXF1ZSBzZXQKICAgIGd1YXJhbnRlZWRVbmlxdWUgPSB7CiAgICAgIGNoaWxkcmVuOiB0cnVlLAogICAgICBjb250ZW50czogdHJ1ZSwKICAgICAgbmV4dDogdHJ1ZSwKICAgICAgcHJldjogdHJ1ZQogICAgfTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGhhczogZnVuY3Rpb24gKHRhcmdldCkgewogICAgICB2YXIgdGFyZ2V0cyA9IGpRdWVyeSh0YXJnZXQsIHRoaXMpLAogICAgICAgIGwgPSB0YXJnZXRzLmxlbmd0aDsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGlmIChqUXVlcnkuY29udGFpbnModGhpcywgdGFyZ2V0c1tpXSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbiAoc2VsZWN0b3JzLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXIsCiAgICAgICAgaSA9IDAsCiAgICAgICAgbCA9IHRoaXMubGVuZ3RoLAogICAgICAgIG1hdGNoZWQgPSBbXSwKICAgICAgICB0YXJnZXRzID0gdHlwZW9mIHNlbGVjdG9ycyAhPT0gInN0cmluZyIgJiYgalF1ZXJ5KHNlbGVjdG9ycyk7CgogICAgICAvLyBQb3NpdGlvbmFsIHNlbGVjdG9ycyBuZXZlciBtYXRjaCwgc2luY2UgdGhlcmUncyBubyBfc2VsZWN0aW9uXyBjb250ZXh0CiAgICAgIGlmICghcm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9ycykpIHsKICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgZm9yIChjdXIgPSB0aGlzW2ldOyBjdXIgJiYgY3VyICE9PSBjb250ZXh0OyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgICAvLyBBbHdheXMgc2tpcCBkb2N1bWVudCBmcmFnbWVudHMKICAgICAgICAgICAgaWYgKGN1ci5ub2RlVHlwZSA8IDExICYmICh0YXJnZXRzID8gdGFyZ2V0cy5pbmRleChjdXIpID4gLTEgOgogICAgICAgICAgICAvLyBEb24ndCBwYXNzIG5vbi1lbGVtZW50cyB0byBqUXVlcnkjZmluZAogICAgICAgICAgICBjdXIubm9kZVR5cGUgPT09IDEgJiYgalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGN1ciwgc2VsZWN0b3JzKSkpIHsKICAgICAgICAgICAgICBtYXRjaGVkLnB1c2goY3VyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sobWF0Y2hlZC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZVNvcnQobWF0Y2hlZCkgOiBtYXRjaGVkKTsKICAgIH0sCiAgICAvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluIHRoZSBzZXQKICAgIGluZGV4OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgICBpZiAoIWVsZW0pIHsKICAgICAgICByZXR1cm4gdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwogICAgICB9CgogICAgICAvLyBJbmRleCBpbiBzZWxlY3RvcgogICAgICBpZiAodHlwZW9mIGVsZW0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbChqUXVlcnkoZWxlbSksIHRoaXNbMF0pOwogICAgICB9CgogICAgICAvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbCh0aGlzLAogICAgICAvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKICAgICAgZWxlbS5qcXVlcnkgPyBlbGVtWzBdIDogZWxlbSk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS51bmlxdWVTb3J0KGpRdWVyeS5tZXJnZSh0aGlzLmdldCgpLCBqUXVlcnkoc2VsZWN0b3IsIGNvbnRleHQpKSkpOwogICAgfSwKICAgIGFkZEJhY2s6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy5hZGQoc2VsZWN0b3IgPT0gbnVsbCA/IHRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpKTsKICAgIH0KICB9KTsKICBmdW5jdGlvbiBzaWJsaW5nKGN1ciwgZGlyKSB7CiAgICB3aGlsZSAoKGN1ciA9IGN1cltkaXJdKSAmJiBjdXIubm9kZVR5cGUgIT09IDEpIHt9CiAgICByZXR1cm4gY3VyOwogIH0KICBqUXVlcnkuZWFjaCh7CiAgICBwYXJlbnQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CiAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGRpcihlbGVtLCAicGFyZW50Tm9kZSIpOwogICAgfSwKICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24gKGVsZW0sIF9pLCB1bnRpbCkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwpOwogICAgfSwKICAgIG5leHQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICJuZXh0U2libGluZyIpOwogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICJwcmV2aW91c1NpYmxpbmciKTsKICAgIH0sCiAgICBuZXh0QWxsOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJuZXh0U2libGluZyIpOwogICAgfSwKICAgIHByZXZBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBkaXIoZWxlbSwgInByZXZpb3VzU2libGluZyIpOwogICAgfSwKICAgIG5leHRVbnRpbDogZnVuY3Rpb24gKGVsZW0sIF9pLCB1bnRpbCkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsKTsKICAgIH0sCiAgICBwcmV2VW50aWw6IGZ1bmN0aW9uIChlbGVtLCBfaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGRpcihlbGVtLCAicHJldmlvdXNTaWJsaW5nIiwgdW50aWwpOwogICAgfSwKICAgIHNpYmxpbmdzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gc2libGluZ3MoKGVsZW0ucGFyZW50Tm9kZSB8fCB7fSkuZmlyc3RDaGlsZCwgZWxlbSk7CiAgICB9LAogICAgY2hpbGRyZW46IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5ncyhlbGVtLmZpcnN0Q2hpbGQpOwogICAgfSwKICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICBpZiAoZWxlbS5jb250ZW50RG9jdW1lbnQgIT0gbnVsbCAmJgogICAgICAvLyBTdXBwb3J0OiBJRSAxMSsKICAgICAgLy8gPG9iamVjdD4gZWxlbWVudHMgd2l0aCBubyBgZGF0YWAgYXR0cmlidXRlIGhhcyBhbiBvYmplY3QKICAgICAgLy8gYGNvbnRlbnREb2N1bWVudGAgd2l0aCBhIGBudWxsYCBwcm90b3R5cGUuCiAgICAgIGdldFByb3RvKGVsZW0uY29udGVudERvY3VtZW50KSkgewogICAgICAgIHJldHVybiBlbGVtLmNvbnRlbnREb2N1bWVudDsKICAgICAgfQoKICAgICAgLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHksIGlPUyA3IG9ubHksIEFuZHJvaWQgQnJvd3NlciA8PTQuMyBvbmx5CiAgICAgIC8vIFRyZWF0IHRoZSB0ZW1wbGF0ZSBlbGVtZW50IGFzIGEgcmVndWxhciBvbmUgaW4gYnJvd3NlcnMgdGhhdAogICAgICAvLyBkb24ndCBzdXBwb3J0IGl0LgogICAgICBpZiAobm9kZU5hbWUoZWxlbSwgInRlbXBsYXRlIikpIHsKICAgICAgICBlbGVtID0gZWxlbS5jb250ZW50IHx8IGVsZW07CiAgICAgIH0KICAgICAgcmV0dXJuIGpRdWVyeS5tZXJnZShbXSwgZWxlbS5jaGlsZE5vZGVzKTsKICAgIH0KICB9LCBmdW5jdGlvbiAobmFtZSwgZm4pIHsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uICh1bnRpbCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIG1hdGNoZWQgPSBqUXVlcnkubWFwKHRoaXMsIGZuLCB1bnRpbCk7CiAgICAgIGlmIChuYW1lLnNsaWNlKC01KSAhPT0gIlVudGlsIikgewogICAgICAgIHNlbGVjdG9yID0gdW50aWw7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICBtYXRjaGVkID0galF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgbWF0Y2hlZCk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMSkgewogICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzCiAgICAgICAgaWYgKCFndWFyYW50ZWVkVW5pcXVlW25hbWVdKSB7CiAgICAgICAgICBqUXVlcnkudW5pcXVlU29ydChtYXRjaGVkKTsKICAgICAgICB9CgogICAgICAgIC8vIFJldmVyc2Ugb3JkZXIgZm9yIHBhcmVudHMqIGFuZCBwcmV2LWRlcml2YXRpdmVzCiAgICAgICAgaWYgKHJwYXJlbnRzcHJldi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICBtYXRjaGVkLnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKG1hdGNoZWQpOwogICAgfTsKICB9KTsKICB2YXIgcm5vdGh0bWx3aGl0ZSA9IC9bXlx4MjBcdFxyXG5cZl0rL2c7CgogIC8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBvcHRpb25zIGludG8gT2JqZWN0LWZvcm1hdHRlZCBvbmVzCiAgZnVuY3Rpb24gY3JlYXRlT3B0aW9ucyhvcHRpb25zKSB7CiAgICB2YXIgb2JqZWN0ID0ge307CiAgICBqUXVlcnkuZWFjaChvcHRpb25zLm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFtdLCBmdW5jdGlvbiAoXywgZmxhZykgewogICAgICBvYmplY3RbZmxhZ10gPSB0cnVlOwogICAgfSk7CiAgICByZXR1cm4gb2JqZWN0OwogIH0KCiAgLyoKICAgKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgKgogICAqCW9wdGlvbnM6IGFuIG9wdGlvbmFsIGxpc3Qgb2Ygc3BhY2Utc2VwYXJhdGVkIG9wdGlvbnMgdGhhdCB3aWxsIGNoYW5nZSBob3cKICAgKgkJCXRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICAgKgogICAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlCiAgICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICAgKgogICAqIFBvc3NpYmxlIG9wdGlvbnM6CiAgICoKICAgKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICAgKgogICAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAgICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAgICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogICAqCiAgICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogICAqCiAgICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogICAqCiAgICovCiAgalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCiAgICAvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpCiAgICBvcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciID8gY3JlYXRlT3B0aW9ucyhvcHRpb25zKSA6IGpRdWVyeS5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgdmFyCiAgICAgIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKICAgICAgZmlyaW5nLAogICAgICAvLyBMYXN0IGZpcmUgdmFsdWUgZm9yIG5vbi1mb3JnZXR0YWJsZSBsaXN0cwogICAgICBtZW1vcnksCiAgICAgIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IHdhcyBhbHJlYWR5IGZpcmVkCiAgICAgIGZpcmVkLAogICAgICAvLyBGbGFnIHRvIHByZXZlbnQgZmlyaW5nCiAgICAgIGxvY2tlZCwKICAgICAgLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKICAgICAgbGlzdCA9IFtdLAogICAgICAvLyBRdWV1ZSBvZiBleGVjdXRpb24gZGF0YSBmb3IgcmVwZWF0YWJsZSBsaXN0cwogICAgICBxdWV1ZSA9IFtdLAogICAgICAvLyBJbmRleCBvZiBjdXJyZW50bHkgZmlyaW5nIGNhbGxiYWNrIChtb2RpZmllZCBieSBhZGQvcmVtb3ZlIGFzIG5lZWRlZCkKICAgICAgZmlyaW5nSW5kZXggPSAtMSwKICAgICAgLy8gRmlyZSBjYWxsYmFja3MKICAgICAgZmlyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBFbmZvcmNlIHNpbmdsZS1maXJpbmcKICAgICAgICBsb2NrZWQgPSBsb2NrZWQgfHwgb3B0aW9ucy5vbmNlOwoKICAgICAgICAvLyBFeGVjdXRlIGNhbGxiYWNrcyBmb3IgYWxsIHBlbmRpbmcgZXhlY3V0aW9ucywKICAgICAgICAvLyByZXNwZWN0aW5nIGZpcmluZ0luZGV4IG92ZXJyaWRlcyBhbmQgcnVudGltZSBjaGFuZ2VzCiAgICAgICAgZmlyZWQgPSBmaXJpbmcgPSB0cnVlOwogICAgICAgIGZvciAoOyBxdWV1ZS5sZW5ndGg7IGZpcmluZ0luZGV4ID0gLTEpIHsKICAgICAgICAgIG1lbW9yeSA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICB3aGlsZSAoKytmaXJpbmdJbmRleCA8IGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgIC8vIFJ1biBjYWxsYmFjayBhbmQgY2hlY2sgZm9yIGVhcmx5IHRlcm1pbmF0aW9uCiAgICAgICAgICAgIGlmIChsaXN0W2ZpcmluZ0luZGV4XS5hcHBseShtZW1vcnlbMF0sIG1lbW9yeVsxXSkgPT09IGZhbHNlICYmIG9wdGlvbnMuc3RvcE9uRmFsc2UpIHsKICAgICAgICAgICAgICAvLyBKdW1wIHRvIGVuZCBhbmQgZm9yZ2V0IHRoZSBkYXRhIHNvIC5hZGQgZG9lc24ndCByZS1maXJlCiAgICAgICAgICAgICAgZmlyaW5nSW5kZXggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgICBtZW1vcnkgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRm9yZ2V0IHRoZSBkYXRhIGlmIHdlJ3JlIGRvbmUgd2l0aCBpdAogICAgICAgIGlmICghb3B0aW9ucy5tZW1vcnkpIHsKICAgICAgICAgIG1lbW9yeSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmaXJpbmcgPSBmYWxzZTsKCiAgICAgICAgLy8gQ2xlYW4gdXAgaWYgd2UncmUgZG9uZSBmaXJpbmcgZm9yIGdvb2QKICAgICAgICBpZiAobG9ja2VkKSB7CiAgICAgICAgICAvLyBLZWVwIGFuIGVtcHR5IGxpc3QgaWYgd2UgaGF2ZSBkYXRhIGZvciBmdXR1cmUgYWRkIGNhbGxzCiAgICAgICAgICBpZiAobWVtb3J5KSB7CiAgICAgICAgICAgIGxpc3QgPSBbXTsKCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgdGhpcyBvYmplY3QgaXMgc3BlbnQKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpc3QgPSAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CiAgICAgIHNlbGYgPSB7CiAgICAgICAgLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAogICAgICAgIGFkZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBtZW1vcnkgZnJvbSBhIHBhc3QgcnVuLCB3ZSBzaG91bGQgZmlyZSBhZnRlciBhZGRpbmcKICAgICAgICAgICAgaWYgKG1lbW9yeSAmJiAhZmlyaW5nKSB7CiAgICAgICAgICAgICAgZmlyaW5nSW5kZXggPSBsaXN0Lmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgcXVldWUucHVzaChtZW1vcnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChmdW5jdGlvbiBhZGQoYXJncykgewogICAgICAgICAgICAgIGpRdWVyeS5lYWNoKGFyZ3MsIGZ1bmN0aW9uIChfLCBhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGFyZykpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnVuaXF1ZSB8fCAhc2VsZi5oYXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZyAmJiBhcmcubGVuZ3RoICYmIHRvVHlwZShhcmcpICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CiAgICAgICAgICAgICAgICAgIGFkZChhcmcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KShhcmd1bWVudHMpOwogICAgICAgICAgICBpZiAobWVtb3J5ICYmICFmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgalF1ZXJ5LmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoXywgYXJnKSB7CiAgICAgICAgICAgIHZhciBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKChpbmRleCA9IGpRdWVyeS5pbkFycmF5KGFyZywgbGlzdCwgaW5kZXgpKSA+IC0xKSB7CiAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICAgICAgICAvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKICAgICAgICAgICAgICBpZiAoaW5kZXggPD0gZmlyaW5nSW5kZXgpIHsKICAgICAgICAgICAgICAgIGZpcmluZ0luZGV4LS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KICAgICAgICAvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KICAgICAgICBoYXM6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoZm4sIGxpc3QpID4gLTEgOiBsaXN0Lmxlbmd0aCA+IDA7CiAgICAgICAgfSwKICAgICAgICAvLyBSZW1vdmUgYWxsIGNhbGxiYWNrcyBmcm9tIHRoZSBsaXN0CiAgICAgICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgIGxpc3QgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gRGlzYWJsZSAuZmlyZSBhbmQgLmFkZAogICAgICAgIC8vIEFib3J0IGFueSBjdXJyZW50L3BlbmRpbmcgZXhlY3V0aW9ucwogICAgICAgIC8vIENsZWFyIGFsbCBjYWxsYmFja3MgYW5kIHZhbHVlcwogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxvY2tlZCA9IHF1ZXVlID0gW107CiAgICAgICAgICBsaXN0ID0gbWVtb3J5ID0gIiI7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gIWxpc3Q7CiAgICAgICAgfSwKICAgICAgICAvLyBEaXNhYmxlIC5maXJlCiAgICAgICAgLy8gQWxzbyBkaXNhYmxlIC5hZGQgdW5sZXNzIHdlIGhhdmUgbWVtb3J5IChzaW5jZSBpdCB3b3VsZCBoYXZlIG5vIGVmZmVjdCkKICAgICAgICAvLyBBYm9ydCBhbnkgcGVuZGluZyBleGVjdXRpb25zCiAgICAgICAgbG9jazogZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9ja2VkID0gcXVldWUgPSBbXTsKICAgICAgICAgIGlmICghbWVtb3J5ICYmICFmaXJpbmcpIHsKICAgICAgICAgICAgbGlzdCA9IG1lbW9yeSA9ICIiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBsb2NrZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAhIWxvY2tlZDsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKICAgICAgICBmaXJlV2l0aDogZnVuY3Rpb24gKGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICAgIGlmICghbG9ja2VkKSB7CiAgICAgICAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICAgICAgICBhcmdzID0gW2NvbnRleHQsIGFyZ3Muc2xpY2UgPyBhcmdzLnNsaWNlKCkgOiBhcmdzXTsKICAgICAgICAgICAgcXVldWUucHVzaChhcmdzKTsKICAgICAgICAgICAgaWYgKCFmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2FsbCBhbGwgdGhlIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMKICAgICAgICBmaXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLmZpcmVXaXRoKHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQogICAgICAgIGZpcmVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gISFmaXJlZDsKICAgICAgICB9CiAgICAgIH07CiAgICByZXR1cm4gc2VsZjsKICB9OwogIGZ1bmN0aW9uIElkZW50aXR5KHYpIHsKICAgIHJldHVybiB2OwogIH0KICBmdW5jdGlvbiBUaHJvd2VyKGV4KSB7CiAgICB0aHJvdyBleDsKICB9CiAgZnVuY3Rpb24gYWRvcHRWYWx1ZSh2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0LCBub1ZhbHVlKSB7CiAgICB2YXIgbWV0aG9kOwogICAgdHJ5IHsKICAgICAgLy8gQ2hlY2sgZm9yIHByb21pc2UgYXNwZWN0IGZpcnN0IHRvIHByaXZpbGVnZSBzeW5jaHJvbm91cyBiZWhhdmlvcgogICAgICBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbihtZXRob2QgPSB2YWx1ZS5wcm9taXNlKSkgewogICAgICAgIG1ldGhvZC5jYWxsKHZhbHVlKS5kb25lKHJlc29sdmUpLmZhaWwocmVqZWN0KTsKCiAgICAgICAgLy8gT3RoZXIgdGhlbmFibGVzCiAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbihtZXRob2QgPSB2YWx1ZS50aGVuKSkgewogICAgICAgIG1ldGhvZC5jYWxsKHZhbHVlLCByZXNvbHZlLCByZWplY3QpOwoKICAgICAgICAvLyBPdGhlciBub24tdGhlbmFibGVzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQ29udHJvbCBgcmVzb2x2ZWAgYXJndW1lbnRzIGJ5IGxldHRpbmcgQXJyYXkjc2xpY2UgY2FzdCBib29sZWFuIGBub1ZhbHVlYCB0byBpbnRlZ2VyOgogICAgICAgIC8vICogZmFsc2U6IFsgdmFsdWUgXS5zbGljZSggMCApID0+IHJlc29sdmUoIHZhbHVlICkKICAgICAgICAvLyAqIHRydWU6IFsgdmFsdWUgXS5zbGljZSggMSApID0+IHJlc29sdmUoKQogICAgICAgIHJlc29sdmUuYXBwbHkodW5kZWZpbmVkLCBbdmFsdWVdLnNsaWNlKG5vVmFsdWUpKTsKICAgICAgfQoKICAgICAgLy8gRm9yIFByb21pc2VzL0ErLCBjb252ZXJ0IGV4Y2VwdGlvbnMgaW50byByZWplY3Rpb25zCiAgICAgIC8vIFNpbmNlIGpRdWVyeS53aGVuIGRvZXNuJ3QgdW53cmFwIHRoZW5hYmxlcywgd2UgY2FuIHNraXAgdGhlIGV4dHJhIGNoZWNrcyBhcHBlYXJpbmcgaW4KICAgICAgLy8gRGVmZXJyZWQjdGhlbiB0byBjb25kaXRpb25hbGx5IHN1cHByZXNzIHJlamVjdGlvbi4KICAgIH0gY2F0Y2ggKHZhbHVlKSB7CiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIG9ubHkKICAgICAgLy8gU3RyaWN0IG1vZGUgZnVuY3Rpb25zIGludm9rZWQgd2l0aG91dCAuY2FsbC8uYXBwbHkgZ2V0IGdsb2JhbC1vYmplY3QgY29udGV4dAogICAgICByZWplY3QuYXBwbHkodW5kZWZpbmVkLCBbdmFsdWVdKTsKICAgIH0KICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBEZWZlcnJlZDogZnVuY3Rpb24gKGZ1bmMpIHsKICAgICAgdmFyIHR1cGxlcyA9IFsKICAgICAgICAvLyBhY3Rpb24sIGFkZCBsaXN0ZW5lciwgY2FsbGJhY2tzLAogICAgICAgIC8vIC4uLiAudGhlbiBoYW5kbGVycywgYXJndW1lbnQgaW5kZXgsIFtmaW5hbCBzdGF0ZV0KICAgICAgICBbIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSwgMl0sIFsicmVzb2x2ZSIsICJkb25lIiwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgMCwgInJlc29sdmVkIl0sIFsicmVqZWN0IiwgImZhaWwiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAxLCAicmVqZWN0ZWQiXV0sCiAgICAgICAgc3RhdGUgPSAicGVuZGluZyIsCiAgICAgICAgcHJvbWlzZSA9IHsKICAgICAgICAgIHN0YXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBhbHdheXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZGVmZXJyZWQuZG9uZShhcmd1bWVudHMpLmZhaWwoYXJndW1lbnRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgImNhdGNoIjogZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4obnVsbCwgZm4pOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKICAgICAgICAgIHBpcGU6IGZ1bmN0aW9uIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovCiAgICAgICAgICAoKSB7CiAgICAgICAgICAgIHZhciBmbnMgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuRGVmZXJyZWQoZnVuY3Rpb24gKG5ld0RlZmVyKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmVhY2godHVwbGVzLCBmdW5jdGlvbiAoX2ksIHR1cGxlKSB7CiAgICAgICAgICAgICAgICAvLyBNYXAgdHVwbGVzIChwcm9ncmVzcywgZG9uZSwgZmFpbCkgdG8gYXJndW1lbnRzIChkb25lLCBmYWlsLCBwcm9ncmVzcykKICAgICAgICAgICAgICAgIHZhciBmbiA9IGlzRnVuY3Rpb24oZm5zW3R1cGxlWzRdXSkgJiYgZm5zW3R1cGxlWzRdXTsKCiAgICAgICAgICAgICAgICAvLyBkZWZlcnJlZC5wcm9ncmVzcyhmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5ub3RpZnkgfSkKICAgICAgICAgICAgICAgIC8vIGRlZmVycmVkLmRvbmUoZnVuY3Rpb24oKSB7IGJpbmQgdG8gbmV3RGVmZXIgb3IgbmV3RGVmZXIucmVzb2x2ZSB9KQogICAgICAgICAgICAgICAgLy8gZGVmZXJyZWQuZmFpbChmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5yZWplY3QgfSkKICAgICAgICAgICAgICAgIGRlZmVycmVkW3R1cGxlWzFdXShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXR1cm5lZCA9IGZuICYmIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCAmJiBpc0Z1bmN0aW9uKHJldHVybmVkLnByb21pc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuZWQucHJvbWlzZSgpLnByb2dyZXNzKG5ld0RlZmVyLm5vdGlmeSkuZG9uZShuZXdEZWZlci5yZXNvbHZlKS5mYWlsKG5ld0RlZmVyLnJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3RGVmZXJbdHVwbGVbMF0gKyAiV2l0aCJdKHRoaXMsIGZuID8gW3JldHVybmVkXSA6IGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGZucyA9IG51bGw7CiAgICAgICAgICAgIH0pLnByb21pc2UoKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0aGVuOiBmdW5jdGlvbiAob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgdmFyIG1heERlcHRoID0gMDsKICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZShkZXB0aCwgZGVmZXJyZWQsIGhhbmRsZXIsIHNwZWNpYWwpIHsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICAgICAgICBtaWdodFRocm93ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXR1cm5lZCwgdGhlbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMy4zLjMKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC01OQogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBkb3VibGUtcmVzb2x1dGlvbiBhdHRlbXB0cwogICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA8IG1heERlcHRoKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybmVkID0gaGFuZGxlci5hcHBseSh0aGF0LCBhcmdzKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMQogICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTQ4CiAgICAgICAgICAgICAgICAgICAgaWYgKHJldHVybmVkID09PSBkZWZlcnJlZC5wcm9taXNlKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZW5hYmxlIHNlbGYtcmVzb2x1dGlvbiIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbnMgMi4zLjMuMSwgMy41CiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNTQKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC03NQogICAgICAgICAgICAgICAgICAgIC8vIFJldHJpZXZlIGB0aGVuYCBvbmx5IG9uY2UKICAgICAgICAgICAgICAgICAgICB0aGVuID0gcmV0dXJuZWQgJiYgKAogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjQKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC02NAogICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgY2hlY2sgb2JqZWN0cyBhbmQgZnVuY3Rpb25zIGZvciB0aGVuYWJpbGl0eQogICAgICAgICAgICAgICAgICAgIHR5cGVvZiByZXR1cm5lZCA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHJldHVybmVkID09PSAiZnVuY3Rpb24iKSAmJiByZXR1cm5lZC50aGVuOwoKICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgYSByZXR1cm5lZCB0aGVuYWJsZQogICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIHByb2Nlc3NvcnMgKG5vdGlmeSkganVzdCB3YWl0IGZvciByZXNvbHV0aW9uCiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGVuLmNhbGwocmV0dXJuZWQsIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgc3BlY2lhbCksIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBUaHJvd2VyLCBzcGVjaWFsKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgcHJvY2Vzc29ycyAocmVzb2x2ZSkgYWxzbyBob29rIGludG8gcHJvZ3Jlc3MKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC4uLmFuZCBkaXNyZWdhcmQgb2xkZXIgcmVzb2x1dGlvbiB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICAgICAgbWF4RGVwdGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhlbi5jYWxsKHJldHVybmVkLCByZXNvbHZlKG1heERlcHRoLCBkZWZlcnJlZCwgSWRlbnRpdHksIHNwZWNpYWwpLCByZXNvbHZlKG1heERlcHRoLCBkZWZlcnJlZCwgVGhyb3dlciwgc3BlY2lhbCksIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgZGVmZXJyZWQubm90aWZ5V2l0aCkpOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBhbGwgb3RoZXIgcmV0dXJuZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc3Vic3RpdHV0ZSBoYW5kbGVycyBwYXNzIG9uIGNvbnRleHQKICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBtdWx0aXBsZSB2YWx1ZXMgKG5vbi1zcGVjIGJlaGF2aW9yKQogICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXIgIT09IElkZW50aXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBbcmV0dXJuZWRdOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIFByb2Nlc3MgdGhlIHZhbHVlKHMpCiAgICAgICAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHByb2Nlc3MgaXMgcmVzb2x2ZQogICAgICAgICAgICAgICAgICAgICAgKHNwZWNpYWwgfHwgZGVmZXJyZWQucmVzb2x2ZVdpdGgpKHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgLy8gT25seSBub3JtYWwgcHJvY2Vzc29ycyAocmVzb2x2ZSkgY2F0Y2ggYW5kIHJlamVjdCBleGNlcHRpb25zCiAgICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBzcGVjaWFsID8gbWlnaHRUaHJvdyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgbWlnaHRUaHJvdygpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vaykgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayhlLCBwcm9jZXNzLmVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy4zLjMuNC4xCiAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC02MQogICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHBvc3QtcmVzb2x1dGlvbiBleGNlcHRpb25zCiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVwdGggKyAxID49IG1heERlcHRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc3Vic3RpdHV0ZSBoYW5kbGVycyBwYXNzIG9uIGNvbnRleHQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIG11bHRpcGxlIHZhbHVlcyAobm9uLXNwZWMgYmVoYXZpb3IpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYW5kbGVyICE9PSBUaHJvd2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gW2VdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgodGhhdCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjMuMy4xCiAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC01NwogICAgICAgICAgICAgICAgLy8gUmUtcmVzb2x2ZSBwcm9taXNlcyBpbW1lZGlhdGVseSB0byBkb2RnZSBmYWxzZSByZWplY3Rpb24gZnJvbQogICAgICAgICAgICAgICAgLy8gc3Vic2VxdWVudCBlcnJvcnMKICAgICAgICAgICAgICAgIGlmIChkZXB0aCkgewogICAgICAgICAgICAgICAgICBwcm9jZXNzKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBDYWxsIGFuIG9wdGlvbmFsIGhvb2sgdG8gcmVjb3JkIHRoZSBlcnJvciwgaW4gY2FzZSBvZiBleGNlcHRpb24KICAgICAgICAgICAgICAgICAgLy8gc2luY2UgaXQncyBvdGhlcndpc2UgbG9zdCB3aGVuIGV4ZWN1dGlvbiBnb2VzIGFzeW5jCiAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuRGVmZXJyZWQuZ2V0RXJyb3JIb29rKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lcnJvciA9IGpRdWVyeS5EZWZlcnJlZC5nZXRFcnJvckhvb2soKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGRlcHJlY2F0ZWQgYWxpYXMgb2YgdGhlIGFib3ZlLiBXaGlsZSB0aGUgbmFtZSBzdWdnZXN0cwogICAgICAgICAgICAgICAgICAgIC8vIHJldHVybmluZyB0aGUgc3RhY2ssIG5vdCBhbiBlcnJvciBpbnN0YW5jZSwgalF1ZXJ5IGp1c3QgcGFzc2VzCiAgICAgICAgICAgICAgICAgICAgLy8gaXQgZGlyZWN0bHkgdG8gYGNvbnNvbGUud2FybmAgc28gYm90aCB3aWxsIHdvcms7IGFuIGluc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgLy8ganVzdCBiZXR0ZXIgY29vcGVyYXRlcyB3aXRoIHNvdXJjZSBtYXBzLgogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGpRdWVyeS5EZWZlcnJlZC5nZXRTdGFja0hvb2spIHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmVycm9yID0galF1ZXJ5LkRlZmVycmVkLmdldFN0YWNrSG9vaygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KHByb2Nlc3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiAobmV3RGVmZXIpIHsKICAgICAgICAgICAgICAvLyBwcm9ncmVzc19oYW5kbGVycy5hZGQoIC4uLiApCiAgICAgICAgICAgICAgdHVwbGVzWzBdWzNdLmFkZChyZXNvbHZlKDAsIG5ld0RlZmVyLCBpc0Z1bmN0aW9uKG9uUHJvZ3Jlc3MpID8gb25Qcm9ncmVzcyA6IElkZW50aXR5LCBuZXdEZWZlci5ub3RpZnlXaXRoKSk7CgogICAgICAgICAgICAgIC8vIGZ1bGZpbGxlZF9oYW5kbGVycy5hZGQoIC4uLiApCiAgICAgICAgICAgICAgdHVwbGVzWzFdWzNdLmFkZChyZXNvbHZlKDAsIG5ld0RlZmVyLCBpc0Z1bmN0aW9uKG9uRnVsZmlsbGVkKSA/IG9uRnVsZmlsbGVkIDogSWRlbnRpdHkpKTsKCiAgICAgICAgICAgICAgLy8gcmVqZWN0ZWRfaGFuZGxlcnMuYWRkKCAuLi4gKQogICAgICAgICAgICAgIHR1cGxlc1syXVszXS5hZGQocmVzb2x2ZSgwLCBuZXdEZWZlciwgaXNGdW5jdGlvbihvblJlamVjdGVkKSA/IG9uUmVqZWN0ZWQgOiBUaHJvd2VyKSk7CiAgICAgICAgICAgIH0pLnByb21pc2UoKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBHZXQgYSBwcm9taXNlIGZvciB0aGlzIGRlZmVycmVkCiAgICAgICAgICAvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0CiAgICAgICAgICBwcm9taXNlOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogIT0gbnVsbCA/IGpRdWVyeS5leHRlbmQob2JqLCBwcm9taXNlKSA6IHByb21pc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkZWZlcnJlZCA9IHt9OwoKICAgICAgLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwogICAgICBqUXVlcnkuZWFjaCh0dXBsZXMsIGZ1bmN0aW9uIChpLCB0dXBsZSkgewogICAgICAgIHZhciBsaXN0ID0gdHVwbGVbMl0sCiAgICAgICAgICBzdGF0ZVN0cmluZyA9IHR1cGxlWzVdOwoKICAgICAgICAvLyBwcm9taXNlLnByb2dyZXNzID0gbGlzdC5hZGQKICAgICAgICAvLyBwcm9taXNlLmRvbmUgPSBsaXN0LmFkZAogICAgICAgIC8vIHByb21pc2UuZmFpbCA9IGxpc3QuYWRkCiAgICAgICAgcHJvbWlzZVt0dXBsZVsxXV0gPSBsaXN0LmFkZDsKCiAgICAgICAgLy8gSGFuZGxlIHN0YXRlCiAgICAgICAgaWYgKHN0YXRlU3RyaW5nKSB7CiAgICAgICAgICBsaXN0LmFkZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIHN0YXRlID0gInJlc29sdmVkIiAoaS5lLiwgZnVsZmlsbGVkKQogICAgICAgICAgICAvLyBzdGF0ZSA9ICJyZWplY3RlZCIKICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZVN0cmluZzsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyByZWplY3RlZF9jYWxsYmFja3MuZGlzYWJsZQogICAgICAgICAgLy8gZnVsZmlsbGVkX2NhbGxiYWNrcy5kaXNhYmxlCiAgICAgICAgICB0dXBsZXNbMyAtIGldWzJdLmRpc2FibGUsCiAgICAgICAgICAvLyByZWplY3RlZF9oYW5kbGVycy5kaXNhYmxlCiAgICAgICAgICAvLyBmdWxmaWxsZWRfaGFuZGxlcnMuZGlzYWJsZQogICAgICAgICAgdHVwbGVzWzMgLSBpXVszXS5kaXNhYmxlLAogICAgICAgICAgLy8gcHJvZ3Jlc3NfY2FsbGJhY2tzLmxvY2sKICAgICAgICAgIHR1cGxlc1swXVsyXS5sb2NrLAogICAgICAgICAgLy8gcHJvZ3Jlc3NfaGFuZGxlcnMubG9jawogICAgICAgICAgdHVwbGVzWzBdWzNdLmxvY2spOwogICAgICAgIH0KCiAgICAgICAgLy8gcHJvZ3Jlc3NfaGFuZGxlcnMuZmlyZQogICAgICAgIC8vIGZ1bGZpbGxlZF9oYW5kbGVycy5maXJlCiAgICAgICAgLy8gcmVqZWN0ZWRfaGFuZGxlcnMuZmlyZQogICAgICAgIGxpc3QuYWRkKHR1cGxlWzNdLmZpcmUpOwoKICAgICAgICAvLyBkZWZlcnJlZC5ub3RpZnkgPSBmdW5jdGlvbigpIHsgZGVmZXJyZWQubm90aWZ5V2l0aCguLi4pIH0KICAgICAgICAvLyBkZWZlcnJlZC5yZXNvbHZlID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLnJlc29sdmVXaXRoKC4uLikgfQogICAgICAgIC8vIGRlZmVycmVkLnJlamVjdCA9IGZ1bmN0aW9uKCkgeyBkZWZlcnJlZC5yZWplY3RXaXRoKC4uLikgfQogICAgICAgIGRlZmVycmVkW3R1cGxlWzBdXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRlZmVycmVkW3R1cGxlWzBdICsgIldpdGgiXSh0aGlzID09PSBkZWZlcnJlZCA/IHVuZGVmaW5lZCA6IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICAvLyBkZWZlcnJlZC5ub3RpZnlXaXRoID0gbGlzdC5maXJlV2l0aAogICAgICAgIC8vIGRlZmVycmVkLnJlc29sdmVXaXRoID0gbGlzdC5maXJlV2l0aAogICAgICAgIC8vIGRlZmVycmVkLnJlamVjdFdpdGggPSBsaXN0LmZpcmVXaXRoCiAgICAgICAgZGVmZXJyZWRbdHVwbGVbMF0gKyAiV2l0aCJdID0gbGlzdC5maXJlV2l0aDsKICAgICAgfSk7CgogICAgICAvLyBNYWtlIHRoZSBkZWZlcnJlZCBhIHByb21pc2UKICAgICAgcHJvbWlzZS5wcm9taXNlKGRlZmVycmVkKTsKCiAgICAgIC8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkKICAgICAgaWYgKGZ1bmMpIHsKICAgICAgICBmdW5jLmNhbGwoZGVmZXJyZWQsIGRlZmVycmVkKTsKICAgICAgfQoKICAgICAgLy8gQWxsIGRvbmUhCiAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgIH0sCiAgICAvLyBEZWZlcnJlZCBoZWxwZXIKICAgIHdoZW46IGZ1bmN0aW9uIChzaW5nbGVWYWx1ZSkgewogICAgICB2YXIKICAgICAgICAvLyBjb3VudCBvZiB1bmNvbXBsZXRlZCBzdWJvcmRpbmF0ZXMKICAgICAgICByZW1haW5pbmcgPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgIC8vIGNvdW50IG9mIHVucHJvY2Vzc2VkIGFyZ3VtZW50cwogICAgICAgIGkgPSByZW1haW5pbmcsCiAgICAgICAgLy8gc3Vib3JkaW5hdGUgZnVsZmlsbG1lbnQgZGF0YQogICAgICAgIHJlc29sdmVDb250ZXh0cyA9IEFycmF5KGkpLAogICAgICAgIHJlc29sdmVWYWx1ZXMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyksCiAgICAgICAgLy8gdGhlIHByaW1hcnkgRGVmZXJyZWQKICAgICAgICBwcmltYXJ5ID0galF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgLy8gc3Vib3JkaW5hdGUgY2FsbGJhY2sgZmFjdG9yeQogICAgICAgIHVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiAoaSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXNvbHZlQ29udGV4dHNbaV0gPSB0aGlzOwogICAgICAgICAgICByZXNvbHZlVmFsdWVzW2ldID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBzbGljZS5jYWxsKGFyZ3VtZW50cykgOiB2YWx1ZTsKICAgICAgICAgICAgaWYgKCEgLS1yZW1haW5pbmcpIHsKICAgICAgICAgICAgICBwcmltYXJ5LnJlc29sdmVXaXRoKHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgIC8vIFNpbmdsZS0gYW5kIGVtcHR5IGFyZ3VtZW50cyBhcmUgYWRvcHRlZCBsaWtlIFByb21pc2UucmVzb2x2ZQogICAgICBpZiAocmVtYWluaW5nIDw9IDEpIHsKICAgICAgICBhZG9wdFZhbHVlKHNpbmdsZVZhbHVlLCBwcmltYXJ5LmRvbmUodXBkYXRlRnVuYyhpKSkucmVzb2x2ZSwgcHJpbWFyeS5yZWplY3QsICFyZW1haW5pbmcpOwoKICAgICAgICAvLyBVc2UgLnRoZW4oKSB0byB1bndyYXAgc2Vjb25kYXJ5IHRoZW5hYmxlcyAoY2YuIGdoLTMwMDApCiAgICAgICAgaWYgKHByaW1hcnkuc3RhdGUoKSA9PT0gInBlbmRpbmciIHx8IGlzRnVuY3Rpb24ocmVzb2x2ZVZhbHVlc1tpXSAmJiByZXNvbHZlVmFsdWVzW2ldLnRoZW4pKSB7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeS50aGVuKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBNdWx0aXBsZSBhcmd1bWVudHMgYXJlIGFnZ3JlZ2F0ZWQgbGlrZSBQcm9taXNlLmFsbCBhcnJheSBlbGVtZW50cwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgYWRvcHRWYWx1ZShyZXNvbHZlVmFsdWVzW2ldLCB1cGRhdGVGdW5jKGkpLCBwcmltYXJ5LnJlamVjdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHByaW1hcnkucHJvbWlzZSgpOwogICAgfQogIH0pOwoKICAvLyBUaGVzZSB1c3VhbGx5IGluZGljYXRlIGEgcHJvZ3JhbW1lciBtaXN0YWtlIGR1cmluZyBkZXZlbG9wbWVudCwKICAvLyB3YXJuIGFib3V0IHRoZW0gQVNBUCByYXRoZXIgdGhhbiBzd2FsbG93aW5nIHRoZW0gYnkgZGVmYXVsdC4KICB2YXIgcmVycm9yTmFtZXMgPSAvXihFdmFsfEludGVybmFsfFJhbmdlfFJlZmVyZW5jZXxTeW50YXh8VHlwZXxVUkkpRXJyb3IkLzsKCiAgLy8gSWYgYGpRdWVyeS5EZWZlcnJlZC5nZXRFcnJvckhvb2tgIGlzIGRlZmluZWQsIGBhc3luY0Vycm9yYCBpcyBhbiBlcnJvcgogIC8vIGNhcHR1cmVkIGJlZm9yZSB0aGUgYXN5bmMgYmFycmllciB0byBnZXQgdGhlIG9yaWdpbmFsIGVycm9yIGNhdXNlCiAgLy8gd2hpY2ggbWF5IG90aGVyd2lzZSBiZSBoaWRkZW4uCiAgalF1ZXJ5LkRlZmVycmVkLmV4Y2VwdGlvbkhvb2sgPSBmdW5jdGlvbiAoZXJyb3IsIGFzeW5jRXJyb3IpIHsKICAgIC8vIFN1cHBvcnQ6IElFIDggLSA5IG9ubHkKICAgIC8vIENvbnNvbGUgZXhpc3RzIHdoZW4gZGV2IHRvb2xzIGFyZSBvcGVuLCB3aGljaCBjYW4gaGFwcGVuIGF0IGFueSB0aW1lCiAgICBpZiAod2luZG93LmNvbnNvbGUgJiYgd2luZG93LmNvbnNvbGUud2FybiAmJiBlcnJvciAmJiByZXJyb3JOYW1lcy50ZXN0KGVycm9yLm5hbWUpKSB7CiAgICAgIHdpbmRvdy5jb25zb2xlLndhcm4oImpRdWVyeS5EZWZlcnJlZCBleGNlcHRpb246ICIgKyBlcnJvci5tZXNzYWdlLCBlcnJvci5zdGFjaywgYXN5bmNFcnJvcik7CiAgICB9CiAgfTsKICBqUXVlcnkucmVhZHlFeGNlcHRpb24gPSBmdW5jdGlvbiAoZXJyb3IpIHsKICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9KTsKICB9OwoKICAvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKICB2YXIgcmVhZHlMaXN0ID0galF1ZXJ5LkRlZmVycmVkKCk7CiAgalF1ZXJ5LmZuLnJlYWR5ID0gZnVuY3Rpb24gKGZuKSB7CiAgICByZWFkeUxpc3QudGhlbihmbikKCiAgICAvLyBXcmFwIGpRdWVyeS5yZWFkeUV4Y2VwdGlvbiBpbiBhIGZ1bmN0aW9uIHNvIHRoYXQgdGhlIGxvb2t1cAogICAgLy8gaGFwcGVucyBhdCB0aGUgdGltZSBvZiBlcnJvciBoYW5kbGluZyBpbnN0ZWFkIG9mIGNhbGxiYWNrCiAgICAvLyByZWdpc3RyYXRpb24uCiAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIGpRdWVyeS5yZWFkeUV4Y2VwdGlvbihlcnJvcik7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgogICAgaXNSZWFkeTogZmFsc2UsCiAgICAvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCiAgICAvLyB0aGUgcmVhZHkgZXZlbnQgZmlyZXMuIFNlZSB0cmFjLTY3ODEKICAgIHJlYWR5V2FpdDogMSwKICAgIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIHJlYWR5OiBmdW5jdGlvbiAod2FpdCkgewogICAgICAvLyBBYm9ydCBpZiB0aGVyZSBhcmUgcGVuZGluZyBob2xkcyBvciB3ZSdyZSBhbHJlYWR5IHJlYWR5CiAgICAgIGlmICh3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQogICAgICBqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgogICAgICAvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQogICAgICBpZiAod2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCiAgICAgIHJlYWR5TGlzdC5yZXNvbHZlV2l0aChkb2N1bWVudCwgW2pRdWVyeV0pOwogICAgfQogIH0pOwogIGpRdWVyeS5yZWFkeS50aGVuID0gcmVhZHlMaXN0LnRoZW47CgogIC8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCiAgZnVuY3Rpb24gY29tcGxldGVkKCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigibG9hZCIsIGNvbXBsZXRlZCk7CiAgICBqUXVlcnkucmVhZHkoKTsKICB9CgogIC8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkCiAgLy8gYWZ0ZXIgdGhlIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCiAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTAgb25seQogIC8vIE9sZGVyIElFIHNvbWV0aW1lcyBzaWduYWxzICJpbnRlcmFjdGl2ZSIgdG9vIHNvb24KICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAibG9hZGluZyIgJiYgIWRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCkgewogICAgLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CiAgICB3aW5kb3cuc2V0VGltZW91dChqUXVlcnkucmVhZHkpOwogIH0gZWxzZSB7CiAgICAvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgY29tcGxldGVkKTsKCiAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBjb21wbGV0ZWQpOwogIH0KCiAgLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uCiAgLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCiAgdmFyIGFjY2VzcyA9IGZ1bmN0aW9uIChlbGVtcywgZm4sIGtleSwgdmFsdWUsIGNoYWluYWJsZSwgZW1wdHlHZXQsIHJhdykgewogICAgdmFyIGkgPSAwLAogICAgICBsZW4gPSBlbGVtcy5sZW5ndGgsCiAgICAgIGJ1bGsgPSBrZXkgPT0gbnVsbDsKCiAgICAvLyBTZXRzIG1hbnkgdmFsdWVzCiAgICBpZiAodG9UeXBlKGtleSkgPT09ICJvYmplY3QiKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGZvciAoaSBpbiBrZXkpIHsKICAgICAgICBhY2Nlc3MoZWxlbXMsIGZuLCBpLCBrZXlbaV0sIHRydWUsIGVtcHR5R2V0LCByYXcpOwogICAgICB9CgogICAgICAvLyBTZXRzIG9uZSB2YWx1ZQogICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGlmICghaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByYXcgPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChidWxrKSB7CiAgICAgICAgLy8gQnVsayBvcGVyYXRpb25zIHJ1biBhZ2FpbnN0IHRoZSBlbnRpcmUgc2V0CiAgICAgICAgaWYgKHJhdykgewogICAgICAgICAgZm4uY2FsbChlbGVtcywgdmFsdWUpOwogICAgICAgICAgZm4gPSBudWxsOwoKICAgICAgICAgIC8vIC4uLmV4Y2VwdCB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnVsayA9IGZuOwogICAgICAgICAgZm4gPSBmdW5jdGlvbiAoZWxlbSwgX2tleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGJ1bGsuY2FsbChqUXVlcnkoZWxlbSksIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGZuKGVsZW1zW2ldLCBrZXksIHJhdyA/IHZhbHVlIDogdmFsdWUuY2FsbChlbGVtc1tpXSwgaSwgZm4oZWxlbXNbaV0sIGtleSkpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChjaGFpbmFibGUpIHsKICAgICAgcmV0dXJuIGVsZW1zOwogICAgfQoKICAgIC8vIEdldHMKICAgIGlmIChidWxrKSB7CiAgICAgIHJldHVybiBmbi5jYWxsKGVsZW1zKTsKICAgIH0KICAgIHJldHVybiBsZW4gPyBmbihlbGVtc1swXSwga2V5KSA6IGVtcHR5R2V0OwogIH07CgogIC8vIE1hdGNoZXMgZGFzaGVkIHN0cmluZyBmb3IgY2FtZWxpemluZwogIHZhciBybXNQcmVmaXggPSAvXi1tcy0vLAogICAgcmRhc2hBbHBoYSA9IC8tKFthLXpdKS9nOwoKICAvLyBVc2VkIGJ5IGNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKICBmdW5jdGlvbiBmY2FtZWxDYXNlKF9hbGwsIGxldHRlcikgewogICAgcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwogIH0KCiAgLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwogIC8vIFN1cHBvcnQ6IElFIDw9OSAtIDExLCBFZGdlIDEyIC0gMTUKICAvLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAodHJhYy05NTcyKQogIGZ1bmN0aW9uIGNhbWVsQ2FzZShzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogIH0KICB2YXIgYWNjZXB0RGF0YSA9IGZ1bmN0aW9uIChvd25lcikgewogICAgLy8gQWNjZXB0cyBvbmx5OgogICAgLy8gIC0gTm9kZQogICAgLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQogICAgLy8gICAgLSBOb2RlLkRPQ1VNRU5UX05PREUKICAgIC8vICAtIE9iamVjdAogICAgLy8gICAgLSBBbnkKICAgIHJldHVybiBvd25lci5ub2RlVHlwZSA9PT0gMSB8fCBvd25lci5ub2RlVHlwZSA9PT0gOSB8fCAhK293bmVyLm5vZGVUeXBlOwogIH07CiAgZnVuY3Rpb24gRGF0YSgpIHsKICAgIHRoaXMuZXhwYW5kbyA9IGpRdWVyeS5leHBhbmRvICsgRGF0YS51aWQrKzsKICB9CiAgRGF0YS51aWQgPSAxOwogIERhdGEucHJvdG90eXBlID0gewogICAgY2FjaGU6IGZ1bmN0aW9uIChvd25lcikgewogICAgICAvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUKICAgICAgdmFyIHZhbHVlID0gb3duZXJbdGhpcy5leHBhbmRvXTsKCiAgICAgIC8vIElmIG5vdCwgY3JlYXRlIG9uZQogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgdmFsdWUgPSB7fTsKCiAgICAgICAgLy8gV2UgY2FuIGFjY2VwdCBkYXRhIGZvciBub24tZWxlbWVudCBub2RlcyBpbiBtb2Rlcm4gYnJvd3NlcnMsCiAgICAgICAgLy8gYnV0IHdlIHNob3VsZCBub3QsIHNlZSB0cmFjLTgzMzUuCiAgICAgICAgLy8gQWx3YXlzIHJldHVybiBhbiBlbXB0eSBvYmplY3QuCiAgICAgICAgaWYgKGFjY2VwdERhdGEob3duZXIpKSB7CiAgICAgICAgICAvLyBJZiBpdCBpcyBhIG5vZGUgdW5saWtlbHkgdG8gYmUgc3RyaW5naWZ5LWVkIG9yIGxvb3BlZCBvdmVyCiAgICAgICAgICAvLyB1c2UgcGxhaW4gYXNzaWdubWVudAogICAgICAgICAgaWYgKG93bmVyLm5vZGVUeXBlKSB7CiAgICAgICAgICAgIG93bmVyW3RoaXMuZXhwYW5kb10gPSB2YWx1ZTsKCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSBzZWN1cmUgaXQgaW4gYSBub24tZW51bWVyYWJsZSBwcm9wZXJ0eQogICAgICAgICAgICAvLyBjb25maWd1cmFibGUgbXVzdCBiZSB0cnVlIHRvIGFsbG93IHRoZSBwcm9wZXJ0eSB0byBiZQogICAgICAgICAgICAvLyBkZWxldGVkIHdoZW4gZGF0YSBpcyByZW1vdmVkCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3duZXIsIHRoaXMuZXhwYW5kbywgewogICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIChvd25lciwgZGF0YSwgdmFsdWUpIHsKICAgICAgdmFyIHByb3AsCiAgICAgICAgY2FjaGUgPSB0aGlzLmNhY2hlKG93bmVyKTsKCiAgICAgIC8vIEhhbmRsZTogWyBvd25lciwga2V5LCB2YWx1ZSBdIGFyZ3MKICAgICAgLy8gQWx3YXlzIHVzZSBjYW1lbENhc2Uga2V5IChnaC0yMjU3KQogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY2FjaGVbY2FtZWxDYXNlKGRhdGEpXSA9IHZhbHVlOwoKICAgICAgICAvLyBIYW5kbGU6IFsgb3duZXIsIHsgcHJvcGVydGllcyB9IF0gYXJncwogICAgICB9IGVsc2UgewogICAgICAgIC8vIENvcHkgdGhlIHByb3BlcnRpZXMgb25lLWJ5LW9uZSB0byB0aGUgY2FjaGUgb2JqZWN0CiAgICAgICAgZm9yIChwcm9wIGluIGRhdGEpIHsKICAgICAgICAgIGNhY2hlW2NhbWVsQ2FzZShwcm9wKV0gPSBkYXRhW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiAob3duZXIsIGtleSkgewogICAgICByZXR1cm4ga2V5ID09PSB1bmRlZmluZWQgPyB0aGlzLmNhY2hlKG93bmVyKSA6CiAgICAgIC8vIEFsd2F5cyB1c2UgY2FtZWxDYXNlIGtleSAoZ2gtMjI1NykKICAgICAgb3duZXJbdGhpcy5leHBhbmRvXSAmJiBvd25lclt0aGlzLmV4cGFuZG9dW2NhbWVsQ2FzZShrZXkpXTsKICAgIH0sCiAgICBhY2Nlc3M6IGZ1bmN0aW9uIChvd25lciwga2V5LCB2YWx1ZSkgewogICAgICAvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CiAgICAgIC8vCiAgICAgIC8vICAgMS4gTm8ga2V5IHdhcyBzcGVjaWZpZWQKICAgICAgLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCiAgICAgIC8vCiAgICAgIC8vIFRha2UgdGhlICJyZWFkIiBwYXRoIGFuZCBhbGxvdyB0aGUgZ2V0IG1ldGhvZCB0byBkZXRlcm1pbmUKICAgICAgLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIFRoZSBlbnRpcmUgY2FjaGUgb2JqZWN0CiAgICAgIC8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKICAgICAgLy8KICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkIHx8IGtleSAmJiB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KG93bmVyLCBrZXkpOwogICAgICB9CgogICAgICAvLyBXaGVuIHRoZSBrZXkgaXMgbm90IGEgc3RyaW5nLCBvciBib3RoIGEga2V5IGFuZCB2YWx1ZQogICAgICAvLyBhcmUgc3BlY2lmaWVkLCBzZXQgb3IgZXh0ZW5kIChleGlzdGluZyBvYmplY3RzKSB3aXRoIGVpdGhlcjoKICAgICAgLy8KICAgICAgLy8gICAxLiBBbiBvYmplY3Qgb2YgcHJvcGVydGllcwogICAgICAvLyAgIDIuIEEga2V5IGFuZCB2YWx1ZQogICAgICAvLwogICAgICB0aGlzLnNldChvd25lciwga2V5LCB2YWx1ZSk7CgogICAgICAvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCiAgICAgIC8vIHJldHVybiB0aGUgZXhwZWN0ZWQgZGF0YSBiYXNlZCBvbiB3aGljaCBwYXRoIHdhcyB0YWtlblsqXQogICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IHZhbHVlIDoga2V5OwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gKG93bmVyLCBrZXkpIHsKICAgICAgdmFyIGksCiAgICAgICAgY2FjaGUgPSBvd25lclt0aGlzLmV4cGFuZG9dOwogICAgICBpZiAoY2FjaGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoa2V5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBTdXBwb3J0IGFycmF5IG9yIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmcgb2Yga2V5cwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGtleSkpIHsKICAgICAgICAgIC8vIElmIGtleSBpcyBhbiBhcnJheSBvZiBrZXlzLi4uCiAgICAgICAgICAvLyBXZSBhbHdheXMgc2V0IGNhbWVsQ2FzZSBrZXlzLCBzbyByZW1vdmUgdGhhdC4KICAgICAgICAgIGtleSA9IGtleS5tYXAoY2FtZWxDYXNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAga2V5ID0gY2FtZWxDYXNlKGtleSk7CgogICAgICAgICAgLy8gSWYgYSBrZXkgd2l0aCB0aGUgc3BhY2VzIGV4aXN0cywgdXNlIGl0LgogICAgICAgICAgLy8gT3RoZXJ3aXNlLCBjcmVhdGUgYW4gYXJyYXkgYnkgbWF0Y2hpbmcgbm9uLXdoaXRlc3BhY2UKICAgICAgICAgIGtleSA9IGtleSBpbiBjYWNoZSA/IFtrZXldIDoga2V5Lm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFtdOwogICAgICAgIH0KICAgICAgICBpID0ga2V5Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBkZWxldGUgY2FjaGVba2V5W2ldXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiB0aGVyZSdzIG5vIG1vcmUgZGF0YQogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQgfHwgalF1ZXJ5LmlzRW1wdHlPYmplY3QoY2FjaGUpKSB7CiAgICAgICAgLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NQogICAgICAgIC8vIFdlYmtpdCAmIEJsaW5rIHBlcmZvcm1hbmNlIHN1ZmZlcnMgd2hlbiBkZWxldGluZyBwcm9wZXJ0aWVzCiAgICAgICAgLy8gZnJvbSBET00gbm9kZXMsIHNvIHNldCB0byB1bmRlZmluZWQgaW5zdGVhZAogICAgICAgIC8vIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTM3ODYwNyAoYnVnIHJlc3RyaWN0ZWQpCiAgICAgICAgaWYgKG93bmVyLm5vZGVUeXBlKSB7CiAgICAgICAgICBvd25lclt0aGlzLmV4cGFuZG9dID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxldGUgb3duZXJbdGhpcy5leHBhbmRvXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBoYXNEYXRhOiBmdW5jdGlvbiAob3duZXIpIHsKICAgICAgdmFyIGNhY2hlID0gb3duZXJbdGhpcy5leHBhbmRvXTsKICAgICAgcmV0dXJuIGNhY2hlICE9PSB1bmRlZmluZWQgJiYgIWpRdWVyeS5pc0VtcHR5T2JqZWN0KGNhY2hlKTsKICAgIH0KICB9OwogIHZhciBkYXRhUHJpdiA9IG5ldyBEYXRhKCk7CiAgdmFyIGRhdGFVc2VyID0gbmV3IERhdGEoKTsKCiAgLy8JSW1wbGVtZW50YXRpb24gU3VtbWFyeQogIC8vCiAgLy8JMS4gRW5mb3JjZSBBUEkgc3VyZmFjZSBhbmQgc2VtYW50aWMgY29tcGF0aWJpbGl0eSB3aXRoIDEuOS54IGJyYW5jaAogIC8vCTIuIEltcHJvdmUgdGhlIG1vZHVsZSdzIG1haW50YWluYWJpbGl0eSBieSByZWR1Y2luZyB0aGUgc3RvcmFnZQogIC8vCQlwYXRocyB0byBhIHNpbmdsZSBtZWNoYW5pc20uCiAgLy8JMy4gVXNlIHRoZSBzYW1lIHNpbmdsZSBtZWNoYW5pc20gdG8gc3VwcG9ydCAicHJpdmF0ZSIgYW5kICJ1c2VyIiBkYXRhLgogIC8vCTQuIF9OZXZlcl8gZXhwb3NlICJwcml2YXRlIiBkYXRhIHRvIHVzZXIgY29kZSAoVE9ETzogRHJvcCBfZGF0YSwgX3JlbW92ZURhdGEpCiAgLy8JNS4gQXZvaWQgZXhwb3NpbmcgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvbiB1c2VyIG9iamVjdHMgKGVnLiBleHBhbmRvIHByb3BlcnRpZXMpCiAgLy8JNi4gUHJvdmlkZSBhIGNsZWFyIHBhdGggZm9yIGltcGxlbWVudGF0aW9uIHVwZ3JhZGUgdG8gV2Vha01hcCBpbiAyMDE0CgogIHZhciByYnJhY2UgPSAvXig/Olx7W1x3XFddKlx9fFxbW1x3XFddKlxdKSQvLAogICAgcm11bHRpRGFzaCA9IC9bQS1aXS9nOwogIGZ1bmN0aW9uIGdldERhdGEoZGF0YSkgewogICAgaWYgKGRhdGEgPT09ICJ0cnVlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChkYXRhID09PSAiZmFsc2UiKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChkYXRhID09PSAibnVsbCIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKICAgIGlmIChkYXRhID09PSArZGF0YSArICIiKSB7CiAgICAgIHJldHVybiArZGF0YTsKICAgIH0KICAgIGlmIChyYnJhY2UudGVzdChkYXRhKSkgewogICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKTsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICBmdW5jdGlvbiBkYXRhQXR0cihlbGVtLCBrZXksIGRhdGEpIHsKICAgIHZhciBuYW1lOwoKICAgIC8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGludGVybmFsbHksIHRyeSB0byBmZXRjaCBhbnkKICAgIC8vIGRhdGEgZnJvbSB0aGUgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZQogICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgIG5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2Uocm11bHRpRGFzaCwgIi0kJiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAic3RyaW5nIikgewogICAgICAgIHRyeSB7CiAgICAgICAgICBkYXRhID0gZ2V0RGF0YShkYXRhKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICAvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKICAgICAgICBkYXRhVXNlci5zZXQoZWxlbSwga2V5LCBkYXRhKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBoYXNEYXRhOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZGF0YVVzZXIuaGFzRGF0YShlbGVtKSB8fCBkYXRhUHJpdi5oYXNEYXRhKGVsZW0pOwogICAgfSwKICAgIGRhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBkYXRhKSB7CiAgICAgIHJldHVybiBkYXRhVXNlci5hY2Nlc3MoZWxlbSwgbmFtZSwgZGF0YSk7CiAgICB9LAogICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgZGF0YVVzZXIucmVtb3ZlKGVsZW0sIG5hbWUpOwogICAgfSwKICAgIC8vIFRPRE86IE5vdyB0aGF0IGFsbCBjYWxscyB0byBfZGF0YSBhbmQgX3JlbW92ZURhdGEgaGF2ZSBiZWVuIHJlcGxhY2VkCiAgICAvLyB3aXRoIGRpcmVjdCBjYWxscyB0byBkYXRhUHJpdiBtZXRob2RzLCB0aGVzZSBjYW4gYmUgZGVwcmVjYXRlZC4KICAgIF9kYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSkgewogICAgICByZXR1cm4gZGF0YVByaXYuYWNjZXNzKGVsZW0sIG5hbWUsIGRhdGEpOwogICAgfSwKICAgIF9yZW1vdmVEYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICBkYXRhUHJpdi5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBkYXRhOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgaSwKICAgICAgICBuYW1lLAogICAgICAgIGRhdGEsCiAgICAgICAgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgYXR0cnMgPSBlbGVtICYmIGVsZW0uYXR0cmlidXRlczsKCiAgICAgIC8vIEdldHMgYWxsIHZhbHVlcwogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAodGhpcy5sZW5ndGgpIHsKICAgICAgICAgIGRhdGEgPSBkYXRhVXNlci5nZXQoZWxlbSk7CiAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhZGF0YVByaXYuZ2V0KGVsZW0sICJoYXNEYXRhQXR0cnMiKSkgewogICAgICAgICAgICBpID0gYXR0cnMubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTEgb25seQogICAgICAgICAgICAgIC8vIFRoZSBhdHRycyBlbGVtZW50cyBjYW4gYmUgbnVsbCAodHJhYy0xNDg5NCkKICAgICAgICAgICAgICBpZiAoYXR0cnNbaV0pIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyc1tpXS5uYW1lOwogICAgICAgICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZigiZGF0YS0iKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUuc2xpY2UoNSkpOwogICAgICAgICAgICAgICAgICBkYXRhQXR0cihlbGVtLCBuYW1lLCBkYXRhW25hbWVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YVByaXYuc2V0KGVsZW0sICJoYXNEYXRhQXR0cnMiLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KCiAgICAgIC8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAib2JqZWN0IikgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YVVzZXIuc2V0KHRoaXMsIGtleSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgZGF0YTsKCiAgICAgICAgLy8gVGhlIGNhbGxpbmcgalF1ZXJ5IG9iamVjdCAoZWxlbWVudCBtYXRjaGVzKSBpcyBub3QgZW1wdHkKICAgICAgICAvLyAoYW5kIHRoZXJlZm9yZSBoYXMgYW4gZWxlbWVudCBhcHBlYXJzIGF0IHRoaXNbIDAgXSkgYW5kIHRoZQogICAgICAgIC8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0CiAgICAgICAgLy8gd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgZm9yIGVsZW0gPSB0aGlzWyAwIF0gd2hpY2ggd2lsbAogICAgICAgIC8vIHRocm93IGFuIGV4Y2VwdGlvbiBpZiBhbiBhdHRlbXB0IHRvIHJlYWQgYSBkYXRhIGNhY2hlIGlzIG1hZGUuCiAgICAgICAgaWYgKGVsZW0gJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gQXR0ZW1wdCB0byBnZXQgZGF0YSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgLy8gVGhlIGtleSB3aWxsIGFsd2F5cyBiZSBjYW1lbENhc2VkIGluIERhdGEKICAgICAgICAgIGRhdGEgPSBkYXRhVXNlci5nZXQoZWxlbSwga2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluCiAgICAgICAgICAvLyBIVE1MNSBjdXN0b20gZGF0YS0qIGF0dHJzCiAgICAgICAgICBkYXRhID0gZGF0YUF0dHIoZWxlbSwga2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gV2UgdHJpZWQgcmVhbGx5IGhhcmQsIGJ1dCB0aGUgZGF0YSBkb2Vzbid0IGV4aXN0LgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gU2V0IHRoZSBkYXRhLi4uCiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIFdlIGFsd2F5cyBzdG9yZSB0aGUgY2FtZWxDYXNlZCBrZXkKICAgICAgICAgIGRhdGFVc2VyLnNldCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCB0cnVlKTsKICAgIH0sCiAgICByZW1vdmVEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRhdGFVc2VyLnJlbW92ZSh0aGlzLCBrZXkpOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIHF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgZGF0YSkgewogICAgICB2YXIgcXVldWU7CiAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgdHlwZSA9ICh0eXBlIHx8ICJmeCIpICsgInF1ZXVlIjsKICAgICAgICBxdWV1ZSA9IGRhdGFQcml2LmdldChlbGVtLCB0eXBlKTsKCiAgICAgICAgLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAogICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICBpZiAoIXF1ZXVlIHx8IEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgcXVldWUgPSBkYXRhUHJpdi5hY2Nlc3MoZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWV1ZS5wdXNoKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcXVldWUgfHwgW107CiAgICAgIH0KICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgICB2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoZWxlbSwgdHlwZSksCiAgICAgICAgc3RhcnRMZW5ndGggPSBxdWV1ZS5sZW5ndGgsCiAgICAgICAgZm4gPSBxdWV1ZS5zaGlmdCgpLAogICAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sIHR5cGUpLAogICAgICAgIG5leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZShlbGVtLCB0eXBlKTsKICAgICAgICB9OwoKICAgICAgLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbAogICAgICBpZiAoZm4gPT09ICJpbnByb2dyZXNzIikgewogICAgICAgIGZuID0gcXVldWUuc2hpZnQoKTsKICAgICAgICBzdGFydExlbmd0aC0tOwogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIC8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKICAgICAgICAvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCiAgICAgICAgaWYgKHR5cGUgPT09ICJmeCIpIHsKICAgICAgICAgIHF1ZXVlLnVuc2hpZnQoImlucHJvZ3Jlc3MiKTsKICAgICAgICB9CgogICAgICAgIC8vIENsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KICAgICAgICBkZWxldGUgaG9va3Muc3RvcDsKICAgICAgICBmbi5jYWxsKGVsZW0sIG5leHQsIGhvb2tzKTsKICAgICAgfQogICAgICBpZiAoIXN0YXJ0TGVuZ3RoICYmIGhvb2tzKSB7CiAgICAgICAgaG9va3MuZW1wdHkuZmlyZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gTm90IHB1YmxpYyAtIGdlbmVyYXRlIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybiB0aGUgY3VycmVudCBvbmUKICAgIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB2YXIga2V5ID0gdHlwZSArICJxdWV1ZUhvb2tzIjsKICAgICAgcmV0dXJuIGRhdGFQcml2LmdldChlbGVtLCBrZXkpIHx8IGRhdGFQcml2LmFjY2VzcyhlbGVtLCBrZXksIHsKICAgICAgICBlbXB0eTogalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKS5hZGQoZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YVByaXYucmVtb3ZlKGVsZW0sIFt0eXBlICsgInF1ZXVlIiwga2V5XSk7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBxdWV1ZTogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIHNldHRlciA9IDI7CiAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIpIHsKICAgICAgICBkYXRhID0gdHlwZTsKICAgICAgICB0eXBlID0gImZ4IjsKICAgICAgICBzZXR0ZXItLTsKICAgICAgfQogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlcikgewogICAgICAgIHJldHVybiBqUXVlcnkucXVldWUodGhpc1swXSwgdHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBkYXRhKTsKCiAgICAgICAgLy8gRW5zdXJlIGEgaG9va3MgZm9yIHRoaXMgcXVldWUKICAgICAgICBqUXVlcnkuX3F1ZXVlSG9va3ModGhpcywgdHlwZSk7CiAgICAgICAgaWYgKHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIikgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgfSk7CiAgICB9LAogICAgY2xlYXJRdWV1ZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMucXVldWUodHlwZSB8fCAiZngiLCBbXSk7CiAgICB9LAogICAgLy8gR2V0IGEgcHJvbWlzZSByZXNvbHZlZCB3aGVuIHF1ZXVlcyBvZiBhIGNlcnRhaW4gdHlwZQogICAgLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpCiAgICBwcm9taXNlOiBmdW5jdGlvbiAodHlwZSwgb2JqKSB7CiAgICAgIHZhciB0bXAsCiAgICAgICAgY291bnQgPSAxLAogICAgICAgIGRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgZWxlbWVudHMgPSB0aGlzLAogICAgICAgIGkgPSB0aGlzLmxlbmd0aCwKICAgICAgICByZXNvbHZlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCEgLS1jb3VudCkgewogICAgICAgICAgICBkZWZlci5yZXNvbHZlV2l0aChlbGVtZW50cywgW2VsZW1lbnRzXSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgIG9iaiA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdG1wID0gZGF0YVByaXYuZ2V0KGVsZW1lbnRzW2ldLCB0eXBlICsgInF1ZXVlSG9va3MiKTsKICAgICAgICBpZiAodG1wICYmIHRtcC5lbXB0eSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICAgIHRtcC5lbXB0eS5hZGQocmVzb2x2ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc29sdmUoKTsKICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2Uob2JqKTsKICAgIH0KICB9KTsKICB2YXIgcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlOwogIHZhciByY3NzTnVtID0gbmV3IFJlZ0V4cCgiXig/OihbKy1dKT18KSgiICsgcG51bSArICIpKFthLXolXSopJCIsICJpIik7CiAgdmFyIGNzc0V4cGFuZCA9IFsiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0Il07CiAgdmFyIGRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICB2YXIgaXNBdHRhY2hlZCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKTsKICAgIH0sCiAgICBjb21wb3NlZCA9IHsKICAgICAgY29tcG9zZWQ6IHRydWUKICAgIH07CgogIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSssIEVkZ2UgMTIgLSAxOCssIGlPUyAxMC4wIC0gMTAuMiBvbmx5CiAgLy8gQ2hlY2sgYXR0YWNobWVudCBhY3Jvc3Mgc2hhZG93IERPTSBib3VuZGFyaWVzIHdoZW4gcG9zc2libGUgKGdoLTM1MDQpCiAgLy8gU3VwcG9ydDogaU9TIDEwLjAtMTAuMiBvbmx5CiAgLy8gRWFybHkgaU9TIDEwIHZlcnNpb25zIHN1cHBvcnQgYGF0dGFjaFNoYWRvd2AgYnV0IG5vdCBgZ2V0Um9vdE5vZGVgLAogIC8vIGxlYWRpbmcgdG8gZXJyb3JzLiBXZSBuZWVkIHRvIGNoZWNrIGZvciBgZ2V0Um9vdE5vZGVgLgogIGlmIChkb2N1bWVudEVsZW1lbnQuZ2V0Um9vdE5vZGUpIHsKICAgIGlzQXR0YWNoZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSkgfHwgZWxlbS5nZXRSb290Tm9kZShjb21wb3NlZCkgPT09IGVsZW0ub3duZXJEb2N1bWVudDsKICAgIH07CiAgfQogIHZhciBpc0hpZGRlbldpdGhpblRyZWUgPSBmdW5jdGlvbiAoZWxlbSwgZWwpIHsKICAgIC8vIGlzSGlkZGVuV2l0aGluVHJlZSBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOwogICAgLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CiAgICBlbGVtID0gZWwgfHwgZWxlbTsKCiAgICAvLyBJbmxpbmUgc3R5bGUgdHJ1bXBzIGFsbAogICAgcmV0dXJuIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYKICAgIC8vIE90aGVyd2lzZSwgY2hlY2sgY29tcHV0ZWQgc3R5bGUKICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00MyAtIDQ1CiAgICAvLyBEaXNjb25uZWN0ZWQgZWxlbWVudHMgY2FuIGhhdmUgY29tcHV0ZWQgZGlzcGxheTogbm9uZSwgc28gZmlyc3QgY29uZmlybSB0aGF0IGVsZW0gaXMKICAgIC8vIGluIHRoZSBkb2N1bWVudC4KICAgIGlzQXR0YWNoZWQoZWxlbSkgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpID09PSAibm9uZSI7CiAgfTsKICBmdW5jdGlvbiBhZGp1c3RDU1MoZWxlbSwgcHJvcCwgdmFsdWVQYXJ0cywgdHdlZW4pIHsKICAgIHZhciBhZGp1c3RlZCwKICAgICAgc2NhbGUsCiAgICAgIG1heEl0ZXJhdGlvbnMgPSAyMCwKICAgICAgY3VycmVudFZhbHVlID0gdHdlZW4gPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHR3ZWVuLmN1cigpOwogICAgICB9IDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBqUXVlcnkuY3NzKGVsZW0sIHByb3AsICIiKTsKICAgICAgfSwKICAgICAgaW5pdGlhbCA9IGN1cnJlbnRWYWx1ZSgpLAogICAgICB1bml0ID0gdmFsdWVQYXJ0cyAmJiB2YWx1ZVBhcnRzWzNdIHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gIiIgOiAicHgiKSwKICAgICAgLy8gU3RhcnRpbmcgdmFsdWUgY29tcHV0YXRpb24gaXMgcmVxdWlyZWQgZm9yIHBvdGVudGlhbCB1bml0IG1pc21hdGNoZXMKICAgICAgaW5pdGlhbEluVW5pdCA9IGVsZW0ubm9kZVR5cGUgJiYgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gfHwgdW5pdCAhPT0gInB4IiAmJiAraW5pdGlhbCkgJiYgcmNzc051bS5leGVjKGpRdWVyeS5jc3MoZWxlbSwgcHJvcCkpOwogICAgaWYgKGluaXRpYWxJblVuaXQgJiYgaW5pdGlhbEluVW5pdFszXSAhPT0gdW5pdCkgewogICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDw9NTQKICAgICAgLy8gSGFsdmUgdGhlIGl0ZXJhdGlvbiB0YXJnZXQgdmFsdWUgdG8gcHJldmVudCBpbnRlcmZlcmVuY2UgZnJvbSBDU1MgdXBwZXIgYm91bmRzIChnaC0yMTQ0KQogICAgICBpbml0aWFsID0gaW5pdGlhbCAvIDI7CgogICAgICAvLyBUcnVzdCB1bml0cyByZXBvcnRlZCBieSBqUXVlcnkuY3NzCiAgICAgIHVuaXQgPSB1bml0IHx8IGluaXRpYWxJblVuaXRbM107CgogICAgICAvLyBJdGVyYXRpdmVseSBhcHByb3hpbWF0ZSBmcm9tIGEgbm9uemVybyBzdGFydGluZyBwb2ludAogICAgICBpbml0aWFsSW5Vbml0ID0gK2luaXRpYWwgfHwgMTsKICAgICAgd2hpbGUgKG1heEl0ZXJhdGlvbnMtLSkgewogICAgICAgIC8vIEV2YWx1YXRlIGFuZCB1cGRhdGUgb3VyIGJlc3QgZ3Vlc3MgKGRvdWJsaW5nIGd1ZXNzZXMgdGhhdCB6ZXJvIG91dCkuCiAgICAgICAgLy8gRmluaXNoIGlmIHRoZSBzY2FsZSBlcXVhbHMgb3IgY3Jvc3NlcyAxIChtYWtpbmcgdGhlIG9sZCpuZXcgcHJvZHVjdCBub24tcG9zaXRpdmUpLgogICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wLCBpbml0aWFsSW5Vbml0ICsgdW5pdCk7CiAgICAgICAgaWYgKCgxIC0gc2NhbGUpICogKDEgLSAoc2NhbGUgPSBjdXJyZW50VmFsdWUoKSAvIGluaXRpYWwgfHwgMC41KSkgPD0gMCkgewogICAgICAgICAgbWF4SXRlcmF0aW9ucyA9IDA7CiAgICAgICAgfQogICAgICAgIGluaXRpYWxJblVuaXQgPSBpbml0aWFsSW5Vbml0IC8gc2NhbGU7CiAgICAgIH0KICAgICAgaW5pdGlhbEluVW5pdCA9IGluaXRpYWxJblVuaXQgKiAyOwogICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgcHJvcCwgaW5pdGlhbEluVW5pdCArIHVuaXQpOwoKICAgICAgLy8gTWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgdHdlZW4gcHJvcGVydGllcyBsYXRlciBvbgogICAgICB2YWx1ZVBhcnRzID0gdmFsdWVQYXJ0cyB8fCBbXTsKICAgIH0KICAgIGlmICh2YWx1ZVBhcnRzKSB7CiAgICAgIGluaXRpYWxJblVuaXQgPSAraW5pdGlhbEluVW5pdCB8fCAraW5pdGlhbCB8fCAwOwoKICAgICAgLy8gQXBwbHkgcmVsYXRpdmUgb2Zmc2V0ICgrPS8tPSkgaWYgc3BlY2lmaWVkCiAgICAgIGFkanVzdGVkID0gdmFsdWVQYXJ0c1sxXSA/IGluaXRpYWxJblVuaXQgKyAodmFsdWVQYXJ0c1sxXSArIDEpICogdmFsdWVQYXJ0c1syXSA6ICt2YWx1ZVBhcnRzWzJdOwogICAgICBpZiAodHdlZW4pIHsKICAgICAgICB0d2Vlbi51bml0ID0gdW5pdDsKICAgICAgICB0d2Vlbi5zdGFydCA9IGluaXRpYWxJblVuaXQ7CiAgICAgICAgdHdlZW4uZW5kID0gYWRqdXN0ZWQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhZGp1c3RlZDsKICB9CiAgdmFyIGRlZmF1bHREaXNwbGF5TWFwID0ge307CiAgZnVuY3Rpb24gZ2V0RGVmYXVsdERpc3BsYXkoZWxlbSkgewogICAgdmFyIHRlbXAsCiAgICAgIGRvYyA9IGVsZW0ub3duZXJEb2N1bWVudCwKICAgICAgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLAogICAgICBkaXNwbGF5ID0gZGVmYXVsdERpc3BsYXlNYXBbbm9kZU5hbWVdOwogICAgaWYgKGRpc3BsYXkpIHsKICAgICAgcmV0dXJuIGRpc3BsYXk7CiAgICB9CiAgICB0ZW1wID0gZG9jLmJvZHkuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpKTsKICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKHRlbXAsICJkaXNwbGF5Iik7CiAgICB0ZW1wLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGVtcCk7CiAgICBpZiAoZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgIGRpc3BsYXkgPSAiYmxvY2siOwogICAgfQogICAgZGVmYXVsdERpc3BsYXlNYXBbbm9kZU5hbWVdID0gZGlzcGxheTsKICAgIHJldHVybiBkaXNwbGF5OwogIH0KICBmdW5jdGlvbiBzaG93SGlkZShlbGVtZW50cywgc2hvdykgewogICAgdmFyIGRpc3BsYXksCiAgICAgIGVsZW0sCiAgICAgIHZhbHVlcyA9IFtdLAogICAgICBpbmRleCA9IDAsCiAgICAgIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCiAgICAvLyBEZXRlcm1pbmUgbmV3IGRpc3BsYXkgdmFsdWUgZm9yIGVsZW1lbnRzIHRoYXQgbmVlZCB0byBjaGFuZ2UKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBlbGVtID0gZWxlbWVudHNbaW5kZXhdOwogICAgICBpZiAoIWVsZW0uc3R5bGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBkaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5OwogICAgICBpZiAoc2hvdykgewogICAgICAgIC8vIFNpbmNlIHdlIGZvcmNlIHZpc2liaWxpdHkgdXBvbiBjYXNjYWRlLWhpZGRlbiBlbGVtZW50cywgYW4gaW1tZWRpYXRlIChhbmQgc2xvdykKICAgICAgICAvLyBjaGVjayBpcyByZXF1aXJlZCBpbiB0aGlzIGZpcnN0IGxvb3AgdW5sZXNzIHdlIGhhdmUgYSBub25lbXB0eSBkaXNwbGF5IHZhbHVlIChlaXRoZXIKICAgICAgICAvLyBpbmxpbmUgb3IgYWJvdXQtdG8tYmUtcmVzdG9yZWQpCiAgICAgICAgaWYgKGRpc3BsYXkgPT09ICJub25lIikgewogICAgICAgICAgdmFsdWVzW2luZGV4XSA9IGRhdGFQcml2LmdldChlbGVtLCAiZGlzcGxheSIpIHx8IG51bGw7CiAgICAgICAgICBpZiAoIXZhbHVlc1tpbmRleF0pIHsKICAgICAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuV2l0aGluVHJlZShlbGVtKSkgewogICAgICAgICAgdmFsdWVzW2luZGV4XSA9IGdldERlZmF1bHREaXNwbGF5KGVsZW0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZGlzcGxheSAhPT0gIm5vbmUiKSB7CiAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gIm5vbmUiOwoKICAgICAgICAgIC8vIFJlbWVtYmVyIHdoYXQgd2UncmUgb3ZlcndyaXRpbmcKICAgICAgICAgIGRhdGFQcml2LnNldChlbGVtLCAiZGlzcGxheSIsIGRpc3BsYXkpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIFNldCB0aGUgZGlzcGxheSBvZiB0aGUgZWxlbWVudHMgaW4gYSBzZWNvbmQgbG9vcCB0byBhdm9pZCBjb25zdGFudCByZWZsb3cKICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBpZiAodmFsdWVzW2luZGV4XSAhPSBudWxsKSB7CiAgICAgICAgZWxlbWVudHNbaW5kZXhdLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZXNbaW5kZXhdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlbWVudHM7CiAgfQogIGpRdWVyeS5mbi5leHRlbmQoewogICAgc2hvdzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2hvd0hpZGUodGhpcywgdHJ1ZSk7CiAgICB9LAogICAgaGlkZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2hvd0hpZGUodGhpcyk7CiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgaWYgKHR5cGVvZiBzdGF0ZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoaXNIaWRkZW5XaXRoaW5UcmVlKHRoaXMpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuc2hvdygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuaGlkZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgdmFyIHJjaGVja2FibGVUeXBlID0gL14oPzpjaGVja2JveHxyYWRpbykkL2k7CiAgdmFyIHJ0YWdOYW1lID0gLzwoW2Etel1bXlwvXDA+XHgyMFx0XHJcblxmXSopL2k7CiAgdmFyIHJzY3JpcHRUeXBlID0gL14kfF5tb2R1bGUkfFwvKD86amF2YXxlY21hKXNjcmlwdC9pOwogIChmdW5jdGlvbiAoKSB7CiAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgIGRpdiA9IGZyYWdtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKSwKICAgICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHkKICAgIC8vIENoZWNrIHN0YXRlIGxvc3QgaWYgdGhlIG5hbWUgaXMgc2V0ICh0cmFjLTExMjE3KQogICAgLy8gU3VwcG9ydDogV2luZG93cyBXZWIgQXBwcyAoV1dBKQogICAgLy8gYG5hbWVgIGFuZCBgdHlwZWAgbXVzdCB1c2UgLnNldEF0dHJpYnV0ZSBmb3IgV1dBICh0cmFjLTE0OTAxKQogICAgaW5wdXQuc2V0QXR0cmlidXRlKCJ0eXBlIiwgInJhZGlvIik7CiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoImNoZWNrZWQiLCAiY2hlY2tlZCIpOwogICAgaW5wdXQuc2V0QXR0cmlidXRlKCJuYW1lIiwgInQiKTsKICAgIGRpdi5hcHBlbmRDaGlsZChpbnB1dCk7CgogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMSBvbmx5CiAgICAvLyBPbGRlciBXZWJLaXQgZG9lc24ndCBjbG9uZSBjaGVja2VkIHN0YXRlIGNvcnJlY3RseSBpbiBmcmFnbWVudHMKICAgIHN1cHBvcnQuY2hlY2tDbG9uZSA9IGRpdi5jbG9uZU5vZGUodHJ1ZSkuY2xvbmVOb2RlKHRydWUpLmxhc3RDaGlsZC5jaGVja2VkOwoKICAgIC8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQogICAgLy8gTWFrZSBzdXJlIHRleHRhcmVhIChhbmQgY2hlY2tib3gpIGRlZmF1bHRWYWx1ZSBpcyBwcm9wZXJseSBjbG9uZWQKICAgIGRpdi5pbm5lckhUTUwgPSAiPHRleHRhcmVhPng8L3RleHRhcmVhPiI7CiAgICBzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkID0gISFkaXYuY2xvbmVOb2RlKHRydWUpLmxhc3RDaGlsZC5kZWZhdWx0VmFsdWU7CgogICAgLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKICAgIC8vIElFIDw9OSByZXBsYWNlcyA8b3B0aW9uPiB0YWdzIHdpdGggdGhlaXIgY29udGVudHMgd2hlbiBpbnNlcnRlZCBvdXRzaWRlIG9mCiAgICAvLyB0aGUgc2VsZWN0IGVsZW1lbnQuCiAgICBkaXYuaW5uZXJIVE1MID0gIjxvcHRpb24+PC9vcHRpb24+IjsKICAgIHN1cHBvcnQub3B0aW9uID0gISFkaXYubGFzdENoaWxkOwogIH0pKCk7CgogIC8vIFdlIGhhdmUgdG8gY2xvc2UgdGhlc2UgdGFncyB0byBzdXBwb3J0IFhIVE1MICh0cmFjLTEzMjAwKQogIHZhciB3cmFwTWFwID0gewogICAgLy8gWEhUTUwgcGFyc2VycyBkbyBub3QgbWFnaWNhbGx5IGluc2VydCBlbGVtZW50cyBpbiB0aGUKICAgIC8vIHNhbWUgd2F5IHRoYXQgdGFnIHNvdXAgcGFyc2VycyBkby4gU28gd2UgY2Fubm90IHNob3J0ZW4KICAgIC8vIHRoaXMgYnkgb21pdHRpbmcgPHRib2R5PiBvciBvdGhlciByZXF1aXJlZCBlbGVtZW50cy4KICAgIHRoZWFkOiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSwKICAgIGNvbDogWzIsICI8dGFibGU+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+Il0sCiAgICB0cjogWzIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+Il0sCiAgICB0ZDogWzMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+Il0sCiAgICBfZGVmYXVsdDogWzAsICIiLCAiIl0KICB9OwogIHdyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CiAgd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgogIC8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CiAgaWYgKCFzdXBwb3J0Lm9wdGlvbikgewogICAgd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uID0gWzEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiJdOwogIH0KICBmdW5jdGlvbiBnZXRBbGwoY29udGV4dCwgdGFnKSB7CiAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5CiAgICAvLyBVc2UgdHlwZW9mIHRvIGF2b2lkIHplcm8tYXJndW1lbnQgbWV0aG9kIGludm9jYXRpb24gb24gaG9zdCBvYmplY3RzICh0cmFjLTE1MTUxKQogICAgdmFyIHJldDsKICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcgfHwgIioiKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0ID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHRhZyB8fCAiKiIpOwogICAgfSBlbHNlIHsKICAgICAgcmV0ID0gW107CiAgICB9CiAgICBpZiAodGFnID09PSB1bmRlZmluZWQgfHwgdGFnICYmIG5vZGVOYW1lKGNvbnRleHQsIHRhZykpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5tZXJnZShbY29udGV4dF0sIHJldCk7CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KCiAgLy8gTWFyayBzY3JpcHRzIGFzIGhhdmluZyBhbHJlYWR5IGJlZW4gZXZhbHVhdGVkCiAgZnVuY3Rpb24gc2V0R2xvYmFsRXZhbChlbGVtcywgcmVmRWxlbWVudHMpIHsKICAgIHZhciBpID0gMCwKICAgICAgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGRhdGFQcml2LnNldChlbGVtc1tpXSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgZGF0YVByaXYuZ2V0KHJlZkVsZW1lbnRzW2ldLCAiZ2xvYmFsRXZhbCIpKTsKICAgIH0KICB9CiAgdmFyIHJodG1sID0gLzx8JiM/XHcrOy87CiAgZnVuY3Rpb24gYnVpbGRGcmFnbWVudChlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uLCBpZ25vcmVkKSB7CiAgICB2YXIgZWxlbSwKICAgICAgdG1wLAogICAgICB0YWcsCiAgICAgIHdyYXAsCiAgICAgIGF0dGFjaGVkLAogICAgICBqLAogICAgICBmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICBub2RlcyA9IFtdLAogICAgICBpID0gMCwKICAgICAgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGVsZW0gPSBlbGVtc1tpXTsKICAgICAgaWYgKGVsZW0gfHwgZWxlbSA9PT0gMCkgewogICAgICAgIC8vIEFkZCBub2RlcyBkaXJlY3RseQogICAgICAgIGlmICh0b1R5cGUoZWxlbSkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKICAgICAgICAgIC8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKICAgICAgICAgIGpRdWVyeS5tZXJnZShub2RlcywgZWxlbS5ub2RlVHlwZSA/IFtlbGVtXSA6IGVsZW0pOwoKICAgICAgICAgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgICAgIH0gZWxzZSBpZiAoIXJodG1sLnRlc3QoZWxlbSkpIHsKICAgICAgICAgIG5vZGVzLnB1c2goY29udGV4dC5jcmVhdGVUZXh0Tm9kZShlbGVtKSk7CgogICAgICAgICAgLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKCiAgICAgICAgICAvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uCiAgICAgICAgICB0YWcgPSAocnRhZ05hbWUuZXhlYyhlbGVtKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgICAgICAgIHRtcC5pbm5lckhUTUwgPSB3cmFwWzFdICsgalF1ZXJ5Lmh0bWxQcmVmaWx0ZXIoZWxlbSkgKyB3cmFwWzJdOwoKICAgICAgICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgICAgICAgaiA9IHdyYXBbMF07CiAgICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CiAgICAgICAgICAvLyBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzIG9uIGFuY2llbnQgV2ViS2l0CiAgICAgICAgICBqUXVlcnkubWVyZ2Uobm9kZXMsIHRtcC5jaGlsZE5vZGVzKTsKCiAgICAgICAgICAvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lcgogICAgICAgICAgdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCiAgICAgICAgICAvLyBFbnN1cmUgdGhlIGNyZWF0ZWQgbm9kZXMgYXJlIG9ycGhhbmVkICh0cmFjLTEyMzkyKQogICAgICAgICAgdG1wLnRleHRDb250ZW50ID0gIiI7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gUmVtb3ZlIHdyYXBwZXIgZnJvbSBmcmFnbWVudAogICAgZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsKICAgIGkgPSAwOwogICAgd2hpbGUgKGVsZW0gPSBub2Rlc1tpKytdKSB7CiAgICAgIC8vIFNraXAgZWxlbWVudHMgYWxyZWFkeSBpbiB0aGUgY29udGV4dCBjb2xsZWN0aW9uICh0cmFjLTQwODcpCiAgICAgIGlmIChzZWxlY3Rpb24gJiYgalF1ZXJ5LmluQXJyYXkoZWxlbSwgc2VsZWN0aW9uKSA+IC0xKSB7CiAgICAgICAgaWYgKGlnbm9yZWQpIHsKICAgICAgICAgIGlnbm9yZWQucHVzaChlbGVtKTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgYXR0YWNoZWQgPSBpc0F0dGFjaGVkKGVsZW0pOwoKICAgICAgLy8gQXBwZW5kIHRvIGZyYWdtZW50CiAgICAgIHRtcCA9IGdldEFsbChmcmFnbWVudC5hcHBlbmRDaGlsZChlbGVtKSwgInNjcmlwdCIpOwoKICAgICAgLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQogICAgICBpZiAoYXR0YWNoZWQpIHsKICAgICAgICBzZXRHbG9iYWxFdmFsKHRtcCk7CiAgICAgIH0KCiAgICAgIC8vIENhcHR1cmUgZXhlY3V0YWJsZXMKICAgICAgaWYgKHNjcmlwdHMpIHsKICAgICAgICBqID0gMDsKICAgICAgICB3aGlsZSAoZWxlbSA9IHRtcFtqKytdKSB7CiAgICAgICAgICBpZiAocnNjcmlwdFR5cGUudGVzdChlbGVtLnR5cGUgfHwgIiIpKSB7CiAgICAgICAgICAgIHNjcmlwdHMucHVzaChlbGVtKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmcmFnbWVudDsKICB9CiAgdmFyIHJ0eXBlbmFtZXNwYWNlID0gL14oW14uXSopKD86XC4oLispfCkvOwogIGZ1bmN0aW9uIHJldHVyblRydWUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIG9uKGVsZW0sIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIG9uZSkgewogICAgdmFyIG9yaWdGbiwgdHlwZTsKCiAgICAvLyBUeXBlcyBjYW4gYmUgYSBtYXAgb2YgdHlwZXMvaGFuZGxlcnMKICAgIGlmICh0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiKSB7CiAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciKSB7CiAgICAgICAgLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQogICAgICAgIGRhdGEgPSBkYXRhIHx8IHNlbGVjdG9yOwogICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGZvciAodHlwZSBpbiB0eXBlcykgewogICAgICAgIG9uKGVsZW0sIHR5cGUsIHNlbGVjdG9yLCBkYXRhLCB0eXBlc1t0eXBlXSwgb25lKTsKICAgICAgfQogICAgICByZXR1cm4gZWxlbTsKICAgIH0KICAgIGlmIChkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCkgewogICAgICAvLyAoIHR5cGVzLCBmbiApCiAgICAgIGZuID0gc2VsZWN0b3I7CiAgICAgIGRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSBpZiAoZm4gPT0gbnVsbCkgewogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIikgewogICAgICAgIC8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApCiAgICAgICAgZm4gPSBkYXRhOwogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gKCB0eXBlcywgZGF0YSwgZm4gKQogICAgICAgIGZuID0gZGF0YTsKICAgICAgICBkYXRhID0gc2VsZWN0b3I7CiAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgZm4gPSByZXR1cm5GYWxzZTsKICAgIH0gZWxzZSBpZiAoIWZuKSB7CiAgICAgIHJldHVybiBlbGVtOwogICAgfQogICAgaWYgKG9uZSA9PT0gMSkgewogICAgICBvcmlnRm4gPSBmbjsKICAgICAgZm4gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAvLyBDYW4gdXNlIGFuIGVtcHR5IHNldCwgc2luY2UgZXZlbnQgY29udGFpbnMgdGhlIGluZm8KICAgICAgICBqUXVlcnkoKS5vZmYoZXZlbnQpOwogICAgICAgIHJldHVybiBvcmlnRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKCiAgICAgIC8vIFVzZSBzYW1lIGd1aWQgc28gY2FsbGVyIGNhbiByZW1vdmUgdXNpbmcgb3JpZ0ZuCiAgICAgIGZuLmd1aWQgPSBvcmlnRm4uZ3VpZCB8fCAob3JpZ0ZuLmd1aWQgPSBqUXVlcnkuZ3VpZCsrKTsKICAgIH0KICAgIHJldHVybiBlbGVtLmVhY2goZnVuY3Rpb24gKCkgewogICAgICBqUXVlcnkuZXZlbnQuYWRkKHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IpOwogICAgfSk7CiAgfQoKICAvKgogICAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICAgKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogICAqLwogIGpRdWVyeS5ldmVudCA9IHsKICAgIGdsb2JhbDoge30sCiAgICBhZGQ6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgZGF0YSwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGhhbmRsZU9iakluLAogICAgICAgIGV2ZW50SGFuZGxlLAogICAgICAgIHRtcCwKICAgICAgICBldmVudHMsCiAgICAgICAgdCwKICAgICAgICBoYW5kbGVPYmosCiAgICAgICAgc3BlY2lhbCwKICAgICAgICBoYW5kbGVycywKICAgICAgICB0eXBlLAogICAgICAgIG5hbWVzcGFjZXMsCiAgICAgICAgb3JpZ1R5cGUsCiAgICAgICAgZWxlbURhdGEgPSBkYXRhUHJpdi5nZXQoZWxlbSk7CgogICAgICAvLyBPbmx5IGF0dGFjaCBldmVudHMgdG8gb2JqZWN0cyB0aGF0IGFjY2VwdCBkYXRhCiAgICAgIGlmICghYWNjZXB0RGF0YShlbGVtKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCiAgICAgIGlmIChoYW5kbGVyLmhhbmRsZXIpIHsKICAgICAgICBoYW5kbGVPYmpJbiA9IGhhbmRsZXI7CiAgICAgICAgaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CiAgICAgICAgc2VsZWN0b3IgPSBoYW5kbGVPYmpJbi5zZWxlY3RvcjsKICAgICAgfQoKICAgICAgLy8gRW5zdXJlIHRoYXQgaW52YWxpZCBzZWxlY3RvcnMgdGhyb3cgZXhjZXB0aW9ucyBhdCBhdHRhY2ggdGltZQogICAgICAvLyBFdmFsdWF0ZSBhZ2FpbnN0IGRvY3VtZW50RWxlbWVudCBpbiBjYXNlIGVsZW0gaXMgYSBub24tZWxlbWVudCBub2RlIChlLmcuLCBkb2N1bWVudCkKICAgICAgaWYgKHNlbGVjdG9yKSB7CiAgICAgICAgalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGRvY3VtZW50RWxlbWVudCwgc2VsZWN0b3IpOwogICAgICB9CgogICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKICAgICAgaWYgKCFoYW5kbGVyLmd1aWQpIHsKICAgICAgICBoYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwogICAgICB9CgogICAgICAvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CiAgICAgIGlmICghKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykpIHsKICAgICAgICBldmVudHMgPSBlbGVtRGF0YS5ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB9CiAgICAgIGlmICghKGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlKSkgewogICAgICAgIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIC8vIERpc2NhcmQgdGhlIHNlY29uZCBldmVudCBvZiBhIGpRdWVyeS5ldmVudC50cmlnZ2VyKCkgYW5kCiAgICAgICAgICAvLyB3aGVuIGFuIGV2ZW50IGlzIGNhbGxlZCBhZnRlciBhIHBhZ2UgaGFzIHVubG9hZGVkCiAgICAgICAgICByZXR1cm4gdHlwZW9mIGpRdWVyeSAhPT0gInVuZGVmaW5lZCIgJiYgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCAhPT0gZS50eXBlID8galF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmFwcGx5KGVsZW0sIGFyZ3VtZW50cykgOiB1bmRlZmluZWQ7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgLy8gSGFuZGxlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgYSBzcGFjZQogICAgICB0eXBlcyA9ICh0eXBlcyB8fCAiIikubWF0Y2gocm5vdGh0bWx3aGl0ZSkgfHwgWyIiXTsKICAgICAgdCA9IHR5cGVzLmxlbmd0aDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWModHlwZXNbdF0pIHx8IFtdOwogICAgICAgIHR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsKICAgICAgICBuYW1lc3BhY2VzID0gKHRtcFsyXSB8fCAiIikuc3BsaXQoIi4iKS5zb3J0KCk7CgogICAgICAgIC8vIFRoZXJlICptdXN0KiBiZSBhIHR5cGUsIG5vIGF0dGFjaGluZyBuYW1lc3BhY2Utb25seSBoYW5kbGVycwogICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbdHlwZV0gfHwge307CgogICAgICAgIC8vIElmIHNlbGVjdG9yIGRlZmluZWQsIGRldGVybWluZSBzcGVjaWFsIGV2ZW50IGFwaSB0eXBlLCBvdGhlcndpc2UgZ2l2ZW4gdHlwZQogICAgICAgIHR5cGUgPSAoc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUpIHx8IHR5cGU7CgogICAgICAgIC8vIFVwZGF0ZSBzcGVjaWFsIGJhc2VkIG9uIG5ld2x5IHJlc2V0IHR5cGUKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbdHlwZV0gfHwge307CgogICAgICAgIC8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgaGFuZGxlT2JqID0galF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgb3JpZ1R5cGU6IG9yaWdUeXBlLAogICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICBndWlkOiBoYW5kbGVyLmd1aWQsCiAgICAgICAgICBzZWxlY3Rvcjogc2VsZWN0b3IsCiAgICAgICAgICBuZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9yKSwKICAgICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCIuIikKICAgICAgICB9LCBoYW5kbGVPYmpJbik7CgogICAgICAgIC8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CiAgICAgICAgaWYgKCEoaGFuZGxlcnMgPSBldmVudHNbdHlwZV0pKSB7CiAgICAgICAgICBoYW5kbGVycyA9IGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgaGFuZGxlcnMuZGVsZWdhdGVDb3VudCA9IDA7CgogICAgICAgICAgLy8gT25seSB1c2UgYWRkRXZlbnRMaXN0ZW5lciBpZiB0aGUgc3BlY2lhbCBldmVudHMgaGFuZGxlciByZXR1cm5zIGZhbHNlCiAgICAgICAgICBpZiAoIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKGVsZW0sIGRhdGEsIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgaWYgKGVsZW0uYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBldmVudEhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNwZWNpYWwuYWRkKSB7CiAgICAgICAgICBzcGVjaWFsLmFkZC5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CiAgICAgICAgICBpZiAoIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQpIHsKICAgICAgICAgICAgaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEFkZCB0byB0aGUgZWxlbWVudCdzIGhhbmRsZXIgbGlzdCwgZGVsZWdhdGVzIGluIGZyb250CiAgICAgICAgaWYgKHNlbGVjdG9yKSB7CiAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaGFuZGxlcnMuZGVsZWdhdGVDb3VudCsrLCAwLCBoYW5kbGVPYmopOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBoYW5kbGVycy5wdXNoKGhhbmRsZU9iaik7CiAgICAgICAgfQoKICAgICAgICAvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCiAgICAgICAgalF1ZXJ5LmV2ZW50Lmdsb2JhbFt0eXBlXSA9IHRydWU7CiAgICAgIH0KICAgIH0sCiAgICAvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKICAgIHJlbW92ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMpIHsKICAgICAgdmFyIGosCiAgICAgICAgb3JpZ0NvdW50LAogICAgICAgIHRtcCwKICAgICAgICBldmVudHMsCiAgICAgICAgdCwKICAgICAgICBoYW5kbGVPYmosCiAgICAgICAgc3BlY2lhbCwKICAgICAgICBoYW5kbGVycywKICAgICAgICB0eXBlLAogICAgICAgIG5hbWVzcGFjZXMsCiAgICAgICAgb3JpZ1R5cGUsCiAgICAgICAgZWxlbURhdGEgPSBkYXRhUHJpdi5oYXNEYXRhKGVsZW0pICYmIGRhdGFQcml2LmdldChlbGVtKTsKICAgICAgaWYgKCFlbGVtRGF0YSB8fCAhKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIE9uY2UgZm9yIGVhY2ggdHlwZS5uYW1lc3BhY2UgaW4gdHlwZXM7IHR5cGUgbWF5IGJlIG9taXR0ZWQKICAgICAgdHlwZXMgPSAodHlwZXMgfHwgIiIpLm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFsiIl07CiAgICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICAgIHdoaWxlICh0LS0pIHsKICAgICAgICB0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKHR5cGVzW3RdKSB8fCBbXTsKICAgICAgICB0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CiAgICAgICAgbmFtZXNwYWNlcyA9ICh0bXBbMl0gfHwgIiIpLnNwbGl0KCIuIikuc29ydCgpOwoKICAgICAgICAvLyBVbmJpbmQgYWxsIGV2ZW50cyAob24gdGhpcyBuYW1lc3BhY2UsIGlmIHByb3ZpZGVkKSBmb3IgdGhlIGVsZW1lbnQKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgIGZvciAodHlwZSBpbiBldmVudHMpIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZShlbGVtLCB0eXBlICsgdHlwZXNbdF0sIGhhbmRsZXIsIHNlbGVjdG9yLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbdHlwZV0gfHwge307CiAgICAgICAgdHlwZSA9IChzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSkgfHwgdHlwZTsKICAgICAgICBoYW5kbGVycyA9IGV2ZW50c1t0eXBlXSB8fCBbXTsKICAgICAgICB0bXAgPSB0bXBbMl0gJiYgbmV3IFJlZ0V4cCgiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIik7CgogICAgICAgIC8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKICAgICAgICBvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwogICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzW2pdOwogICAgICAgICAgaWYgKChtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlKSAmJiAoIWhhbmRsZXIgfHwgaGFuZGxlci5ndWlkID09PSBoYW5kbGVPYmouZ3VpZCkgJiYgKCF0bXAgfHwgdG1wLnRlc3QoaGFuZGxlT2JqLm5hbWVzcGFjZSkpICYmICghc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IGhhbmRsZU9iai5zZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gIioqIiAmJiBoYW5kbGVPYmouc2VsZWN0b3IpKSB7CiAgICAgICAgICAgIGhhbmRsZXJzLnNwbGljZShqLCAxKTsKICAgICAgICAgICAgaWYgKGhhbmRsZU9iai5zZWxlY3RvcikgewogICAgICAgICAgICAgIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lhbC5yZW1vdmUpIHsKICAgICAgICAgICAgICBzcGVjaWFsLnJlbW92ZS5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKICAgICAgICAvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKICAgICAgICBpZiAob3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGgpIHsKICAgICAgICAgIGlmICghc3BlY2lhbC50ZWFyZG93biB8fCBzcGVjaWFsLnRlYXJkb3duLmNhbGwoZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KGVsZW0sIHR5cGUsIGVsZW1EYXRhLmhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmVtb3ZlIGRhdGEgYW5kIHRoZSBleHBhbmRvIGlmIGl0J3Mgbm8gbG9uZ2VyIHVzZWQKICAgICAgaWYgKGpRdWVyeS5pc0VtcHR5T2JqZWN0KGV2ZW50cykpIHsKICAgICAgICBkYXRhUHJpdi5yZW1vdmUoZWxlbSwgImhhbmRsZSBldmVudHMiKTsKICAgICAgfQogICAgfSwKICAgIGRpc3BhdGNoOiBmdW5jdGlvbiAobmF0aXZlRXZlbnQpIHsKICAgICAgdmFyIGksCiAgICAgICAgaiwKICAgICAgICByZXQsCiAgICAgICAgbWF0Y2hlZCwKICAgICAgICBoYW5kbGVPYmosCiAgICAgICAgaGFuZGxlclF1ZXVlLAogICAgICAgIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCksCiAgICAgICAgLy8gTWFrZSBhIHdyaXRhYmxlIGpRdWVyeS5FdmVudCBmcm9tIHRoZSBuYXRpdmUgZXZlbnQgb2JqZWN0CiAgICAgICAgZXZlbnQgPSBqUXVlcnkuZXZlbnQuZml4KG5hdGl2ZUV2ZW50KSwKICAgICAgICBoYW5kbGVycyA9IChkYXRhUHJpdi5nZXQodGhpcywgImV2ZW50cyIpIHx8IE9iamVjdC5jcmVhdGUobnVsbCkpW2V2ZW50LnR5cGVdIHx8IFtdLAogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFtldmVudC50eXBlXSB8fCB7fTsKCiAgICAgIC8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CiAgICAgIGFyZ3NbMF0gPSBldmVudDsKICAgICAgZm9yIChpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIGFyZ3NbaV0gPSBhcmd1bWVudHNbaV07CiAgICAgIH0KICAgICAgZXZlbnQuZGVsZWdhdGVUYXJnZXQgPSB0aGlzOwoKICAgICAgLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAogICAgICBpZiAoc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwodGhpcywgZXZlbnQpID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGhhbmRsZXJzCiAgICAgIGhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKHRoaXMsIGV2ZW50LCBoYW5kbGVycyk7CgogICAgICAvLyBSdW4gZGVsZWdhdGVzIGZpcnN0OyB0aGV5IG1heSB3YW50IHRvIHN0b3AgcHJvcGFnYXRpb24gYmVuZWF0aCB1cwogICAgICBpID0gMDsKICAgICAgd2hpbGUgKChtYXRjaGVkID0gaGFuZGxlclF1ZXVlW2krK10pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgZXZlbnQuY3VycmVudFRhcmdldCA9IG1hdGNoZWQuZWxlbTsKICAgICAgICBqID0gMDsKICAgICAgICB3aGlsZSAoKGhhbmRsZU9iaiA9IG1hdGNoZWQuaGFuZGxlcnNbaisrXSkgJiYgIWV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgIC8vIElmIHRoZSBldmVudCBpcyBuYW1lc3BhY2VkLCB0aGVuIGVhY2ggaGFuZGxlciBpcyBvbmx5IGludm9rZWQgaWYgaXQgaXMKICAgICAgICAgIC8vIHNwZWNpYWxseSB1bml2ZXJzYWwgb3IgaXRzIG5hbWVzcGFjZXMgYXJlIGEgc3VwZXJzZXQgb2YgdGhlIGV2ZW50J3MuCiAgICAgICAgICBpZiAoIWV2ZW50LnJuYW1lc3BhY2UgfHwgaGFuZGxlT2JqLm5hbWVzcGFjZSA9PT0gZmFsc2UgfHwgZXZlbnQucm5hbWVzcGFjZS50ZXN0KGhhbmRsZU9iai5uYW1lc3BhY2UpKSB7CiAgICAgICAgICAgIGV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwogICAgICAgICAgICByZXQgPSAoKGpRdWVyeS5ldmVudC5zcGVjaWFsW2hhbmRsZU9iai5vcmlnVHlwZV0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlcikuYXBwbHkobWF0Y2hlZC5lbGVtLCBhcmdzKTsKICAgICAgICAgICAgaWYgKHJldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgaWYgKChldmVudC5yZXN1bHQgPSByZXQpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQogICAgICBpZiAoc3BlY2lhbC5wb3N0RGlzcGF0Y2gpIHsKICAgICAgICBzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnQucmVzdWx0OwogICAgfSwKICAgIGhhbmRsZXJzOiBmdW5jdGlvbiAoZXZlbnQsIGhhbmRsZXJzKSB7CiAgICAgIHZhciBpLAogICAgICAgIGhhbmRsZU9iaiwKICAgICAgICBzZWwsCiAgICAgICAgbWF0Y2hlZEhhbmRsZXJzLAogICAgICAgIG1hdGNoZWRTZWxlY3RvcnMsCiAgICAgICAgaGFuZGxlclF1ZXVlID0gW10sCiAgICAgICAgZGVsZWdhdGVDb3VudCA9IGhhbmRsZXJzLmRlbGVnYXRlQ291bnQsCiAgICAgICAgY3VyID0gZXZlbnQudGFyZ2V0OwoKICAgICAgLy8gRmluZCBkZWxlZ2F0ZSBoYW5kbGVycwogICAgICBpZiAoZGVsZWdhdGVDb3VudCAmJgogICAgICAvLyBTdXBwb3J0OiBJRSA8PTkKICAgICAgLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKHRyYWMtMTMxODApCiAgICAgIGN1ci5ub2RlVHlwZSAmJgogICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDw9NDIKICAgICAgLy8gU3VwcHJlc3Mgc3BlYy12aW9sYXRpbmcgY2xpY2tzIGluZGljYXRpbmcgYSBub24tcHJpbWFyeSBwb2ludGVyIGJ1dHRvbiAodHJhYy0zODYxKQogICAgICAvLyBodHRwczovL3d3dy53My5vcmcvVFIvRE9NLUxldmVsLTMtRXZlbnRzLyNldmVudC10eXBlLWNsaWNrCiAgICAgIC8vIFN1cHBvcnQ6IElFIDExIG9ubHkKICAgICAgLy8gLi4uYnV0IG5vdCBhcnJvdyBrZXkgImNsaWNrcyIgb2YgcmFkaW8gaW5wdXRzLCB3aGljaCBjYW4gaGF2ZSBgYnV0dG9uYCAtMSAoZ2gtMjM0MykKICAgICAgIShldmVudC50eXBlID09PSAiY2xpY2siICYmIGV2ZW50LmJ1dHRvbiA+PSAxKSkgewogICAgICAgIGZvciAoOyBjdXIgIT09IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMpIHsKICAgICAgICAgIC8vIERvbid0IGNoZWNrIG5vbi1lbGVtZW50cyAodHJhYy0xMzIwOCkKICAgICAgICAgIC8vIERvbid0IHByb2Nlc3MgY2xpY2tzIG9uIGRpc2FibGVkIGVsZW1lbnRzICh0cmFjLTY5MTEsIHRyYWMtODE2NSwgdHJhYy0xMTM4MiwgdHJhYy0xMTc2NCkKICAgICAgICAgIGlmIChjdXIubm9kZVR5cGUgPT09IDEgJiYgIShldmVudC50eXBlID09PSAiY2xpY2siICYmIGN1ci5kaXNhYmxlZCA9PT0gdHJ1ZSkpIHsKICAgICAgICAgICAgbWF0Y2hlZEhhbmRsZXJzID0gW107CiAgICAgICAgICAgIG1hdGNoZWRTZWxlY3RvcnMgPSB7fTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKykgewogICAgICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzW2ldOwoKICAgICAgICAgICAgICAvLyBEb24ndCBjb25mbGljdCB3aXRoIE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAodHJhYy0xMzIwMykKICAgICAgICAgICAgICBzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAiICI7CiAgICAgICAgICAgICAgaWYgKG1hdGNoZWRTZWxlY3RvcnNbc2VsXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkU2VsZWN0b3JzW3NlbF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8galF1ZXJ5KHNlbCwgdGhpcykuaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5LmZpbmQoc2VsLCB0aGlzLCBudWxsLCBbY3VyXSkubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobWF0Y2hlZFNlbGVjdG9yc1tzZWxdKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkSGFuZGxlcnMucHVzaChoYW5kbGVPYmopOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWF0Y2hlZEhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGVsZW06IGN1ciwKICAgICAgICAgICAgICAgIGhhbmRsZXJzOiBtYXRjaGVkSGFuZGxlcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQWRkIHRoZSByZW1haW5pbmcgKGRpcmVjdGx5LWJvdW5kKSBoYW5kbGVycwogICAgICBjdXIgPSB0aGlzOwogICAgICBpZiAoZGVsZWdhdGVDb3VudCA8IGhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsKICAgICAgICAgIGVsZW06IGN1ciwKICAgICAgICAgIGhhbmRsZXJzOiBoYW5kbGVycy5zbGljZShkZWxlZ2F0ZUNvdW50KQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyUXVldWU7CiAgICB9LAogICAgYWRkUHJvcDogZnVuY3Rpb24gKG5hbWUsIGhvb2spIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGpRdWVyeS5FdmVudC5wcm90b3R5cGUsIG5hbWUsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGlzRnVuY3Rpb24oaG9vaykgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vcmlnaW5hbEV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBob29rKHRoaXMub3JpZ2luYWxFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLm9yaWdpbmFsRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luYWxFdmVudFtuYW1lXTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgbmFtZSwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICB2YWx1ZTogdmFsdWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZml4OiBmdW5jdGlvbiAob3JpZ2luYWxFdmVudCkgewogICAgICByZXR1cm4gb3JpZ2luYWxFdmVudFtqUXVlcnkuZXhwYW5kb10gPyBvcmlnaW5hbEV2ZW50IDogbmV3IGpRdWVyeS5FdmVudChvcmlnaW5hbEV2ZW50KTsKICAgIH0sCiAgICBzcGVjaWFsOiB7CiAgICAgIGxvYWQ6IHsKICAgICAgICAvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCiAgICAgICAgbm9CdWJibGU6IHRydWUKICAgICAgfSwKICAgICAgY2xpY2s6IHsKICAgICAgICAvLyBVdGlsaXplIG5hdGl2ZSBldmVudCB0byBlbnN1cmUgY29ycmVjdCBzdGF0ZSBmb3IgY2hlY2thYmxlIGlucHV0cwogICAgICAgIHNldHVwOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgLy8gRm9yIG11dHVhbCBjb21wcmVzc2liaWxpdHkgd2l0aCBfZGVmYXVsdCwgcmVwbGFjZSBgdGhpc2AgYWNjZXNzIHdpdGggYSBsb2NhbCB2YXIuCiAgICAgICAgICAvLyBgfHwgZGF0YWAgaXMgZGVhZCBjb2RlIG1lYW50IG9ubHkgdG8gcHJlc2VydmUgdGhlIHZhcmlhYmxlIHRocm91Z2ggbWluaWZpY2F0aW9uLgogICAgICAgICAgdmFyIGVsID0gdGhpcyB8fCBkYXRhOwoKICAgICAgICAgIC8vIENsYWltIHRoZSBmaXJzdCBoYW5kbGVyCiAgICAgICAgICBpZiAocmNoZWNrYWJsZVR5cGUudGVzdChlbC50eXBlKSAmJiBlbC5jbGljayAmJiBub2RlTmFtZShlbCwgImlucHV0IikpIHsKICAgICAgICAgICAgLy8gZGF0YVByaXYuc2V0KCBlbCwgImNsaWNrIiwgLi4uICkKICAgICAgICAgICAgbGV2ZXJhZ2VOYXRpdmUoZWwsICJjbGljayIsIHRydWUpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJldHVybiBmYWxzZSB0byBhbGxvdyBub3JtYWwgcHJvY2Vzc2luZyBpbiB0aGUgY2FsbGVyCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgLy8gRm9yIG11dHVhbCBjb21wcmVzc2liaWxpdHkgd2l0aCBfZGVmYXVsdCwgcmVwbGFjZSBgdGhpc2AgYWNjZXNzIHdpdGggYSBsb2NhbCB2YXIuCiAgICAgICAgICAvLyBgfHwgZGF0YWAgaXMgZGVhZCBjb2RlIG1lYW50IG9ubHkgdG8gcHJlc2VydmUgdGhlIHZhcmlhYmxlIHRocm91Z2ggbWluaWZpY2F0aW9uLgogICAgICAgICAgdmFyIGVsID0gdGhpcyB8fCBkYXRhOwoKICAgICAgICAgIC8vIEZvcmNlIHNldHVwIGJlZm9yZSB0cmlnZ2VyaW5nIGEgY2xpY2sKICAgICAgICAgIGlmIChyY2hlY2thYmxlVHlwZS50ZXN0KGVsLnR5cGUpICYmIGVsLmNsaWNrICYmIG5vZGVOYW1lKGVsLCAiaW5wdXQiKSkgewogICAgICAgICAgICBsZXZlcmFnZU5hdGl2ZShlbCwgImNsaWNrIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUmV0dXJuIG5vbi1mYWxzZSB0byBhbGxvdyBub3JtYWwgZXZlbnQtcGF0aCBwcm9wYWdhdGlvbgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAvLyBGb3IgY3Jvc3MtYnJvd3NlciBjb25zaXN0ZW5jeSwgc3VwcHJlc3MgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCiAgICAgICAgLy8gQWxzbyBwcmV2ZW50IGl0IGlmIHdlJ3JlIGN1cnJlbnRseSBpbnNpZGUgYSBsZXZlcmFnZWQgbmF0aXZlLWV2ZW50IHN0YWNrCiAgICAgICAgX2RlZmF1bHQ6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKICAgICAgICAgIHJldHVybiByY2hlY2thYmxlVHlwZS50ZXN0KHRhcmdldC50eXBlKSAmJiB0YXJnZXQuY2xpY2sgJiYgbm9kZU5hbWUodGFyZ2V0LCAiaW5wdXQiKSAmJiBkYXRhUHJpdi5nZXQodGFyZ2V0LCAiY2xpY2siKSB8fCBub2RlTmFtZSh0YXJnZXQsICJhIik7CiAgICAgICAgfQogICAgICB9LAogICAgICBiZWZvcmV1bmxvYWQ6IHsKICAgICAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCAyMCsKICAgICAgICAgIC8vIEZpcmVmb3ggZG9lc24ndCBhbGVydCBpZiB0aGUgcmV0dXJuVmFsdWUgZmllbGQgaXMgbm90IHNldC4KICAgICAgICAgIGlmIChldmVudC5yZXN1bHQgIT09IHVuZGVmaW5lZCAmJiBldmVudC5vcmlnaW5hbEV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50Lm9yaWdpbmFsRXZlbnQucmV0dXJuVmFsdWUgPSBldmVudC5yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gRW5zdXJlIHRoZSBwcmVzZW5jZSBvZiBhbiBldmVudCBsaXN0ZW5lciB0aGF0IGhhbmRsZXMgbWFudWFsbHktdHJpZ2dlcmVkCiAgLy8gc3ludGhldGljIGV2ZW50cyBieSBpbnRlcnJ1cHRpbmcgcHJvZ3Jlc3MgdW50aWwgcmVpbnZva2VkIGluIHJlc3BvbnNlIHRvCiAgLy8gKm5hdGl2ZSogZXZlbnRzIHRoYXQgaXQgZmlyZXMgZGlyZWN0bHksIGVuc3VyaW5nIHRoYXQgc3RhdGUgY2hhbmdlcyBoYXZlCiAgLy8gYWxyZWFkeSBvY2N1cnJlZCBiZWZvcmUgb3RoZXIgbGlzdGVuZXJzIGFyZSBpbnZva2VkLgogIGZ1bmN0aW9uIGxldmVyYWdlTmF0aXZlKGVsLCB0eXBlLCBpc1NldHVwKSB7CiAgICAvLyBNaXNzaW5nIGBpc1NldHVwYCBpbmRpY2F0ZXMgYSB0cmlnZ2VyIGNhbGwsIHdoaWNoIG11c3QgZm9yY2Ugc2V0dXAgdGhyb3VnaCBqUXVlcnkuZXZlbnQuYWRkCiAgICBpZiAoIWlzU2V0dXApIHsKICAgICAgaWYgKGRhdGFQcml2LmdldChlbCwgdHlwZSkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZWwsIHR5cGUsIHJldHVyblRydWUpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBSZWdpc3RlciB0aGUgY29udHJvbGxlciBhcyBhIHNwZWNpYWwgdW5pdmVyc2FsIGhhbmRsZXIgZm9yIGFsbCBldmVudCBuYW1lc3BhY2VzCiAgICBkYXRhUHJpdi5zZXQoZWwsIHR5cGUsIGZhbHNlKTsKICAgIGpRdWVyeS5ldmVudC5hZGQoZWwsIHR5cGUsIHsKICAgICAgbmFtZXNwYWNlOiBmYWxzZSwKICAgICAgaGFuZGxlcjogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJlc3VsdCwKICAgICAgICAgIHNhdmVkID0gZGF0YVByaXYuZ2V0KHRoaXMsIHR5cGUpOwogICAgICAgIGlmIChldmVudC5pc1RyaWdnZXIgJiAxICYmIHRoaXNbdHlwZV0pIHsKICAgICAgICAgIC8vIEludGVycnVwdCBwcm9jZXNzaW5nIG9mIHRoZSBvdXRlciBzeW50aGV0aWMgLnRyaWdnZXIoKWVkIGV2ZW50CiAgICAgICAgICBpZiAoIXNhdmVkKSB7CiAgICAgICAgICAgIC8vIFN0b3JlIGFyZ3VtZW50cyBmb3IgdXNlIHdoZW4gaGFuZGxpbmcgdGhlIGlubmVyIG5hdGl2ZSBldmVudAogICAgICAgICAgICAvLyBUaGVyZSB3aWxsIGFsd2F5cyBiZSBhdCBsZWFzdCBvbmUgYXJndW1lbnQgKGFuIGV2ZW50IG9iamVjdCksIHNvIHRoaXMgYXJyYXkKICAgICAgICAgICAgLy8gd2lsbCBub3QgYmUgY29uZnVzZWQgd2l0aCBhIGxlZnRvdmVyIGNhcHR1cmUgb2JqZWN0LgogICAgICAgICAgICBzYXZlZCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgZGF0YVByaXYuc2V0KHRoaXMsIHR5cGUsIHNhdmVkKTsKCiAgICAgICAgICAgIC8vIFRyaWdnZXIgdGhlIG5hdGl2ZSBldmVudCBhbmQgY2FwdHVyZSBpdHMgcmVzdWx0CiAgICAgICAgICAgIHRoaXNbdHlwZV0oKTsKICAgICAgICAgICAgcmVzdWx0ID0gZGF0YVByaXYuZ2V0KHRoaXMsIHR5cGUpOwogICAgICAgICAgICBkYXRhUHJpdi5zZXQodGhpcywgdHlwZSwgZmFsc2UpOwogICAgICAgICAgICBpZiAoc2F2ZWQgIT09IHJlc3VsdCkgewogICAgICAgICAgICAgIC8vIENhbmNlbCB0aGUgb3V0ZXIgc3ludGhldGljIGV2ZW50CiAgICAgICAgICAgICAgZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGlzIGlzIGFuIGlubmVyIHN5bnRoZXRpYyBldmVudCBmb3IgYW4gZXZlbnQgd2l0aCBhIGJ1YmJsaW5nIHN1cnJvZ2F0ZQogICAgICAgICAgICAvLyAoZm9jdXMgb3IgYmx1ciksIGFzc3VtZSB0aGF0IHRoZSBzdXJyb2dhdGUgYWxyZWFkeSBwcm9wYWdhdGVkIGZyb20gdHJpZ2dlcmluZwogICAgICAgICAgICAvLyB0aGUgbmF0aXZlIGV2ZW50IGFuZCBwcmV2ZW50IHRoYXQgZnJvbSBoYXBwZW5pbmcgYWdhaW4gaGVyZS4KICAgICAgICAgICAgLy8gVGhpcyB0ZWNobmljYWxseSBnZXRzIHRoZSBvcmRlcmluZyB3cm9uZyB3LnIudC4gdG8gYC50cmlnZ2VyKClgIChpbiB3aGljaCB0aGUKICAgICAgICAgICAgLy8gYnViYmxpbmcgc3Vycm9nYXRlIHByb3BhZ2F0ZXMgKmFmdGVyKiB0aGUgbm9uLWJ1YmJsaW5nIGJhc2UpLCBidXQgdGhhdCBzZWVtcwogICAgICAgICAgICAvLyBsZXNzIGJhZCB0aGFuIGR1cGxpY2F0aW9uLgogICAgICAgICAgfSBlbHNlIGlmICgoalF1ZXJ5LmV2ZW50LnNwZWNpYWxbdHlwZV0gfHwge30pLmRlbGVnYXRlVHlwZSkgewogICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJZiB0aGlzIGlzIGEgbmF0aXZlIGV2ZW50IHRyaWdnZXJlZCBhYm92ZSwgZXZlcnl0aGluZyBpcyBub3cgaW4gb3JkZXIKICAgICAgICAgIC8vIEZpcmUgYW4gaW5uZXIgc3ludGhldGljIGV2ZW50IHdpdGggdGhlIG9yaWdpbmFsIGFyZ3VtZW50cwogICAgICAgIH0gZWxzZSBpZiAoc2F2ZWQpIHsKICAgICAgICAgIC8vIC4uLmFuZCBjYXB0dXJlIHRoZSByZXN1bHQKICAgICAgICAgIGRhdGFQcml2LnNldCh0aGlzLCB0eXBlLCBqUXVlcnkuZXZlbnQudHJpZ2dlcihzYXZlZFswXSwgc2F2ZWQuc2xpY2UoMSksIHRoaXMpKTsKCiAgICAgICAgICAvLyBBYm9ydCBoYW5kbGluZyBvZiB0aGUgbmF0aXZlIGV2ZW50IGJ5IGFsbCBqUXVlcnkgaGFuZGxlcnMgd2hpbGUgYWxsb3dpbmcKICAgICAgICAgIC8vIG5hdGl2ZSBoYW5kbGVycyBvbiB0aGUgc2FtZSBlbGVtZW50IHRvIHJ1bi4gT24gdGFyZ2V0LCB0aGlzIGlzIGFjaGlldmVkCiAgICAgICAgICAvLyBieSBzdG9wcGluZyBpbW1lZGlhdGUgcHJvcGFnYXRpb24ganVzdCBvbiB0aGUgalF1ZXJ5IGV2ZW50LiBIb3dldmVyLAogICAgICAgICAgLy8gdGhlIG5hdGl2ZSBldmVudCBpcyByZS13cmFwcGVkIGJ5IGEgalF1ZXJ5IG9uZSBvbiBlYWNoIGxldmVsIG9mIHRoZQogICAgICAgICAgLy8gcHJvcGFnYXRpb24gc28gdGhlIG9ubHkgd2F5IHRvIHN0b3AgaXQgZm9yIGpRdWVyeSBpcyB0byBzdG9wIGl0IGZvcgogICAgICAgICAgLy8gZXZlcnlvbmUgdmlhIG5hdGl2ZSBgc3RvcFByb3BhZ2F0aW9uKClgLiBUaGlzIGlzIG5vdCBhIHByb2JsZW0gZm9yCiAgICAgICAgICAvLyBmb2N1cy9ibHVyIHdoaWNoIGRvbid0IGJ1YmJsZSwgYnV0IGl0IGRvZXMgYWxzbyBzdG9wIGNsaWNrIG9uIGNoZWNrYm94ZXMKICAgICAgICAgIC8vIGFuZCByYWRpb3MuIFdlIGFjY2VwdCB0aGlzIGxpbWl0YXRpb24uCiAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIGV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICBqUXVlcnkucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgaGFuZGxlKSB7CiAgICAvLyBUaGlzICJpZiIgaXMgbmVlZGVkIGZvciBwbGFpbiBvYmplY3RzCiAgICBpZiAoZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKSB7CiAgICAgIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGUpOwogICAgfQogIH07CiAgalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24gKHNyYywgcHJvcHMpIHsKICAgIC8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGpRdWVyeS5FdmVudCkpIHsKICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuRXZlbnQoc3JjLCBwcm9wcyk7CiAgICB9CgogICAgLy8gRXZlbnQgb2JqZWN0CiAgICBpZiAoc3JjICYmIHNyYy50eXBlKSB7CiAgICAgIHRoaXMub3JpZ2luYWxFdmVudCA9IHNyYzsKICAgICAgdGhpcy50eXBlID0gc3JjLnR5cGU7CgogICAgICAvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAogICAgICAvLyBieSBhIGhhbmRsZXIgbG93ZXIgZG93biB0aGUgdHJlZTsgcmVmbGVjdCB0aGUgY29ycmVjdCB2YWx1ZS4KICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMuZGVmYXVsdFByZXZlbnRlZCA9PT0gdW5kZWZpbmVkICYmCiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD0yLjMgb25seQogICAgICBzcmMucmV0dXJuVmFsdWUgPT09IGZhbHNlID8gcmV0dXJuVHJ1ZSA6IHJldHVybkZhbHNlOwoKICAgICAgLy8gQ3JlYXRlIHRhcmdldCBwcm9wZXJ0aWVzCiAgICAgIC8vIFN1cHBvcnQ6IFNhZmFyaSA8PTYgLSA3IG9ubHkKICAgICAgLy8gVGFyZ2V0IHNob3VsZCBub3QgYmUgYSB0ZXh0IG5vZGUgKHRyYWMtNTA0LCB0cmFjLTEzMTQzKQogICAgICB0aGlzLnRhcmdldCA9IHNyYy50YXJnZXQgJiYgc3JjLnRhcmdldC5ub2RlVHlwZSA9PT0gMyA/IHNyYy50YXJnZXQucGFyZW50Tm9kZSA6IHNyYy50YXJnZXQ7CiAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IHNyYy5jdXJyZW50VGFyZ2V0OwogICAgICB0aGlzLnJlbGF0ZWRUYXJnZXQgPSBzcmMucmVsYXRlZFRhcmdldDsKCiAgICAgIC8vIEV2ZW50IHR5cGUKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMudHlwZSA9IHNyYzsKICAgIH0KCiAgICAvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAogICAgaWYgKHByb3BzKSB7CiAgICAgIGpRdWVyeS5leHRlbmQodGhpcywgcHJvcHMpOwogICAgfQoKICAgIC8vIENyZWF0ZSBhIHRpbWVzdGFtcCBpZiBpbmNvbWluZyBldmVudCBkb2Vzbid0IGhhdmUgb25lCiAgICB0aGlzLnRpbWVTdGFtcCA9IHNyYyAmJiBzcmMudGltZVN0YW1wIHx8IERhdGUubm93KCk7CgogICAgLy8gTWFyayBpdCBhcyBmaXhlZAogICAgdGhpc1tqUXVlcnkuZXhwYW5kb10gPSB0cnVlOwogIH07CgogIC8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwogIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKICBqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IGpRdWVyeS5FdmVudCwKICAgIGlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCiAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc1NpbXVsYXRlZDogZmFsc2UsCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiAhdGhpcy5pc1NpbXVsYXRlZCkgewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgfSwKICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CiAgICAgIGlmIChlICYmICF0aGlzLmlzU2ltdWxhdGVkKSB7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgfQogICAgfSwKICAgIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CiAgICAgIGlmIChlICYmICF0aGlzLmlzU2ltdWxhdGVkKSB7CiAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgfQogICAgICB0aGlzLnN0b3BQcm9wYWdhdGlvbigpOwogICAgfQogIH07CgogIC8vIEluY2x1ZGVzIGFsbCBjb21tb24gZXZlbnQgcHJvcHMgaW5jbHVkaW5nIEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50IHNwZWNpZmljIHByb3BzCiAgalF1ZXJ5LmVhY2goewogICAgYWx0S2V5OiB0cnVlLAogICAgYnViYmxlczogdHJ1ZSwKICAgIGNhbmNlbGFibGU6IHRydWUsCiAgICBjaGFuZ2VkVG91Y2hlczogdHJ1ZSwKICAgIGN0cmxLZXk6IHRydWUsCiAgICBkZXRhaWw6IHRydWUsCiAgICBldmVudFBoYXNlOiB0cnVlLAogICAgbWV0YUtleTogdHJ1ZSwKICAgIHBhZ2VYOiB0cnVlLAogICAgcGFnZVk6IHRydWUsCiAgICBzaGlmdEtleTogdHJ1ZSwKICAgIHZpZXc6IHRydWUsCiAgICAiY2hhciI6IHRydWUsCiAgICBjb2RlOiB0cnVlLAogICAgY2hhckNvZGU6IHRydWUsCiAgICBrZXk6IHRydWUsCiAgICBrZXlDb2RlOiB0cnVlLAogICAgYnV0dG9uOiB0cnVlLAogICAgYnV0dG9uczogdHJ1ZSwKICAgIGNsaWVudFg6IHRydWUsCiAgICBjbGllbnRZOiB0cnVlLAogICAgb2Zmc2V0WDogdHJ1ZSwKICAgIG9mZnNldFk6IHRydWUsCiAgICBwb2ludGVySWQ6IHRydWUsCiAgICBwb2ludGVyVHlwZTogdHJ1ZSwKICAgIHNjcmVlblg6IHRydWUsCiAgICBzY3JlZW5ZOiB0cnVlLAogICAgdGFyZ2V0VG91Y2hlczogdHJ1ZSwKICAgIHRvRWxlbWVudDogdHJ1ZSwKICAgIHRvdWNoZXM6IHRydWUsCiAgICB3aGljaDogdHJ1ZQogIH0sIGpRdWVyeS5ldmVudC5hZGRQcm9wKTsKICBqUXVlcnkuZWFjaCh7CiAgICBmb2N1czogImZvY3VzaW4iLAogICAgYmx1cjogImZvY3Vzb3V0IgogIH0sIGZ1bmN0aW9uICh0eXBlLCBkZWxlZ2F0ZVR5cGUpIHsKICAgIGZ1bmN0aW9uIGZvY3VzTWFwcGVkSGFuZGxlcihuYXRpdmVFdmVudCkgewogICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlKSB7CiAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErCiAgICAgICAgLy8gQXR0YWNoIGEgc2luZ2xlIGZvY3VzaW4vZm9jdXNvdXQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQgd2hpbGUgc29tZW9uZSB3YW50cwogICAgICAgIC8vIGZvY3VzL2JsdXIuIFRoaXMgaXMgYmVjYXVzZSB0aGUgZm9ybWVyIGFyZSBzeW5jaHJvbm91cyBpbiBJRSB3aGlsZSB0aGUgbGF0dGVyCiAgICAgICAgLy8gYXJlIGFzeW5jLiBJbiBvdGhlciBicm93c2VycywgYWxsIHRob3NlIGhhbmRsZXJzIGFyZSBpbnZva2VkIHN5bmNocm9ub3VzbHkuCgogICAgICAgIC8vIGBoYW5kbGVgIGZyb20gcHJpdmF0ZSBkYXRhIHdvdWxkIGFscmVhZHkgd3JhcCB0aGUgZXZlbnQsIGJ1dCB3ZSBuZWVkCiAgICAgICAgLy8gdG8gY2hhbmdlIHRoZSBgdHlwZWAgaGVyZS4KICAgICAgICB2YXIgaGFuZGxlID0gZGF0YVByaXYuZ2V0KHRoaXMsICJoYW5kbGUiKSwKICAgICAgICAgIGV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeChuYXRpdmVFdmVudCk7CiAgICAgICAgZXZlbnQudHlwZSA9IG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJmb2N1c2luIiA/ICJmb2N1cyIgOiAiYmx1ciI7CiAgICAgICAgZXZlbnQuaXNTaW11bGF0ZWQgPSB0cnVlOwoKICAgICAgICAvLyBGaXJzdCwgaGFuZGxlIGZvY3VzaW4vZm9jdXNvdXQKICAgICAgICBoYW5kbGUobmF0aXZlRXZlbnQpOwoKICAgICAgICAvLyAuLi50aGVuLCBoYW5kbGUgZm9jdXMvYmx1cgogICAgICAgIC8vCiAgICAgICAgLy8gZm9jdXMvYmx1ciBkb24ndCBidWJibGUgd2hpbGUgZm9jdXNpbi9mb2N1c291dCBkbzsgc2ltdWxhdGUgdGhlIGZvcm1lciBieSBvbmx5CiAgICAgICAgLy8gaW52b2tpbmcgdGhlIGhhbmRsZXIgYXQgdGhlIGxvd2VyIGxldmVsLgogICAgICAgIGlmIChldmVudC50YXJnZXQgPT09IGV2ZW50LmN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIC8vIFRoZSBzZXR1cCBwYXJ0IGNhbGxzIGBsZXZlcmFnZU5hdGl2ZWAsIHdoaWNoLCBpbiB0dXJuLCBjYWxscwogICAgICAgICAgLy8gYGpRdWVyeS5ldmVudC5hZGRgLCBzbyBldmVudCBoYW5kbGUgd2lsbCBhbHJlYWR5IGhhdmUgYmVlbiBzZXQKICAgICAgICAgIC8vIGJ5IHRoaXMgcG9pbnQuCiAgICAgICAgICBoYW5kbGUoZXZlbnQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBGb3Igbm9uLUlFIGJyb3dzZXJzLCBhdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50CiAgICAgICAgLy8gd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0LgogICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZShkZWxlZ2F0ZVR5cGUsIG5hdGl2ZUV2ZW50LnRhcmdldCwgalF1ZXJ5LmV2ZW50LmZpeChuYXRpdmVFdmVudCkpOwogICAgICB9CiAgICB9CiAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSA9IHsKICAgICAgLy8gVXRpbGl6ZSBuYXRpdmUgZXZlbnQgaWYgcG9zc2libGUgc28gYmx1ci9mb2N1cyBzZXF1ZW5jZSBpcyBjb3JyZWN0CiAgICAgIHNldHVwOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGF0dGFjaGVzOwoKICAgICAgICAvLyBDbGFpbSB0aGUgZmlyc3QgaGFuZGxlcgogICAgICAgIC8vIGRhdGFQcml2LnNldCggdGhpcywgImZvY3VzIiwgLi4uICkKICAgICAgICAvLyBkYXRhUHJpdi5zZXQoIHRoaXMsICJibHVyIiwgLi4uICkKICAgICAgICBsZXZlcmFnZU5hdGl2ZSh0aGlzLCB0eXBlLCB0cnVlKTsKICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErCiAgICAgICAgICAvLyBXZSB1c2UgdGhlIHNhbWUgbmF0aXZlIGhhbmRsZXIgZm9yIGZvY3VzaW4gJiBmb2N1cyAoYW5kIGZvY3Vzb3V0ICYgYmx1cikKICAgICAgICAgIC8vIHNvIHdlIG5lZWQgdG8gY29vcmRpbmF0ZSBzZXR1cCAmIHRlYXJkb3duIHBhcnRzIGJldHdlZW4gdGhvc2UgZXZlbnRzLgogICAgICAgICAgLy8gVXNlIGBkZWxlZ2F0ZVR5cGVgIGFzIHRoZSBrZXkgYXMgYHR5cGVgIGlzIGFscmVhZHkgdXNlZCBieSBgbGV2ZXJhZ2VOYXRpdmVgLgogICAgICAgICAgYXR0YWNoZXMgPSBkYXRhUHJpdi5nZXQodGhpcywgZGVsZWdhdGVUeXBlKTsKICAgICAgICAgIGlmICghYXR0YWNoZXMpIHsKICAgICAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKGRlbGVnYXRlVHlwZSwgZm9jdXNNYXBwZWRIYW5kbGVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGRhdGFQcml2LnNldCh0aGlzLCBkZWxlZ2F0ZVR5cGUsIChhdHRhY2hlcyB8fCAwKSArIDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBSZXR1cm4gZmFsc2UgdG8gYWxsb3cgbm9ybWFsIHByb2Nlc3NpbmcgaW4gdGhlIGNhbGxlcgogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKCkgewogICAgICAgIC8vIEZvcmNlIHNldHVwIGJlZm9yZSB0cmlnZ2VyCiAgICAgICAgbGV2ZXJhZ2VOYXRpdmUodGhpcywgdHlwZSk7CgogICAgICAgIC8vIFJldHVybiBub24tZmFsc2UgdG8gYWxsb3cgbm9ybWFsIGV2ZW50LXBhdGggcHJvcGFnYXRpb24KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgdGVhcmRvd246IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgYXR0YWNoZXM7CiAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50TW9kZSkgewogICAgICAgICAgYXR0YWNoZXMgPSBkYXRhUHJpdi5nZXQodGhpcywgZGVsZWdhdGVUeXBlKSAtIDE7CiAgICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihkZWxlZ2F0ZVR5cGUsIGZvY3VzTWFwcGVkSGFuZGxlcik7CiAgICAgICAgICAgIGRhdGFQcml2LnJlbW92ZSh0aGlzLCBkZWxlZ2F0ZVR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGF0YVByaXYuc2V0KHRoaXMsIGRlbGVnYXRlVHlwZSwgYXR0YWNoZXMpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBSZXR1cm4gZmFsc2UgdG8gaW5kaWNhdGUgc3RhbmRhcmQgdGVhcmRvd24gc2hvdWxkIGJlIGFwcGxpZWQKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIFN1cHByZXNzIG5hdGl2ZSBmb2N1cyBvciBibHVyIGlmIHdlJ3JlIGN1cnJlbnRseSBpbnNpZGUKICAgICAgLy8gYSBsZXZlcmFnZWQgbmF0aXZlLWV2ZW50IHN0YWNrCiAgICAgIF9kZWZhdWx0OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gZGF0YVByaXYuZ2V0KGV2ZW50LnRhcmdldCwgdHlwZSk7CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlVHlwZTogZGVsZWdhdGVUeXBlCiAgICB9OwoKICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00NAogICAgLy8gRmlyZWZveCBkb2Vzbid0IGhhdmUgZm9jdXMoaW4gfCBvdXQpIGV2ZW50cwogICAgLy8gUmVsYXRlZCB0aWNrZXQgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02ODc3ODcKICAgIC8vCiAgICAvLyBTdXBwb3J0OiBDaHJvbWUgPD00OCAtIDQ5LCBTYWZhcmkgPD05LjAgLSA5LjEKICAgIC8vIGZvY3VzKGluIHwgb3V0KSBldmVudHMgZmlyZSBhZnRlciBmb2N1cyAmIGJsdXIgZXZlbnRzLAogICAgLy8gd2hpY2ggaXMgc3BlYyB2aW9sYXRpb24gLSBodHRwOi8vd3d3LnczLm9yZy9UUi9ET00tTGV2ZWwtMy1FdmVudHMvI2V2ZW50cy1mb2N1c2V2ZW50LWV2ZW50LW9yZGVyCiAgICAvLyBSZWxhdGVkIHRpY2tldCAtIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTQ0OTg1NwogICAgLy8KICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSsKICAgIC8vIFRvIHByZXNlcnZlIHJlbGF0aXZlIGZvY3VzaW4vZm9jdXMgJiBmb2N1c291dC9ibHVyIGV2ZW50IG9yZGVyIGd1YXJhbnRlZWQgb24gdGhlIDMueCBicmFuY2gsCiAgICAvLyBhdHRhY2ggYSBzaW5nbGUgaGFuZGxlciBmb3IgYm90aCBldmVudHMgaW4gSUUuCiAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFtkZWxlZ2F0ZVR5cGVdID0gewogICAgICBzZXR1cDogZnVuY3Rpb24gKCkgewogICAgICAgIC8vIEhhbmRsZTogcmVndWxhciBub2RlcyAodmlhIGB0aGlzLm93bmVyRG9jdW1lbnRgKSwgd2luZG93CiAgICAgICAgLy8gKHZpYSBgdGhpcy5kb2N1bWVudGApICYgZG9jdW1lbnQgKHZpYSBgdGhpc2ApLgogICAgICAgIHZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcy5kb2N1bWVudCB8fCB0aGlzLAogICAgICAgICAgZGF0YUhvbGRlciA9IGRvY3VtZW50LmRvY3VtZW50TW9kZSA/IHRoaXMgOiBkb2MsCiAgICAgICAgICBhdHRhY2hlcyA9IGRhdGFQcml2LmdldChkYXRhSG9sZGVyLCBkZWxlZ2F0ZVR5cGUpOwoKICAgICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErCiAgICAgICAgLy8gV2UgdXNlIHRoZSBzYW1lIG5hdGl2ZSBoYW5kbGVyIGZvciBmb2N1c2luICYgZm9jdXMgKGFuZCBmb2N1c291dCAmIGJsdXIpCiAgICAgICAgLy8gc28gd2UgbmVlZCB0byBjb29yZGluYXRlIHNldHVwICYgdGVhcmRvd24gcGFydHMgYmV0d2VlbiB0aG9zZSBldmVudHMuCiAgICAgICAgLy8gVXNlIGBkZWxlZ2F0ZVR5cGVgIGFzIHRoZSBrZXkgYXMgYHR5cGVgIGlzIGFscmVhZHkgdXNlZCBieSBgbGV2ZXJhZ2VOYXRpdmVgLgogICAgICAgIGlmICghYXR0YWNoZXMpIHsKICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudE1vZGUpIHsKICAgICAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKGRlbGVnYXRlVHlwZSwgZm9jdXNNYXBwZWRIYW5kbGVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZvY3VzTWFwcGVkSGFuZGxlciwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRhdGFQcml2LnNldChkYXRhSG9sZGVyLCBkZWxlZ2F0ZVR5cGUsIChhdHRhY2hlcyB8fCAwKSArIDEpOwogICAgICB9LAogICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcy5kb2N1bWVudCB8fCB0aGlzLAogICAgICAgICAgZGF0YUhvbGRlciA9IGRvY3VtZW50LmRvY3VtZW50TW9kZSA/IHRoaXMgOiBkb2MsCiAgICAgICAgICBhdHRhY2hlcyA9IGRhdGFQcml2LmdldChkYXRhSG9sZGVyLCBkZWxlZ2F0ZVR5cGUpIC0gMTsKICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlKSB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihkZWxlZ2F0ZVR5cGUsIGZvY3VzTWFwcGVkSGFuZGxlcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmb2N1c01hcHBlZEhhbmRsZXIsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZGF0YVByaXYucmVtb3ZlKGRhdGFIb2xkZXIsIGRlbGVnYXRlVHlwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRhdGFQcml2LnNldChkYXRhSG9sZGVyLCBkZWxlZ2F0ZVR5cGUsIGF0dGFjaGVzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfSk7CgogIC8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcwogIC8vIHNvIHRoYXQgZXZlbnQgZGVsZWdhdGlvbiB3b3JrcyBpbiBqUXVlcnkuCiAgLy8gRG8gdGhlIHNhbWUgZm9yIHBvaW50ZXJlbnRlci9wb2ludGVybGVhdmUgYW5kIHBvaW50ZXJvdmVyL3BvaW50ZXJvdXQKICAvLwogIC8vIFN1cHBvcnQ6IFNhZmFyaSA3IG9ubHkKICAvLyBTYWZhcmkgc2VuZHMgbW91c2VlbnRlciB0b28gb2Z0ZW47IHNlZToKICAvLyBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00NzAyNTgKICAvLyBmb3IgdGhlIGRlc2NyaXB0aW9uIG9mIHRoZSBidWcgKGl0IGV4aXN0ZWQgaW4gb2xkZXIgQ2hyb21lIHZlcnNpb25zIGFzIHdlbGwpLgogIGpRdWVyeS5lYWNoKHsKICAgIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAogICAgbW91c2VsZWF2ZTogIm1vdXNlb3V0IiwKICAgIHBvaW50ZXJlbnRlcjogInBvaW50ZXJvdmVyIiwKICAgIHBvaW50ZXJsZWF2ZTogInBvaW50ZXJvdXQiCiAgfSwgZnVuY3Rpb24gKG9yaWcsIGZpeCkgewogICAgalF1ZXJ5LmV2ZW50LnNwZWNpYWxbb3JpZ10gPSB7CiAgICAgIGRlbGVnYXRlVHlwZTogZml4LAogICAgICBiaW5kVHlwZTogZml4LAogICAgICBoYW5kbGU6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciByZXQsCiAgICAgICAgICB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsCiAgICAgICAgICBoYW5kbGVPYmogPSBldmVudC5oYW5kbGVPYmo7CgogICAgICAgIC8vIEZvciBtb3VzZWVudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgcmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkgewogICAgICAgICAgZXZlbnQudHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZTsKICAgICAgICAgIHJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBldmVudC50eXBlID0gZml4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9CiAgICB9OwogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgb246IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiBvbih0aGlzLCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKTsKICAgIH0sCiAgICBvbmU6IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiBvbih0aGlzLCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxKTsKICAgIH0sCiAgICBvZmY6IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGZuKSB7CiAgICAgIHZhciBoYW5kbGVPYmosIHR5cGU7CiAgICAgIGlmICh0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmopIHsKICAgICAgICAvLyAoIGV2ZW50ICkgIGRpc3BhdGNoZWQgalF1ZXJ5LkV2ZW50CiAgICAgICAgaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwogICAgICAgIGpRdWVyeSh0eXBlcy5kZWxlZ2F0ZVRhcmdldCkub2ZmKGhhbmRsZU9iai5uYW1lc3BhY2UgPyBoYW5kbGVPYmoub3JpZ1R5cGUgKyAiLiIgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDogaGFuZGxlT2JqLm9yaWdUeXBlLCBoYW5kbGVPYmouc2VsZWN0b3IsIGhhbmRsZU9iai5oYW5kbGVyKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHR5cGVzID09PSAib2JqZWN0IikgewogICAgICAgIC8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApCiAgICAgICAgZm9yICh0eXBlIGluIHR5cGVzKSB7CiAgICAgICAgICB0aGlzLm9mZih0eXBlLCBzZWxlY3RvciwgdHlwZXNbdHlwZV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAoc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIC8vICggdHlwZXMgWywgZm5dICkKICAgICAgICBmbiA9IHNlbGVjdG9yOwogICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgICBmbiA9IHJldHVybkZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUodGhpcywgdHlwZXMsIGZuLCBzZWxlY3Rvcik7CiAgICAgIH0pOwogICAgfQogIH0pOwogIHZhcgogICAgLy8gU3VwcG9ydDogSUUgPD0xMCAtIDExLCBFZGdlIDEyIC0gMTMgb25seQogICAgLy8gSW4gSUUvRWRnZSB1c2luZyByZWdleCBncm91cHMgaGVyZSBjYXVzZXMgc2V2ZXJlIHNsb3dkb3ducy4KICAgIC8vIFNlZSBodHRwczovL2Nvbm5lY3QubWljcm9zb2Z0LmNvbS9JRS9mZWVkYmFjay9kZXRhaWxzLzE3MzY1MTIvCiAgICBybm9Jbm5lcmh0bWwgPSAvPHNjcmlwdHw8c3R5bGV8PGxpbmsvaSwKICAgIC8vIGNoZWNrZWQ9ImNoZWNrZWQiIG9yIGNoZWNrZWQKICAgIHJjaGVja2VkID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCiAgICByY2xlYW5TY3JpcHQgPSAvXlxzKjwhXFtDREFUQVxbfFxdXF0+XHMqJC9nOwoKICAvLyBQcmVmZXIgYSB0Ym9keSBvdmVyIGl0cyBwYXJlbnQgdGFibGUgZm9yIGNvbnRhaW5pbmcgbmV3IHJvd3MKICBmdW5jdGlvbiBtYW5pcHVsYXRpb25UYXJnZXQoZWxlbSwgY29udGVudCkgewogICAgaWYgKG5vZGVOYW1lKGVsZW0sICJ0YWJsZSIpICYmIG5vZGVOYW1lKGNvbnRlbnQubm9kZVR5cGUgIT09IDExID8gY29udGVudCA6IGNvbnRlbnQuZmlyc3RDaGlsZCwgInRyIikpIHsKICAgICAgcmV0dXJuIGpRdWVyeShlbGVtKS5jaGlsZHJlbigidGJvZHkiKVswXSB8fCBlbGVtOwogICAgfQogICAgcmV0dXJuIGVsZW07CiAgfQoKICAvLyBSZXBsYWNlL3Jlc3RvcmUgdGhlIHR5cGUgYXR0cmlidXRlIG9mIHNjcmlwdCBlbGVtZW50cyBmb3Igc2FmZSBET00gbWFuaXB1bGF0aW9uCiAgZnVuY3Rpb24gZGlzYWJsZVNjcmlwdChlbGVtKSB7CiAgICBlbGVtLnR5cGUgPSAoZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSAhPT0gbnVsbCkgKyAiLyIgKyBlbGVtLnR5cGU7CiAgICByZXR1cm4gZWxlbTsKICB9CiAgZnVuY3Rpb24gcmVzdG9yZVNjcmlwdChlbGVtKSB7CiAgICBpZiAoKGVsZW0udHlwZSB8fCAiIikuc2xpY2UoMCwgNSkgPT09ICJ0cnVlLyIpIHsKICAgICAgZWxlbS50eXBlID0gZWxlbS50eXBlLnNsaWNlKDUpOwogICAgfSBlbHNlIHsKICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoInR5cGUiKTsKICAgIH0KICAgIHJldHVybiBlbGVtOwogIH0KICBmdW5jdGlvbiBjbG9uZUNvcHlFdmVudChzcmMsIGRlc3QpIHsKICAgIHZhciBpLCBsLCB0eXBlLCBwZGF0YU9sZCwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CiAgICBpZiAoZGVzdC5ub2RlVHlwZSAhPT0gMSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gMS4gQ29weSBwcml2YXRlIGRhdGE6IGV2ZW50cywgaGFuZGxlcnMsIGV0Yy4KICAgIGlmIChkYXRhUHJpdi5oYXNEYXRhKHNyYykpIHsKICAgICAgcGRhdGFPbGQgPSBkYXRhUHJpdi5nZXQoc3JjKTsKICAgICAgZXZlbnRzID0gcGRhdGFPbGQuZXZlbnRzOwogICAgICBpZiAoZXZlbnRzKSB7CiAgICAgICAgZGF0YVByaXYucmVtb3ZlKGRlc3QsICJoYW5kbGUgZXZlbnRzIik7CiAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IGV2ZW50c1t0eXBlXS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZChkZXN0LCB0eXBlLCBldmVudHNbdHlwZV1baV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIDIuIENvcHkgdXNlciBkYXRhCiAgICBpZiAoZGF0YVVzZXIuaGFzRGF0YShzcmMpKSB7CiAgICAgIHVkYXRhT2xkID0gZGF0YVVzZXIuYWNjZXNzKHNyYyk7CiAgICAgIHVkYXRhQ3VyID0galF1ZXJ5LmV4dGVuZCh7fSwgdWRhdGFPbGQpOwogICAgICBkYXRhVXNlci5zZXQoZGVzdCwgdWRhdGFDdXIpOwogICAgfQogIH0KCiAgLy8gRml4IElFIGJ1Z3MsIHNlZSBzdXBwb3J0IHRlc3RzCiAgZnVuY3Rpb24gZml4SW5wdXQoc3JjLCBkZXN0KSB7CiAgICB2YXIgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgLy8gRmFpbHMgdG8gcGVyc2lzdCB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBhIGNsb25lZCBjaGVja2JveCBvciByYWRpbyBidXR0b24uCiAgICBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgcmNoZWNrYWJsZVR5cGUudGVzdChzcmMudHlwZSkpIHsKICAgICAgZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7CgogICAgICAvLyBGYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZCBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucwogICAgfSBlbHNlIGlmIChub2RlTmFtZSA9PT0gImlucHV0IiB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIikgewogICAgICBkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGRvbU1hbmlwKGNvbGxlY3Rpb24sIGFyZ3MsIGNhbGxiYWNrLCBpZ25vcmVkKSB7CiAgICAvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCiAgICBhcmdzID0gZmxhdChhcmdzKTsKICAgIHZhciBmcmFnbWVudCwKICAgICAgZmlyc3QsCiAgICAgIHNjcmlwdHMsCiAgICAgIGhhc1NjcmlwdHMsCiAgICAgIG5vZGUsCiAgICAgIGRvYywKICAgICAgaSA9IDAsCiAgICAgIGwgPSBjb2xsZWN0aW9uLmxlbmd0aCwKICAgICAgaU5vQ2xvbmUgPSBsIC0gMSwKICAgICAgdmFsdWUgPSBhcmdzWzBdLAogICAgICB2YWx1ZUlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uKHZhbHVlKTsKCiAgICAvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKICAgIGlmICh2YWx1ZUlzRnVuY3Rpb24gfHwgbCA+IDEgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAhc3VwcG9ydC5jaGVja0Nsb25lICYmIHJjaGVja2VkLnRlc3QodmFsdWUpKSB7CiAgICAgIHJldHVybiBjb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgdmFyIHNlbGYgPSBjb2xsZWN0aW9uLmVxKGluZGV4KTsKICAgICAgICBpZiAodmFsdWVJc0Z1bmN0aW9uKSB7CiAgICAgICAgICBhcmdzWzBdID0gdmFsdWUuY2FsbCh0aGlzLCBpbmRleCwgc2VsZi5odG1sKCkpOwogICAgICAgIH0KICAgICAgICBkb21NYW5pcChzZWxmLCBhcmdzLCBjYWxsYmFjaywgaWdub3JlZCk7CiAgICAgIH0pOwogICAgfQogICAgaWYgKGwpIHsKICAgICAgZnJhZ21lbnQgPSBidWlsZEZyYWdtZW50KGFyZ3MsIGNvbGxlY3Rpb25bMF0ub3duZXJEb2N1bWVudCwgZmFsc2UsIGNvbGxlY3Rpb24sIGlnbm9yZWQpOwogICAgICBmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CiAgICAgIGlmIChmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGZyYWdtZW50ID0gZmlyc3Q7CiAgICAgIH0KCiAgICAgIC8vIFJlcXVpcmUgZWl0aGVyIG5ldyBjb250ZW50IG9yIGFuIGludGVyZXN0IGluIGlnbm9yZWQgZWxlbWVudHMgdG8gaW52b2tlIHRoZSBjYWxsYmFjawogICAgICBpZiAoZmlyc3QgfHwgaWdub3JlZCkgewogICAgICAgIHNjcmlwdHMgPSBqUXVlcnkubWFwKGdldEFsbChmcmFnbWVudCwgInNjcmlwdCIpLCBkaXNhYmxlU2NyaXB0KTsKICAgICAgICBoYXNTY3JpcHRzID0gc2NyaXB0cy5sZW5ndGg7CgogICAgICAgIC8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0KICAgICAgICAvLyBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKICAgICAgICAvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAodHJhYy04MDcwKS4KICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbm9kZSA9IGZyYWdtZW50OwogICAgICAgICAgaWYgKGkgIT09IGlOb0Nsb25lKSB7CiAgICAgICAgICAgIG5vZGUgPSBqUXVlcnkuY2xvbmUobm9kZSwgdHJ1ZSwgdHJ1ZSk7CgogICAgICAgICAgICAvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uCiAgICAgICAgICAgIGlmIChoYXNTY3JpcHRzKSB7CiAgICAgICAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CiAgICAgICAgICAgICAgLy8gcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAogICAgICAgICAgICAgIGpRdWVyeS5tZXJnZShzY3JpcHRzLCBnZXRBbGwobm9kZSwgInNjcmlwdCIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2suY2FsbChjb2xsZWN0aW9uW2ldLCBub2RlLCBpKTsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1NjcmlwdHMpIHsKICAgICAgICAgIGRvYyA9IHNjcmlwdHNbc2NyaXB0cy5sZW5ndGggLSAxXS5vd25lckRvY3VtZW50OwoKICAgICAgICAgIC8vIFJlLWVuYWJsZSBzY3JpcHRzCiAgICAgICAgICBqUXVlcnkubWFwKHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQpOwoKICAgICAgICAgIC8vIEV2YWx1YXRlIGV4ZWN1dGFibGUgc2NyaXB0cyBvbiBmaXJzdCBkb2N1bWVudCBpbnNlcnRpb24KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBoYXNTY3JpcHRzOyBpKyspIHsKICAgICAgICAgICAgbm9kZSA9IHNjcmlwdHNbaV07CiAgICAgICAgICAgIGlmIChyc2NyaXB0VHlwZS50ZXN0KG5vZGUudHlwZSB8fCAiIikgJiYgIWRhdGFQcml2LmFjY2Vzcyhub2RlLCAiZ2xvYmFsRXZhbCIpICYmIGpRdWVyeS5jb250YWlucyhkb2MsIG5vZGUpKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUuc3JjICYmIChub2RlLnR5cGUgfHwgIiIpLnRvTG93ZXJDYXNlKCkgIT09ICJtb2R1bGUiKSB7CiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbCBBSkFYIGRlcGVuZGVuY3ksIGJ1dCB3b24ndCBydW4gc2NyaXB0cyBpZiBub3QgcHJlc2VudAogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5fZXZhbFVybCAmJiAhbm9kZS5ub01vZHVsZSkgewogICAgICAgICAgICAgICAgICBqUXVlcnkuX2V2YWxVcmwobm9kZS5zcmMsIHsKICAgICAgICAgICAgICAgICAgICBub25jZTogbm9kZS5ub25jZSB8fCBub2RlLmdldEF0dHJpYnV0ZSgibm9uY2UiKQogICAgICAgICAgICAgICAgICB9LCBkb2MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBVbndyYXAgYSBDREFUQSBzZWN0aW9uIGNvbnRhaW5pbmcgc2NyaXB0IGNvbnRlbnRzLiBUaGlzIHNob3VsZG4ndCBiZQogICAgICAgICAgICAgICAgLy8gbmVlZGVkIGFzIGluIFhNTCBkb2N1bWVudHMgdGhleSdyZSBhbHJlYWR5IG5vdCB2aXNpYmxlIHdoZW4KICAgICAgICAgICAgICAgIC8vIGluc3BlY3RpbmcgZWxlbWVudCBjb250ZW50cyBhbmQgaW4gSFRNTCBkb2N1bWVudHMgdGhleSBoYXZlIG5vCiAgICAgICAgICAgICAgICAvLyBtZWFuaW5nIGJ1dCB3ZSdyZSBwcmVzZXJ2aW5nIHRoYXQgbG9naWMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogICAgICAgICAgICAgICAgLy8gVGhpcyB3aWxsIGJlIHJlbW92ZWQgY29tcGxldGVseSBpbiA0LjAuIFNlZSBnaC00OTA0LgogICAgICAgICAgICAgICAgRE9NRXZhbChub2RlLnRleHRDb250ZW50LnJlcGxhY2UocmNsZWFuU2NyaXB0LCAiIiksIG5vZGUsIGRvYyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29sbGVjdGlvbjsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlKGVsZW0sIHNlbGVjdG9yLCBrZWVwRGF0YSkgewogICAgdmFyIG5vZGUsCiAgICAgIG5vZGVzID0gc2VsZWN0b3IgPyBqUXVlcnkuZmlsdGVyKHNlbGVjdG9yLCBlbGVtKSA6IGVsZW0sCiAgICAgIGkgPSAwOwogICAgZm9yICg7IChub2RlID0gbm9kZXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICBpZiAoIWtlZXBEYXRhICYmIG5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChub2RlKSk7CiAgICAgIH0KICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkgewogICAgICAgIGlmIChrZWVwRGF0YSAmJiBpc0F0dGFjaGVkKG5vZGUpKSB7CiAgICAgICAgICBzZXRHbG9iYWxFdmFsKGdldEFsbChub2RlLCAic2NyaXB0IikpOwogICAgICAgIH0KICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbGVtOwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIGh0bWxQcmVmaWx0ZXI6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgIHJldHVybiBodG1sOwogICAgfSwKICAgIGNsb25lOiBmdW5jdGlvbiAoZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgdmFyIGksCiAgICAgICAgbCwKICAgICAgICBzcmNFbGVtZW50cywKICAgICAgICBkZXN0RWxlbWVudHMsCiAgICAgICAgY2xvbmUgPSBlbGVtLmNsb25lTm9kZSh0cnVlKSwKICAgICAgICBpblBhZ2UgPSBpc0F0dGFjaGVkKGVsZW0pOwoKICAgICAgLy8gRml4IElFIGNsb25pbmcgaXNzdWVzCiAgICAgIGlmICghc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCAmJiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSkgJiYgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSkgewogICAgICAgIC8vIFdlIGVzY2hldyBqUXVlcnkjZmluZCBoZXJlIGZvciBwZXJmb3JtYW5jZSByZWFzb25zOgogICAgICAgIC8vIGh0dHBzOi8vanNwZXJmLmNvbS9nZXRhbGwtdnMtc2l6emxlLzIKICAgICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoY2xvbmUpOwogICAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKGVsZW0pOwogICAgICAgIGZvciAoaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGZpeElucHV0KHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQogICAgICBpZiAoZGF0YUFuZEV2ZW50cykgewogICAgICAgIGlmIChkZWVwRGF0YUFuZEV2ZW50cykgewogICAgICAgICAgc3JjRWxlbWVudHMgPSBzcmNFbGVtZW50cyB8fCBnZXRBbGwoZWxlbSk7CiAgICAgICAgICBkZXN0RWxlbWVudHMgPSBkZXN0RWxlbWVudHMgfHwgZ2V0QWxsKGNsb25lKTsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgY2xvbmVDb3B5RXZlbnQoc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNsb25lQ29weUV2ZW50KGVsZW0sIGNsb25lKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKICAgICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKGNsb25lLCAic2NyaXB0Iik7CiAgICAgIGlmIChkZXN0RWxlbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgIHNldEdsb2JhbEV2YWwoZGVzdEVsZW1lbnRzLCAhaW5QYWdlICYmIGdldEFsbChlbGVtLCAic2NyaXB0IikpOwogICAgICB9CgogICAgICAvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKICAgICAgcmV0dXJuIGNsb25lOwogICAgfSwKICAgIGNsZWFuRGF0YTogZnVuY3Rpb24gKGVsZW1zKSB7CiAgICAgIHZhciBkYXRhLAogICAgICAgIGVsZW0sCiAgICAgICAgdHlwZSwKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsCiAgICAgICAgaSA9IDA7CiAgICAgIGZvciAoOyAoZWxlbSA9IGVsZW1zW2ldKSAhPT0gdW5kZWZpbmVkOyBpKyspIHsKICAgICAgICBpZiAoYWNjZXB0RGF0YShlbGVtKSkgewogICAgICAgICAgaWYgKGRhdGEgPSBlbGVtW2RhdGFQcml2LmV4cGFuZG9dKSB7CiAgICAgICAgICAgIGlmIChkYXRhLmV2ZW50cykgewogICAgICAgICAgICAgIGZvciAodHlwZSBpbiBkYXRhLmV2ZW50cykgewogICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxbdHlwZV0pIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZShlbGVtLCB0eXBlKTsKCiAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVFdmVudChlbGVtLCB0eXBlLCBkYXRhLmhhbmRsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdXBwb3J0OiBDaHJvbWUgPD0zNSAtIDQ1KwogICAgICAgICAgICAvLyBBc3NpZ24gdW5kZWZpbmVkIGluc3RlYWQgb2YgdXNpbmcgZGVsZXRlLCBzZWUgRGF0YSNyZW1vdmUKICAgICAgICAgICAgZWxlbVtkYXRhUHJpdi5leHBhbmRvXSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlbGVtW2RhdGFVc2VyLmV4cGFuZG9dKSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSA8PTM1IC0gNDUrCiAgICAgICAgICAgIC8vIEFzc2lnbiB1bmRlZmluZWQgaW5zdGVhZCBvZiB1c2luZyBkZWxldGUsIHNlZSBEYXRhI3JlbW92ZQogICAgICAgICAgICBlbGVtW2RhdGFVc2VyLmV4cGFuZG9dID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZGV0YWNoOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHJlbW92ZSh0aGlzLCBzZWxlY3RvciwgdHJ1ZSk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHJlbW92ZSh0aGlzLCBzZWxlY3Rvcik7CiAgICB9LAogICAgdGV4dDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPyBqUXVlcnkudGV4dCh0aGlzKSA6IHRoaXMuZW1wdHkoKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgdGhpcy50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICB9LAogICAgYXBwZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBkb21NYW5pcCh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG1hbmlwdWxhdGlvblRhcmdldCh0aGlzLCBlbGVtKTsKICAgICAgICAgIHRhcmdldC5hcHBlbmRDaGlsZChlbGVtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHByZXBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGRvbU1hbmlwKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KHRoaXMsIGVsZW0pOwogICAgICAgICAgdGFyZ2V0Lmluc2VydEJlZm9yZShlbGVtLCB0YXJnZXQuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBiZWZvcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGRvbU1hbmlwKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlKSB7CiAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsZW0sIHRoaXMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgYWZ0ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGRvbU1hbmlwKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlKSB7CiAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsZW0sIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGVsZW0sCiAgICAgICAgaSA9IDA7CiAgICAgIGZvciAoOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAvLyBQcmV2ZW50IG1lbW9yeSBsZWFrcwogICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwoZWxlbSwgZmFsc2UpKTsKCiAgICAgICAgICAvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwogICAgICAgICAgZWxlbS50ZXh0Q29udGVudCA9ICIiOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBjbG9uZTogZnVuY3Rpb24gKGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgIGRhdGFBbmRFdmVudHMgPSBkYXRhQW5kRXZlbnRzID09IG51bGwgPyBmYWxzZSA6IGRhdGFBbmRFdmVudHM7CiAgICAgIGRlZXBEYXRhQW5kRXZlbnRzID0gZGVlcERhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGRhdGFBbmRFdmVudHMgOiBkZWVwRGF0YUFuZEV2ZW50czsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmNsb25lKHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKTsKICAgICAgfSk7CiAgICB9LAogICAgaHRtbDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICBsID0gdGhpcy5sZW5ndGg7CiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uaW5uZXJIVE1MOwogICAgICAgIH0KCiAgICAgICAgLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCh2YWx1ZSkgJiYgIXdyYXBNYXBbKHJ0YWdOYW1lLmV4ZWModmFsdWUpIHx8IFsiIiwgIiJdKVsxXS50b0xvd2VyQ2FzZSgpXSkgewogICAgICAgICAgdmFsdWUgPSBqUXVlcnkuaHRtbFByZWZpbHRlcih2YWx1ZSk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgIGVsZW0gPSB0aGlzW2ldIHx8IHt9OwoKICAgICAgICAgICAgICAvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwoZWxlbSwgZmFsc2UpKTsKICAgICAgICAgICAgICAgIGVsZW0uaW5uZXJIVE1MID0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW0gPSAwOwoKICAgICAgICAgICAgLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCiAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIH0KICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgdGhpcy5lbXB0eSgpLmFwcGVuZCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGlnbm9yZWQgPSBbXTsKCiAgICAgIC8vIE1ha2UgdGhlIGNoYW5nZXMsIHJlcGxhY2luZyBlYWNoIG5vbi1pZ25vcmVkIGNvbnRleHQgZWxlbWVudCB3aXRoIHRoZSBuZXcgY29udGVudAogICAgICByZXR1cm4gZG9tTWFuaXAodGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnBhcmVudE5vZGU7CiAgICAgICAgaWYgKGpRdWVyeS5pbkFycmF5KHRoaXMsIGlnbm9yZWQpIDwgMCkgewogICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwodGhpcykpOwogICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKGVsZW0sIHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRm9yY2UgY2FsbGJhY2sgaW52b2NhdGlvbgogICAgICB9LCBpZ25vcmVkKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaCh7CiAgICBhcHBlbmRUbzogImFwcGVuZCIsCiAgICBwcmVwZW5kVG86ICJwcmVwZW5kIiwKICAgIGluc2VydEJlZm9yZTogImJlZm9yZSIsCiAgICBpbnNlcnRBZnRlcjogImFmdGVyIiwKICAgIHJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKICB9LCBmdW5jdGlvbiAobmFtZSwgb3JpZ2luYWwpIHsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICB2YXIgZWxlbXMsCiAgICAgICAgcmV0ID0gW10sCiAgICAgICAgaW5zZXJ0ID0galF1ZXJ5KHNlbGVjdG9yKSwKICAgICAgICBsYXN0ID0gaW5zZXJ0Lmxlbmd0aCAtIDEsCiAgICAgICAgaSA9IDA7CiAgICAgIGZvciAoOyBpIDw9IGxhc3Q7IGkrKykgewogICAgICAgIGVsZW1zID0gaSA9PT0gbGFzdCA/IHRoaXMgOiB0aGlzLmNsb25lKHRydWUpOwogICAgICAgIGpRdWVyeShpbnNlcnRbaV0pW29yaWdpbmFsXShlbGVtcyk7CgogICAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQogICAgICAgIC8vIC5nZXQoKSBiZWNhdXNlIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKICAgICAgICBwdXNoLmFwcGx5KHJldCwgZWxlbXMuZ2V0KCkpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhyZXQpOwogICAgfTsKICB9KTsKICB2YXIgcm51bW5vbnB4ID0gbmV3IFJlZ0V4cCgiXigiICsgcG51bSArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIpOwogIHZhciByY3VzdG9tUHJvcCA9IC9eLS0vOwogIHZhciBnZXRTdHlsZXMgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5LCBGaXJlZm94IDw9MzAgKHRyYWMtMTUwOTgsIHRyYWMtMTQxNTApCiAgICAvLyBJRSB0aHJvd3Mgb24gZWxlbWVudHMgY3JlYXRlZCBpbiBwb3B1cHMKICAgIC8vIEZGIG1lYW53aGlsZSB0aHJvd3Mgb24gZnJhbWUgZWxlbWVudHMgdGhyb3VnaCAiZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSIKICAgIHZhciB2aWV3ID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3OwogICAgaWYgKCF2aWV3IHx8ICF2aWV3Lm9wZW5lcikgewogICAgICB2aWV3ID0gd2luZG93OwogICAgfQogICAgcmV0dXJuIHZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtKTsKICB9OwogIHZhciBzd2FwID0gZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICB2YXIgcmV0LAogICAgICBuYW1lLAogICAgICBvbGQgPSB7fTsKCiAgICAvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgIG9sZFtuYW1lXSA9IGVsZW0uc3R5bGVbbmFtZV07CiAgICAgIGVsZW0uc3R5bGVbbmFtZV0gPSBvcHRpb25zW25hbWVdOwogICAgfQogICAgcmV0ID0gY2FsbGJhY2suY2FsbChlbGVtKTsKCiAgICAvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgIGVsZW0uc3R5bGVbbmFtZV0gPSBvbGRbbmFtZV07CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH07CiAgdmFyIHJib3hTdHlsZSA9IG5ldyBSZWdFeHAoY3NzRXhwYW5kLmpvaW4oInwiKSwgImkiKTsKICAoZnVuY3Rpb24gKCkgewogICAgLy8gRXhlY3V0aW5nIGJvdGggcGl4ZWxQb3NpdGlvbiAmIGJveFNpemluZ1JlbGlhYmxlIHRlc3RzIHJlcXVpcmUgb25seSBvbmUgbGF5b3V0CiAgICAvLyBzbyB0aGV5J3JlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIHRpbWUgdG8gc2F2ZSB0aGUgc2Vjb25kIGNvbXB1dGF0aW9uLgogICAgZnVuY3Rpb24gY29tcHV0ZVN0eWxlVGVzdHMoKSB7CiAgICAgIC8vIFRoaXMgaXMgYSBzaW5nbGV0b24sIHdlIG5lZWQgdG8gZXhlY3V0ZSBpdCBvbmx5IG9uY2UKICAgICAgaWYgKCFkaXYpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7bGVmdDotMTExMTFweDt3aWR0aDo2MHB4OyIgKyAibWFyZ2luLXRvcDoxcHg7cGFkZGluZzowO2JvcmRlcjowIjsKICAgICAgZGl2LnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246cmVsYXRpdmU7ZGlzcGxheTpibG9jaztib3gtc2l6aW5nOmJvcmRlci1ib3g7b3ZlcmZsb3c6c2Nyb2xsOyIgKyAibWFyZ2luOmF1dG87Ym9yZGVyOjFweDtwYWRkaW5nOjFweDsiICsgIndpZHRoOjYwJTt0b3A6MSUiOwogICAgICBkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoY29udGFpbmVyKS5hcHBlbmRDaGlsZChkaXYpOwogICAgICB2YXIgZGl2U3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShkaXYpOwogICAgICBwaXhlbFBvc2l0aW9uVmFsID0gZGl2U3R5bGUudG9wICE9PSAiMSUiOwoKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA0LjAgLSA0LjMgb25seSwgRmlyZWZveCA8PTMgLSA0NAogICAgICByZWxpYWJsZU1hcmdpbkxlZnRWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoZGl2U3R5bGUubWFyZ2luTGVmdCkgPT09IDEyOwoKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA0LjAgLSA0LjMgb25seSwgU2FmYXJpIDw9OS4xIC0gMTAuMSwgaU9TIDw9Ny4wIC0gOS4zCiAgICAgIC8vIFNvbWUgc3R5bGVzIGNvbWUgYmFjayB3aXRoIHBlcmNlbnRhZ2UgdmFsdWVzLCBldmVuIHRob3VnaCB0aGV5IHNob3VsZG4ndAogICAgICBkaXYuc3R5bGUucmlnaHQgPSAiNjAlIjsKICAgICAgcGl4ZWxCb3hTdHlsZXNWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoZGl2U3R5bGUucmlnaHQpID09PSAzNjsKCiAgICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5CiAgICAgIC8vIERldGVjdCBtaXNyZXBvcnRpbmcgb2YgY29udGVudCBkaW1lbnNpb25zIGZvciBib3gtc2l6aW5nOmJvcmRlci1ib3ggZWxlbWVudHMKICAgICAgYm94U2l6aW5nUmVsaWFibGVWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoZGl2U3R5bGUud2lkdGgpID09PSAzNjsKCiAgICAgIC8vIFN1cHBvcnQ6IElFIDkgb25seQogICAgICAvLyBEZXRlY3Qgb3ZlcmZsb3c6c2Nyb2xsIHNjcmV3aW5lc3MgKGdoLTM2OTkpCiAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSA8PTY0CiAgICAgIC8vIERvbid0IGdldCB0cmlja2VkIHdoZW4gem9vbSBhZmZlY3RzIG9mZnNldFdpZHRoIChnaC00MDI5KQogICAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICBzY3JvbGxib3hTaXplVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKGRpdi5vZmZzZXRXaWR0aCAvIDMpID09PSAxMjsKICAgICAgZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7CgogICAgICAvLyBOdWxsaWZ5IHRoZSBkaXYgc28gaXQgd291bGRuJ3QgYmUgc3RvcmVkIGluIHRoZSBtZW1vcnkgYW5kCiAgICAgIC8vIGl0IHdpbGwgYWxzbyBiZSBhIHNpZ24gdGhhdCBjaGVja3MgYWxyZWFkeSBwZXJmb3JtZWQKICAgICAgZGl2ID0gbnVsbDsKICAgIH0KICAgIGZ1bmN0aW9uIHJvdW5kUGl4ZWxNZWFzdXJlcyhtZWFzdXJlKSB7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcnNlRmxvYXQobWVhc3VyZSkpOwogICAgfQogICAgdmFyIHBpeGVsUG9zaXRpb25WYWwsCiAgICAgIGJveFNpemluZ1JlbGlhYmxlVmFsLAogICAgICBzY3JvbGxib3hTaXplVmFsLAogICAgICBwaXhlbEJveFN0eWxlc1ZhbCwKICAgICAgcmVsaWFibGVUckRpbWVuc2lvbnNWYWwsCiAgICAgIHJlbGlhYmxlTWFyZ2luTGVmdFZhbCwKICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKICAgIC8vIEZpbmlzaCBlYXJseSBpbiBsaW1pdGVkIChub24tYnJvd3NlcikgZW52aXJvbm1lbnRzCiAgICBpZiAoIWRpdi5zdHlsZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQogICAgLy8gU3R5bGUgb2YgY2xvbmVkIGVsZW1lbnQgYWZmZWN0cyBzb3VyY2UgZWxlbWVudCBjbG9uZWQgKHRyYWMtODkwOCkKICAgIGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICJjb250ZW50LWJveCI7CiAgICBkaXYuY2xvbmVOb2RlKHRydWUpLnN0eWxlLmJhY2tncm91bmRDbGlwID0gIiI7CiAgICBzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSA9IGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9PT0gImNvbnRlbnQtYm94IjsKICAgIGpRdWVyeS5leHRlbmQoc3VwcG9ydCwgewogICAgICBib3hTaXppbmdSZWxpYWJsZTogZnVuY3Rpb24gKCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIGJveFNpemluZ1JlbGlhYmxlVmFsOwogICAgICB9LAogICAgICBwaXhlbEJveFN0eWxlczogZnVuY3Rpb24gKCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIHBpeGVsQm94U3R5bGVzVmFsOwogICAgICB9LAogICAgICBwaXhlbFBvc2l0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29tcHV0ZVN0eWxlVGVzdHMoKTsKICAgICAgICByZXR1cm4gcGl4ZWxQb3NpdGlvblZhbDsKICAgICAgfSwKICAgICAgcmVsaWFibGVNYXJnaW5MZWZ0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29tcHV0ZVN0eWxlVGVzdHMoKTsKICAgICAgICByZXR1cm4gcmVsaWFibGVNYXJnaW5MZWZ0VmFsOwogICAgICB9LAogICAgICBzY3JvbGxib3hTaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29tcHV0ZVN0eWxlVGVzdHMoKTsKICAgICAgICByZXR1cm4gc2Nyb2xsYm94U2l6ZVZhbDsKICAgICAgfSwKICAgICAgLy8gU3VwcG9ydDogSUUgOSAtIDExKywgRWRnZSAxNSAtIDE4KwogICAgICAvLyBJRS9FZGdlIG1pc3JlcG9ydCBgZ2V0Q29tcHV0ZWRTdHlsZWAgb2YgdGFibGUgcm93cyB3aXRoIHdpZHRoL2hlaWdodAogICAgICAvLyBzZXQgaW4gQ1NTIHdoaWxlIGBvZmZzZXQqYCBwcm9wZXJ0aWVzIHJlcG9ydCBjb3JyZWN0IHZhbHVlcy4KICAgICAgLy8gQmVoYXZpb3IgaW4gSUUgOSBpcyBtb3JlIHN1YnRsZSB0aGFuIGluIG5ld2VyIHZlcnNpb25zICYgaXQgcGFzc2VzCiAgICAgIC8vIHNvbWUgdmVyc2lvbnMgb2YgdGhpcyB0ZXN0OyBtYWtlIHN1cmUgbm90IHRvIG1ha2UgaXQgcGFzcyB0aGVyZSEKICAgICAgLy8KICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCA3MCsKICAgICAgLy8gT25seSBGaXJlZm94IGluY2x1ZGVzIGJvcmRlciB3aWR0aHMKICAgICAgLy8gaW4gY29tcHV0ZWQgZGltZW5zaW9ucy4gKGdoLTQ1MjkpCiAgICAgIHJlbGlhYmxlVHJEaW1lbnNpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHRhYmxlLCB0ciwgdHJDaGlsZCwgdHJTdHlsZTsKICAgICAgICBpZiAocmVsaWFibGVUckRpbWVuc2lvbnNWYWwgPT0gbnVsbCkgewogICAgICAgICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0YWJsZSIpOwogICAgICAgICAgdHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ciIpOwogICAgICAgICAgdHJDaGlsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgdGFibGUuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0Oi0xMTExMXB4O2JvcmRlci1jb2xsYXBzZTpzZXBhcmF0ZSI7CiAgICAgICAgICB0ci5zdHlsZS5jc3NUZXh0ID0gImJveC1zaXppbmc6Y29udGVudC1ib3g7Ym9yZGVyOjFweCBzb2xpZCI7CgogICAgICAgICAgLy8gU3VwcG9ydDogQ2hyb21lIDg2KwogICAgICAgICAgLy8gSGVpZ2h0IHNldCB0aHJvdWdoIGNzc1RleHQgZG9lcyBub3QgZ2V0IGFwcGxpZWQuCiAgICAgICAgICAvLyBDb21wdXRlZCBoZWlnaHQgdGhlbiBjb21lcyBiYWNrIGFzIDAuCiAgICAgICAgICB0ci5zdHlsZS5oZWlnaHQgPSAiMXB4IjsKICAgICAgICAgIHRyQ2hpbGQuc3R5bGUuaGVpZ2h0ID0gIjlweCI7CgogICAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA4IENocm9tZSA4NisKICAgICAgICAgIC8vIEluIG91ciBib2R5QmFja2dyb3VuZC5odG1sIGlmcmFtZSwKICAgICAgICAgIC8vIGRpc3BsYXkgZm9yIGFsbCBkaXYgZWxlbWVudHMgaXMgc2V0IHRvICJpbmxpbmUiLAogICAgICAgICAgLy8gd2hpY2ggY2F1c2VzIGEgcHJvYmxlbSBvbmx5IGluIEFuZHJvaWQgOCBDaHJvbWUgODYuCiAgICAgICAgICAvLyBFbnN1cmluZyB0aGUgZGl2IGlzIGBkaXNwbGF5OiBibG9ja2AKICAgICAgICAgIC8vIGdldHMgYXJvdW5kIHRoaXMgaXNzdWUuCiAgICAgICAgICB0ckNoaWxkLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKHRhYmxlKS5hcHBlbmRDaGlsZCh0cikuYXBwZW5kQ2hpbGQodHJDaGlsZCk7CiAgICAgICAgICB0clN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodHIpOwogICAgICAgICAgcmVsaWFibGVUckRpbWVuc2lvbnNWYWwgPSBwYXJzZUludCh0clN0eWxlLmhlaWdodCwgMTApICsgcGFyc2VJbnQodHJTdHlsZS5ib3JkZXJUb3BXaWR0aCwgMTApICsgcGFyc2VJbnQodHJTdHlsZS5ib3JkZXJCb3R0b21XaWR0aCwgMTApID09PSB0ci5vZmZzZXRIZWlnaHQ7CiAgICAgICAgICBkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQodGFibGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVsaWFibGVUckRpbWVuc2lvbnNWYWw7CiAgICAgIH0KICAgIH0pOwogIH0pKCk7CiAgZnVuY3Rpb24gY3VyQ1NTKGVsZW0sIG5hbWUsIGNvbXB1dGVkKSB7CiAgICB2YXIgd2lkdGgsCiAgICAgIG1pbldpZHRoLAogICAgICBtYXhXaWR0aCwKICAgICAgcmV0LAogICAgICBpc0N1c3RvbVByb3AgPSByY3VzdG9tUHJvcC50ZXN0KG5hbWUpLAogICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDUxKwogICAgICAvLyBSZXRyaWV2aW5nIHN0eWxlIGJlZm9yZSBjb21wdXRlZCBzb21laG93CiAgICAgIC8vIGZpeGVzIGFuIGlzc3VlIHdpdGggZ2V0dGluZyB3cm9uZyB2YWx1ZXMKICAgICAgLy8gb24gZGV0YWNoZWQgZWxlbWVudHMKICAgICAgc3R5bGUgPSBlbGVtLnN0eWxlOwogICAgY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoZWxlbSk7CgogICAgLy8gZ2V0UHJvcGVydHlWYWx1ZSBpcyBuZWVkZWQgZm9yOgogICAgLy8gICAuY3NzKCdmaWx0ZXInKSAoSUUgOSBvbmx5LCB0cmFjLTEyNTM3KQogICAgLy8gICAuY3NzKCctLWN1c3RvbVByb3BlcnR5KSAoZ2gtMzE0NCkKICAgIGlmIChjb21wdXRlZCkgewogICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsKICAgICAgLy8gSUUgb25seSBzdXBwb3J0cyBgImZsb2F0ImAgaW4gYGdldFByb3BlcnR5VmFsdWVgOyBpbiBjb21wdXRlZCBzdHlsZXMKICAgICAgLy8gaXQncyBvbmx5IGF2YWlsYWJsZSBhcyBgImNzc0Zsb2F0ImAuIFdlIG5vIGxvbmdlciBtb2RpZnkgcHJvcGVydGllcwogICAgICAvLyBzZW50IHRvIGAuY3NzKClgIGFwYXJ0IGZyb20gY2FtZWxDYXNpbmcsIHNvIHdlIG5lZWQgdG8gY2hlY2sgYm90aC4KICAgICAgLy8gTm9ybWFsbHksIHRoaXMgd291bGQgY3JlYXRlIGRpZmZlcmVuY2UgaW4gYmVoYXZpb3I6IGlmCiAgICAgIC8vIGBnZXRQcm9wZXJ0eVZhbHVlYCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZywgdGhlIHZhbHVlIHJldHVybmVkCiAgICAgIC8vIGJ5IGAuY3NzKClgIHdvdWxkIGJlIGB1bmRlZmluZWRgLiBUaGlzIGlzIHVzdWFsbHkgdGhlIGNhc2UgZm9yCiAgICAgIC8vIGRpc2Nvbm5lY3RlZCBlbGVtZW50cy4gSG93ZXZlciwgaW4gSUUgZXZlbiBkaXNjb25uZWN0ZWQgZWxlbWVudHMKICAgICAgLy8gd2l0aCBubyBzdHlsZXMgcmV0dXJuIGAibm9uZSJgIGZvciBgZ2V0UHJvcGVydHlWYWx1ZSggImZsb2F0IiApYAogICAgICByZXQgPSBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpIHx8IGNvbXB1dGVkW25hbWVdOwogICAgICBpZiAoaXNDdXN0b21Qcm9wICYmIHJldCkgewogICAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggMTA1KywgQ2hyb21lIDw9MTA1KwogICAgICAgIC8vIFNwZWMgcmVxdWlyZXMgdHJpbW1pbmcgd2hpdGVzcGFjZSBmb3IgY3VzdG9tIHByb3BlcnRpZXMgKGdoLTQ5MjYpLgogICAgICAgIC8vIEZpcmVmb3ggb25seSB0cmltcyBsZWFkaW5nIHdoaXRlc3BhY2UuIENocm9tZSBqdXN0IGNvbGxhcHNlcwogICAgICAgIC8vIGJvdGggbGVhZGluZyAmIHRyYWlsaW5nIHdoaXRlc3BhY2UgdG8gYSBzaW5nbGUgc3BhY2UuCiAgICAgICAgLy8KICAgICAgICAvLyBGYWxsIGJhY2sgdG8gYHVuZGVmaW5lZGAgaWYgZW1wdHkgc3RyaW5nIHJldHVybmVkLgogICAgICAgIC8vIFRoaXMgY29sbGFwc2VzIGEgbWlzc2luZyBkZWZpbml0aW9uIHdpdGggcHJvcGVydHkgZGVmaW5lZAogICAgICAgIC8vIGFuZCBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nIGJ1dCB0aGVyZSdzIG5vIHN0YW5kYXJkIEFQSQogICAgICAgIC8vIGFsbG93aW5nIHVzIHRvIGRpZmZlcmVudGlhdGUgdGhlbSB3aXRob3V0IGEgcGVyZm9ybWFuY2UgcGVuYWx0eQogICAgICAgIC8vIGFuZCByZXR1cm5pbmcgYHVuZGVmaW5lZGAgYWxpZ25zIHdpdGggb2xkZXIgalF1ZXJ5LgogICAgICAgIC8vCiAgICAgICAgLy8gcnRyaW1DU1MgdHJlYXRzIFUrMDAwRCBDQVJSSUFHRSBSRVRVUk4gYW5kIFUrMDAwQyBGT1JNIEZFRUQKICAgICAgICAvLyBhcyB3aGl0ZXNwYWNlIHdoaWxlIENTUyBkb2VzIG5vdCwgYnV0IHRoaXMgaXMgbm90IGEgcHJvYmxlbQogICAgICAgIC8vIGJlY2F1c2UgQ1NTIHByZXByb2Nlc3NpbmcgcmVwbGFjZXMgdGhlbSB3aXRoIFUrMDAwQSBMSU5FIEZFRUQKICAgICAgICAvLyAod2hpY2ggKmlzKiBDU1Mgd2hpdGVzcGFjZSkKICAgICAgICAvLyBodHRwczovL3d3dy53My5vcmcvVFIvY3NzLXN5bnRheC0zLyNpbnB1dC1wcmVwcm9jZXNzaW5nCiAgICAgICAgcmV0ID0gcmV0LnJlcGxhY2UocnRyaW1DU1MsICIkMSIpIHx8IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAocmV0ID09PSAiIiAmJiAhaXNBdHRhY2hlZChlbGVtKSkgewogICAgICAgIHJldCA9IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lKTsKICAgICAgfQoKICAgICAgLy8gQSB0cmlidXRlIHRvIHRoZSAiYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcyIKICAgICAgLy8gQW5kcm9pZCBCcm93c2VyIHJldHVybnMgcGVyY2VudGFnZSBmb3Igc29tZSB2YWx1ZXMsCiAgICAgIC8vIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMuCiAgICAgIC8vIFRoaXMgaXMgYWdhaW5zdCB0aGUgQ1NTT00gZHJhZnQgc3BlYzoKICAgICAgLy8gaHR0cHM6Ly9kcmFmdHMuY3Nzd2cub3JnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKICAgICAgaWYgKCFzdXBwb3J0LnBpeGVsQm94U3R5bGVzKCkgJiYgcm51bW5vbnB4LnRlc3QocmV0KSAmJiByYm94U3R5bGUudGVzdChuYW1lKSkgewogICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICB3aWR0aCA9IHN0eWxlLndpZHRoOwogICAgICAgIG1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CiAgICAgICAgbWF4V2lkdGggPSBzdHlsZS5tYXhXaWR0aDsKCiAgICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAogICAgICAgIHN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKICAgICAgICByZXQgPSBjb21wdXRlZC53aWR0aDsKCiAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgIHN0eWxlLndpZHRoID0gd2lkdGg7CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBtaW5XaWR0aDsKICAgICAgICBzdHlsZS5tYXhXaWR0aCA9IG1heFdpZHRoOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmV0ICE9PSB1bmRlZmluZWQgPwogICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQogICAgLy8gSUUgcmV0dXJucyB6SW5kZXggdmFsdWUgYXMgYW4gaW50ZWdlci4KICAgIHJldCArICIiIDogcmV0OwogIH0KICBmdW5jdGlvbiBhZGRHZXRIb29rSWYoY29uZGl0aW9uRm4sIGhvb2tGbikgewogICAgLy8gRGVmaW5lIHRoZSBob29rLCB3ZSdsbCBjaGVjayBvbiB0aGUgZmlyc3QgcnVuIGlmIGl0J3MgcmVhbGx5IG5lZWRlZC4KICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChjb25kaXRpb25GbigpKSB7CiAgICAgICAgICAvLyBIb29rIG5vdCBuZWVkZWQgKG9yIGl0J3Mgbm90IHBvc3NpYmxlIHRvIHVzZSBpdCBkdWUKICAgICAgICAgIC8vIHRvIG1pc3NpbmcgZGVwZW5kZW5jeSksIHJlbW92ZSBpdC4KICAgICAgICAgIGRlbGV0ZSB0aGlzLmdldDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIEhvb2sgbmVlZGVkOyByZWRlZmluZSBpdCBzbyB0aGF0IHRoZSBzdXBwb3J0IHRlc3QgaXMgbm90IGV4ZWN1dGVkIGFnYWluLgogICAgICAgIHJldHVybiAodGhpcy5nZXQgPSBob29rRm4pLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQogIHZhciBjc3NQcmVmaXhlcyA9IFsiV2Via2l0IiwgIk1veiIsICJtcyJdLAogICAgZW1wdHlTdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlLAogICAgdmVuZG9yUHJvcHMgPSB7fTsKCiAgLy8gUmV0dXJuIGEgdmVuZG9yLXByZWZpeGVkIHByb3BlcnR5IG9yIHVuZGVmaW5lZAogIGZ1bmN0aW9uIHZlbmRvclByb3BOYW1lKG5hbWUpIHsKICAgIC8vIENoZWNrIGZvciB2ZW5kb3IgcHJlZml4ZWQgbmFtZXMKICAgIHZhciBjYXBOYW1lID0gbmFtZVswXS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKICAgICAgaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgbmFtZSA9IGNzc1ByZWZpeGVzW2ldICsgY2FwTmFtZTsKICAgICAgaWYgKG5hbWUgaW4gZW1wdHlTdHlsZSkgewogICAgICAgIHJldHVybiBuYW1lOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZXR1cm4gYSBwb3RlbnRpYWxseS1tYXBwZWQgalF1ZXJ5LmNzc1Byb3BzIG9yIHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQogIGZ1bmN0aW9uIGZpbmFsUHJvcE5hbWUobmFtZSkgewogICAgdmFyIGZpbmFsID0galF1ZXJ5LmNzc1Byb3BzW25hbWVdIHx8IHZlbmRvclByb3BzW25hbWVdOwogICAgaWYgKGZpbmFsKSB7CiAgICAgIHJldHVybiBmaW5hbDsKICAgIH0KICAgIGlmIChuYW1lIGluIGVtcHR5U3R5bGUpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgICByZXR1cm4gdmVuZG9yUHJvcHNbbmFtZV0gPSB2ZW5kb3JQcm9wTmFtZShuYW1lKSB8fCBuYW1lOwogIH0KICB2YXIKICAgIC8vIFN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUKICAgIC8vIGV4Y2VwdCAidGFibGUiLCAidGFibGUtY2VsbCIsIG9yICJ0YWJsZS1jYXB0aW9uIgogICAgLy8gU2VlIGhlcmUgZm9yIGRpc3BsYXkgdmFsdWVzOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0NTUy9kaXNwbGF5CiAgICByZGlzcGxheXN3YXAgPSAvXihub25lfHRhYmxlKD8hLWNbZWFdKS4rKS8sCiAgICBjc3NTaG93ID0gewogICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIsCiAgICAgIGRpc3BsYXk6ICJibG9jayIKICAgIH0sCiAgICBjc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CiAgICAgIGxldHRlclNwYWNpbmc6ICIwIiwKICAgICAgZm9udFdlaWdodDogIjQwMCIKICAgIH07CiAgZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoX2VsZW0sIHZhbHVlLCBzdWJ0cmFjdCkgewogICAgLy8gQW55IHJlbGF0aXZlICgrLy0pIHZhbHVlcyBoYXZlIGFscmVhZHkgYmVlbgogICAgLy8gbm9ybWFsaXplZCBhdCB0aGlzIHBvaW50CiAgICB2YXIgbWF0Y2hlcyA9IHJjc3NOdW0uZXhlYyh2YWx1ZSk7CiAgICByZXR1cm4gbWF0Y2hlcyA/CiAgICAvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MKICAgIE1hdGgubWF4KDAsIG1hdGNoZXNbMl0gLSAoc3VidHJhY3QgfHwgMCkpICsgKG1hdGNoZXNbM10gfHwgInB4IikgOiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gYm94TW9kZWxBZGp1c3RtZW50KGVsZW0sIGRpbWVuc2lvbiwgYm94LCBpc0JvcmRlckJveCwgc3R5bGVzLCBjb21wdXRlZFZhbCkgewogICAgdmFyIGkgPSBkaW1lbnNpb24gPT09ICJ3aWR0aCIgPyAxIDogMCwKICAgICAgZXh0cmEgPSAwLAogICAgICBkZWx0YSA9IDAsCiAgICAgIG1hcmdpbkRlbHRhID0gMDsKCiAgICAvLyBBZGp1c3RtZW50IG1heSBub3QgYmUgbmVjZXNzYXJ5CiAgICBpZiAoYm94ID09PSAoaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IikpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICBmb3IgKDsgaSA8IDQ7IGkgKz0gMikgewogICAgICAvLyBCb3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4KICAgICAgLy8gQ291bnQgbWFyZ2luIGRlbHRhIHNlcGFyYXRlbHkgdG8gb25seSBhZGQgaXQgYWZ0ZXIgc2Nyb2xsIGd1dHRlciBhZGp1c3RtZW50LgogICAgICAvLyBUaGlzIGlzIG5lZWRlZCB0byBtYWtlIG5lZ2F0aXZlIG1hcmdpbnMgd29yayB3aXRoIGBvdXRlckhlaWdodCggdHJ1ZSApYCAoZ2gtMzk4MikuCiAgICAgIGlmIChib3ggPT09ICJtYXJnaW4iKSB7CiAgICAgICAgbWFyZ2luRGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCBib3ggKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CiAgICAgIH0KCiAgICAgIC8vIElmIHdlIGdldCBoZXJlIHdpdGggYSBjb250ZW50LWJveCwgd2UncmUgc2Vla2luZyAicGFkZGluZyIgb3IgImJvcmRlciIgb3IgIm1hcmdpbiIKICAgICAgaWYgKCFpc0JvcmRlckJveCkgewogICAgICAgIC8vIEFkZCBwYWRkaW5nCiAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CgogICAgICAgIC8vIEZvciAiYm9yZGVyIiBvciAibWFyZ2luIiwgYWRkIGJvcmRlcgogICAgICAgIGlmIChib3ggIT09ICJwYWRkaW5nIikgewogICAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFtpXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyk7CgogICAgICAgICAgLy8gQnV0IHN0aWxsIGtlZXAgdHJhY2sgb2YgaXQgb3RoZXJ3aXNlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4dHJhICs9IGpRdWVyeS5jc3MoZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbaV0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgZ2V0IGhlcmUgd2l0aCBhIGJvcmRlci1ib3ggKGNvbnRlbnQgKyBwYWRkaW5nICsgYm9yZGVyKSwgd2UncmUgc2Vla2luZyAiY29udGVudCIgb3IKICAgICAgICAvLyAicGFkZGluZyIgb3IgIm1hcmdpbiIKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBGb3IgImNvbnRlbnQiLCBzdWJ0cmFjdCBwYWRkaW5nCiAgICAgICAgaWYgKGJveCA9PT0gImNvbnRlbnQiKSB7CiAgICAgICAgICBkZWx0YSAtPSBqUXVlcnkuY3NzKGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFtpXSwgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICB9CgogICAgICAgIC8vIEZvciAiY29udGVudCIgb3IgInBhZGRpbmciLCBzdWJ0cmFjdCBib3JkZXIKICAgICAgICBpZiAoYm94ICE9PSAibWFyZ2luIikgewogICAgICAgICAgZGVsdGEgLT0galF1ZXJ5LmNzcyhlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFtpXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gQWNjb3VudCBmb3IgcG9zaXRpdmUgY29udGVudC1ib3ggc2Nyb2xsIGd1dHRlciB3aGVuIHJlcXVlc3RlZCBieSBwcm92aWRpbmcgY29tcHV0ZWRWYWwKICAgIGlmICghaXNCb3JkZXJCb3ggJiYgY29tcHV0ZWRWYWwgPj0gMCkgewogICAgICAvLyBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgaXMgYSByb3VuZGVkIHN1bSBvZiBjb250ZW50LCBwYWRkaW5nLCBzY3JvbGwgZ3V0dGVyLCBhbmQgYm9yZGVyCiAgICAgIC8vIEFzc3VtaW5nIGludGVnZXIgc2Nyb2xsIGd1dHRlciwgc3VidHJhY3QgdGhlIHJlc3QgYW5kIHJvdW5kIGRvd24KICAgICAgZGVsdGEgKz0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKGVsZW1bIm9mZnNldCIgKyBkaW1lbnNpb25bMF0udG9VcHBlckNhc2UoKSArIGRpbWVuc2lvbi5zbGljZSgxKV0gLSBjb21wdXRlZFZhbCAtIGRlbHRhIC0gZXh0cmEgLSAwLjUKCiAgICAgIC8vIElmIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBpcyB1bmtub3duLCB0aGVuIHdlIGNhbid0IGRldGVybWluZSBjb250ZW50LWJveCBzY3JvbGwgZ3V0dGVyCiAgICAgIC8vIFVzZSBhbiBleHBsaWNpdCB6ZXJvIHRvIGF2b2lkIE5hTiAoZ2gtMzk2NCkKICAgICAgKSkgfHwgMDsKICAgIH0KICAgIHJldHVybiBkZWx0YSArIG1hcmdpbkRlbHRhOwogIH0KICBmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIGRpbWVuc2lvbiwgZXh0cmEpIHsKICAgIC8vIFN0YXJ0IHdpdGggY29tcHV0ZWQgc3R5bGUKICAgIHZhciBzdHlsZXMgPSBnZXRTdHlsZXMoZWxlbSksCiAgICAgIC8vIFRvIGF2b2lkIGZvcmNpbmcgYSByZWZsb3csIG9ubHkgZmV0Y2ggYm94U2l6aW5nIGlmIHdlIG5lZWQgaXQgKGdoLTQzMjIpLgogICAgICAvLyBGYWtlIGNvbnRlbnQtYm94IHVudGlsIHdlIGtub3cgaXQncyBuZWVkZWQgdG8ga25vdyB0aGUgdHJ1ZSB2YWx1ZS4KICAgICAgYm94U2l6aW5nTmVlZGVkID0gIXN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUoKSB8fCBleHRyYSwKICAgICAgaXNCb3JkZXJCb3ggPSBib3hTaXppbmdOZWVkZWQgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcykgPT09ICJib3JkZXItYm94IiwKICAgICAgdmFsdWVJc0JvcmRlckJveCA9IGlzQm9yZGVyQm94LAogICAgICB2YWwgPSBjdXJDU1MoZWxlbSwgZGltZW5zaW9uLCBzdHlsZXMpLAogICAgICBvZmZzZXRQcm9wID0gIm9mZnNldCIgKyBkaW1lbnNpb25bMF0udG9VcHBlckNhc2UoKSArIGRpbWVuc2lvbi5zbGljZSgxKTsKCiAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDw9NTQKICAgIC8vIFJldHVybiBhIGNvbmZvdW5kaW5nIG5vbi1waXhlbCB2YWx1ZSBvciBmZWlnbiBpZ25vcmFuY2UsIGFzIGFwcHJvcHJpYXRlLgogICAgaWYgKHJudW1ub25weC50ZXN0KHZhbCkpIHsKICAgICAgaWYgKCFleHRyYSkgewogICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0KICAgICAgdmFsID0gImF1dG8iOwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5CiAgICAvLyBVc2Ugb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGZvciB3aGVuIGJveCBzaXppbmcgaXMgdW5yZWxpYWJsZS4KICAgIC8vIEluIHRob3NlIGNhc2VzLCB0aGUgY29tcHV0ZWQgdmFsdWUgY2FuIGJlIHRydXN0ZWQgdG8gYmUgYm9yZGVyLWJveC4KICAgIGlmICgoIXN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUoKSAmJiBpc0JvcmRlckJveCB8fAogICAgLy8gU3VwcG9ydDogSUUgMTAgLSAxMSssIEVkZ2UgMTUgLSAxOCsKICAgIC8vIElFL0VkZ2UgbWlzcmVwb3J0IGBnZXRDb21wdXRlZFN0eWxlYCBvZiB0YWJsZSByb3dzIHdpdGggd2lkdGgvaGVpZ2h0CiAgICAvLyBzZXQgaW4gQ1NTIHdoaWxlIGBvZmZzZXQqYCBwcm9wZXJ0aWVzIHJlcG9ydCBjb3JyZWN0IHZhbHVlcy4KICAgIC8vIEludGVyZXN0aW5nbHksIGluIHNvbWUgY2FzZXMgSUUgOSBkb2Vzbid0IHN1ZmZlciBmcm9tIHRoaXMgaXNzdWUuCiAgICAhc3VwcG9ydC5yZWxpYWJsZVRyRGltZW5zaW9ucygpICYmIG5vZGVOYW1lKGVsZW0sICJ0ciIpIHx8CiAgICAvLyBGYWxsIGJhY2sgdG8gb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IHdoZW4gdmFsdWUgaXMgImF1dG8iCiAgICAvLyBUaGlzIGhhcHBlbnMgZm9yIGlubGluZSBlbGVtZW50cyB3aXRoIG5vIGV4cGxpY2l0IHNldHRpbmcgKGdoLTM1NzEpCiAgICB2YWwgPT09ICJhdXRvIiB8fAogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMSAtIDQuMyBvbmx5CiAgICAvLyBBbHNvIHVzZSBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgZm9yIG1pc3JlcG9ydGVkIGlubGluZSBkaW1lbnNpb25zIChnaC0zNjAyKQogICAgIXBhcnNlRmxvYXQodmFsKSAmJiBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5IiwgZmFsc2UsIHN0eWxlcykgPT09ICJpbmxpbmUiKSAmJgogICAgLy8gTWFrZSBzdXJlIHRoZSBlbGVtZW50IGlzIHZpc2libGUgJiBjb25uZWN0ZWQKICAgIGVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgpIHsKICAgICAgaXNCb3JkZXJCb3ggPSBqUXVlcnkuY3NzKGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzKSA9PT0gImJvcmRlci1ib3giOwoKICAgICAgLy8gV2hlcmUgYXZhaWxhYmxlLCBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgYXBwcm94aW1hdGUgYm9yZGVyIGJveCBkaW1lbnNpb25zLgogICAgICAvLyBXaGVyZSBub3QgYXZhaWxhYmxlIChlLmcuLCBTVkcpLCBhc3N1bWUgdW5yZWxpYWJsZSBib3gtc2l6aW5nIGFuZCBpbnRlcnByZXQgdGhlCiAgICAgIC8vIHJldHJpZXZlZCB2YWx1ZSBhcyBhIGNvbnRlbnQgYm94IGRpbWVuc2lvbi4KICAgICAgdmFsdWVJc0JvcmRlckJveCA9IG9mZnNldFByb3AgaW4gZWxlbTsKICAgICAgaWYgKHZhbHVlSXNCb3JkZXJCb3gpIHsKICAgICAgICB2YWwgPSBlbGVtW29mZnNldFByb3BdOwogICAgICB9CiAgICB9CgogICAgLy8gTm9ybWFsaXplICIiIGFuZCBhdXRvCiAgICB2YWwgPSBwYXJzZUZsb2F0KHZhbCkgfHwgMDsKCiAgICAvLyBBZGp1c3QgZm9yIHRoZSBlbGVtZW50J3MgYm94IG1vZGVsCiAgICByZXR1cm4gdmFsICsgYm94TW9kZWxBZGp1c3RtZW50KGVsZW0sIGRpbWVuc2lvbiwgZXh0cmEgfHwgKGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIpLCB2YWx1ZUlzQm9yZGVyQm94LCBzdHlsZXMsCiAgICAvLyBQcm92aWRlIHRoZSBjdXJyZW50IGNvbXB1dGVkIHNpemUgdG8gcmVxdWVzdCBzY3JvbGwgZ3V0dGVyIGNhbGN1bGF0aW9uIChnaC0zNTg5KQogICAgdmFsKSArICJweCI7CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CiAgICAvLyBiZWhhdmlvciBvZiBnZXR0aW5nIGFuZCBzZXR0aW5nIGEgc3R5bGUgcHJvcGVydHkKICAgIGNzc0hvb2tzOiB7CiAgICAgIG9wYWNpdHk6IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgICAgIC8vIFdlIHNob3VsZCBhbHdheXMgZ2V0IGEgbnVtYmVyIGJhY2sgZnJvbSBvcGFjaXR5CiAgICAgICAgICAgIHZhciByZXQgPSBjdXJDU1MoZWxlbSwgIm9wYWNpdHkiKTsKICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gIiIgPyAiMSIgOiByZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gRG9uJ3QgYXV0b21hdGljYWxseSBhZGQgInB4IiB0byB0aGVzZSBwb3NzaWJseS11bml0bGVzcyBwcm9wZXJ0aWVzCiAgICBjc3NOdW1iZXI6IHsKICAgICAgYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQ6IHRydWUsCiAgICAgIGFzcGVjdFJhdGlvOiB0cnVlLAogICAgICBib3JkZXJJbWFnZVNsaWNlOiB0cnVlLAogICAgICBjb2x1bW5Db3VudDogdHJ1ZSwKICAgICAgZmxleEdyb3c6IHRydWUsCiAgICAgIGZsZXhTaHJpbms6IHRydWUsCiAgICAgIGZvbnRXZWlnaHQ6IHRydWUsCiAgICAgIGdyaWRBcmVhOiB0cnVlLAogICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICBncmlkQ29sdW1uRW5kOiB0cnVlLAogICAgICBncmlkQ29sdW1uU3RhcnQ6IHRydWUsCiAgICAgIGdyaWRSb3c6IHRydWUsCiAgICAgIGdyaWRSb3dFbmQ6IHRydWUsCiAgICAgIGdyaWRSb3dTdGFydDogdHJ1ZSwKICAgICAgbGluZUhlaWdodDogdHJ1ZSwKICAgICAgb3BhY2l0eTogdHJ1ZSwKICAgICAgb3JkZXI6IHRydWUsCiAgICAgIG9ycGhhbnM6IHRydWUsCiAgICAgIHNjYWxlOiB0cnVlLAogICAgICB3aWRvd3M6IHRydWUsCiAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgem9vbTogdHJ1ZSwKICAgICAgLy8gU1ZHLXJlbGF0ZWQKICAgICAgZmlsbE9wYWNpdHk6IHRydWUsCiAgICAgIGZsb29kT3BhY2l0eTogdHJ1ZSwKICAgICAgc3RvcE9wYWNpdHk6IHRydWUsCiAgICAgIHN0cm9rZU1pdGVybGltaXQ6IHRydWUsCiAgICAgIHN0cm9rZU9wYWNpdHk6IHRydWUKICAgIH0sCiAgICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgICAvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCiAgICBjc3NQcm9wczoge30sCiAgICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogICAgc3R5bGU6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEpIHsKICAgICAgLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQogICAgICB2YXIgcmV0LAogICAgICAgIHR5cGUsCiAgICAgICAgaG9va3MsCiAgICAgICAgb3JpZ05hbWUgPSBjYW1lbENhc2UobmFtZSksCiAgICAgICAgaXNDdXN0b21Qcm9wID0gcmN1c3RvbVByb3AudGVzdChuYW1lKSwKICAgICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUuIFdlIGRvbid0CiAgICAgIC8vIHdhbnQgdG8gcXVlcnkgdGhlIHZhbHVlIGlmIGl0IGlzIGEgQ1NTIGN1c3RvbSBwcm9wZXJ0eQogICAgICAvLyBzaW5jZSB0aGV5IGFyZSB1c2VyLWRlZmluZWQuCiAgICAgIGlmICghaXNDdXN0b21Qcm9wKSB7CiAgICAgICAgbmFtZSA9IGZpbmFsUHJvcE5hbWUob3JpZ05hbWUpOwogICAgICB9CgogICAgICAvLyBHZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uLCB0aGVuIHVucHJlZml4ZWQgdmVyc2lvbgogICAgICBob29rcyA9IGpRdWVyeS5jc3NIb29rc1tuYW1lXSB8fCBqUXVlcnkuY3NzSG9va3Nbb3JpZ05hbWVdOwoKICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgc2V0dGluZyBhIHZhbHVlCiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCiAgICAgICAgLy8gQ29udmVydCAiKz0iIG9yICItPSIgdG8gcmVsYXRpdmUgbnVtYmVycyAodHJhYy03MzQ1KQogICAgICAgIGlmICh0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcmNzc051bS5leGVjKHZhbHVlKSkgJiYgcmV0WzFdKSB7CiAgICAgICAgICB2YWx1ZSA9IGFkanVzdENTUyhlbGVtLCBuYW1lLCByZXQpOwoKICAgICAgICAgIC8vIEZpeGVzIGJ1ZyB0cmFjLTkyMzcKICAgICAgICAgIHR5cGUgPSAibnVtYmVyIjsKICAgICAgICB9CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG51bGwgYW5kIE5hTiB2YWx1ZXMgYXJlbid0IHNldCAodHJhYy03MTE2KQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgYSBudW1iZXIgd2FzIHBhc3NlZCBpbiwgYWRkIHRoZSB1bml0IChleGNlcHQgZm9yIGNlcnRhaW4gQ1NTIHByb3BlcnRpZXMpCiAgICAgICAgLy8gVGhlIGlzQ3VzdG9tUHJvcCBjaGVjayBjYW4gYmUgcmVtb3ZlZCBpbiBqUXVlcnkgNC4wIHdoZW4gd2Ugb25seSBhdXRvLWFwcGVuZAogICAgICAgIC8vICJweCIgdG8gYSBmZXcgaGFyZGNvZGVkIHZhbHVlcy4KICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIgJiYgIWlzQ3VzdG9tUHJvcCkgewogICAgICAgICAgdmFsdWUgKz0gcmV0ICYmIHJldFszXSB8fCAoalF1ZXJ5LmNzc051bWJlcltvcmlnTmFtZV0gPyAiIiA6ICJweCIpOwogICAgICAgIH0KCiAgICAgICAgLy8gYmFja2dyb3VuZC0qIHByb3BzIGFmZmVjdCBvcmlnaW5hbCBjbG9uZSdzIHZhbHVlcwogICAgICAgIGlmICghc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgJiYgdmFsdWUgPT09ICIiICYmIG5hbWUuaW5kZXhPZigiYmFja2dyb3VuZCIpID09PSAwKSB7CiAgICAgICAgICBzdHlsZVtuYW1lXSA9ICJpbmhlcml0IjsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQogICAgICAgIGlmICghaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgKHZhbHVlID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBleHRyYSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGlmIChpc0N1c3RvbVByb3ApIHsKICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgICAgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgZmFsc2UsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CgogICAgICAgIC8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0CiAgICAgICAgcmV0dXJuIHN0eWxlW25hbWVdOwogICAgICB9CiAgICB9LAogICAgY3NzOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZXh0cmEsIHN0eWxlcykgewogICAgICB2YXIgdmFsLAogICAgICAgIG51bSwKICAgICAgICBob29rcywKICAgICAgICBvcmlnTmFtZSA9IGNhbWVsQ2FzZShuYW1lKSwKICAgICAgICBpc0N1c3RvbVByb3AgPSByY3VzdG9tUHJvcC50ZXN0KG5hbWUpOwoKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lLiBXZSBkb24ndAogICAgICAvLyB3YW50IHRvIG1vZGlmeSB0aGUgdmFsdWUgaWYgaXQgaXMgYSBDU1MgY3VzdG9tIHByb3BlcnR5CiAgICAgIC8vIHNpbmNlIHRoZXkgYXJlIHVzZXItZGVmaW5lZC4KICAgICAgaWYgKCFpc0N1c3RvbVByb3ApIHsKICAgICAgICBuYW1lID0gZmluYWxQcm9wTmFtZShvcmlnTmFtZSk7CiAgICAgIH0KCiAgICAgIC8vIFRyeSBwcmVmaXhlZCBuYW1lIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIG5hbWUKICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV0gfHwgalF1ZXJ5LmNzc0hvb2tzW29yaWdOYW1lXTsKCiAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcykgewogICAgICAgIHZhbCA9IGhvb2tzLmdldChlbGVtLCB0cnVlLCBleHRyYSk7CiAgICAgIH0KCiAgICAgIC8vIE90aGVyd2lzZSwgaWYgYSB3YXkgdG8gZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBleGlzdHMsIHVzZSB0aGF0CiAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhbCA9IGN1ckNTUyhlbGVtLCBuYW1lLCBzdHlsZXMpOwogICAgICB9CgogICAgICAvLyBDb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCiAgICAgIGlmICh2YWwgPT09ICJub3JtYWwiICYmIG5hbWUgaW4gY3NzTm9ybWFsVHJhbnNmb3JtKSB7CiAgICAgICAgdmFsID0gY3NzTm9ybWFsVHJhbnNmb3JtW25hbWVdOwogICAgICB9CgogICAgICAvLyBNYWtlIG51bWVyaWMgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKICAgICAgaWYgKGV4dHJhID09PSAiIiB8fCBleHRyYSkgewogICAgICAgIG51bSA9IHBhcnNlRmxvYXQodmFsKTsKICAgICAgICByZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgaXNGaW5pdGUobnVtKSA/IG51bSB8fCAwIDogdmFsOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWyJoZWlnaHQiLCAid2lkdGgiXSwgZnVuY3Rpb24gKF9pLCBkaW1lbnNpb24pIHsKICAgIGpRdWVyeS5jc3NIb29rc1tkaW1lbnNpb25dID0gewogICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCwgZXh0cmEpIHsKICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgIC8vIENlcnRhaW4gZWxlbWVudHMgY2FuIGhhdmUgZGltZW5zaW9uIGluZm8gaWYgd2UgaW52aXNpYmx5IHNob3cgdGhlbQogICAgICAgICAgLy8gYnV0IGl0IG11c3QgaGF2ZSBhIGN1cnJlbnQgZGlzcGxheSBzdHlsZSB0aGF0IHdvdWxkIGJlbmVmaXQKICAgICAgICAgIHJldHVybiByZGlzcGxheXN3YXAudGVzdChqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5IikpICYmICgKICAgICAgICAgIC8vIFN1cHBvcnQ6IFNhZmFyaSA4KwogICAgICAgICAgLy8gVGFibGUgY29sdW1ucyBpbiBTYWZhcmkgaGF2ZSBub24temVybyBvZmZzZXRXaWR0aCAmIHplcm8KICAgICAgICAgIC8vIGdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoIHVubGVzcyBkaXNwbGF5IGlzIGNoYW5nZWQuCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKICAgICAgICAgIC8vIFJ1bm5pbmcgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IG9uIGEgZGlzY29ubmVjdGVkIG5vZGUKICAgICAgICAgIC8vIGluIElFIHRocm93cyBhbiBlcnJvci4KICAgICAgICAgICFlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoIHx8ICFlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoKSA/IHN3YXAoZWxlbSwgY3NzU2hvdywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gZ2V0V2lkdGhPckhlaWdodChlbGVtLCBkaW1lbnNpb24sIGV4dHJhKTsKICAgICAgICAgIH0pIDogZ2V0V2lkdGhPckhlaWdodChlbGVtLCBkaW1lbnNpb24sIGV4dHJhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlLCBleHRyYSkgewogICAgICAgIHZhciBtYXRjaGVzLAogICAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pLAogICAgICAgICAgLy8gT25seSByZWFkIHN0eWxlcy5wb3NpdGlvbiBpZiB0aGUgdGVzdCBoYXMgYSBjaGFuY2UgdG8gZmFpbAogICAgICAgICAgLy8gdG8gYXZvaWQgZm9yY2luZyBhIHJlZmxvdy4KICAgICAgICAgIHNjcm9sbGJveFNpemVCdWdneSA9ICFzdXBwb3J0LnNjcm9sbGJveFNpemUoKSAmJiBzdHlsZXMucG9zaXRpb24gPT09ICJhYnNvbHV0ZSIsCiAgICAgICAgICAvLyBUbyBhdm9pZCBmb3JjaW5nIGEgcmVmbG93LCBvbmx5IGZldGNoIGJveFNpemluZyBpZiB3ZSBuZWVkIGl0IChnaC0zOTkxKQogICAgICAgICAgYm94U2l6aW5nTmVlZGVkID0gc2Nyb2xsYm94U2l6ZUJ1Z2d5IHx8IGV4dHJhLAogICAgICAgICAgaXNCb3JkZXJCb3ggPSBib3hTaXppbmdOZWVkZWQgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcykgPT09ICJib3JkZXItYm94IiwKICAgICAgICAgIHN1YnRyYWN0ID0gZXh0cmEgPyBib3hNb2RlbEFkanVzdG1lbnQoZWxlbSwgZGltZW5zaW9uLCBleHRyYSwgaXNCb3JkZXJCb3gsIHN0eWxlcykgOiAwOwoKICAgICAgICAvLyBBY2NvdW50IGZvciB1bnJlbGlhYmxlIGJvcmRlci1ib3ggZGltZW5zaW9ucyBieSBjb21wYXJpbmcgb2Zmc2V0KiB0byBjb21wdXRlZCBhbmQKICAgICAgICAvLyBmYWtpbmcgYSBjb250ZW50LWJveCB0byBnZXQgYm9yZGVyIGFuZCBwYWRkaW5nIChnaC0zNjk5KQogICAgICAgIGlmIChpc0JvcmRlckJveCAmJiBzY3JvbGxib3hTaXplQnVnZ3kpIHsKICAgICAgICAgIHN1YnRyYWN0IC09IE1hdGguY2VpbChlbGVtWyJvZmZzZXQiICsgZGltZW5zaW9uWzBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoMSldIC0gcGFyc2VGbG9hdChzdHlsZXNbZGltZW5zaW9uXSkgLSBib3hNb2RlbEFkanVzdG1lbnQoZWxlbSwgZGltZW5zaW9uLCAiYm9yZGVyIiwgZmFsc2UsIHN0eWxlcykgLSAwLjUpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ29udmVydCB0byBwaXhlbHMgaWYgdmFsdWUgYWRqdXN0bWVudCBpcyBuZWVkZWQKICAgICAgICBpZiAoc3VidHJhY3QgJiYgKG1hdGNoZXMgPSByY3NzTnVtLmV4ZWModmFsdWUpKSAmJiAobWF0Y2hlc1szXSB8fCAicHgiKSAhPT0gInB4IikgewogICAgICAgICAgZWxlbS5zdHlsZVtkaW1lbnNpb25dID0gdmFsdWU7CiAgICAgICAgICB2YWx1ZSA9IGpRdWVyeS5jc3MoZWxlbSwgZGltZW5zaW9uKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCk7CiAgICAgIH0KICAgIH07CiAgfSk7CiAgalF1ZXJ5LmNzc0hvb2tzLm1hcmdpbkxlZnQgPSBhZGRHZXRIb29rSWYoc3VwcG9ydC5yZWxpYWJsZU1hcmdpbkxlZnQsIGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgIHJldHVybiAocGFyc2VGbG9hdChjdXJDU1MoZWxlbSwgIm1hcmdpbkxlZnQiKSkgfHwgZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IC0gc3dhcChlbGVtLCB7CiAgICAgICAgbWFyZ2luTGVmdDogMAogICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdDsKICAgICAgfSkpICsgInB4IjsKICAgIH0KICB9KTsKCiAgLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcwogIGpRdWVyeS5lYWNoKHsKICAgIG1hcmdpbjogIiIsCiAgICBwYWRkaW5nOiAiIiwKICAgIGJvcmRlcjogIldpZHRoIgogIH0sIGZ1bmN0aW9uIChwcmVmaXgsIHN1ZmZpeCkgewogICAgalF1ZXJ5LmNzc0hvb2tzW3ByZWZpeCArIHN1ZmZpeF0gPSB7CiAgICAgIGV4cGFuZDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgZXhwYW5kZWQgPSB7fSwKICAgICAgICAgIC8vIEFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwogICAgICAgICAgcGFydHMgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciID8gdmFsdWUuc3BsaXQoIiAiKSA6IFt2YWx1ZV07CiAgICAgICAgZm9yICg7IGkgPCA0OyBpKyspIHsKICAgICAgICAgIGV4cGFuZGVkW3ByZWZpeCArIGNzc0V4cGFuZFtpXSArIHN1ZmZpeF0gPSBwYXJ0c1tpXSB8fCBwYXJ0c1tpIC0gMl0gfHwgcGFydHNbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgfQogICAgfTsKICAgIGlmIChwcmVmaXggIT09ICJtYXJnaW4iKSB7CiAgICAgIGpRdWVyeS5jc3NIb29rc1twcmVmaXggKyBzdWZmaXhdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgY3NzOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICB2YXIgc3R5bGVzLAogICAgICAgICAgbGVuLAogICAgICAgICAgbWFwID0ge30sCiAgICAgICAgICBpID0gMDsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuYW1lKSkgewogICAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pOwogICAgICAgICAgbGVuID0gbmFtZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIG1hcFtuYW1lW2ldXSA9IGpRdWVyeS5jc3MoZWxlbSwgbmFtZVtpXSwgZmFsc2UsIHN0eWxlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lLCB2YWx1ZSkgOiBqUXVlcnkuY3NzKGVsZW0sIG5hbWUpOwogICAgICB9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIFR3ZWVuKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKSB7CiAgICByZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKTsKICB9CiAgalF1ZXJ5LlR3ZWVuID0gVHdlZW47CiAgVHdlZW4ucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IFR3ZWVuLAogICAgaW5pdDogZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0KSB7CiAgICAgIHRoaXMuZWxlbSA9IGVsZW07CiAgICAgIHRoaXMucHJvcCA9IHByb3A7CiAgICAgIHRoaXMuZWFzaW5nID0gZWFzaW5nIHx8IGpRdWVyeS5lYXNpbmcuX2RlZmF1bHQ7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CiAgICAgIHRoaXMuZW5kID0gZW5kOwogICAgICB0aGlzLnVuaXQgPSB1bml0IHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gIiIgOiAicHgiKTsKICAgIH0sCiAgICBjdXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIHJldHVybiBob29rcyAmJiBob29rcy5nZXQgPyBob29rcy5nZXQodGhpcykgOiBUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KHRoaXMpOwogICAgfSwKICAgIHJ1bjogZnVuY3Rpb24gKHBlcmNlbnQpIHsKICAgICAgdmFyIGVhc2VkLAogICAgICAgIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0galF1ZXJ5LmVhc2luZ1t0aGlzLmVhc2luZ10ocGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0gcGVyY2VudDsKICAgICAgfQogICAgICB0aGlzLm5vdyA9ICh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpICogZWFzZWQgKyB0aGlzLnN0YXJ0OwogICAgICBpZiAodGhpcy5vcHRpb25zLnN0ZXApIHsKICAgICAgICB0aGlzLm9wdGlvbnMuc3RlcC5jYWxsKHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiBob29rcy5zZXQpIHsKICAgICAgICBob29rcy5zZXQodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwogIFR3ZWVuLnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IFR3ZWVuLnByb3RvdHlwZTsKICBUd2Vlbi5wcm9wSG9va3MgPSB7CiAgICBfZGVmYXVsdDogewogICAgICBnZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIHZhciByZXN1bHQ7CgogICAgICAgIC8vIFVzZSBhIHByb3BlcnR5IG9uIHRoZSBlbGVtZW50IGRpcmVjdGx5IHdoZW4gaXQgaXMgbm90IGEgRE9NIGVsZW1lbnQsCiAgICAgICAgLy8gb3Igd2hlbiB0aGVyZSBpcyBubyBtYXRjaGluZyBzdHlsZSBwcm9wZXJ0eSB0aGF0IGV4aXN0cy4KICAgICAgICBpZiAodHdlZW4uZWxlbS5ub2RlVHlwZSAhPT0gMSB8fCB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdICE9IG51bGwgJiYgdHdlZW4uZWxlbS5zdHlsZVt0d2Vlbi5wcm9wXSA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHdlZW4uZWxlbVt0d2Vlbi5wcm9wXTsKICAgICAgICB9CgogICAgICAgIC8vIFBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQogICAgICAgIC8vIGF0dGVtcHQgYSBwYXJzZUZsb2F0IGFuZCBmYWxsYmFjayB0byBhIHN0cmluZyBpZiB0aGUgcGFyc2UgZmFpbHMuCiAgICAgICAgLy8gU2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0OwogICAgICAgIC8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzLWlzLgogICAgICAgIHJlc3VsdCA9IGpRdWVyeS5jc3ModHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgIiIpOwoKICAgICAgICAvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuCiAgICAgICAgcmV0dXJuICFyZXN1bHQgfHwgcmVzdWx0ID09PSAiYXV0byIgPyAwIDogcmVzdWx0OwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIC8vIFVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0LgogICAgICAgIC8vIFVzZSBjc3NIb29rIGlmIGl0cyB0aGVyZS4KICAgICAgICAvLyBVc2UgLnN0eWxlIGlmIGF2YWlsYWJsZSBhbmQgdXNlIHBsYWluIHByb3BlcnRpZXMgd2hlcmUgYXZhaWxhYmxlLgogICAgICAgIGlmIChqUXVlcnkuZnguc3RlcFt0d2Vlbi5wcm9wXSkgewogICAgICAgICAgalF1ZXJ5LmZ4LnN0ZXBbdHdlZW4ucHJvcF0odHdlZW4pOwogICAgICAgIH0gZWxzZSBpZiAodHdlZW4uZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoalF1ZXJ5LmNzc0hvb2tzW3R3ZWVuLnByb3BdIHx8IHR3ZWVuLmVsZW0uc3R5bGVbZmluYWxQcm9wTmFtZSh0d2Vlbi5wcm9wKV0gIT0gbnVsbCkpIHsKICAgICAgICAgIGpRdWVyeS5zdHlsZSh0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCB0d2Vlbi5ub3cgKyB0d2Vlbi51bml0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHdlZW4uZWxlbVt0d2Vlbi5wcm9wXSA9IHR3ZWVuLm5vdzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogIC8vIFBhbmljIGJhc2VkIGFwcHJvYWNoIHRvIHNldHRpbmcgdGhpbmdzIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwogIFR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKICAgIHNldDogZnVuY3Rpb24gKHR3ZWVuKSB7CiAgICAgIGlmICh0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgIHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF0gPSB0d2Vlbi5ub3c7CiAgICAgIH0KICAgIH0KICB9OwogIGpRdWVyeS5lYXNpbmcgPSB7CiAgICBsaW5lYXI6IGZ1bmN0aW9uIChwKSB7CiAgICAgIHJldHVybiBwOwogICAgfSwKICAgIHN3aW5nOiBmdW5jdGlvbiAocCkgewogICAgICByZXR1cm4gMC41IC0gTWF0aC5jb3MocCAqIE1hdGguUEkpIC8gMjsKICAgIH0sCiAgICBfZGVmYXVsdDogInN3aW5nIgogIH07CiAgalF1ZXJ5LmZ4ID0gVHdlZW4ucHJvdG90eXBlLmluaXQ7CgogIC8vIEJhY2sgY29tcGF0IDwxLjggZXh0ZW5zaW9uIHBvaW50CiAgalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKICB2YXIgZnhOb3csCiAgICBpblByb2dyZXNzLAogICAgcmZ4dHlwZXMgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sCiAgICBycnVuID0gL3F1ZXVlSG9va3MkLzsKICBmdW5jdGlvbiBzY2hlZHVsZSgpIHsKICAgIGlmIChpblByb2dyZXNzKSB7CiAgICAgIGlmIChkb2N1bWVudC5oaWRkZW4gPT09IGZhbHNlICYmIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUpIHsKICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHNjaGVkdWxlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3aW5kb3cuc2V0VGltZW91dChzY2hlZHVsZSwgalF1ZXJ5LmZ4LmludGVydmFsKTsKICAgICAgfQogICAgICBqUXVlcnkuZngudGljaygpOwogICAgfQogIH0KCiAgLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQogIGZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewogICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBmeE5vdyA9IHVuZGVmaW5lZDsKICAgIH0pOwogICAgcmV0dXJuIGZ4Tm93ID0gRGF0ZS5ub3coKTsKICB9CgogIC8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCiAgZnVuY3Rpb24gZ2VuRngodHlwZSwgaW5jbHVkZVdpZHRoKSB7CiAgICB2YXIgd2hpY2gsCiAgICAgIGkgPSAwLAogICAgICBhdHRycyA9IHsKICAgICAgICBoZWlnaHQ6IHR5cGUKICAgICAgfTsKCiAgICAvLyBJZiB3ZSBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDEgdG8gZG8gYWxsIGNzc0V4cGFuZCB2YWx1ZXMsCiAgICAvLyBvdGhlcndpc2Ugc3RlcCB2YWx1ZSBpcyAyIHRvIHNraXAgb3ZlciBMZWZ0IGFuZCBSaWdodAogICAgaW5jbHVkZVdpZHRoID0gaW5jbHVkZVdpZHRoID8gMSA6IDA7CiAgICBmb3IgKDsgaSA8IDQ7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCkgewogICAgICB3aGljaCA9IGNzc0V4cGFuZFtpXTsKICAgICAgYXR0cnNbIm1hcmdpbiIgKyB3aGljaF0gPSBhdHRyc1sicGFkZGluZyIgKyB3aGljaF0gPSB0eXBlOwogICAgfQogICAgaWYgKGluY2x1ZGVXaWR0aCkgewogICAgICBhdHRycy5vcGFjaXR5ID0gYXR0cnMud2lkdGggPSB0eXBlOwogICAgfQogICAgcmV0dXJuIGF0dHJzOwogIH0KICBmdW5jdGlvbiBjcmVhdGVUd2Vlbih2YWx1ZSwgcHJvcCwgYW5pbWF0aW9uKSB7CiAgICB2YXIgdHdlZW4sCiAgICAgIGNvbGxlY3Rpb24gPSAoQW5pbWF0aW9uLnR3ZWVuZXJzW3Byb3BdIHx8IFtdKS5jb25jYXQoQW5pbWF0aW9uLnR3ZWVuZXJzWyIqIl0pLAogICAgICBpbmRleCA9IDAsCiAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGlmICh0d2VlbiA9IGNvbGxlY3Rpb25baW5kZXhdLmNhbGwoYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSkpIHsKICAgICAgICAvLyBXZSdyZSBkb25lIHdpdGggdGhpcyBwcm9wZXJ0eQogICAgICAgIHJldHVybiB0d2VlbjsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKGVsZW0sIHByb3BzLCBvcHRzKSB7CiAgICB2YXIgcHJvcCwKICAgICAgdmFsdWUsCiAgICAgIHRvZ2dsZSwKICAgICAgaG9va3MsCiAgICAgIG9sZGZpcmUsCiAgICAgIHByb3BUd2VlbiwKICAgICAgcmVzdG9yZURpc3BsYXksCiAgICAgIGRpc3BsYXksCiAgICAgIGlzQm94ID0gIndpZHRoIiBpbiBwcm9wcyB8fCAiaGVpZ2h0IiBpbiBwcm9wcywKICAgICAgYW5pbSA9IHRoaXMsCiAgICAgIG9yaWcgPSB7fSwKICAgICAgc3R5bGUgPSBlbGVtLnN0eWxlLAogICAgICBoaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuV2l0aGluVHJlZShlbGVtKSwKICAgICAgZGF0YVNob3cgPSBkYXRhUHJpdi5nZXQoZWxlbSwgImZ4c2hvdyIpOwoKICAgIC8vIFF1ZXVlLXNraXBwaW5nIGFuaW1hdGlvbnMgaGlqYWNrIHRoZSBmeCBob29rcwogICAgaWYgKCFvcHRzLnF1ZXVlKSB7CiAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sICJmeCIpOwogICAgICBpZiAoaG9va3MudW5xdWV1ZWQgPT0gbnVsbCkgewogICAgICAgIGhvb2tzLnVucXVldWVkID0gMDsKICAgICAgICBvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKICAgICAgICBob29rcy5lbXB0eS5maXJlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCFob29rcy51bnF1ZXVlZCkgewogICAgICAgICAgICBvbGRmaXJlKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBob29rcy51bnF1ZXVlZCsrOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRW5zdXJlIHRoZSBjb21wbGV0ZSBoYW5kbGVyIGlzIGNhbGxlZCBiZWZvcmUgdGhpcyBjb21wbGV0ZXMKICAgICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICBob29rcy51bnF1ZXVlZC0tOwogICAgICAgICAgaWYgKCFqUXVlcnkucXVldWUoZWxlbSwgImZ4IikubGVuZ3RoKSB7CiAgICAgICAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLy8gRGV0ZWN0IHNob3cvaGlkZSBhbmltYXRpb25zCiAgICBmb3IgKHByb3AgaW4gcHJvcHMpIHsKICAgICAgdmFsdWUgPSBwcm9wc1twcm9wXTsKICAgICAgaWYgKHJmeHR5cGVzLnRlc3QodmFsdWUpKSB7CiAgICAgICAgZGVsZXRlIHByb3BzW3Byb3BdOwogICAgICAgIHRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gInRvZ2dsZSI7CiAgICAgICAgaWYgKHZhbHVlID09PSAoaGlkZGVuID8gImhpZGUiIDogInNob3ciKSkgewogICAgICAgICAgLy8gUHJldGVuZCB0byBiZSBoaWRkZW4gaWYgdGhpcyBpcyBhICJzaG93IiBhbmQKICAgICAgICAgIC8vIHRoZXJlIGlzIHN0aWxsIGRhdGEgZnJvbSBhIHN0b3BwZWQgc2hvdy9oaWRlCiAgICAgICAgICBpZiAodmFsdWUgPT09ICJzaG93IiAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1twcm9wXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGhpZGRlbiA9IHRydWU7CgogICAgICAgICAgICAvLyBJZ25vcmUgYWxsIG90aGVyIG5vLW9wIHNob3cvaGlkZSBkYXRhCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgb3JpZ1twcm9wXSA9IGRhdGFTaG93ICYmIGRhdGFTaG93W3Byb3BdIHx8IGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wKTsKICAgICAgfQogICAgfQoKICAgIC8vIEJhaWwgb3V0IGlmIHRoaXMgaXMgYSBuby1vcCBsaWtlIC5oaWRlKCkuaGlkZSgpCiAgICBwcm9wVHdlZW4gPSAhalF1ZXJ5LmlzRW1wdHlPYmplY3QocHJvcHMpOwogICAgaWYgKCFwcm9wVHdlZW4gJiYgalF1ZXJ5LmlzRW1wdHlPYmplY3Qob3JpZykpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIFJlc3RyaWN0ICJvdmVyZmxvdyIgYW5kICJkaXNwbGF5IiBzdHlsZXMgZHVyaW5nIGJveCBhbmltYXRpb25zCiAgICBpZiAoaXNCb3ggJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSwgRWRnZSAxMiAtIDE1CiAgICAgIC8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUUgZG9lcyBub3QgaW5mZXIgdGhlIHNob3J0aGFuZAogICAgICAvLyBmcm9tIGlkZW50aWNhbGx5LXZhbHVlZCBvdmVyZmxvd1ggYW5kIG92ZXJmbG93WSBhbmQgRWRnZSBqdXN0IG1pcnJvcnMKICAgICAgLy8gdGhlIG92ZXJmbG93WCB2YWx1ZSB0aGVyZS4KICAgICAgb3B0cy5vdmVyZmxvdyA9IFtzdHlsZS5vdmVyZmxvdywgc3R5bGUub3ZlcmZsb3dYLCBzdHlsZS5vdmVyZmxvd1ldOwoKICAgICAgLy8gSWRlbnRpZnkgYSBkaXNwbGF5IHR5cGUsIHByZWZlcnJpbmcgb2xkIHNob3cvaGlkZSBkYXRhIG92ZXIgdGhlIENTUyBjYXNjYWRlCiAgICAgIHJlc3RvcmVEaXNwbGF5ID0gZGF0YVNob3cgJiYgZGF0YVNob3cuZGlzcGxheTsKICAgICAgaWYgKHJlc3RvcmVEaXNwbGF5ID09IG51bGwpIHsKICAgICAgICByZXN0b3JlRGlzcGxheSA9IGRhdGFQcml2LmdldChlbGVtLCAiZGlzcGxheSIpOwogICAgICB9CiAgICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5Iik7CiAgICAgIGlmIChkaXNwbGF5ID09PSAibm9uZSIpIHsKICAgICAgICBpZiAocmVzdG9yZURpc3BsYXkpIHsKICAgICAgICAgIGRpc3BsYXkgPSByZXN0b3JlRGlzcGxheTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gR2V0IG5vbmVtcHR5IHZhbHVlKHMpIGJ5IHRlbXBvcmFyaWx5IGZvcmNpbmcgdmlzaWJpbGl0eQogICAgICAgICAgc2hvd0hpZGUoW2VsZW1dLCB0cnVlKTsKICAgICAgICAgIHJlc3RvcmVEaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5IHx8IHJlc3RvcmVEaXNwbGF5OwogICAgICAgICAgZGlzcGxheSA9IGpRdWVyeS5jc3MoZWxlbSwgImRpc3BsYXkiKTsKICAgICAgICAgIHNob3dIaWRlKFtlbGVtXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBBbmltYXRlIGlubGluZSBlbGVtZW50cyBhcyBpbmxpbmUtYmxvY2sKICAgICAgaWYgKGRpc3BsYXkgPT09ICJpbmxpbmUiIHx8IGRpc3BsYXkgPT09ICJpbmxpbmUtYmxvY2siICYmIHJlc3RvcmVEaXNwbGF5ICE9IG51bGwpIHsKICAgICAgICBpZiAoalF1ZXJ5LmNzcyhlbGVtLCAiZmxvYXQiKSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICAvLyBSZXN0b3JlIHRoZSBvcmlnaW5hbCBkaXNwbGF5IHZhbHVlIGF0IHRoZSBlbmQgb2YgcHVyZSBzaG93L2hpZGUgYW5pbWF0aW9ucwogICAgICAgICAgaWYgKCFwcm9wVHdlZW4pIHsKICAgICAgICAgICAgYW5pbS5kb25lKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBzdHlsZS5kaXNwbGF5ID0gcmVzdG9yZURpc3BsYXk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAocmVzdG9yZURpc3BsYXkgPT0gbnVsbCkgewogICAgICAgICAgICAgIGRpc3BsYXkgPSBzdHlsZS5kaXNwbGF5OwogICAgICAgICAgICAgIHJlc3RvcmVEaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gIiIgOiBkaXNwbGF5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAob3B0cy5vdmVyZmxvdykgewogICAgICBzdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgc3R5bGUub3ZlcmZsb3cgPSBvcHRzLm92ZXJmbG93WzBdOwogICAgICAgIHN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbMV07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dZID0gb3B0cy5vdmVyZmxvd1syXTsKICAgICAgfSk7CiAgICB9CgogICAgLy8gSW1wbGVtZW50IHNob3cvaGlkZSBhbmltYXRpb25zCiAgICBwcm9wVHdlZW4gPSBmYWxzZTsKICAgIGZvciAocHJvcCBpbiBvcmlnKSB7CiAgICAgIC8vIEdlbmVyYWwgc2hvdy9oaWRlIHNldHVwIGZvciB0aGlzIGVsZW1lbnQgYW5pbWF0aW9uCiAgICAgIGlmICghcHJvcFR3ZWVuKSB7CiAgICAgICAgaWYgKGRhdGFTaG93KSB7CiAgICAgICAgICBpZiAoImhpZGRlbiIgaW4gZGF0YVNob3cpIHsKICAgICAgICAgICAgaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkYXRhU2hvdyA9IGRhdGFQcml2LmFjY2VzcyhlbGVtLCAiZnhzaG93IiwgewogICAgICAgICAgICBkaXNwbGF5OiByZXN0b3JlRGlzcGxheQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBTdG9yZSBoaWRkZW4vdmlzaWJsZSBmb3IgdG9nZ2xlIHNvIGAuc3RvcCgpLnRvZ2dsZSgpYCAicmV2ZXJzZXMiCiAgICAgICAgaWYgKHRvZ2dsZSkgewogICAgICAgICAgZGF0YVNob3cuaGlkZGVuID0gIWhpZGRlbjsKICAgICAgICB9CgogICAgICAgIC8vIFNob3cgZWxlbWVudHMgYmVmb3JlIGFuaW1hdGluZyB0aGVtCiAgICAgICAgaWYgKGhpZGRlbikgewogICAgICAgICAgc2hvd0hpZGUoW2VsZW1dLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWxvb3AtZnVuYyAqLwoKICAgICAgICBhbmltLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBuby1sb29wLWZ1bmMgKi8KCiAgICAgICAgICAvLyBUaGUgZmluYWwgc3RlcCBvZiBhICJoaWRlIiBhbmltYXRpb24gaXMgYWN0dWFsbHkgaGlkaW5nIHRoZSBlbGVtZW50CiAgICAgICAgICBpZiAoIWhpZGRlbikgewogICAgICAgICAgICBzaG93SGlkZShbZWxlbV0pOwogICAgICAgICAgfQogICAgICAgICAgZGF0YVByaXYucmVtb3ZlKGVsZW0sICJmeHNob3ciKTsKICAgICAgICAgIGZvciAocHJvcCBpbiBvcmlnKSB7CiAgICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wLCBvcmlnW3Byb3BdKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gUGVyLXByb3BlcnR5IHNldHVwCiAgICAgIHByb3BUd2VlbiA9IGNyZWF0ZVR3ZWVuKGhpZGRlbiA/IGRhdGFTaG93W3Byb3BdIDogMCwgcHJvcCwgYW5pbSk7CiAgICAgIGlmICghKHByb3AgaW4gZGF0YVNob3cpKSB7CiAgICAgICAgZGF0YVNob3dbcHJvcF0gPSBwcm9wVHdlZW4uc3RhcnQ7CiAgICAgICAgaWYgKGhpZGRlbikgewogICAgICAgICAgcHJvcFR3ZWVuLmVuZCA9IHByb3BUd2Vlbi5zdGFydDsKICAgICAgICAgIHByb3BUd2Vlbi5zdGFydCA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHByb3BGaWx0ZXIocHJvcHMsIHNwZWNpYWxFYXNpbmcpIHsKICAgIHZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7CgogICAgLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzCiAgICBmb3IgKGluZGV4IGluIHByb3BzKSB7CiAgICAgIG5hbWUgPSBjYW1lbENhc2UoaW5kZXgpOwogICAgICBlYXNpbmcgPSBzcGVjaWFsRWFzaW5nW25hbWVdOwogICAgICB2YWx1ZSA9IHByb3BzW2luZGV4XTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgZWFzaW5nID0gdmFsdWVbMV07CiAgICAgICAgdmFsdWUgPSBwcm9wc1tpbmRleF0gPSB2YWx1ZVswXTsKICAgICAgfQogICAgICBpZiAoaW5kZXggIT09IG5hbWUpIHsKICAgICAgICBwcm9wc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIGRlbGV0ZSBwcm9wc1tpbmRleF07CiAgICAgIH0KICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV07CiAgICAgIGlmIChob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcykgewogICAgICAgIHZhbHVlID0gaG9va3MuZXhwYW5kKHZhbHVlKTsKICAgICAgICBkZWxldGUgcHJvcHNbbmFtZV07CgogICAgICAgIC8vIE5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b24ndCBvdmVyd3JpdGUgZXhpc3Rpbmcga2V5cy4KICAgICAgICAvLyBSZXVzaW5nICdpbmRleCcgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgogICAgICAgIGZvciAoaW5kZXggaW4gdmFsdWUpIHsKICAgICAgICAgIGlmICghKGluZGV4IGluIHByb3BzKSkgewogICAgICAgICAgICBwcm9wc1tpbmRleF0gPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgIHNwZWNpYWxFYXNpbmdbaW5kZXhdID0gZWFzaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzcGVjaWFsRWFzaW5nW25hbWVdID0gZWFzaW5nOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIEFuaW1hdGlvbihlbGVtLCBwcm9wZXJ0aWVzLCBvcHRpb25zKSB7CiAgICB2YXIgcmVzdWx0LAogICAgICBzdG9wcGVkLAogICAgICBpbmRleCA9IDAsCiAgICAgIGxlbmd0aCA9IEFuaW1hdGlvbi5wcmVmaWx0ZXJzLmxlbmd0aCwKICAgICAgZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIERvbid0IG1hdGNoIGVsZW0gaW4gdGhlIDphbmltYXRlZCBzZWxlY3RvcgogICAgICAgIGRlbGV0ZSB0aWNrLmVsZW07CiAgICAgIH0pLAogICAgICB0aWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50VGltZSA9IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgICAgICByZW1haW5pbmcgPSBNYXRoLm1heCgwLCBhbmltYXRpb24uc3RhcnRUaW1lICsgYW5pbWF0aW9uLmR1cmF0aW9uIC0gY3VycmVudFRpbWUpLAogICAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMgb25seQogICAgICAgICAgLy8gQXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIGAxIC0gKCAwLjUgfHwgMCApYCAodHJhYy0xMjQ5NykKICAgICAgICAgIHRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKICAgICAgICAgIHBlcmNlbnQgPSAxIC0gdGVtcCwKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwogICAgICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKHBlcmNlbnQpOwogICAgICAgIH0KICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFthbmltYXRpb24sIHBlcmNlbnQsIHJlbWFpbmluZ10pOwoKICAgICAgICAvLyBJZiB0aGVyZSdzIG1vcmUgdG8gZG8sIHlpZWxkCiAgICAgICAgaWYgKHBlcmNlbnQgPCAxICYmIGxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIHJlbWFpbmluZzsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRoaXMgd2FzIGFuIGVtcHR5IGFuaW1hdGlvbiwgc3ludGhlc2l6ZSBhIGZpbmFsIHByb2dyZXNzIG5vdGlmaWNhdGlvbgogICAgICAgIGlmICghbGVuZ3RoKSB7CiAgICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFthbmltYXRpb24sIDEsIDBdKTsKICAgICAgICB9CgogICAgICAgIC8vIFJlc29sdmUgdGhlIGFuaW1hdGlvbiBhbmQgcmVwb3J0IGl0cyBjb25jbHVzaW9uCiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgW2FuaW1hdGlvbl0pOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CiAgICAgICAgZWxlbTogZWxlbSwKICAgICAgICBwcm9wczogalF1ZXJ5LmV4dGVuZCh7fSwgcHJvcGVydGllcyksCiAgICAgICAgb3B0czogalF1ZXJ5LmV4dGVuZCh0cnVlLCB7CiAgICAgICAgICBzcGVjaWFsRWFzaW5nOiB7fSwKICAgICAgICAgIGVhc2luZzogalF1ZXJ5LmVhc2luZy5fZGVmYXVsdAogICAgICAgIH0sIG9wdGlvbnMpLAogICAgICAgIG9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKICAgICAgICBvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgc3RhcnRUaW1lOiBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAogICAgICAgIGR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAogICAgICAgIHR3ZWVuczogW10sCiAgICAgICAgY3JlYXRlVHdlZW46IGZ1bmN0aW9uIChwcm9wLCBlbmQpIHsKICAgICAgICAgIHZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbihlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nW3Byb3BdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyk7CiAgICAgICAgICBhbmltYXRpb24udHdlZW5zLnB1c2godHdlZW4pOwogICAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGdvdG9FbmQpIHsKICAgICAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICAgIC8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZW5kLCB3ZSB3YW50IHRvIHJ1biBhbGwgdGhlIHR3ZWVucwogICAgICAgICAgICAvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKICAgICAgICAgICAgbGVuZ3RoID0gZ290b0VuZCA/IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoIDogMDsKICAgICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgc3RvcHBlZCA9IHRydWU7CiAgICAgICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKDEpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWU7IG90aGVyd2lzZSwgcmVqZWN0CiAgICAgICAgICBpZiAoZ290b0VuZCkgewogICAgICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFthbmltYXRpb24sIDEsIDBdKTsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgW2FuaW1hdGlvbiwgZ290b0VuZF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aChlbGVtLCBbYW5pbWF0aW9uLCBnb3RvRW5kXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH0pLAogICAgICBwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKICAgIHByb3BGaWx0ZXIocHJvcHMsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmcpOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIHJlc3VsdCA9IEFuaW1hdGlvbi5wcmVmaWx0ZXJzW2luZGV4XS5jYWxsKGFuaW1hdGlvbiwgZWxlbSwgcHJvcHMsIGFuaW1hdGlvbi5vcHRzKTsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKHJlc3VsdC5zdG9wKSkgewogICAgICAgICAgalF1ZXJ5Ll9xdWV1ZUhvb2tzKGFuaW1hdGlvbi5lbGVtLCBhbmltYXRpb24ub3B0cy5xdWV1ZSkuc3RvcCA9IHJlc3VsdC5zdG9wLmJpbmQocmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQogICAgalF1ZXJ5Lm1hcChwcm9wcywgY3JlYXRlVHdlZW4sIGFuaW1hdGlvbik7CiAgICBpZiAoaXNGdW5jdGlvbihhbmltYXRpb24ub3B0cy5zdGFydCkpIHsKICAgICAgYW5pbWF0aW9uLm9wdHMuc3RhcnQuY2FsbChlbGVtLCBhbmltYXRpb24pOwogICAgfQoKICAgIC8vIEF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zCiAgICBhbmltYXRpb24ucHJvZ3Jlc3MoYW5pbWF0aW9uLm9wdHMucHJvZ3Jlc3MpLmRvbmUoYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUpLmZhaWwoYW5pbWF0aW9uLm9wdHMuZmFpbCkuYWx3YXlzKGFuaW1hdGlvbi5vcHRzLmFsd2F5cyk7CiAgICBqUXVlcnkuZngudGltZXIoalF1ZXJ5LmV4dGVuZCh0aWNrLCB7CiAgICAgIGVsZW06IGVsZW0sCiAgICAgIGFuaW06IGFuaW1hdGlvbiwKICAgICAgcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCiAgICB9KSk7CiAgICByZXR1cm4gYW5pbWF0aW9uOwogIH0KICBqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZChBbmltYXRpb24sIHsKICAgIHR3ZWVuZXJzOiB7CiAgICAgICIqIjogW2Z1bmN0aW9uIChwcm9wLCB2YWx1ZSkgewogICAgICAgIHZhciB0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4ocHJvcCwgdmFsdWUpOwogICAgICAgIGFkanVzdENTUyh0d2Vlbi5lbGVtLCBwcm9wLCByY3NzTnVtLmV4ZWModmFsdWUpLCB0d2Vlbik7CiAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICB9XQogICAgfSwKICAgIHR3ZWVuZXI6IGZ1bmN0aW9uIChwcm9wcywgY2FsbGJhY2spIHsKICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvcHMpKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwcm9wczsKICAgICAgICBwcm9wcyA9IFsiKiJdOwogICAgICB9IGVsc2UgewogICAgICAgIHByb3BzID0gcHJvcHMubWF0Y2gocm5vdGh0bWx3aGl0ZSk7CiAgICAgIH0KICAgICAgdmFyIHByb3AsCiAgICAgICAgaW5kZXggPSAwLAogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgcHJvcCA9IHByb3BzW2luZGV4XTsKICAgICAgICBBbmltYXRpb24udHdlZW5lcnNbcHJvcF0gPSBBbmltYXRpb24udHdlZW5lcnNbcHJvcF0gfHwgW107CiAgICAgICAgQW5pbWF0aW9uLnR3ZWVuZXJzW3Byb3BdLnVuc2hpZnQoY2FsbGJhY2spOwogICAgICB9CiAgICB9LAogICAgcHJlZmlsdGVyczogW2RlZmF1bHRQcmVmaWx0ZXJdLAogICAgcHJlZmlsdGVyOiBmdW5jdGlvbiAoY2FsbGJhY2ssIHByZXBlbmQpIHsKICAgICAgaWYgKHByZXBlbmQpIHsKICAgICAgICBBbmltYXRpb24ucHJlZmlsdGVycy51bnNoaWZ0KGNhbGxiYWNrKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBBbmltYXRpb24ucHJlZmlsdGVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgfQogICAgfQogIH0pOwogIGpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBmbikgewogICAgdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKHt9LCBzcGVlZCkgOiB7CiAgICAgIGNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8IGlzRnVuY3Rpb24oc3BlZWQpICYmIHNwZWVkLAogICAgICBkdXJhdGlvbjogc3BlZWQsCiAgICAgIGVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhaXNGdW5jdGlvbihlYXNpbmcpICYmIGVhc2luZwogICAgfTsKCiAgICAvLyBHbyB0byB0aGUgZW5kIHN0YXRlIGlmIGZ4IGFyZSBvZmYKICAgIGlmIChqUXVlcnkuZngub2ZmKSB7CiAgICAgIG9wdC5kdXJhdGlvbiA9IDA7CiAgICB9IGVsc2UgewogICAgICBpZiAodHlwZW9mIG9wdC5kdXJhdGlvbiAhPT0gIm51bWJlciIpIHsKICAgICAgICBpZiAob3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMpIHsKICAgICAgICAgIG9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5zcGVlZHNbb3B0LmR1cmF0aW9uXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4LnNwZWVkcy5fZGVmYXVsdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBOb3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCiAgICBpZiAob3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlKSB7CiAgICAgIG9wdC5xdWV1ZSA9ICJmeCI7CiAgICB9CgogICAgLy8gUXVldWVpbmcKICAgIG9wdC5vbGQgPSBvcHQuY29tcGxldGU7CiAgICBvcHQuY29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdC5vbGQpKSB7CiAgICAgICAgb3B0Lm9sZC5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIGlmIChvcHQucXVldWUpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCBvcHQucXVldWUpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIG9wdDsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZmFkZVRvOiBmdW5jdGlvbiAoc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIC8vIFNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoaXNIaWRkZW5XaXRoaW5UcmVlKS5jc3MoIm9wYWNpdHkiLCAwKS5zaG93KCkKCiAgICAgIC8vIEFuaW1hdGUgdG8gdGhlIHZhbHVlIHNwZWNpZmllZAogICAgICAuZW5kKCkuYW5pbWF0ZSh7CiAgICAgICAgb3BhY2l0eTogdG8KICAgICAgfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfSwKICAgIGFuaW1hdGU6IGZ1bmN0aW9uIChwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICB2YXIgZW1wdHkgPSBqUXVlcnkuaXNFbXB0eU9iamVjdChwcm9wKSwKICAgICAgICBvcHRhbGwgPSBqUXVlcnkuc3BlZWQoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spLAogICAgICAgIGRvQW5pbWF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKICAgICAgICAgIHZhciBhbmltID0gQW5pbWF0aW9uKHRoaXMsIGpRdWVyeS5leHRlbmQoe30sIHByb3ApLCBvcHRhbGwpOwoKICAgICAgICAgIC8vIEVtcHR5IGFuaW1hdGlvbnMsIG9yIGZpbmlzaGluZyByZXNvbHZlcyBpbW1lZGlhdGVseQogICAgICAgICAgaWYgKGVtcHR5IHx8IGRhdGFQcml2LmdldCh0aGlzLCAiZmluaXNoIikpIHsKICAgICAgICAgICAgYW5pbS5zdG9wKHRydWUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIGRvQW5pbWF0aW9uLmZpbmlzaCA9IGRvQW5pbWF0aW9uOwogICAgICByZXR1cm4gZW1wdHkgfHwgb3B0YWxsLnF1ZXVlID09PSBmYWxzZSA/IHRoaXMuZWFjaChkb0FuaW1hdGlvbikgOiB0aGlzLnF1ZXVlKG9wdGFsbC5xdWV1ZSwgZG9BbmltYXRpb24pOwogICAgfSwKICAgIHN0b3A6IGZ1bmN0aW9uICh0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kKSB7CiAgICAgIHZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiAoaG9va3MpIHsKICAgICAgICB2YXIgc3RvcCA9IGhvb2tzLnN0b3A7CiAgICAgICAgZGVsZXRlIGhvb2tzLnN0b3A7CiAgICAgICAgc3RvcChnb3RvRW5kKTsKICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgIGdvdG9FbmQgPSBjbGVhclF1ZXVlOwogICAgICAgIGNsZWFyUXVldWUgPSB0eXBlOwogICAgICAgIHR5cGUgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgaWYgKGNsZWFyUXVldWUpIHsKICAgICAgICB0aGlzLnF1ZXVlKHR5cGUgfHwgImZ4IiwgW10pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkZXF1ZXVlID0gdHJ1ZSwKICAgICAgICAgIGluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCiAgICAgICAgICB0aW1lcnMgPSBqUXVlcnkudGltZXJzLAogICAgICAgICAgZGF0YSA9IGRhdGFQcml2LmdldCh0aGlzKTsKICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgIGlmIChkYXRhW2luZGV4XSAmJiBkYXRhW2luZGV4XS5zdG9wKSB7CiAgICAgICAgICAgIHN0b3BRdWV1ZShkYXRhW2luZGV4XSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaW5kZXggaW4gZGF0YSkgewogICAgICAgICAgICBpZiAoZGF0YVtpbmRleF0gJiYgZGF0YVtpbmRleF0uc3RvcCAmJiBycnVuLnRlc3QoaW5kZXgpKSB7CiAgICAgICAgICAgICAgc3RvcFF1ZXVlKGRhdGFbaW5kZXhdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTspIHsKICAgICAgICAgIGlmICh0aW1lcnNbaW5kZXhdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbaW5kZXhdLnF1ZXVlID09PSB0eXBlKSkgewogICAgICAgICAgICB0aW1lcnNbaW5kZXhdLmFuaW0uc3RvcChnb3RvRW5kKTsKICAgICAgICAgICAgZGVxdWV1ZSA9IGZhbHNlOwogICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQuCiAgICAgICAgLy8gVGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaAogICAgICAgIC8vIHdpbGwgZGVxdWV1ZSBidXQgb25seSBpZiB0aGV5IHdlcmUgZ290b0VuZC4KICAgICAgICBpZiAoZGVxdWV1ZSB8fCAhZ290b0VuZCkgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBmaW5pc2g6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIGlmICh0eXBlICE9PSBmYWxzZSkgewogICAgICAgIHR5cGUgPSB0eXBlIHx8ICJmeCI7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGluZGV4LAogICAgICAgICAgZGF0YSA9IGRhdGFQcml2LmdldCh0aGlzKSwKICAgICAgICAgIHF1ZXVlID0gZGF0YVt0eXBlICsgInF1ZXVlIl0sCiAgICAgICAgICBob29rcyA9IGRhdGFbdHlwZSArICJxdWV1ZUhvb2tzIl0sCiAgICAgICAgICB0aW1lcnMgPSBqUXVlcnkudGltZXJzLAogICAgICAgICAgbGVuZ3RoID0gcXVldWUgPyBxdWV1ZS5sZW5ndGggOiAwOwoKICAgICAgICAvLyBFbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCiAgICAgICAgZGF0YS5maW5pc2ggPSB0cnVlOwoKICAgICAgICAvLyBFbXB0eSB0aGUgcXVldWUgZmlyc3QKICAgICAgICBqUXVlcnkucXVldWUodGhpcywgdHlwZSwgW10pOwogICAgICAgIGlmIChob29rcyAmJiBob29rcy5zdG9wKSB7CiAgICAgICAgICBob29rcy5zdG9wLmNhbGwodGhpcywgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBMb29rIGZvciBhbnkgYWN0aXZlIGFuaW1hdGlvbnMsIGFuZCBmaW5pc2ggdGhlbQogICAgICAgIGZvciAoaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOykgewogICAgICAgICAgaWYgKHRpbWVyc1tpbmRleF0uZWxlbSA9PT0gdGhpcyAmJiB0aW1lcnNbaW5kZXhdLnF1ZXVlID09PSB0eXBlKSB7CiAgICAgICAgICAgIHRpbWVyc1tpbmRleF0uYW5pbS5zdG9wKHRydWUpOwogICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIExvb2sgZm9yIGFueSBhbmltYXRpb25zIGluIHRoZSBvbGQgcXVldWUgYW5kIGZpbmlzaCB0aGVtCiAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICBpZiAocXVldWVbaW5kZXhdICYmIHF1ZXVlW2luZGV4XS5maW5pc2gpIHsKICAgICAgICAgICAgcXVldWVbaW5kZXhdLmZpbmlzaC5jYWxsKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVHVybiBvZmYgZmluaXNoaW5nIGZsYWcKICAgICAgICBkZWxldGUgZGF0YS5maW5pc2g7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKFsidG9nZ2xlIiwgInNob3ciLCAiaGlkZSJdLCBmdW5jdGlvbiAoX2ksIG5hbWUpIHsKICAgIHZhciBjc3NGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/IGNzc0ZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzLmFuaW1hdGUoZ2VuRngobmFtZSwgdHJ1ZSksIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH07CiAgfSk7CgogIC8vIEdlbmVyYXRlIHNob3J0Y3V0cyBmb3IgY3VzdG9tIGFuaW1hdGlvbnMKICBqUXVlcnkuZWFjaCh7CiAgICBzbGlkZURvd246IGdlbkZ4KCJzaG93IiksCiAgICBzbGlkZVVwOiBnZW5GeCgiaGlkZSIpLAogICAgc2xpZGVUb2dnbGU6IGdlbkZ4KCJ0b2dnbGUiKSwKICAgIGZhZGVJbjogewogICAgICBvcGFjaXR5OiAic2hvdyIKICAgIH0sCiAgICBmYWRlT3V0OiB7CiAgICAgIG9wYWNpdHk6ICJoaWRlIgogICAgfSwKICAgIGZhZGVUb2dnbGU6IHsKICAgICAgb3BhY2l0eTogInRvZ2dsZSIKICAgIH0KICB9LCBmdW5jdGlvbiAobmFtZSwgcHJvcHMpIHsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5hbmltYXRlKHByb3BzLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CiAgICB9OwogIH0pOwogIGpRdWVyeS50aW1lcnMgPSBbXTsKICBqUXVlcnkuZngudGljayA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0aW1lciwKICAgICAgaSA9IDAsCiAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnM7CiAgICBmeE5vdyA9IERhdGUubm93KCk7CiAgICBmb3IgKDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKykgewogICAgICB0aW1lciA9IHRpbWVyc1tpXTsKCiAgICAgIC8vIFJ1biB0aGUgdGltZXIgYW5kIHNhZmVseSByZW1vdmUgaXQgd2hlbiBkb25lIChhbGxvd2luZyBmb3IgZXh0ZXJuYWwgcmVtb3ZhbCkKICAgICAgaWYgKCF0aW1lcigpICYmIHRpbWVyc1tpXSA9PT0gdGltZXIpIHsKICAgICAgICB0aW1lcnMuc3BsaWNlKGktLSwgMSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghdGltZXJzLmxlbmd0aCkgewogICAgICBqUXVlcnkuZnguc3RvcCgpOwogICAgfQogICAgZnhOb3cgPSB1bmRlZmluZWQ7CiAgfTsKICBqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiAodGltZXIpIHsKICAgIGpRdWVyeS50aW1lcnMucHVzaCh0aW1lcik7CiAgICBqUXVlcnkuZnguc3RhcnQoKTsKICB9OwogIGpRdWVyeS5meC5pbnRlcnZhbCA9IDEzOwogIGpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmIChpblByb2dyZXNzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGluUHJvZ3Jlc3MgPSB0cnVlOwogICAgc2NoZWR1bGUoKTsKICB9OwogIGpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgaW5Qcm9ncmVzcyA9IG51bGw7CiAgfTsKICBqUXVlcnkuZnguc3BlZWRzID0gewogICAgc2xvdzogNjAwLAogICAgZmFzdDogMjAwLAogICAgLy8gRGVmYXVsdCBzcGVlZAogICAgX2RlZmF1bHQ6IDQwMAogIH07CgogIC8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KICBqUXVlcnkuZm4uZGVsYXkgPSBmdW5jdGlvbiAodGltZSwgdHlwZSkgewogICAgdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbdGltZV0gfHwgdGltZSA6IHRpbWU7CiAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgcmV0dXJuIHRoaXMucXVldWUodHlwZSwgZnVuY3Rpb24gKG5leHQsIGhvb2tzKSB7CiAgICAgIHZhciB0aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQobmV4dCwgdGltZSk7CiAgICAgIGhvb2tzLnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0IiksCiAgICAgIHNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpLAogICAgICBvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIikpOwogICAgaW5wdXQudHlwZSA9ICJjaGVja2JveCI7CgogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMyBvbmx5CiAgICAvLyBEZWZhdWx0IHZhbHVlIGZvciBhIGNoZWNrYm94IHNob3VsZCBiZSAib24iCiAgICBzdXBwb3J0LmNoZWNrT24gPSBpbnB1dC52YWx1ZSAhPT0gIiI7CgogICAgLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CiAgICAvLyBNdXN0IGFjY2VzcyBzZWxlY3RlZEluZGV4IHRvIG1ha2UgZGVmYXVsdCBvcHRpb25zIHNlbGVjdAogICAgc3VwcG9ydC5vcHRTZWxlY3RlZCA9IG9wdC5zZWxlY3RlZDsKCiAgICAvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKICAgIC8vIEFuIGlucHV0IGxvc2VzIGl0cyB2YWx1ZSBhZnRlciBiZWNvbWluZyBhIHJhZGlvCiAgICBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICBpbnB1dC52YWx1ZSA9ICJ0IjsKICAgIGlucHV0LnR5cGUgPSAicmFkaW8iOwogICAgc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICJ0IjsKICB9KSgpOwogIHZhciBib29sSG9vaywKICAgIGF0dHJIYW5kbGUgPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgalF1ZXJ5LmF0dHIsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIodGhpcywgbmFtZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciByZXQsCiAgICAgICAgaG9va3MsCiAgICAgICAgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKICAgICAgLy8gRG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICBpZiAoblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCiAgICAgIGlmICh0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5wcm9wKGVsZW0sIG5hbWUsIHZhbHVlKTsKICAgICAgfQoKICAgICAgLy8gQXR0cmlidXRlIGhvb2tzIGFyZSBkZXRlcm1pbmVkIGJ5IHRoZSBsb3dlcmNhc2UgdmVyc2lvbgogICAgICAvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCiAgICAgIGlmIChuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pKSB7CiAgICAgICAgaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzW25hbWUudG9Mb3dlckNhc2UoKV0gfHwgKGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdChuYW1lKSA/IGJvb2xIb29rIDogdW5kZWZpbmVkKTsKICAgICAgfQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUgKyAiIik7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIG5hbWUpKSAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgICAgcmV0ID0galF1ZXJ5LmZpbmQuYXR0cihlbGVtLCBuYW1lKTsKCiAgICAgIC8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCiAgICAgIHJldHVybiByZXQgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKICAgIH0sCiAgICBhdHRySG9va3M6IHsKICAgICAgdHlwZTogewogICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICBpZiAoIXN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJiBub2RlTmFtZShlbGVtLCAiaW5wdXQiKSkgewogICAgICAgICAgICB2YXIgdmFsID0gZWxlbS52YWx1ZTsKICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoInR5cGUiLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmICh2YWwpIHsKICAgICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgdmFyIG5hbWUsCiAgICAgICAgaSA9IDAsCiAgICAgICAgLy8gQXR0cmlidXRlIG5hbWVzIGNhbiBjb250YWluIG5vbi1IVE1MIHdoaXRlc3BhY2UgY2hhcmFjdGVycwogICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3N5bnRheC5odG1sI2F0dHJpYnV0ZXMtMgogICAgICAgIGF0dHJOYW1lcyA9IHZhbHVlICYmIHZhbHVlLm1hdGNoKHJub3RodG1sd2hpdGUpOwogICAgICBpZiAoYXR0ck5hbWVzICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICB3aGlsZSAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSB7CiAgICAgICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gSG9va3MgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogIGJvb2xIb29rID0gewogICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUsIG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIC8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCBuYW1lKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9OwogIGpRdWVyeS5lYWNoKGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKC9cdysvZyksIGZ1bmN0aW9uIChfaSwgbmFtZSkgewogICAgdmFyIGdldHRlciA9IGF0dHJIYW5kbGVbbmFtZV0gfHwgalF1ZXJ5LmZpbmQuYXR0cjsKICAgIGF0dHJIYW5kbGVbbmFtZV0gPSBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgdmFyIHJldCwKICAgICAgICBoYW5kbGUsCiAgICAgICAgbG93ZXJjYXNlTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKCFpc1hNTCkgewogICAgICAgIC8vIEF2b2lkIGFuIGluZmluaXRlIGxvb3AgYnkgdGVtcG9yYXJpbHkgcmVtb3ZpbmcgdGhpcyBmdW5jdGlvbiBmcm9tIHRoZSBnZXR0ZXIKICAgICAgICBoYW5kbGUgPSBhdHRySGFuZGxlW2xvd2VyY2FzZU5hbWVdOwogICAgICAgIGF0dHJIYW5kbGVbbG93ZXJjYXNlTmFtZV0gPSByZXQ7CiAgICAgICAgcmV0ID0gZ2V0dGVyKGVsZW0sIG5hbWUsIGlzWE1MKSAhPSBudWxsID8gbG93ZXJjYXNlTmFtZSA6IG51bGw7CiAgICAgICAgYXR0ckhhbmRsZVtsb3dlcmNhc2VOYW1lXSA9IGhhbmRsZTsKICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfTsKICB9KTsKICB2YXIgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksCiAgICByY2xpY2thYmxlID0gL14oPzphfGFyZWEpJC9pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgcHJvcDogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgcmVtb3ZlUHJvcDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbalF1ZXJ5LnByb3BGaXhbbmFtZV0gfHwgbmFtZV07CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgcHJvcDogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciByZXQsCiAgICAgICAgaG9va3MsCiAgICAgICAgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKICAgICAgLy8gRG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICBpZiAoblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkpIHsKICAgICAgICAvLyBGaXggbmFtZSBhbmQgYXR0YWNoIGhvb2tzCiAgICAgICAgbmFtZSA9IGpRdWVyeS5wcm9wRml4W25hbWVdIHx8IG5hbWU7CiAgICAgICAgaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzW25hbWVdOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUsIG5hbWUpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZWxlbVtuYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIG5hbWUpKSAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW1bbmFtZV07CiAgICB9LAogICAgcHJvcEhvb2tzOiB7CiAgICAgIHRhYkluZGV4OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQogICAgICAgICAgLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlCiAgICAgICAgICAvLyBjb3JyZWN0IHZhbHVlIHdoZW4gaXQgaGFzbid0IGJlZW4gZXhwbGljaXRseSBzZXQKICAgICAgICAgIC8vIFVzZSBwcm9wZXIgYXR0cmlidXRlIHJldHJpZXZhbCAodHJhYy0xMjA3MikKICAgICAgICAgIHZhciB0YWJpbmRleCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgInRhYmluZGV4Iik7CiAgICAgICAgICBpZiAodGFiaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KHRhYmluZGV4LCAxMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmZvY3VzYWJsZS50ZXN0KGVsZW0ubm9kZU5hbWUpIHx8IHJjbGlja2FibGUudGVzdChlbGVtLm5vZGVOYW1lKSAmJiBlbGVtLmhyZWYpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcHJvcEZpeDogewogICAgICAiZm9yIjogImh0bWxGb3IiLAogICAgICAiY2xhc3MiOiAiY2xhc3NOYW1lIgogICAgfQogIH0pOwoKICAvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKICAvLyBBY2Nlc3NpbmcgdGhlIHNlbGVjdGVkSW5kZXggcHJvcGVydHkKICAvLyBmb3JjZXMgdGhlIGJyb3dzZXIgdG8gcmVzcGVjdCBzZXR0aW5nIHNlbGVjdGVkCiAgLy8gb24gdGhlIG9wdGlvbgogIC8vIFRoZSBnZXR0ZXIgZW5zdXJlcyBhIGRlZmF1bHQgb3B0aW9uIGlzIHNlbGVjdGVkCiAgLy8gd2hlbiBpbiBhbiBvcHRncm91cAogIC8vIGVzbGludCBydWxlICJuby11bnVzZWQtZXhwcmVzc2lvbnMiIGlzIGRpc2FibGVkIGZvciB0aGlzIGNvZGUKICAvLyBzaW5jZSBpdCBjb25zaWRlcnMgc3VjaCBhY2Nlc3Npb25zIG5vb3AKICBpZiAoIXN1cHBvcnQub3B0U2VsZWN0ZWQpIHsKICAgIGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQgPSB7CiAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAvKiBlc2xpbnQgbm8tdW51c2VkLWV4cHJlc3Npb25zOiAib2ZmIiAqLwoKICAgICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50LnBhcmVudE5vZGUpIHsKICAgICAgICAgIHBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgLyogZXNsaW50IG5vLXVudXNlZC1leHByZXNzaW9uczogIm9mZiIgKi8KCiAgICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICBwYXJlbnQuc2VsZWN0ZWRJbmRleDsKICAgICAgICAgIGlmIChwYXJlbnQucGFyZW50Tm9kZSkgewogICAgICAgICAgICBwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CiAgalF1ZXJ5LmVhY2goWyJ0YWJJbmRleCIsICJyZWFkT25seSIsICJtYXhMZW5ndGgiLCAiY2VsbFNwYWNpbmciLCAiY2VsbFBhZGRpbmciLCAicm93U3BhbiIsICJjb2xTcGFuIiwgInVzZU1hcCIsICJmcmFtZUJvcmRlciIsICJjb250ZW50RWRpdGFibGUiXSwgZnVuY3Rpb24gKCkgewogICAgalF1ZXJ5LnByb3BGaXhbdGhpcy50b0xvd2VyQ2FzZSgpXSA9IHRoaXM7CiAgfSk7CgogIC8vIFN0cmlwIGFuZCBjb2xsYXBzZSB3aGl0ZXNwYWNlIGFjY29yZGluZyB0byBIVE1MIHNwZWMKICAvLyBodHRwczovL2luZnJhLnNwZWMud2hhdHdnLm9yZy8jc3RyaXAtYW5kLWNvbGxhcHNlLWFzY2lpLXdoaXRlc3BhY2UKICBmdW5jdGlvbiBzdHJpcEFuZENvbGxhcHNlKHZhbHVlKSB7CiAgICB2YXIgdG9rZW5zID0gdmFsdWUubWF0Y2gocm5vdGh0bWx3aGl0ZSkgfHwgW107CiAgICByZXR1cm4gdG9rZW5zLmpvaW4oIiAiKTsKICB9CiAgZnVuY3Rpb24gZ2V0Q2xhc3MoZWxlbSkgewogICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiOwogIH0KICBmdW5jdGlvbiBjbGFzc2VzVG9BcnJheSh2YWx1ZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiB2YWx1ZS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbXTsKICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBhZGRDbGFzczogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBjbGFzc05hbWVzLCBjdXIsIGN1clZhbHVlLCBjbGFzc05hbWUsIGksIGZpbmFsVmFsdWU7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5hZGRDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGosIGdldENsYXNzKHRoaXMpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY2xhc3NOYW1lcyA9IGNsYXNzZXNUb0FycmF5KHZhbHVlKTsKICAgICAgaWYgKGNsYXNzTmFtZXMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjdXJWYWx1ZSA9IGdldENsYXNzKHRoaXMpOwogICAgICAgICAgY3VyID0gdGhpcy5ub2RlVHlwZSA9PT0gMSAmJiAiICIgKyBzdHJpcEFuZENvbGxhcHNlKGN1clZhbHVlKSArICIgIjsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNsYXNzTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChjdXIuaW5kZXhPZigiICIgKyBjbGFzc05hbWUgKyAiICIpIDwgMCkgewogICAgICAgICAgICAgICAgY3VyICs9IGNsYXNzTmFtZSArICIgIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBzdHJpcEFuZENvbGxhcHNlKGN1cik7CiAgICAgICAgICAgIGlmIChjdXJWYWx1ZSAhPT0gZmluYWxWYWx1ZSkgewogICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGZpbmFsVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgY2xhc3NOYW1lcywgY3VyLCBjdXJWYWx1ZSwgY2xhc3NOYW1lLCBpLCBmaW5hbFZhbHVlOwogICAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChqKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykucmVtb3ZlQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBqLCBnZXRDbGFzcyh0aGlzKSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dHIoImNsYXNzIiwgIiIpOwogICAgICB9CiAgICAgIGNsYXNzTmFtZXMgPSBjbGFzc2VzVG9BcnJheSh2YWx1ZSk7CiAgICAgIGlmIChjbGFzc05hbWVzLmxlbmd0aCkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgY3VyVmFsdWUgPSBnZXRDbGFzcyh0aGlzKTsKCiAgICAgICAgICAvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQogICAgICAgICAgY3VyID0gdGhpcy5ub2RlVHlwZSA9PT0gMSAmJiAiICIgKyBzdHJpcEFuZENvbGxhcHNlKGN1clZhbHVlKSArICIgIjsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNsYXNzTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVzW2ldOwoKICAgICAgICAgICAgICAvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCiAgICAgICAgICAgICAgd2hpbGUgKGN1ci5pbmRleE9mKCIgIiArIGNsYXNzTmFtZSArICIgIikgPiAtMSkgewogICAgICAgICAgICAgICAgY3VyID0gY3VyLnJlcGxhY2UoIiAiICsgY2xhc3NOYW1lICsgIiAiLCAiICIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT25seSBhc3NpZ24gaWYgZGlmZmVyZW50IHRvIGF2b2lkIHVubmVlZGVkIHJlbmRlcmluZy4KICAgICAgICAgICAgZmluYWxWYWx1ZSA9IHN0cmlwQW5kQ29sbGFwc2UoY3VyKTsKICAgICAgICAgICAgaWYgKGN1clZhbHVlICE9PSBmaW5hbFZhbHVlKSB7CiAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgZmluYWxWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKHZhbHVlLCBzdGF0ZVZhbCkgewogICAgICB2YXIgY2xhc3NOYW1lcywKICAgICAgICBjbGFzc05hbWUsCiAgICAgICAgaSwKICAgICAgICBzZWxmLAogICAgICAgIHR5cGUgPSB0eXBlb2YgdmFsdWUsCiAgICAgICAgaXNWYWxpZFZhbHVlID0gdHlwZSA9PT0gInN0cmluZyIgfHwgQXJyYXkuaXNBcnJheSh2YWx1ZSk7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS50b2dnbGVDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGksIGdldENsYXNzKHRoaXMpLCBzdGF0ZVZhbCksIHN0YXRlVmFsKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiIgJiYgaXNWYWxpZFZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlVmFsID8gdGhpcy5hZGRDbGFzcyh2YWx1ZSkgOiB0aGlzLnJlbW92ZUNsYXNzKHZhbHVlKTsKICAgICAgfQogICAgICBjbGFzc05hbWVzID0gY2xhc3Nlc1RvQXJyYXkodmFsdWUpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoaXNWYWxpZFZhbHVlKSB7CiAgICAgICAgICAvLyBUb2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwogICAgICAgICAgc2VsZiA9IGpRdWVyeSh0aGlzKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjbGFzc05hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZXNbaV07CgogICAgICAgICAgICAvLyBDaGVjayBlYWNoIGNsYXNzTmFtZSBnaXZlbiwgc3BhY2Ugc2VwYXJhdGVkIGxpc3QKICAgICAgICAgICAgaWYgKHNlbGYuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgIHNlbGYucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxmLmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgIGNsYXNzTmFtZSA9IGdldENsYXNzKHRoaXMpOwogICAgICAgICAgaWYgKGNsYXNzTmFtZSkgewogICAgICAgICAgICAvLyBTdG9yZSBjbGFzc05hbWUgaWYgc2V0CiAgICAgICAgICAgIGRhdGFQcml2LnNldCh0aGlzLCAiX19jbGFzc05hbWVfXyIsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgYGZhbHNlYCwKICAgICAgICAgIC8vIHRoZW4gcmVtb3ZlIHRoZSB3aG9sZSBjbGFzc25hbWUgKGlmIHRoZXJlIHdhcyBvbmUsIHRoZSBhYm92ZSBzYXZlZCBpdCkuCiAgICAgICAgICAvLyBPdGhlcndpc2UgYnJpbmcgYmFjayB3aGF0ZXZlciB3YXMgcHJldmlvdXNseSBzYXZlZCAoaWYgYW55dGhpbmcpLAogICAgICAgICAgLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLgogICAgICAgICAgaWYgKHRoaXMuc2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGNsYXNzTmFtZSB8fCB2YWx1ZSA9PT0gZmFsc2UgPyAiIiA6IGRhdGFQcml2LmdldCh0aGlzLCAiX19jbGFzc05hbWVfXyIpIHx8ICIiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGNsYXNzTmFtZSwKICAgICAgICBlbGVtLAogICAgICAgIGkgPSAwOwogICAgICBjbGFzc05hbWUgPSAiICIgKyBzZWxlY3RvciArICIgIjsKICAgICAgd2hpbGUgKGVsZW0gPSB0aGlzW2krK10pIHsKICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoIiAiICsgc3RyaXBBbmRDb2xsYXBzZShnZXRDbGFzcyhlbGVtKSkgKyAiICIpLmluZGV4T2YoY2xhc3NOYW1lKSA+IC0xKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0pOwogIHZhciBycmV0dXJuID0gL1xyL2c7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB2YWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgaG9va3MsCiAgICAgICAgcmV0LAogICAgICAgIHZhbHVlSXNGdW5jdGlvbiwKICAgICAgICBlbGVtID0gdGhpc1swXTsKICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgIGhvb2tzID0galF1ZXJ5LnZhbEhvb2tzW2VsZW0udHlwZV0gfHwgalF1ZXJ5LnZhbEhvb2tzW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCAidmFsdWUiKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgICAgcmV0ID0gZWxlbS52YWx1ZTsKCiAgICAgICAgICAvLyBIYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCiAgICAgICAgICBpZiAodHlwZW9mIHJldCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHJldC5yZXBsYWNlKHJyZXR1cm4sICIiKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBIYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKICAgICAgICAgIHJldHVybiByZXQgPT0gbnVsbCA/ICIiIDogcmV0OwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFsdWVJc0Z1bmN0aW9uID0gaXNGdW5jdGlvbih2YWx1ZSk7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh2YWx1ZUlzRnVuY3Rpb24pIHsKICAgICAgICAgIHZhbCA9IHZhbHVlLmNhbGwodGhpcywgaSwgalF1ZXJ5KHRoaXMpLnZhbCgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFsID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICAvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZwogICAgICAgIGlmICh2YWwgPT0gbnVsbCkgewogICAgICAgICAgdmFsID0gIiI7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgICAgICAgdmFsICs9ICIiOwogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgICAgICB2YWwgPSBqUXVlcnkubWFwKHZhbCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGhvb2tzID0galF1ZXJ5LnZhbEhvb2tzW3RoaXMudHlwZV0gfHwgalF1ZXJ5LnZhbEhvb2tzW3RoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCiAgICAgICAgaWYgKCFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQodGhpcywgdmFsLCAidmFsdWUiKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICB2YWxIb29rczogewogICAgICBvcHRpb246IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgdmFsID0galF1ZXJ5LmZpbmQuYXR0cihlbGVtLCAidmFsdWUiKTsKICAgICAgICAgIHJldHVybiB2YWwgIT0gbnVsbCA/IHZhbCA6CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTEwIC0gMTEgb25seQogICAgICAgICAgLy8gb3B0aW9uLnRleHQgdGhyb3dzIGV4Y2VwdGlvbnMgKHRyYWMtMTQ2ODYsIHRyYWMtMTQ4NTgpCiAgICAgICAgICAvLyBTdHJpcCBhbmQgY29sbGFwc2Ugd2hpdGVzcGFjZQogICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy8jc3RyaXAtYW5kLWNvbGxhcHNlLXdoaXRlc3BhY2UKICAgICAgICAgIHN0cmlwQW5kQ29sbGFwc2UoalF1ZXJ5LnRleHQoZWxlbSkpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2VsZWN0OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIHZhbHVlLAogICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCiAgICAgICAgICAgIGluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LAogICAgICAgICAgICBvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIiwKICAgICAgICAgICAgdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAogICAgICAgICAgICBtYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aDsKICAgICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgaSA9IG1heDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGkgPSBvbmUgPyBpbmRleCA6IDA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucwogICAgICAgICAgZm9yICg7IGkgPCBtYXg7IGkrKykgewogICAgICAgICAgICBvcHRpb24gPSBvcHRpb25zW2ldOwoKICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKICAgICAgICAgICAgLy8gSUU4LTkgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAodHJhYy0yNTUxKQogICAgICAgICAgICBpZiAoKG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCkgJiYKICAgICAgICAgICAgLy8gRG9uJ3QgcmV0dXJuIG9wdGlvbnMgdGhhdCBhcmUgZGlzYWJsZWQgb3IgaW4gYSBkaXNhYmxlZCBvcHRncm91cAogICAgICAgICAgICAhb3B0aW9uLmRpc2FibGVkICYmICghb3B0aW9uLnBhcmVudE5vZGUuZGlzYWJsZWQgfHwgIW5vZGVOYW1lKG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiKSkpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCiAgICAgICAgICAgICAgdmFsdWUgPSBqUXVlcnkob3B0aW9uKS52YWwoKTsKCiAgICAgICAgICAgICAgLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKICAgICAgICAgICAgICBpZiAob25lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQogICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICB2YXIgb3B0aW9uU2V0LAogICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCiAgICAgICAgICAgIHZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkodmFsdWUpLAogICAgICAgICAgICBpID0gb3B0aW9ucy5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CgogICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25kLWFzc2lnbiAqLwoKICAgICAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeS52YWxIb29rcy5vcHRpb24uZ2V0KG9wdGlvbiksIHZhbHVlcykgPiAtMSkgewogICAgICAgICAgICAgIG9wdGlvblNldCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgbm8tY29uZC1hc3NpZ24gKi8KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBGb3JjZSBicm93c2VycyB0byBiZWhhdmUgY29uc2lzdGVudGx5IHdoZW4gbm9uLW1hdGNoaW5nIHZhbHVlIGlzIHNldAogICAgICAgICAgaWYgKCFvcHRpb25TZXQpIHsKICAgICAgICAgICAgZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwoKICAvLyBSYWRpb3MgYW5kIGNoZWNrYm94ZXMgZ2V0dGVyL3NldHRlcgogIGpRdWVyeS5lYWNoKFsicmFkaW8iLCAiY2hlY2tib3giXSwgZnVuY3Rpb24gKCkgewogICAgalF1ZXJ5LnZhbEhvb2tzW3RoaXNdID0gewogICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUpID4gLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgaWYgKCFzdXBwb3J0LmNoZWNrT24pIHsKICAgICAgalF1ZXJ5LnZhbEhvb2tzW3RoaXNdLmdldCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpID09PSBudWxsID8gIm9uIiA6IGVsZW0udmFsdWU7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIFJldHVybiBqUXVlcnkgZm9yIGF0dHJpYnV0ZXMtb25seSBpbmNsdXNpb24KICB2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgdmFyIG5vbmNlID0gewogICAgZ3VpZDogRGF0ZS5ub3coKQogIH07CiAgdmFyIHJxdWVyeSA9IC9cPy87CgogIC8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcKICBqUXVlcnkucGFyc2VYTUwgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHhtbCwgcGFyc2VyRXJyb3JFbGVtOwogICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTEgb25seQogICAgLy8gSUUgdGhyb3dzIG9uIHBhcnNlRnJvbVN0cmluZyB3aXRoIGludmFsaWQgaW5wdXQuCiAgICB0cnkgewogICAgICB4bWwgPSBuZXcgd2luZG93LkRPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhkYXRhLCAidGV4dC94bWwiKTsKICAgIH0gY2F0Y2ggKGUpIHt9CiAgICBwYXJzZXJFcnJvckVsZW0gPSB4bWwgJiYgeG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJwYXJzZXJlcnJvciIpWzBdOwogICAgaWYgKCF4bWwgfHwgcGFyc2VyRXJyb3JFbGVtKSB7CiAgICAgIGpRdWVyeS5lcnJvcigiSW52YWxpZCBYTUw6ICIgKyAocGFyc2VyRXJyb3JFbGVtID8galF1ZXJ5Lm1hcChwYXJzZXJFcnJvckVsZW0uY2hpbGROb2RlcywgZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgcmV0dXJuIGVsLnRleHRDb250ZW50OwogICAgICB9KS5qb2luKCJcbiIpIDogZGF0YSkpOwogICAgfQogICAgcmV0dXJuIHhtbDsKICB9OwogIHZhciByZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKICAgIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrID0gZnVuY3Rpb24gKGUpIHsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH07CiAgalF1ZXJ5LmV4dGVuZChqUXVlcnkuZXZlbnQsIHsKICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzKSB7CiAgICAgIHZhciBpLAogICAgICAgIGN1ciwKICAgICAgICB0bXAsCiAgICAgICAgYnViYmxlVHlwZSwKICAgICAgICBvbnR5cGUsCiAgICAgICAgaGFuZGxlLAogICAgICAgIHNwZWNpYWwsCiAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgZXZlbnRQYXRoID0gW2VsZW0gfHwgZG9jdW1lbnRdLAogICAgICAgIHR5cGUgPSBoYXNPd24uY2FsbChldmVudCwgInR5cGUiKSA/IGV2ZW50LnR5cGUgOiBldmVudCwKICAgICAgICBuYW1lc3BhY2VzID0gaGFzT3duLmNhbGwoZXZlbnQsICJuYW1lc3BhY2UiKSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgiLiIpIDogW107CiAgICAgIGN1ciA9IGxhc3RFbGVtZW50ID0gdG1wID0gZWxlbSA9IGVsZW0gfHwgZG9jdW1lbnQ7CgogICAgICAvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKICAgICAgaWYgKHJmb2N1c01vcnBoLnRlc3QodHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0eXBlLmluZGV4T2YoIi4iKSA+IC0xKSB7CiAgICAgICAgLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQogICAgICAgIG5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CiAgICAgICAgdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKICAgICAgICBuYW1lc3BhY2VzLnNvcnQoKTsKICAgICAgfQogICAgICBvbnR5cGUgPSB0eXBlLmluZGV4T2YoIjoiKSA8IDAgJiYgIm9uIiArIHR5cGU7CgogICAgICAvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYSBqUXVlcnkuRXZlbnQgb2JqZWN0LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcKICAgICAgZXZlbnQgPSBldmVudFtqUXVlcnkuZXhwYW5kb10gPyBldmVudCA6IG5ldyBqUXVlcnkuRXZlbnQodHlwZSwgdHlwZW9mIGV2ZW50ID09PSAib2JqZWN0IiAmJiBldmVudCk7CgogICAgICAvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCiAgICAgIGV2ZW50LmlzVHJpZ2dlciA9IG9ubHlIYW5kbGVycyA/IDIgOiAzOwogICAgICBldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oIi4iKTsKICAgICAgZXZlbnQucm5hbWVzcGFjZSA9IGV2ZW50Lm5hbWVzcGFjZSA/IG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIpIDogbnVsbDsKCiAgICAgIC8vIENsZWFuIHVwIHRoZSBldmVudCBpbiBjYXNlIGl0IGlzIGJlaW5nIHJldXNlZAogICAgICBldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgZXZlbnQudGFyZ2V0ID0gZWxlbTsKICAgICAgfQoKICAgICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgICBkYXRhID0gZGF0YSA9PSBudWxsID8gW2V2ZW50XSA6IGpRdWVyeS5tYWtlQXJyYXkoZGF0YSwgW2V2ZW50XSk7CgogICAgICAvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseShlbGVtLCBkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKHRyYWMtOTk1MSkKICAgICAgLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICh0cmFjLTk3MjQpCiAgICAgIGlmICghb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFpc1dpbmRvdyhlbGVtKSkgewogICAgICAgIGJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwogICAgICAgIGlmICghcmZvY3VzTW9ycGgudGVzdChidWJibGVUeXBlICsgdHlwZSkpIHsKICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgZXZlbnRQYXRoLnB1c2goY3VyKTsKICAgICAgICAgIHRtcCA9IGN1cjsKICAgICAgICB9CgogICAgICAgIC8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQogICAgICAgIGlmICh0bXAgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpKSB7CiAgICAgICAgICBldmVudFBhdGgucHVzaCh0bXAuZGVmYXVsdFZpZXcgfHwgdG1wLnBhcmVudFdpbmRvdyB8fCB3aW5kb3cpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gRmlyZSBoYW5kbGVycyBvbiB0aGUgZXZlbnQgcGF0aAogICAgICBpID0gMDsKICAgICAgd2hpbGUgKChjdXIgPSBldmVudFBhdGhbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICBsYXN0RWxlbWVudCA9IGN1cjsKICAgICAgICBldmVudC50eXBlID0gaSA+IDEgPyBidWJibGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlOwoKICAgICAgICAvLyBqUXVlcnkgaGFuZGxlcgogICAgICAgIGhhbmRsZSA9IChkYXRhUHJpdi5nZXQoY3VyLCAiZXZlbnRzIikgfHwgT2JqZWN0LmNyZWF0ZShudWxsKSlbZXZlbnQudHlwZV0gJiYgZGF0YVByaXYuZ2V0KGN1ciwgImhhbmRsZSIpOwogICAgICAgIGlmIChoYW5kbGUpIHsKICAgICAgICAgIGhhbmRsZS5hcHBseShjdXIsIGRhdGEpOwogICAgICAgIH0KCiAgICAgICAgLy8gTmF0aXZlIGhhbmRsZXIKICAgICAgICBoYW5kbGUgPSBvbnR5cGUgJiYgY3VyW29udHlwZV07CiAgICAgICAgaWYgKGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgYWNjZXB0RGF0YShjdXIpKSB7CiAgICAgICAgICBldmVudC5yZXN1bHQgPSBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKTsKICAgICAgICAgIGlmIChldmVudC5yZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGV2ZW50LnR5cGUgPSB0eXBlOwoKICAgICAgLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwogICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICBpZiAoKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoZXZlbnRQYXRoLnBvcCgpLCBkYXRhKSA9PT0gZmFsc2UpICYmIGFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICAgIC8vIENhbGwgYSBuYXRpdmUgRE9NIG1ldGhvZCBvbiB0aGUgdGFyZ2V0IHdpdGggdGhlIHNhbWUgbmFtZSBhcyB0aGUgZXZlbnQuCiAgICAgICAgICAvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAodHJhYy02MTcwKQogICAgICAgICAgaWYgKG9udHlwZSAmJiBpc0Z1bmN0aW9uKGVsZW1bdHlwZV0pICYmICFpc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICAgIHRtcCA9IGVsZW1bb250eXBlXTsKICAgICAgICAgICAgaWYgKHRtcCkgewogICAgICAgICAgICAgIGVsZW1bb250eXBlXSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwogICAgICAgICAgICBpZiAoZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgIGxhc3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgc3RvcFByb3BhZ2F0aW9uQ2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1bdHlwZV0oKTsKICAgICAgICAgICAgaWYgKGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICBsYXN0RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAodG1wKSB7CiAgICAgICAgICAgICAgZWxlbVtvbnR5cGVdID0gdG1wOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgICB9LAogICAgLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lCiAgICAvLyBVc2VkIG9ubHkgZm9yIGBmb2N1cyhpbiB8IG91dClgIGV2ZW50cwogICAgc2ltdWxhdGU6IGZ1bmN0aW9uICh0eXBlLCBlbGVtLCBldmVudCkgewogICAgICB2YXIgZSA9IGpRdWVyeS5leHRlbmQobmV3IGpRdWVyeS5FdmVudCgpLCBldmVudCwgewogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaXNTaW11bGF0ZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKGUsIG51bGwsIGVsZW0pOwogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgdHJpZ2dlcjogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgdGhpcyk7CiAgICAgIH0pOwogICAgfSwKICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICB2YXIgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIGVsZW0sIHRydWUpOwogICAgICB9CiAgICB9CiAgfSk7CiAgdmFyIHJicmFja2V0ID0gL1xbXF0kLywKICAgIHJDUkxGID0gL1xyP1xuL2csCiAgICByc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksCiAgICByc3VibWl0dGFibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxrZXlnZW4pL2k7CiAgZnVuY3Rpb24gYnVpbGRQYXJhbXMocHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQpIHsKICAgIHZhciBuYW1lOwogICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgICAvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KICAgICAgalF1ZXJ5LmVhY2gob2JqLCBmdW5jdGlvbiAoaSwgdikgewogICAgICAgIGlmICh0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KHByZWZpeCkpIHsKICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgIGFkZChwcmVmaXgsIHYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBJdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMgbnVtZXJpYyBpbmRleC4KICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgJiYgdiAhPSBudWxsID8gaSA6ICIiKSArICJdIiwgdiwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoIXRyYWRpdGlvbmFsICYmIHRvVHlwZShvYmopID09PSAib2JqZWN0IikgewogICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAiWyIgKyBuYW1lICsgIl0iLCBvYmpbbmFtZV0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICB9CiAgfQoKICAvLyBTZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgogIC8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwogIGpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uIChhLCB0cmFkaXRpb25hbCkgewogICAgdmFyIHByZWZpeCwKICAgICAgcyA9IFtdLAogICAgICBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZU9yRnVuY3Rpb24pIHsKICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHVzZSBpdHMgcmV0dXJuIHZhbHVlCiAgICAgICAgdmFyIHZhbHVlID0gaXNGdW5jdGlvbih2YWx1ZU9yRnVuY3Rpb24pID8gdmFsdWVPckZ1bmN0aW9uKCkgOiB2YWx1ZU9yRnVuY3Rpb247CiAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSk7CiAgICAgIH07CiAgICBpZiAoYSA9PSBudWxsKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KCiAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgaWYgKEFycmF5LmlzQXJyYXkoYSkgfHwgYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KGEpKSB7CiAgICAgIC8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwogICAgICBqUXVlcnkuZWFjaChhLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgYWRkKHRoaXMubmFtZSwgdGhpcy52YWx1ZSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCiAgICAgIC8vIGRpZCBpdCksIG90aGVyd2lzZSBlbmNvZGUgcGFyYW1zIHJlY3Vyc2l2ZWx5LgogICAgICBmb3IgKHByZWZpeCBpbiBhKSB7CiAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9CgogICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgcmV0dXJuIHMuam9pbigiJiIpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5wYXJhbSh0aGlzLnNlcmlhbGl6ZUFycmF5KCkpOwogICAgfSwKICAgIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gQ2FuIGFkZCBwcm9wSG9vayBmb3IgImVsZW1lbnRzIiB0byBmaWx0ZXIgb3IgYWRkIGZvcm0gZWxlbWVudHMKICAgICAgICB2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCh0aGlzLCAiZWxlbWVudHMiKTsKICAgICAgICByZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KGVsZW1lbnRzKSA6IHRoaXM7CiAgICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHR5cGUgPSB0aGlzLnR5cGU7CgogICAgICAgIC8vIFVzZSAuaXMoICI6ZGlzYWJsZWQiICkgc28gdGhhdCBmaWVsZHNldFtkaXNhYmxlZF0gd29ya3MKICAgICAgICByZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkodGhpcykuaXMoIjpkaXNhYmxlZCIpICYmIHJzdWJtaXR0YWJsZS50ZXN0KHRoaXMubm9kZU5hbWUpICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCh0eXBlKSAmJiAodGhpcy5jaGVja2VkIHx8ICFyY2hlY2thYmxlVHlwZS50ZXN0KHR5cGUpKTsKICAgICAgfSkubWFwKGZ1bmN0aW9uIChfaSwgZWxlbSkgewogICAgICAgIHZhciB2YWwgPSBqUXVlcnkodGhpcykudmFsKCk7CiAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgcmV0dXJuIGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZTogZWxlbS5uYW1lLAogICAgICAgICAgICAgIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgIlxyXG4iKQogICAgICAgICAgICB9OwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBuYW1lOiBlbGVtLm5hbWUsCiAgICAgICAgICB2YWx1ZTogdmFsLnJlcGxhY2UockNSTEYsICJcclxuIikKICAgICAgICB9OwogICAgICB9KS5nZXQoKTsKICAgIH0KICB9KTsKICB2YXIgcjIwID0gLyUyMC9nLAogICAgcmhhc2ggPSAvIy4qJC8sCiAgICByYW50aUNhY2hlID0gLyhbPyZdKV89W14mXSovLAogICAgcmhlYWRlcnMgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKikkL21nLAogICAgLy8gdHJhYy03NjUzLCB0cmFjLTgxMjUsIHRyYWMtODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCiAgICBybG9jYWxQcm90b2NvbCA9IC9eKD86YWJvdXR8YXBwfGFwcC1zdG9yYWdlfC4rLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLAogICAgcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sCiAgICBycHJvdG9jb2wgPSAvXlwvXC8vLAogICAgLyogUHJlZmlsdGVycwogICAgICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKICAgICAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CiAgICAgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CiAgICAgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCiAgICAgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCiAgICAgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCiAgICAgKi8KICAgIHByZWZpbHRlcnMgPSB7fSwKICAgIC8qIFRyYW5zcG9ydHMgYmluZGluZ3MKICAgICAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKICAgICAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICAgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCiAgICAgKi8KICAgIHRyYW5zcG9ydHMgPSB7fSwKICAgIC8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKHRyYWMtMTAwOTgpOyBtdXN0IGFwcGVhc2UgbGludCBhbmQgZXZhZGUgY29tcHJlc3Npb24KICAgIGFsbFR5cGVzID0gIiovIi5jb25jYXQoIioiKSwKICAgIC8vIEFuY2hvciB0YWcgZm9yIHBhcnNpbmcgdGhlIGRvY3VtZW50IG9yaWdpbgogICAgb3JpZ2luQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogIG9yaWdpbkFuY2hvci5ocmVmID0gbG9jYXRpb24uaHJlZjsKCiAgLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKICBmdW5jdGlvbiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlKSB7CiAgICAvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhVHlwZUV4cHJlc3Npb24sIGZ1bmMpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICJzdHJpbmciKSB7CiAgICAgICAgZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKICAgICAgICBkYXRhVHlwZUV4cHJlc3Npb24gPSAiKiI7CiAgICAgIH0KICAgICAgdmFyIGRhdGFUeXBlLAogICAgICAgIGkgPSAwLAogICAgICAgIGRhdGFUeXBlcyA9IGRhdGFUeXBlRXhwcmVzc2lvbi50b0xvd2VyQ2FzZSgpLm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFtdOwogICAgICBpZiAoaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIC8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KICAgICAgICB3aGlsZSAoZGF0YVR5cGUgPSBkYXRhVHlwZXNbaSsrXSkgewogICAgICAgICAgLy8gUHJlcGVuZCBpZiByZXF1ZXN0ZWQKICAgICAgICAgIGlmIChkYXRhVHlwZVswXSA9PT0gIisiKSB7CiAgICAgICAgICAgIGRhdGFUeXBlID0gZGF0YVR5cGUuc2xpY2UoMSkgfHwgIioiOwogICAgICAgICAgICAoc3RydWN0dXJlW2RhdGFUeXBlXSA9IHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10pLnVuc2hpZnQoZnVuYyk7CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgYXBwZW5kCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAoc3RydWN0dXJlW2RhdGFUeXBlXSA9IHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10pLnB1c2goZnVuYyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KCiAgLy8gQmFzZSBpbnNwZWN0aW9uIGZ1bmN0aW9uIGZvciBwcmVmaWx0ZXJzIGFuZCB0cmFuc3BvcnRzCiAgZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKSB7CiAgICB2YXIgaW5zcGVjdGVkID0ge30sCiAgICAgIHNlZWtpbmdUcmFuc3BvcnQgPSBzdHJ1Y3R1cmUgPT09IHRyYW5zcG9ydHM7CiAgICBmdW5jdGlvbiBpbnNwZWN0KGRhdGFUeXBlKSB7CiAgICAgIHZhciBzZWxlY3RlZDsKICAgICAgaW5zcGVjdGVkW2RhdGFUeXBlXSA9IHRydWU7CiAgICAgIGpRdWVyeS5lYWNoKHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10sIGZ1bmN0aW9uIChfLCBwcmVmaWx0ZXJPckZhY3RvcnkpIHsKICAgICAgICB2YXIgZGF0YVR5cGVPclRyYW5zcG9ydCA9IHByZWZpbHRlck9yRmFjdG9yeShvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGFUeXBlT3JUcmFuc3BvcnQgPT09ICJzdHJpbmciICYmICFzZWVraW5nVHJhbnNwb3J0ICYmICFpbnNwZWN0ZWRbZGF0YVR5cGVPclRyYW5zcG9ydF0pIHsKICAgICAgICAgIG9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoZGF0YVR5cGVPclRyYW5zcG9ydCk7CiAgICAgICAgICBpbnNwZWN0KGRhdGFUeXBlT3JUcmFuc3BvcnQpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoc2Vla2luZ1RyYW5zcG9ydCkgewogICAgICAgICAgcmV0dXJuICEoc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgICB9CiAgICByZXR1cm4gaW5zcGVjdChvcHRpb25zLmRhdGFUeXBlc1swXSkgfHwgIWluc3BlY3RlZFsiKiJdICYmIGluc3BlY3QoIioiKTsKICB9CgogIC8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwogIC8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQogIC8vIEZpeGVzIHRyYWMtOTg4NwogIGZ1bmN0aW9uIGFqYXhFeHRlbmQodGFyZ2V0LCBzcmMpIHsKICAgIHZhciBrZXksCiAgICAgIGRlZXAsCiAgICAgIGZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKICAgIGZvciAoa2V5IGluIHNyYykgewogICAgICBpZiAoc3JjW2tleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIChmbGF0T3B0aW9uc1trZXldID8gdGFyZ2V0IDogZGVlcCB8fCAoZGVlcCA9IHt9KSlba2V5XSA9IHNyY1trZXldOwogICAgICB9CiAgICB9CiAgICBpZiAoZGVlcCkgewogICAgICBqUXVlcnkuZXh0ZW5kKHRydWUsIHRhcmdldCwgZGVlcCk7CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KCiAgLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogICAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAgICogLSByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICovCiAgZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKSB7CiAgICB2YXIgY3QsCiAgICAgIHR5cGUsCiAgICAgIGZpbmFsRGF0YVR5cGUsCiAgICAgIGZpcnN0RGF0YVR5cGUsCiAgICAgIGNvbnRlbnRzID0gcy5jb250ZW50cywKICAgICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXM7CgogICAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICAgIHdoaWxlIChkYXRhVHlwZXNbMF0gPT09ICIqIikgewogICAgICBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwogICAgICB9CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgd2UncmUgZGVhbGluZyB3aXRoIGEga25vd24gY29udGVudC10eXBlCiAgICBpZiAoY3QpIHsKICAgICAgZm9yICh0eXBlIGluIGNvbnRlbnRzKSB7CiAgICAgICAgaWYgKGNvbnRlbnRzW3R5cGVdICYmIGNvbnRlbnRzW3R5cGVdLnRlc3QoY3QpKSB7CiAgICAgICAgICBkYXRhVHlwZXMudW5zaGlmdCh0eXBlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQogICAgaWYgKGRhdGFUeXBlc1swXSBpbiByZXNwb25zZXMpIHsKICAgICAgZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgICAgZm9yICh0eXBlIGluIHJlc3BvbnNlcykgewogICAgICAgIGlmICghZGF0YVR5cGVzWzBdIHx8IHMuY29udmVydGVyc1t0eXBlICsgIiAiICsgZGF0YVR5cGVzWzBdXSkgewogICAgICAgICAgZmluYWxEYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFmaXJzdERhdGFUeXBlKSB7CiAgICAgICAgICBmaXJzdERhdGFUeXBlID0gdHlwZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQogICAgICBmaW5hbERhdGFUeXBlID0gZmluYWxEYXRhVHlwZSB8fCBmaXJzdERhdGFUeXBlOwogICAgfQoKICAgIC8vIElmIHdlIGZvdW5kIGEgZGF0YVR5cGUKICAgIC8vIFdlIGFkZCB0aGUgZGF0YVR5cGUgdG8gdGhlIGxpc3QgaWYgbmVlZGVkCiAgICAvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICBpZiAoZmluYWxEYXRhVHlwZSkgewogICAgICBpZiAoZmluYWxEYXRhVHlwZSAhPT0gZGF0YVR5cGVzWzBdKSB7CiAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQoZmluYWxEYXRhVHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3BvbnNlc1tmaW5hbERhdGFUeXBlXTsKICAgIH0KICB9CgogIC8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICAgKiBBbHNvIHNldHMgdGhlIHJlc3BvbnNlWFhYIGZpZWxkcyBvbiB0aGUganFYSFIgaW5zdGFuY2UKICAgKi8KICBmdW5jdGlvbiBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcykgewogICAgdmFyIGNvbnYyLAogICAgICBjdXJyZW50LAogICAgICBjb252LAogICAgICB0bXAsCiAgICAgIHByZXYsCiAgICAgIGNvbnZlcnRlcnMgPSB7fSwKICAgICAgLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgogICAgICBkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcy5zbGljZSgpOwoKICAgIC8vIENyZWF0ZSBjb252ZXJ0ZXJzIG1hcCB3aXRoIGxvd2VyY2FzZWQga2V5cwogICAgaWYgKGRhdGFUeXBlc1sxXSkgewogICAgICBmb3IgKGNvbnYgaW4gcy5jb252ZXJ0ZXJzKSB7CiAgICAgICAgY29udmVydGVyc1tjb252LnRvTG93ZXJDYXNlKCldID0gcy5jb252ZXJ0ZXJzW2NvbnZdOwogICAgICB9CiAgICB9CiAgICBjdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CgogICAgLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUKICAgIHdoaWxlIChjdXJyZW50KSB7CiAgICAgIGlmIChzLnJlc3BvbnNlRmllbGRzW2N1cnJlbnRdKSB7CiAgICAgICAganFYSFJbcy5yZXNwb25zZUZpZWxkc1tjdXJyZW50XV0gPSByZXNwb25zZTsKICAgICAgfQoKICAgICAgLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKICAgICAgaWYgKCFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIpIHsKICAgICAgICByZXNwb25zZSA9IHMuZGF0YUZpbHRlcihyZXNwb25zZSwgcy5kYXRhVHlwZSk7CiAgICAgIH0KICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICAgIGN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN1cnJlbnQpIHsKICAgICAgICAvLyBUaGVyZSdzIG9ubHkgd29yayB0byBkbyBpZiBjdXJyZW50IGRhdGFUeXBlIGlzIG5vbi1hdXRvCiAgICAgICAgaWYgKGN1cnJlbnQgPT09ICIqIikgewogICAgICAgICAgY3VycmVudCA9IHByZXY7CgogICAgICAgICAgLy8gQ29udmVydCByZXNwb25zZSBpZiBwcmV2IGRhdGFUeXBlIGlzIG5vbi1hdXRvIGFuZCBkaWZmZXJzIGZyb20gY3VycmVudAogICAgICAgIH0gZWxzZSBpZiAocHJldiAhPT0gIioiICYmIHByZXYgIT09IGN1cnJlbnQpIHsKICAgICAgICAgIC8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCiAgICAgICAgICBjb252ID0gY29udmVydGVyc1twcmV2ICsgIiAiICsgY3VycmVudF0gfHwgY29udmVydGVyc1siKiAiICsgY3VycmVudF07CgogICAgICAgICAgLy8gSWYgbm9uZSBmb3VuZCwgc2VlayBhIHBhaXIKICAgICAgICAgIGlmICghY29udikgewogICAgICAgICAgICBmb3IgKGNvbnYyIGluIGNvbnZlcnRlcnMpIHsKICAgICAgICAgICAgICAvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQKICAgICAgICAgICAgICB0bXAgPSBjb252Mi5zcGxpdCgiICIpOwogICAgICAgICAgICAgIGlmICh0bXBbMV0gPT09IGN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIC8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAogICAgICAgICAgICAgICAgY29udiA9IGNvbnZlcnRlcnNbcHJldiArICIgIiArIHRtcFswXV0gfHwgY29udmVydGVyc1siKiAiICsgdG1wWzBdXTsKICAgICAgICAgICAgICAgIGlmIChjb252KSB7CiAgICAgICAgICAgICAgICAgIC8vIENvbmRlbnNlIGVxdWl2YWxlbmNlIGNvbnZlcnRlcnMKICAgICAgICAgICAgICAgICAgaWYgKGNvbnYgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjb252ID0gY29udmVydGVyc1tjb252Ml07CgogICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb252ZXJ0ZXJzW2NvbnYyXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0bXBbMF07CiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQodG1wWzFdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKICAgICAgICAgIGlmIChjb252ICE9PSB0cnVlKSB7CiAgICAgICAgICAgIC8vIFVubGVzcyBlcnJvcnMgYXJlIGFsbG93ZWQgdG8gYnViYmxlLCBjYXRjaCBhbmQgcmV0dXJuIHRoZW0KICAgICAgICAgICAgaWYgKGNvbnYgJiYgcy50aHJvd3MpIHsKICAgICAgICAgICAgICByZXNwb25zZSA9IGNvbnYocmVzcG9uc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IGNvbnYocmVzcG9uc2UpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIHN0YXRlOiAicGFyc2VyZXJyb3IiLAogICAgICAgICAgICAgICAgICBlcnJvcjogY29udiA/IGUgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBwcmV2ICsgIiB0byAiICsgY3VycmVudAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIHN0YXRlOiAic3VjY2VzcyIsCiAgICAgIGRhdGE6IHJlc3BvbnNlCiAgICB9OwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIC8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwogICAgYWN0aXZlOiAwLAogICAgLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAogICAgbGFzdE1vZGlmaWVkOiB7fSwKICAgIGV0YWc6IHt9LAogICAgYWpheFNldHRpbmdzOiB7CiAgICAgIHVybDogbG9jYXRpb24uaHJlZiwKICAgICAgdHlwZTogIkdFVCIsCiAgICAgIGlzTG9jYWw6IHJsb2NhbFByb3RvY29sLnRlc3QobG9jYXRpb24ucHJvdG9jb2wpLAogICAgICBnbG9iYWw6IHRydWUsCiAgICAgIHByb2Nlc3NEYXRhOiB0cnVlLAogICAgICBhc3luYzogdHJ1ZSwKICAgICAgY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiLAogICAgICAvKgogICAgICB0aW1lb3V0OiAwLAogICAgICBkYXRhOiBudWxsLAogICAgICBkYXRhVHlwZTogbnVsbCwKICAgICAgdXNlcm5hbWU6IG51bGwsCiAgICAgIHBhc3N3b3JkOiBudWxsLAogICAgICBjYWNoZTogbnVsbCwKICAgICAgdGhyb3dzOiBmYWxzZSwKICAgICAgdHJhZGl0aW9uYWw6IGZhbHNlLAogICAgICBoZWFkZXJzOiB7fSwKICAgICAgKi8KCiAgICAgIGFjY2VwdHM6IHsKICAgICAgICAiKiI6IGFsbFR5cGVzLAogICAgICAgIHRleHQ6ICJ0ZXh0L3BsYWluIiwKICAgICAgICBodG1sOiAidGV4dC9odG1sIiwKICAgICAgICB4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKICAgICAgICBqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IgogICAgICB9LAogICAgICBjb250ZW50czogewogICAgICAgIHhtbDogL1xieG1sXGIvLAogICAgICAgIGh0bWw6IC9cYmh0bWwvLAogICAgICAgIGpzb246IC9cYmpzb25cYi8KICAgICAgfSwKICAgICAgcmVzcG9uc2VGaWVsZHM6IHsKICAgICAgICB4bWw6ICJyZXNwb25zZVhNTCIsCiAgICAgICAgdGV4dDogInJlc3BvbnNlVGV4dCIsCiAgICAgICAganNvbjogInJlc3BvbnNlSlNPTiIKICAgICAgfSwKICAgICAgLy8gRGF0YSBjb252ZXJ0ZXJzCiAgICAgIC8vIEtleXMgc2VwYXJhdGUgc291cmNlIChvciBjYXRjaGFsbCAiKiIpIGFuZCBkZXN0aW5hdGlvbiB0eXBlcyB3aXRoIGEgc2luZ2xlIHNwYWNlCiAgICAgIGNvbnZlcnRlcnM6IHsKICAgICAgICAvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKICAgICAgICAiKiB0ZXh0IjogU3RyaW5nLAogICAgICAgIC8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQogICAgICAgICJ0ZXh0IGh0bWwiOiB0cnVlLAogICAgICAgIC8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KICAgICAgICAidGV4dCBqc29uIjogSlNPTi5wYXJzZSwKICAgICAgICAvLyBQYXJzZSB0ZXh0IGFzIHhtbAogICAgICAgICJ0ZXh0IHhtbCI6IGpRdWVyeS5wYXJzZVhNTAogICAgICB9LAogICAgICAvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgogICAgICAvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCiAgICAgIC8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCiAgICAgIC8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQogICAgICBmbGF0T3B0aW9uczogewogICAgICAgIHVybDogdHJ1ZSwKICAgICAgICBjb250ZXh0OiB0cnVlCiAgICAgIH0KICAgIH0sCiAgICAvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAogICAgLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgogICAgLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KICAgIGFqYXhTZXR1cDogZnVuY3Rpb24gKHRhcmdldCwgc2V0dGluZ3MpIHsKICAgICAgcmV0dXJuIHNldHRpbmdzID8KICAgICAgLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKICAgICAgYWpheEV4dGVuZChhamF4RXh0ZW5kKHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyksIHNldHRpbmdzKSA6CiAgICAgIC8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKICAgICAgYWpheEV4dGVuZChqUXVlcnkuYWpheFNldHRpbmdzLCB0YXJnZXQpOwogICAgfSwKICAgIGFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyhwcmVmaWx0ZXJzKSwKICAgIGFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzKSwKICAgIC8vIE1haW4gbWV0aG9kCiAgICBhamF4OiBmdW5jdGlvbiAodXJsLCBvcHRpb25zKSB7CiAgICAgIC8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCiAgICAgIGlmICh0eXBlb2YgdXJsID09PSAib2JqZWN0IikgewogICAgICAgIG9wdGlvbnMgPSB1cmw7CiAgICAgICAgdXJsID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICAvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIHRyYW5zcG9ydCwKICAgICAgICAvLyBVUkwgd2l0aG91dCBhbnRpLWNhY2hlIHBhcmFtCiAgICAgICAgY2FjaGVVUkwsCiAgICAgICAgLy8gUmVzcG9uc2UgaGVhZGVycwogICAgICAgIHJlc3BvbnNlSGVhZGVyc1N0cmluZywKICAgICAgICByZXNwb25zZUhlYWRlcnMsCiAgICAgICAgLy8gdGltZW91dCBoYW5kbGUKICAgICAgICB0aW1lb3V0VGltZXIsCiAgICAgICAgLy8gVXJsIGNsZWFudXAgdmFyCiAgICAgICAgdXJsQW5jaG9yLAogICAgICAgIC8vIFJlcXVlc3Qgc3RhdGUgKGJlY29tZXMgZmFsc2UgdXBvbiBzZW5kIGFuZCB0cnVlIHVwb24gY29tcGxldGlvbikKICAgICAgICBjb21wbGV0ZWQsCiAgICAgICAgLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCiAgICAgICAgZmlyZUdsb2JhbHMsCiAgICAgICAgLy8gTG9vcCB2YXJpYWJsZQogICAgICAgIGksCiAgICAgICAgLy8gdW5jYWNoZWQgcGFydCBvZiB0aGUgdXJsCiAgICAgICAgdW5jYWNoZWQsCiAgICAgICAgLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAogICAgICAgIHMgPSBqUXVlcnkuYWpheFNldHVwKHt9LCBvcHRpb25zKSwKICAgICAgICAvLyBDYWxsYmFja3MgY29udGV4dAogICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAogICAgICAgIC8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24KICAgICAgICBnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYgKGNhbGxiYWNrQ29udGV4dC5ub2RlVHlwZSB8fCBjYWxsYmFja0NvbnRleHQuanF1ZXJ5KSA/IGpRdWVyeShjYWxsYmFja0NvbnRleHQpIDogalF1ZXJ5LmV2ZW50LAogICAgICAgIC8vIERlZmVycmVkcwogICAgICAgIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgY29tcGxldGVEZWZlcnJlZCA9IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAogICAgICAgIC8vIEhlYWRlcnMgKHRoZXkgYXJlIHNlbnQgYWxsIGF0IG9uY2UpCiAgICAgICAgcmVxdWVzdEhlYWRlcnMgPSB7fSwKICAgICAgICByZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sCiAgICAgICAgLy8gRGVmYXVsdCBhYm9ydCBtZXNzYWdlCiAgICAgICAgc3RyQWJvcnQgPSAiY2FuY2VsZWQiLAogICAgICAgIC8vIEZha2UgeGhyCiAgICAgICAganFYSFIgPSB7CiAgICAgICAgICByZWFkeVN0YXRlOiAwLAogICAgICAgICAgLy8gQnVpbGRzIGhlYWRlcnMgaGFzaHRhYmxlIGlmIG5lZWRlZAogICAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIG1hdGNoOwogICAgICAgICAgICBpZiAoY29tcGxldGVkKSB7CiAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9IHt9OwogICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gcmhlYWRlcnMuZXhlYyhyZXNwb25zZUhlYWRlcnNTdHJpbmcpKSB7CiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyc1ttYXRjaFsxXS50b0xvd2VyQ2FzZSgpICsgIiAiXSA9IChyZXNwb25zZUhlYWRlcnNbbWF0Y2hbMV0udG9Mb3dlckNhc2UoKSArICIgIl0gfHwgW10pLmNvbmNhdChtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG1hdGNoID0gcmVzcG9uc2VIZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpICsgIiAiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF0Y2ggPT0gbnVsbCA/IG51bGwgOiBtYXRjaC5qb2luKCIsICIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIFJhdyBzdHJpbmcKICAgICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY29tcGxldGVkID8gcmVzcG9uc2VIZWFkZXJzU3RyaW5nIDogbnVsbDsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYWNoZXMgdGhlIGhlYWRlcgogICAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChjb21wbGV0ZWQgPT0gbnVsbCkgewogICAgICAgICAgICAgIG5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzW25hbWUudG9Mb3dlckNhc2UoKV0gPSByZXF1ZXN0SGVhZGVyc05hbWVzW25hbWUudG9Mb3dlckNhc2UoKV0gfHwgbmFtZTsKICAgICAgICAgICAgICByZXF1ZXN0SGVhZGVyc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICBpZiAoY29tcGxldGVkID09IG51bGwpIHsKICAgICAgICAgICAgICBzLm1pbWVUeXBlID0gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwogICAgICAgICAgc3RhdHVzQ29kZTogZnVuY3Rpb24gKG1hcCkgewogICAgICAgICAgICB2YXIgY29kZTsKICAgICAgICAgICAgaWYgKG1hcCkgewogICAgICAgICAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICAgICAgICAgIC8vIEV4ZWN1dGUgdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrcwogICAgICAgICAgICAgICAganFYSFIuYWx3YXlzKG1hcFtqcVhIUi5zdGF0dXNdKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTGF6eS1hZGQgdGhlIG5ldyBjYWxsYmFja3MgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMKICAgICAgICAgICAgICAgIGZvciAoY29kZSBpbiBtYXApIHsKICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZVtjb2RlXSA9IFtzdGF0dXNDb2RlW2NvZGVdLCBtYXBbY29kZV1dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYW5jZWwgdGhlIHJlcXVlc3QKICAgICAgICAgIGFib3J0OiBmdW5jdGlvbiAoc3RhdHVzVGV4dCkgewogICAgICAgICAgICB2YXIgZmluYWxUZXh0ID0gc3RhdHVzVGV4dCB8fCBzdHJBYm9ydDsKICAgICAgICAgICAgaWYgKHRyYW5zcG9ydCkgewogICAgICAgICAgICAgIHRyYW5zcG9ydC5hYm9ydChmaW5hbFRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvbmUoMCwgZmluYWxUZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgIC8vIEF0dGFjaCBkZWZlcnJlZHMKICAgICAgZGVmZXJyZWQucHJvbWlzZShqcVhIUik7CgogICAgICAvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkIChwcmVmaWx0ZXJzIG1pZ2h0IGV4cGVjdCBpdCkKICAgICAgLy8gSGFuZGxlIGZhbHN5IHVybCBpbiB0aGUgc2V0dGluZ3Mgb2JqZWN0ICh0cmFjLTEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCiAgICAgIC8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQogICAgICBzLnVybCA9ICgodXJsIHx8IHMudXJsIHx8IGxvY2F0aW9uLmhyZWYpICsgIiIpLnJlcGxhY2UocnByb3RvY29sLCBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIpOwoKICAgICAgLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgdHJhYy0xMjAwNAogICAgICBzLnR5cGUgPSBvcHRpb25zLm1ldGhvZCB8fCBvcHRpb25zLnR5cGUgfHwgcy5tZXRob2QgfHwgcy50eXBlOwoKICAgICAgLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAogICAgICBzLmRhdGFUeXBlcyA9IChzLmRhdGFUeXBlIHx8ICIqIikudG9Mb3dlckNhc2UoKS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbIiJdOwoKICAgICAgLy8gQSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlciB3aGVuIHRoZSBvcmlnaW4gZG9lc24ndCBtYXRjaCB0aGUgY3VycmVudCBvcmlnaW4uCiAgICAgIGlmIChzLmNyb3NzRG9tYWluID09IG51bGwpIHsKICAgICAgICB1cmxBbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CgogICAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OCAtIDExLCBFZGdlIDEyIC0gMTUKICAgICAgICAvLyBJRSB0aHJvd3MgZXhjZXB0aW9uIG9uIGFjY2Vzc2luZyB0aGUgaHJlZiBwcm9wZXJ0eSBpZiB1cmwgaXMgbWFsZm9ybWVkLAogICAgICAgIC8vIGUuZy4gaHR0cDovL2V4YW1wbGUuY29tOjgweC8KICAgICAgICB0cnkgewogICAgICAgICAgdXJsQW5jaG9yLmhyZWYgPSBzLnVybDsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTggLSAxMSBvbmx5CiAgICAgICAgICAvLyBBbmNob3IncyBob3N0IHByb3BlcnR5IGlzbid0IGNvcnJlY3RseSBzZXQgd2hlbiBzLnVybCBpcyByZWxhdGl2ZQogICAgICAgICAgdXJsQW5jaG9yLmhyZWYgPSB1cmxBbmNob3IuaHJlZjsKICAgICAgICAgIHMuY3Jvc3NEb21haW4gPSBvcmlnaW5BbmNob3IucHJvdG9jb2wgKyAiLy8iICsgb3JpZ2luQW5jaG9yLmhvc3QgIT09IHVybEFuY2hvci5wcm90b2NvbCArICIvLyIgKyB1cmxBbmNob3IuaG9zdDsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBhbiBlcnJvciBwYXJzaW5nIHRoZSBVUkwsIGFzc3VtZSBpdCBpcyBjcm9zc0RvbWFpbiwKICAgICAgICAgIC8vIGl0IGNhbiBiZSByZWplY3RlZCBieSB0aGUgdHJhbnNwb3J0IGlmIGl0IGlzIGludmFsaWQKICAgICAgICAgIHMuY3Jvc3NEb21haW4gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCiAgICAgIGlmIChzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIikgewogICAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEsIHMudHJhZGl0aW9uYWwpOwogICAgICB9CgogICAgICAvLyBBcHBseSBwcmVmaWx0ZXJzCiAgICAgIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSKTsKCiAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCiAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICByZXR1cm4ganFYSFI7CiAgICAgIH0KCiAgICAgIC8vIFdlIGNhbiBmaXJlIGdsb2JhbCBldmVudHMgYXMgb2Ygbm93IGlmIGFza2VkIHRvCiAgICAgIC8vIERvbid0IGZpcmUgZXZlbnRzIGlmIGpRdWVyeS5ldmVudCBpcyB1bmRlZmluZWQgaW4gYW4gQU1ELXVzYWdlIHNjZW5hcmlvICh0cmFjLTE1MTE4KQogICAgICBmaXJlR2xvYmFscyA9IGpRdWVyeS5ldmVudCAmJiBzLmdsb2JhbDsKCiAgICAgIC8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKICAgICAgaWYgKGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCkgewogICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RhcnQiKTsKICAgICAgfQoKICAgICAgLy8gVXBwZXJjYXNlIHRoZSB0eXBlCiAgICAgIHMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKICAgICAgcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdChzLnR5cGUpOwoKICAgICAgLy8gU2F2ZSB0aGUgVVJMIGluIGNhc2Ugd2UncmUgdG95aW5nIHdpdGggdGhlIElmLU1vZGlmaWVkLVNpbmNlCiAgICAgIC8vIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciBsYXRlciBvbgogICAgICAvLyBSZW1vdmUgaGFzaCB0byBzaW1wbGlmeSB1cmwgbWFuaXB1bGF0aW9uCiAgICAgIGNhY2hlVVJMID0gcy51cmwucmVwbGFjZShyaGFzaCwgIiIpOwoKICAgICAgLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKICAgICAgaWYgKCFzLmhhc0NvbnRlbnQpIHsKICAgICAgICAvLyBSZW1lbWJlciB0aGUgaGFzaCBzbyB3ZSBjYW4gcHV0IGl0IGJhY2sKICAgICAgICB1bmNhY2hlZCA9IHMudXJsLnNsaWNlKGNhY2hlVVJMLmxlbmd0aCk7CgogICAgICAgIC8vIElmIGRhdGEgaXMgYXZhaWxhYmxlIGFuZCBzaG91bGQgYmUgcHJvY2Vzc2VkLCBhcHBlbmQgZGF0YSB0byB1cmwKICAgICAgICBpZiAocy5kYXRhICYmIChzLnByb2Nlc3NEYXRhIHx8IHR5cGVvZiBzLmRhdGEgPT09ICJzdHJpbmciKSkgewogICAgICAgICAgY2FjaGVVUkwgKz0gKHJxdWVyeS50ZXN0KGNhY2hlVVJMKSA/ICImIiA6ICI/IikgKyBzLmRhdGE7CgogICAgICAgICAgLy8gdHJhYy05NjgyOiByZW1vdmUgZGF0YSBzbyB0aGF0IGl0J3Mgbm90IHVzZWQgaW4gYW4gZXZlbnR1YWwgcmV0cnkKICAgICAgICAgIGRlbGV0ZSBzLmRhdGE7CiAgICAgICAgfQoKICAgICAgICAvLyBBZGQgb3IgdXBkYXRlIGFudGktY2FjaGUgcGFyYW0gaWYgbmVlZGVkCiAgICAgICAgaWYgKHMuY2FjaGUgPT09IGZhbHNlKSB7CiAgICAgICAgICBjYWNoZVVSTCA9IGNhY2hlVVJMLnJlcGxhY2UocmFudGlDYWNoZSwgIiQxIik7CiAgICAgICAgICB1bmNhY2hlZCA9IChycXVlcnkudGVzdChjYWNoZVVSTCkgPyAiJiIgOiAiPyIpICsgIl89IiArIG5vbmNlLmd1aWQrKyArIHVuY2FjaGVkOwogICAgICAgIH0KCiAgICAgICAgLy8gUHV0IGhhc2ggYW5kIGFudGktY2FjaGUgb24gdGhlIFVSTCB0aGF0IHdpbGwgYmUgcmVxdWVzdGVkIChnaC0xNzMyKQogICAgICAgIHMudXJsID0gY2FjaGVVUkwgKyB1bmNhY2hlZDsKCiAgICAgICAgLy8gQ2hhbmdlICclMjAnIHRvICcrJyBpZiB0aGlzIGlzIGVuY29kZWQgZm9ybSBib2R5IGNvbnRlbnQgKGdoLTI2NTgpCiAgICAgIH0gZWxzZSBpZiAocy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgKHMuY29udGVudFR5cGUgfHwgIiIpLmluZGV4T2YoImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpID09PSAwKSB7CiAgICAgICAgcy5kYXRhID0gcy5kYXRhLnJlcGxhY2UocjIwLCAiKyIpOwogICAgICB9CgogICAgICAvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgogICAgICBpZiAocy5pZk1vZGlmaWVkKSB7CiAgICAgICAgaWYgKGpRdWVyeS5sYXN0TW9kaWZpZWRbY2FjaGVVUkxdKSB7CiAgICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsIGpRdWVyeS5sYXN0TW9kaWZpZWRbY2FjaGVVUkxdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGpRdWVyeS5ldGFnW2NhY2hlVVJMXSkgewogICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcigiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnW2NhY2hlVVJMXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTZXQgdGhlIGNvcnJlY3QgaGVhZGVyLCBpZiBkYXRhIGlzIGJlaW5nIHNlbnQKICAgICAgaWYgKHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSkgewogICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsIHMuY29udGVudFR5cGUpOwogICAgICB9CgogICAgICAvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCiAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIkFjY2VwdCIsIHMuZGF0YVR5cGVzWzBdICYmIHMuYWNjZXB0c1tzLmRhdGFUeXBlc1swXV0gPyBzLmFjY2VwdHNbcy5kYXRhVHlwZXNbMF1dICsgKHMuZGF0YVR5cGVzWzBdICE9PSAiKiIgPyAiLCAiICsgYWxsVHlwZXMgKyAiOyBxPTAuMDEiIDogIiIpIDogcy5hY2NlcHRzWyIqIl0pOwoKICAgICAgLy8gQ2hlY2sgZm9yIGhlYWRlcnMgb3B0aW9uCiAgICAgIGZvciAoaSBpbiBzLmhlYWRlcnMpIHsKICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKGksIHMuaGVhZGVyc1tpXSk7CiAgICAgIH0KCiAgICAgIC8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKICAgICAgaWYgKHMuYmVmb3JlU2VuZCAmJiAocy5iZWZvcmVTZW5kLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcykgPT09IGZhbHNlIHx8IGNvbXBsZXRlZCkpIHsKICAgICAgICAvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5IGFuZCByZXR1cm4KICAgICAgICByZXR1cm4ganFYSFIuYWJvcnQoKTsKICAgICAgfQoKICAgICAgLy8gQWJvcnRpbmcgaXMgbm8gbG9uZ2VyIGEgY2FuY2VsbGF0aW9uCiAgICAgIHN0ckFib3J0ID0gImFib3J0IjsKCiAgICAgIC8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcwogICAgICBjb21wbGV0ZURlZmVycmVkLmFkZChzLmNvbXBsZXRlKTsKICAgICAganFYSFIuZG9uZShzLnN1Y2Nlc3MpOwogICAgICBqcVhIUi5mYWlsKHMuZXJyb3IpOwoKICAgICAgLy8gR2V0IHRyYW5zcG9ydAogICAgICB0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUik7CgogICAgICAvLyBJZiBubyB0cmFuc3BvcnQsIHdlIGF1dG8tYWJvcnQKICAgICAgaWYgKCF0cmFuc3BvcnQpIHsKICAgICAgICBkb25lKC0xLCAiTm8gVHJhbnNwb3J0Iik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IDE7CgogICAgICAgIC8vIFNlbmQgZ2xvYmFsIGV2ZW50CiAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcigiYWpheFNlbmQiLCBbanFYSFIsIHNdKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGFqYXhTZW5kLCBzdG9wIHRoZXJlCiAgICAgICAgaWYgKGNvbXBsZXRlZCkgewogICAgICAgICAgcmV0dXJuIGpxWEhSOwogICAgICAgIH0KCiAgICAgICAgLy8gVGltZW91dAogICAgICAgIGlmIChzLmFzeW5jICYmIHMudGltZW91dCA+IDApIHsKICAgICAgICAgIHRpbWVvdXRUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAganFYSFIuYWJvcnQoInRpbWVvdXQiKTsKICAgICAgICAgIH0sIHMudGltZW91dCk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICBjb21wbGV0ZWQgPSBmYWxzZTsKICAgICAgICAgIHRyYW5zcG9ydC5zZW5kKHJlcXVlc3RIZWFkZXJzLCBkb25lKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAvLyBSZXRocm93IHBvc3QtY29tcGxldGlvbiBleGNlcHRpb25zCiAgICAgICAgICBpZiAoY29tcGxldGVkKSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUHJvcGFnYXRlIG90aGVycyBhcyByZXN1bHRzCiAgICAgICAgICBkb25lKC0xLCBlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQogICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzKSB7CiAgICAgICAgdmFyIGlzU3VjY2VzcywKICAgICAgICAgIHN1Y2Nlc3MsCiAgICAgICAgICBlcnJvciwKICAgICAgICAgIHJlc3BvbnNlLAogICAgICAgICAgbW9kaWZpZWQsCiAgICAgICAgICBzdGF0dXNUZXh0ID0gbmF0aXZlU3RhdHVzVGV4dDsKCiAgICAgICAgLy8gSWdub3JlIHJlcGVhdCBpbnZvY2F0aW9ucwogICAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29tcGxldGVkID0gdHJ1ZTsKCiAgICAgICAgLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMKICAgICAgICBpZiAodGltZW91dFRpbWVyKSB7CiAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgICAgfQoKICAgICAgICAvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIC8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCiAgICAgICAgdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKICAgICAgICAvLyBDYWNoZSByZXNwb25zZSBoZWFkZXJzCiAgICAgICAgcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCiAgICAgICAgLy8gU2V0IHJlYWR5U3RhdGUKICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gc3RhdHVzID4gMCA/IDQgOiAwOwoKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAogICAgICAgIGlzU3VjY2VzcyA9IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwoKICAgICAgICAvLyBHZXQgcmVzcG9uc2UgZGF0YQogICAgICAgIGlmIChyZXNwb25zZXMpIHsKICAgICAgICAgIHJlc3BvbnNlID0gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKTsKICAgICAgICB9CgogICAgICAgIC8vIFVzZSBhIG5vb3AgY29udmVydGVyIGZvciBtaXNzaW5nIHNjcmlwdCBidXQgbm90IGlmIGpzb25wCiAgICAgICAgaWYgKCFpc1N1Y2Nlc3MgJiYgalF1ZXJ5LmluQXJyYXkoInNjcmlwdCIsIHMuZGF0YVR5cGVzKSA+IC0xICYmIGpRdWVyeS5pbkFycmF5KCJqc29uIiwgcy5kYXRhVHlwZXMpIDwgMCkgewogICAgICAgICAgcy5jb252ZXJ0ZXJzWyJ0ZXh0IHNjcmlwdCJdID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgfQoKICAgICAgICAvLyBDb252ZXJ0IG5vIG1hdHRlciB3aGF0ICh0aGF0IHdheSByZXNwb25zZVhYWCBmaWVsZHMgYXJlIGFsd2F5cyBzZXQpCiAgICAgICAgcmVzcG9uc2UgPSBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2Vzcyk7CgogICAgICAgIC8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCiAgICAgICAgaWYgKGlzU3VjY2VzcykgewogICAgICAgICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgICAgICAgIGlmIChzLmlmTW9kaWZpZWQpIHsKICAgICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpOwogICAgICAgICAgICBpZiAobW9kaWZpZWQpIHsKICAgICAgICAgICAgICBqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSA9IG1vZGlmaWVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoImV0YWciKTsKICAgICAgICAgICAgaWYgKG1vZGlmaWVkKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmV0YWdbY2FjaGVVUkxdID0gbW9kaWZpZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBpZiBubyBjb250ZW50CiAgICAgICAgICBpZiAoc3RhdHVzID09PSAyMDQgfHwgcy50eXBlID09PSAiSEVBRCIpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICJub2NvbnRlbnQiOwoKICAgICAgICAgICAgLy8gaWYgbm90IG1vZGlmaWVkCiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gMzA0KSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAibm90bW9kaWZpZWQiOwoKICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBkYXRhLCBsZXQncyBjb252ZXJ0IGl0CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7CiAgICAgICAgICAgIHN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwogICAgICAgICAgICBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgICAgICBpc1N1Y2Nlc3MgPSAhZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0IGFuZCBub3JtYWxpemUgZm9yIG5vbi1hYm9ydHMKICAgICAgICAgIGVycm9yID0gc3RhdHVzVGV4dDsKICAgICAgICAgIGlmIChzdGF0dXMgfHwgIXN0YXR1c1RleHQpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICJlcnJvciI7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPCAwKSB7CiAgICAgICAgICAgICAgc3RhdHVzID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKICAgICAgICBqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAganFYSFIuc3RhdHVzVGV4dCA9IChuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQpICsgIiI7CgogICAgICAgIC8vIFN1Y2Nlc3MvRXJyb3IKICAgICAgICBpZiAoaXNTdWNjZXNzKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChjYWxsYmFja0NvbnRleHQsIFtzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUl0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3RXaXRoKGNhbGxiYWNrQ29udGV4dCwgW2pxWEhSLCBzdGF0dXNUZXh0LCBlcnJvcl0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBqcVhIUi5zdGF0dXNDb2RlKHN0YXR1c0NvZGUpOwogICAgICAgIHN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcihpc1N1Y2Nlc3MgPyAiYWpheFN1Y2Nlc3MiIDogImFqYXhFcnJvciIsIFtqcVhIUiwgcywgaXNTdWNjZXNzID8gc3VjY2VzcyA6IGVycm9yXSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDb21wbGV0ZQogICAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbanFYSFIsIHN0YXR1c1RleHRdKTsKICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCJhamF4Q29tcGxldGUiLCBbanFYSFIsIHNdKTsKCiAgICAgICAgICAvLyBIYW5kbGUgdGhlIGdsb2JhbCBBSkFYIGNvdW50ZXIKICAgICAgICAgIGlmICghIC0talF1ZXJ5LmFjdGl2ZSkgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGpxWEhSOwogICAgfSwKICAgIGdldEpTT046IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ2V0KHVybCwgZGF0YSwgY2FsbGJhY2ssICJqc29uIik7CiAgICB9LAogICAgZ2V0U2NyaXB0OiBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICJzY3JpcHQiKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaChbImdldCIsICJwb3N0Il0sIGZ1bmN0aW9uIChfaSwgbWV0aG9kKSB7CiAgICBqUXVlcnlbbWV0aG9kXSA9IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrLCB0eXBlKSB7CiAgICAgIC8vIFNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCiAgICAgIGlmIChpc0Z1bmN0aW9uKGRhdGEpKSB7CiAgICAgICAgdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSBkYXRhOwogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIC8vIFRoZSB1cmwgY2FuIGJlIGFuIG9wdGlvbnMgb2JqZWN0ICh3aGljaCB0aGVuIG11c3QgaGF2ZSAudXJsKQogICAgICByZXR1cm4galF1ZXJ5LmFqYXgoalF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgdHlwZTogbWV0aG9kLAogICAgICAgIGRhdGFUeXBlOiB0eXBlLAogICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgc3VjY2VzczogY2FsbGJhY2sKICAgICAgfSwgalF1ZXJ5LmlzUGxhaW5PYmplY3QodXJsKSAmJiB1cmwpKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoZnVuY3Rpb24gKHMpIHsKICAgIHZhciBpOwogICAgZm9yIChpIGluIHMuaGVhZGVycykgewogICAgICBpZiAoaS50b0xvd2VyQ2FzZSgpID09PSAiY29udGVudC10eXBlIikgewogICAgICAgIHMuY29udGVudFR5cGUgPSBzLmhlYWRlcnNbaV0gfHwgIiI7CiAgICAgIH0KICAgIH0KICB9KTsKICBqUXVlcnkuX2V2YWxVcmwgPSBmdW5jdGlvbiAodXJsLCBvcHRpb25zLCBkb2MpIHsKICAgIHJldHVybiBqUXVlcnkuYWpheCh7CiAgICAgIHVybDogdXJsLAogICAgICAvLyBNYWtlIHRoaXMgZXhwbGljaXQsIHNpbmNlIHVzZXIgY2FuIG92ZXJyaWRlIHRoaXMgdGhyb3VnaCBhamF4U2V0dXAgKHRyYWMtMTEyNjQpCiAgICAgIHR5cGU6ICJHRVQiLAogICAgICBkYXRhVHlwZTogInNjcmlwdCIsCiAgICAgIGNhY2hlOiB0cnVlLAogICAgICBhc3luYzogZmFsc2UsCiAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgIC8vIE9ubHkgZXZhbHVhdGUgdGhlIHJlc3BvbnNlIGlmIGl0IGlzIHN1Y2Nlc3NmdWwgKGdoLTQxMjYpCiAgICAgIC8vIGRhdGFGaWx0ZXIgaXMgbm90IGludm9rZWQgZm9yIGZhaWx1cmUgcmVzcG9uc2VzLCBzbyB1c2luZyBpdCBpbnN0ZWFkCiAgICAgIC8vIG9mIHRoZSBkZWZhdWx0IGNvbnZlcnRlciBpcyBrbHVkZ3kgYnV0IGl0IHdvcmtzLgogICAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICAgInRleHQgc2NyaXB0IjogZnVuY3Rpb24gKCkge30KICAgICAgfSwKICAgICAgZGF0YUZpbHRlcjogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwocmVzcG9uc2UsIG9wdGlvbnMsIGRvYyk7CiAgICAgIH0KICAgIH0pOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB3cmFwQWxsOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgd3JhcDsKICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgICAgaHRtbCA9IGh0bWwuY2FsbCh0aGlzWzBdKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgICAgd3JhcCA9IGpRdWVyeShodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQpLmVxKDApLmNsb25lKHRydWUpOwogICAgICAgIGlmICh0aGlzWzBdLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pOwogICAgICAgIH0KICAgICAgICB3cmFwLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZWxlbSA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoZWxlbS5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgICAgICAgICBlbGVtID0gZWxlbS5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtOwogICAgICAgIH0pLmFwcGVuZCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB3cmFwSW5uZXI6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGh0bWwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBJbm5lcihodG1sLmNhbGwodGhpcywgaSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzZWxmID0galF1ZXJ5KHRoaXMpLAogICAgICAgICAgY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CiAgICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCkgewogICAgICAgICAgY29udGVudHMud3JhcEFsbChodG1sKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5hcHBlbmQoaHRtbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgaHRtbElzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uKGh0bWwpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaHRtbElzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sKTsKICAgICAgfSk7CiAgICB9LAogICAgdW53cmFwOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdGhpcy5wYXJlbnQoc2VsZWN0b3IpLm5vdCgiYm9keSIpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeSh0aGlzKS5yZXBsYWNlV2l0aCh0aGlzLmNoaWxkTm9kZXMpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4cHIucHNldWRvcy5oaWRkZW4gPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuICFqUXVlcnkuZXhwci5wc2V1ZG9zLnZpc2libGUoZWxlbSk7CiAgfTsKICBqUXVlcnkuZXhwci5wc2V1ZG9zLnZpc2libGUgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuICEhKGVsZW0ub2Zmc2V0V2lkdGggfHwgZWxlbS5vZmZzZXRIZWlnaHQgfHwgZWxlbS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCk7CiAgfTsKICBqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7CiAgICB9IGNhdGNoIChlKSB7fQogIH07CiAgdmFyIHhoclN1Y2Nlc3NTdGF0dXMgPSB7CiAgICAgIC8vIEZpbGUgcHJvdG9jb2wgYWx3YXlzIHlpZWxkcyBzdGF0dXMgY29kZSAwLCBhc3N1bWUgMjAwCiAgICAgIDA6IDIwMCwKICAgICAgLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKICAgICAgLy8gdHJhYy0xNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAxMjIzOiAyMDQKICAgIH0sCiAgICB4aHJTdXBwb3J0ZWQgPSBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpOwogIHN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhoclN1cHBvcnRlZDsKICBzdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsKICBqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiAob3B0aW9ucykgewogICAgdmFyIGNhbGxiYWNrLCBlcnJvckNhbGxiYWNrOwoKICAgIC8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QKICAgIGlmIChzdXBwb3J0LmNvcnMgfHwgeGhyU3VwcG9ydGVkICYmICFvcHRpb25zLmNyb3NzRG9tYWluKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKGhlYWRlcnMsIGNvbXBsZXRlKSB7CiAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgeGhyID0gb3B0aW9ucy54aHIoKTsKICAgICAgICAgIHhoci5vcGVuKG9wdGlvbnMudHlwZSwgb3B0aW9ucy51cmwsIG9wdGlvbnMuYXN5bmMsIG9wdGlvbnMudXNlcm5hbWUsIG9wdGlvbnMucGFzc3dvcmQpOwoKICAgICAgICAgIC8vIEFwcGx5IGN1c3RvbSBmaWVsZHMgaWYgcHJvdmlkZWQKICAgICAgICAgIGlmIChvcHRpb25zLnhockZpZWxkcykgewogICAgICAgICAgICBmb3IgKGkgaW4gb3B0aW9ucy54aHJGaWVsZHMpIHsKICAgICAgICAgICAgICB4aHJbaV0gPSBvcHRpb25zLnhockZpZWxkc1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKICAgICAgICAgIGlmIChvcHRpb25zLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKSB7CiAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKG9wdGlvbnMubWltZVR5cGUpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCiAgICAgICAgICAvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCiAgICAgICAgICAvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgogICAgICAgICAgLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCiAgICAgICAgICAvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KICAgICAgICAgIGlmICghb3B0aW9ucy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdKSB7CiAgICAgICAgICAgIGhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSA9ICJYTUxIdHRwUmVxdWVzdCI7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU2V0IGhlYWRlcnMKICAgICAgICAgIGZvciAoaSBpbiBoZWFkZXJzKSB7CiAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGksIGhlYWRlcnNbaV0pOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIENhbGxiYWNrCiAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGVycm9yQ2FsbGJhY2sgPSB4aHIub25sb2FkID0geGhyLm9uZXJyb3IgPSB4aHIub25hYm9ydCA9IHhoci5vbnRpbWVvdXQgPSB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAiYWJvcnQiKSB7CiAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiZXJyb3IiKSB7CiAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CiAgICAgICAgICAgICAgICAgIC8vIE9uIGEgbWFudWFsIG5hdGl2ZSBhYm9ydCwgSUU5IHRocm93cwogICAgICAgICAgICAgICAgICAvLyBlcnJvcnMgb24gYW55IHByb3BlcnR5IGFjY2VzcyB0aGF0IGlzIG5vdCByZWFkeVN0YXRlCiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgeGhyLnN0YXR1cyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZSgwLCAiZXJyb3IiKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZSgKICAgICAgICAgICAgICAgICAgICAvLyBGaWxlOiBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyAwOyBzZWUgdHJhYy04NjA1LCB0cmFjLTE0MjA3CiAgICAgICAgICAgICAgICAgICAgeGhyLnN0YXR1cywgeGhyLnN0YXR1c1RleHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21wbGV0ZSh4aHJTdWNjZXNzU3RhdHVzW3hoci5zdGF0dXNdIHx8IHhoci5zdGF0dXMsIHhoci5zdGF0dXNUZXh0LAogICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogICAgICAgICAgICAgICAgICAvLyBJRTkgaGFzIG5vIFhIUjIgYnV0IHRocm93cyBvbiBiaW5hcnkgKHRyYWMtMTE0MjYpCiAgICAgICAgICAgICAgICAgIC8vIEZvciBYSFIyIG5vbi10ZXh0LCBsZXQgdGhlIGNhbGxlciBoYW5kbGUgaXQgKGdoLTI0OTgpCiAgICAgICAgICAgICAgICAgICh4aHIucmVzcG9uc2VUeXBlIHx8ICJ0ZXh0IikgIT09ICJ0ZXh0IiB8fCB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCAhPT0gInN0cmluZyIgPyB7CiAgICAgICAgICAgICAgICAgICAgYmluYXJ5OiB4aHIucmVzcG9uc2UKICAgICAgICAgICAgICAgICAgfSA6IHsKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB4aHIucmVzcG9uc2VUZXh0CiAgICAgICAgICAgICAgICAgIH0sIHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBMaXN0ZW4gdG8gZXZlbnRzCiAgICAgICAgICB4aHIub25sb2FkID0gY2FsbGJhY2soKTsKICAgICAgICAgIGVycm9yQ2FsbGJhY2sgPSB4aHIub25lcnJvciA9IHhoci5vbnRpbWVvdXQgPSBjYWxsYmFjaygiZXJyb3IiKTsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA5IG9ubHkKICAgICAgICAgIC8vIFVzZSBvbnJlYWR5c3RhdGVjaGFuZ2UgdG8gcmVwbGFjZSBvbmFib3J0CiAgICAgICAgICAvLyB0byBoYW5kbGUgdW5jYXVnaHQgYWJvcnRzCiAgICAgICAgICBpZiAoeGhyLm9uYWJvcnQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB4aHIub25hYm9ydCA9IGVycm9yQ2FsbGJhY2s7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIC8vIENoZWNrIHJlYWR5U3RhdGUgYmVmb3JlIHRpbWVvdXQgYXMgaXQgY2hhbmdlcwogICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgICAgICAgICAgLy8gQWxsb3cgb25lcnJvciB0byBiZSBjYWxsZWQgZmlyc3QsCiAgICAgICAgICAgICAgICAvLyBidXQgdGhhdCB3aWxsIG5vdCBoYW5kbGUgYSBuYXRpdmUgYWJvcnQKICAgICAgICAgICAgICAgIC8vIEFsc28sIHNhdmUgZXJyb3JDYWxsYmFjayB0byBhIHZhcmlhYmxlCiAgICAgICAgICAgICAgICAvLyBhcyB4aHIub25lcnJvciBjYW5ub3QgYmUgYWNjZXNzZWQKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ3JlYXRlIHRoZSBhYm9ydCBjYWxsYmFjawogICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjaygiYWJvcnQiKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIERvIHNlbmQgdGhlIHJlcXVlc3QgKHRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbikKICAgICAgICAgICAgeGhyLnNlbmQob3B0aW9ucy5oYXNDb250ZW50ICYmIG9wdGlvbnMuZGF0YSB8fCBudWxsKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gdHJhYy0xNDY4MzogT25seSByZXRocm93IGlmIHRoaXMgaGFzbid0IGJlZW4gbm90aWZpZWQgYXMgYW4gZXJyb3IgeWV0CiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFib3J0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIFByZXZlbnQgYXV0by1leGVjdXRpb24gb2Ygc2NyaXB0cyB3aGVuIG5vIGV4cGxpY2l0IGRhdGFUeXBlIHdhcyBwcm92aWRlZCAoU2VlIGdoLTI0MzIpCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoZnVuY3Rpb24gKHMpIHsKICAgIGlmIChzLmNyb3NzRG9tYWluKSB7CiAgICAgIHMuY29udGVudHMuc2NyaXB0ID0gZmFsc2U7CiAgICB9CiAgfSk7CgogIC8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBhY2NlcHRzOiB7CiAgICAgIHNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgIiArICJhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCiAgICB9LAogICAgY29udGVudHM6IHsKICAgICAgc2NyaXB0OiAvXGIoPzpqYXZhfGVjbWEpc2NyaXB0XGIvCiAgICB9LAogICAgY29udmVydGVyczogewogICAgICAidGV4dCBzY3JpcHQiOiBmdW5jdGlvbiAodGV4dCkgewogICAgICAgIGpRdWVyeS5nbG9iYWxFdmFsKHRleHQpOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgY3Jvc3NEb21haW4KICBqUXVlcnkuYWpheFByZWZpbHRlcigic2NyaXB0IiwgZnVuY3Rpb24gKHMpIHsKICAgIGlmIChzLmNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgcy5jYWNoZSA9IGZhbHNlOwogICAgfQogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgcy50eXBlID0gIkdFVCI7CiAgICB9CiAgfSk7CgogIC8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydAogIGpRdWVyeS5hamF4VHJhbnNwb3J0KCJzY3JpcHQiLCBmdW5jdGlvbiAocykgewogICAgLy8gVGhpcyB0cmFuc3BvcnQgb25seSBkZWFscyB3aXRoIGNyb3NzIGRvbWFpbiBvciBmb3JjZWQtYnktYXR0cnMgcmVxdWVzdHMKICAgIGlmIChzLmNyb3NzRG9tYWluIHx8IHMuc2NyaXB0QXR0cnMpIHsKICAgICAgdmFyIHNjcmlwdCwgY2FsbGJhY2s7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKF8sIGNvbXBsZXRlKSB7CiAgICAgICAgICBzY3JpcHQgPSBqUXVlcnkoIjxzY3JpcHQ+IikuYXR0cihzLnNjcmlwdEF0dHJzIHx8IHt9KS5wcm9wKHsKICAgICAgICAgICAgY2hhcnNldDogcy5zY3JpcHRDaGFyc2V0LAogICAgICAgICAgICBzcmM6IHMudXJsCiAgICAgICAgICB9KS5vbigibG9hZCBlcnJvciIsIGNhbGxiYWNrID0gZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICBzY3JpcHQucmVtb3ZlKCk7CiAgICAgICAgICAgIGNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgaWYgKGV2dCkgewogICAgICAgICAgICAgIGNvbXBsZXRlKGV2dC50eXBlID09PSAiZXJyb3IiID8gNDA0IDogMjAwLCBldnQudHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIFVzZSBuYXRpdmUgRE9NIG1hbmlwdWxhdGlvbiB0byBhdm9pZCBvdXIgZG9tTWFuaXAgQUpBWCB0cmlja2VyeQogICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHRbMF0pOwogICAgICAgIH0sCiAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKICB2YXIgb2xkQ2FsbGJhY2tzID0gW10sCiAgICByanNvbnAgPSAvKD0pXD8oPz0mfCQpfFw/XD8vOwoKICAvLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBqc29ucDogImNhbGxiYWNrIiwKICAgIGpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8IGpRdWVyeS5leHBhbmRvICsgIl8iICsgbm9uY2UuZ3VpZCsrOwogICAgICB0aGlzW2NhbGxiYWNrXSA9IHRydWU7CiAgICAgIHJldHVybiBjYWxsYmFjazsKICAgIH0KICB9KTsKCiAgLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoImpzb24ganNvbnAiLCBmdW5jdGlvbiAocywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIpIHsKICAgIHZhciBjYWxsYmFja05hbWUsCiAgICAgIG92ZXJ3cml0dGVuLAogICAgICByZXNwb25zZUNvbnRhaW5lciwKICAgICAganNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAocmpzb25wLnRlc3Qocy51cmwpID8gInVybCIgOiB0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJiAocy5jb250ZW50VHlwZSB8fCAiIikuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgPT09IDAgJiYgcmpzb25wLnRlc3Qocy5kYXRhKSAmJiAiZGF0YSIpOwoKICAgIC8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0CiAgICBpZiAoanNvblByb3AgfHwgcy5kYXRhVHlwZXNbMF0gPT09ICJqc29ucCIpIHsKICAgICAgLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAogICAgICBjYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBpc0Z1bmN0aW9uKHMuanNvbnBDYWxsYmFjaykgPyBzLmpzb25wQ2FsbGJhY2soKSA6IHMuanNvbnBDYWxsYmFjazsKCiAgICAgIC8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKICAgICAgaWYgKGpzb25Qcm9wKSB7CiAgICAgICAgc1tqc29uUHJvcF0gPSBzW2pzb25Qcm9wXS5yZXBsYWNlKHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSk7CiAgICAgIH0gZWxzZSBpZiAocy5qc29ucCAhPT0gZmFsc2UpIHsKICAgICAgICBzLnVybCArPSAocnF1ZXJ5LnRlc3Qocy51cmwpID8gIiYiIDogIj8iKSArIHMuanNvbnAgKyAiPSIgKyBjYWxsYmFja05hbWU7CiAgICAgIH0KCiAgICAgIC8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KICAgICAgcy5jb252ZXJ0ZXJzWyJzY3JpcHQganNvbiJdID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghcmVzcG9uc2VDb250YWluZXIpIHsKICAgICAgICAgIGpRdWVyeS5lcnJvcihjYWxsYmFja05hbWUgKyAiIHdhcyBub3QgY2FsbGVkIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNwb25zZUNvbnRhaW5lclswXTsKICAgICAgfTsKCiAgICAgIC8vIEZvcmNlIGpzb24gZGF0YVR5cGUKICAgICAgcy5kYXRhVHlwZXNbMF0gPSAianNvbiI7CgogICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrCiAgICAgIG92ZXJ3cml0dGVuID0gd2luZG93W2NhbGxiYWNrTmFtZV07CiAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwogICAgICB9OwoKICAgICAgLy8gQ2xlYW4tdXAgZnVuY3Rpb24gKGZpcmVzIGFmdGVyIGNvbnZlcnRlcnMpCiAgICAgIGpxWEhSLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gSWYgcHJldmlvdXMgdmFsdWUgZGlkbid0IGV4aXN0IC0gcmVtb3ZlIGl0CiAgICAgICAgaWYgKG92ZXJ3cml0dGVuID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGpRdWVyeSh3aW5kb3cpLnJlbW92ZVByb3AoY2FsbGJhY2tOYW1lKTsKCiAgICAgICAgICAvLyBPdGhlcndpc2UgcmVzdG9yZSBwcmVleGlzdGluZyB2YWx1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IG92ZXJ3cml0dGVuOwogICAgICAgIH0KCiAgICAgICAgLy8gU2F2ZSBiYWNrIGFzIGZyZWUKICAgICAgICBpZiAoc1tjYWxsYmFja05hbWVdKSB7CiAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCByZS11c2luZyB0aGUgb3B0aW9ucyBkb2Vzbid0IHNjcmV3IHRoaW5ncyBhcm91bmQKICAgICAgICAgIHMuanNvbnBDYWxsYmFjayA9IG9yaWdpbmFsU2V0dGluZ3MuanNvbnBDYWxsYmFjazsKCiAgICAgICAgICAvLyBTYXZlIHRoZSBjYWxsYmFjayBuYW1lIGZvciBmdXR1cmUgdXNlCiAgICAgICAgICBvbGRDYWxsYmFja3MucHVzaChjYWxsYmFja05hbWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCiAgICAgICAgaWYgKHJlc3BvbnNlQ29udGFpbmVyICYmIGlzRnVuY3Rpb24ob3ZlcndyaXR0ZW4pKSB7CiAgICAgICAgICBvdmVyd3JpdHRlbihyZXNwb25zZUNvbnRhaW5lclswXSk7CiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CiAgICAgIH0pOwoKICAgICAgLy8gRGVsZWdhdGUgdG8gc2NyaXB0CiAgICAgIHJldHVybiAic2NyaXB0IjsKICAgIH0KICB9KTsKCiAgLy8gU3VwcG9ydDogU2FmYXJpIDggb25seQogIC8vIEluIFNhZmFyaSA4IGRvY3VtZW50cyBjcmVhdGVkIHZpYSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQKICAvLyBjb2xsYXBzZSBzaWJsaW5nIGZvcm1zOiB0aGUgc2Vjb25kIG9uZSBiZWNvbWVzIGEgY2hpbGQgb2YgdGhlIGZpcnN0IG9uZS4KICAvLyBCZWNhdXNlIG9mIHRoYXQsIHRoaXMgc2VjdXJpdHkgbWVhc3VyZSBoYXMgdG8gYmUgZGlzYWJsZWQgaW4gU2FmYXJpIDguCiAgLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNzMzNwogIHN1cHBvcnQuY3JlYXRlSFRNTERvY3VtZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJvZHkgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoIiIpLmJvZHk7CiAgICBib2R5LmlubmVySFRNTCA9ICI8Zm9ybT48L2Zvcm0+PGZvcm0+PC9mb3JtPiI7CiAgICByZXR1cm4gYm9keS5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMjsKICB9KCk7CgogIC8vIEFyZ3VtZW50ICJkYXRhIiBzaG91bGQgYmUgc3RyaW5nIG9mIGh0bWwKICAvLyBjb250ZXh0IChvcHRpb25hbCk6IElmIHNwZWNpZmllZCwgdGhlIGZyYWdtZW50IHdpbGwgYmUgY3JlYXRlZCBpbiB0aGlzIGNvbnRleHQsCiAgLy8gZGVmYXVsdHMgdG8gZG9jdW1lbnQKICAvLyBrZWVwU2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nCiAgalF1ZXJ5LnBhcnNlSFRNTCA9IGZ1bmN0aW9uIChkYXRhLCBjb250ZXh0LCBrZWVwU2NyaXB0cykgewogICAgaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICJib29sZWFuIikgewogICAgICBrZWVwU2NyaXB0cyA9IGNvbnRleHQ7CiAgICAgIGNvbnRleHQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBiYXNlLCBwYXJzZWQsIHNjcmlwdHM7CiAgICBpZiAoIWNvbnRleHQpIHsKICAgICAgLy8gU3RvcCBzY3JpcHRzIG9yIGlubGluZSBldmVudCBoYW5kbGVycyBmcm9tIGJlaW5nIGV4ZWN1dGVkIGltbWVkaWF0ZWx5CiAgICAgIC8vIGJ5IHVzaW5nIGRvY3VtZW50LmltcGxlbWVudGF0aW9uCiAgICAgIGlmIChzdXBwb3J0LmNyZWF0ZUhUTUxEb2N1bWVudCkgewogICAgICAgIGNvbnRleHQgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoIiIpOwoKICAgICAgICAvLyBTZXQgdGhlIGJhc2UgaHJlZiBmb3IgdGhlIGNyZWF0ZWQgZG9jdW1lbnQKICAgICAgICAvLyBzbyBhbnkgcGFyc2VkIGVsZW1lbnRzIHdpdGggVVJMcwogICAgICAgIC8vIGFyZSBiYXNlZCBvbiB0aGUgZG9jdW1lbnQncyBVUkwgKGdoLTI5NjUpCiAgICAgICAgYmFzZSA9IGNvbnRleHQuY3JlYXRlRWxlbWVudCgiYmFzZSIpOwogICAgICAgIGJhc2UuaHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgY29udGV4dC5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRleHQgPSBkb2N1bWVudDsKICAgICAgfQogICAgfQogICAgcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKGRhdGEpOwogICAgc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCiAgICAvLyBTaW5nbGUgdGFnCiAgICBpZiAocGFyc2VkKSB7CiAgICAgIHJldHVybiBbY29udGV4dC5jcmVhdGVFbGVtZW50KHBhcnNlZFsxXSldOwogICAgfQogICAgcGFyc2VkID0gYnVpbGRGcmFnbWVudChbZGF0YV0sIGNvbnRleHQsIHNjcmlwdHMpOwogICAgaWYgKHNjcmlwdHMgJiYgc2NyaXB0cy5sZW5ndGgpIHsKICAgICAgalF1ZXJ5KHNjcmlwdHMpLnJlbW92ZSgpOwogICAgfQogICAgcmV0dXJuIGpRdWVyeS5tZXJnZShbXSwgcGFyc2VkLmNoaWxkTm9kZXMpOwogIH07CgogIC8qKgogICAqIExvYWQgYSB1cmwgaW50byBhIHBhZ2UKICAgKi8KICBqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uICh1cmwsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgIHZhciBzZWxlY3RvciwKICAgICAgdHlwZSwKICAgICAgcmVzcG9uc2UsCiAgICAgIHNlbGYgPSB0aGlzLAogICAgICBvZmYgPSB1cmwuaW5kZXhPZigiICIpOwogICAgaWYgKG9mZiA+IC0xKSB7CiAgICAgIHNlbGVjdG9yID0gc3RyaXBBbmRDb2xsYXBzZSh1cmwuc2xpY2Uob2ZmKSk7CiAgICAgIHVybCA9IHVybC5zbGljZSgwLCBvZmYpOwogICAgfQoKICAgIC8vIElmIGl0J3MgYSBmdW5jdGlvbgogICAgaWYgKGlzRnVuY3Rpb24ocGFyYW1zKSkgewogICAgICAvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawogICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgcGFyYW1zID0gdW5kZWZpbmVkOwoKICAgICAgLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwogICAgfSBlbHNlIGlmIChwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIpIHsKICAgICAgdHlwZSA9ICJQT1NUIjsKICAgIH0KCiAgICAvLyBJZiB3ZSBoYXZlIGVsZW1lbnRzIHRvIG1vZGlmeSwgbWFrZSB0aGUgcmVxdWVzdAogICAgaWYgKHNlbGYubGVuZ3RoID4gMCkgewogICAgICBqUXVlcnkuYWpheCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgLy8gSWYgInR5cGUiIHZhcmlhYmxlIGlzIHVuZGVmaW5lZCwgdGhlbiAiR0VUIiBtZXRob2Qgd2lsbCBiZSB1c2VkLgogICAgICAgIC8vIE1ha2UgdmFsdWUgb2YgdGhpcyBmaWVsZCBleHBsaWNpdCBzaW5jZQogICAgICAgIC8vIHVzZXIgY2FuIG92ZXJyaWRlIGl0IHRocm91Z2ggYWpheFNldHVwIG1ldGhvZAogICAgICAgIHR5cGU6IHR5cGUgfHwgIkdFVCIsCiAgICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgICBkYXRhOiBwYXJhbXMKICAgICAgfSkuZG9uZShmdW5jdGlvbiAocmVzcG9uc2VUZXh0KSB7CiAgICAgICAgLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCiAgICAgICAgcmVzcG9uc2UgPSBhcmd1bWVudHM7CiAgICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYKICAgICAgICAvLyBFeGNsdWRlIHNjcmlwdHMgdG8gYXZvaWQgSUUgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMKICAgICAgICBqUXVlcnkoIjxkaXY+IikuYXBwZW5kKGpRdWVyeS5wYXJzZUhUTUwocmVzcG9uc2VUZXh0KSkuZmluZChzZWxlY3RvcikgOgogICAgICAgIC8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CiAgICAgICAgcmVzcG9uc2VUZXh0KTsKCiAgICAgICAgLy8gSWYgdGhlIHJlcXVlc3Qgc3VjY2VlZHMsIHRoaXMgZnVuY3Rpb24gZ2V0cyAiZGF0YSIsICJzdGF0dXMiLCAianFYSFIiCiAgICAgICAgLy8gYnV0IHRoZXkgYXJlIGlnbm9yZWQgYmVjYXVzZSByZXNwb25zZSB3YXMgc2V0IGFib3ZlLgogICAgICAgIC8vIElmIGl0IGZhaWxzLCB0aGlzIGZ1bmN0aW9uIGdldHMgImpxWEhSIiwgInN0YXR1cyIsICJlcnJvciIKICAgICAgfSkuYWx3YXlzKGNhbGxiYWNrICYmIGZ1bmN0aW9uIChqcVhIUiwgc3RhdHVzKSB7CiAgICAgICAgc2VsZi5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIHJlc3BvbnNlIHx8IFtqcVhIUi5yZXNwb25zZVRleHQsIHN0YXR1cywganFYSFJdKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGpRdWVyeS5leHByLnBzZXVkb3MuYW5pbWF0ZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKICAgIH0pLmxlbmd0aDsKICB9OwogIGpRdWVyeS5vZmZzZXQgPSB7CiAgICBzZXRPZmZzZXQ6IGZ1bmN0aW9uIChlbGVtLCBvcHRpb25zLCBpKSB7CiAgICAgIHZhciBjdXJQb3NpdGlvbiwKICAgICAgICBjdXJMZWZ0LAogICAgICAgIGN1ckNTU1RvcCwKICAgICAgICBjdXJUb3AsCiAgICAgICAgY3VyT2Zmc2V0LAogICAgICAgIGN1ckNTU0xlZnQsCiAgICAgICAgY2FsY3VsYXRlUG9zaXRpb24sCiAgICAgICAgcG9zaXRpb24gPSBqUXVlcnkuY3NzKGVsZW0sICJwb3NpdGlvbiIpLAogICAgICAgIGN1ckVsZW0gPSBqUXVlcnkoZWxlbSksCiAgICAgICAgcHJvcHMgPSB7fTsKCiAgICAgIC8vIFNldCBwb3NpdGlvbiBmaXJzdCwgaW4tY2FzZSB0b3AvbGVmdCBhcmUgc2V0IGV2ZW4gb24gc3RhdGljIGVsZW0KICAgICAgaWYgKHBvc2l0aW9uID09PSAic3RhdGljIikgewogICAgICAgIGVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICB9CiAgICAgIGN1ck9mZnNldCA9IGN1ckVsZW0ub2Zmc2V0KCk7CiAgICAgIGN1ckNTU1RvcCA9IGpRdWVyeS5jc3MoZWxlbSwgInRvcCIpOwogICAgICBjdXJDU1NMZWZ0ID0galF1ZXJ5LmNzcyhlbGVtLCAibGVmdCIpOwogICAgICBjYWxjdWxhdGVQb3NpdGlvbiA9IChwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIikgJiYgKGN1ckNTU1RvcCArIGN1ckNTU0xlZnQpLmluZGV4T2YoImF1dG8iKSA+IC0xOwoKICAgICAgLy8gTmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIKICAgICAgLy8gdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICAgIGlmIChjYWxjdWxhdGVQb3NpdGlvbikgewogICAgICAgIGN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwogICAgICAgIGN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKICAgICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJUb3AgPSBwYXJzZUZsb2F0KGN1ckNTU1RvcCkgfHwgMDsKICAgICAgICBjdXJMZWZ0ID0gcGFyc2VGbG9hdChjdXJDU1NMZWZ0KSB8fCAwOwogICAgICB9CiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMpKSB7CiAgICAgICAgLy8gVXNlIGpRdWVyeS5leHRlbmQgaGVyZSB0byBhbGxvdyBtb2RpZmljYXRpb24gb2YgY29vcmRpbmF0ZXMgYXJndW1lbnQgKGdoLTE4NDgpCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuY2FsbChlbGVtLCBpLCBqUXVlcnkuZXh0ZW5kKHt9LCBjdXJPZmZzZXQpKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50b3AgIT0gbnVsbCkgewogICAgICAgIHByb3BzLnRvcCA9IG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCArIGN1clRvcDsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5sZWZ0ICE9IG51bGwpIHsKICAgICAgICBwcm9wcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKyBjdXJMZWZ0OwogICAgICB9CiAgICAgIGlmICgidXNpbmciIGluIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zLnVzaW5nLmNhbGwoZWxlbSwgcHJvcHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGN1ckVsZW0uY3NzKHByb3BzKTsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAvLyBvZmZzZXQoKSByZWxhdGVzIGFuIGVsZW1lbnQncyBib3JkZXIgYm94IHRvIHRoZSBkb2N1bWVudCBvcmlnaW4KICAgIG9mZnNldDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgLy8gUHJlc2VydmUgY2hhaW5pbmcgZm9yIHNldHRlcgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBvcHRpb25zID09PSB1bmRlZmluZWQgPyB0aGlzIDogdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkub2Zmc2V0LnNldE9mZnNldCh0aGlzLCBvcHRpb25zLCBpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgcmVjdCwKICAgICAgICB3aW4sCiAgICAgICAgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmICghZWxlbSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gUmV0dXJuIHplcm9zIGZvciBkaXNjb25uZWN0ZWQgYW5kIGhpZGRlbiAoZGlzcGxheTogbm9uZSkgZWxlbWVudHMgKGdoLTIzMTApCiAgICAgIC8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQogICAgICAvLyBSdW5uaW5nIGdldEJvdW5kaW5nQ2xpZW50UmVjdCBvbiBhCiAgICAgIC8vIGRpc2Nvbm5lY3RlZCBub2RlIGluIElFIHRocm93cyBhbiBlcnJvcgogICAgICBpZiAoIWVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8vIEdldCBkb2N1bWVudC1yZWxhdGl2ZSBwb3NpdGlvbiBieSBhZGRpbmcgdmlld3BvcnQgc2Nyb2xsIHRvIHZpZXdwb3J0LXJlbGF0aXZlIGdCQ1IKICAgICAgcmVjdCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHdpbiA9IGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldzsKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IHJlY3QudG9wICsgd2luLnBhZ2VZT2Zmc2V0LAogICAgICAgIGxlZnQ6IHJlY3QubGVmdCArIHdpbi5wYWdlWE9mZnNldAogICAgICB9OwogICAgfSwKICAgIC8vIHBvc2l0aW9uKCkgcmVsYXRlcyBhbiBlbGVtZW50J3MgbWFyZ2luIGJveCB0byBpdHMgb2Zmc2V0IHBhcmVudCdzIHBhZGRpbmcgYm94CiAgICAvLyBUaGlzIGNvcnJlc3BvbmRzIHRvIHRoZSBiZWhhdmlvciBvZiBDU1MgYWJzb2x1dGUgcG9zaXRpb25pbmcKICAgIHBvc2l0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpc1swXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb2Zmc2V0UGFyZW50LAogICAgICAgIG9mZnNldCwKICAgICAgICBkb2MsCiAgICAgICAgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgcGFyZW50T2Zmc2V0ID0gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH07CgogICAgICAvLyBwb3NpdGlvbjpmaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gdGhlIHZpZXdwb3J0LCB3aGljaCBpdHNlbGYgYWx3YXlzIGhhcyB6ZXJvIG9mZnNldAogICAgICBpZiAoalF1ZXJ5LmNzcyhlbGVtLCAicG9zaXRpb24iKSA9PT0gImZpeGVkIikgewogICAgICAgIC8vIEFzc3VtZSBwb3NpdGlvbjpmaXhlZCBpbXBsaWVzIGF2YWlsYWJpbGl0eSBvZiBnZXRCb3VuZGluZ0NsaWVudFJlY3QKICAgICAgICBvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICB9IGVsc2UgewogICAgICAgIG9mZnNldCA9IHRoaXMub2Zmc2V0KCk7CgogICAgICAgIC8vIEFjY291bnQgZm9yIHRoZSAqcmVhbCogb2Zmc2V0IHBhcmVudCwgd2hpY2ggY2FuIGJlIHRoZSBkb2N1bWVudCBvciBpdHMgcm9vdCBlbGVtZW50CiAgICAgICAgLy8gd2hlbiBhIHN0YXRpY2FsbHkgcG9zaXRpb25lZCBlbGVtZW50IGlzIGlkZW50aWZpZWQKICAgICAgICBkb2MgPSBlbGVtLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQgfHwgZG9jLmRvY3VtZW50RWxlbWVudDsKICAgICAgICB3aGlsZSAob2Zmc2V0UGFyZW50ICYmIChvZmZzZXRQYXJlbnQgPT09IGRvYy5ib2R5IHx8IG9mZnNldFBhcmVudCA9PT0gZG9jLmRvY3VtZW50RWxlbWVudCkgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikgewogICAgICAgICAgb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50LnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIGlmIChvZmZzZXRQYXJlbnQgJiYgb2Zmc2V0UGFyZW50ICE9PSBlbGVtICYmIG9mZnNldFBhcmVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgLy8gSW5jb3Jwb3JhdGUgYm9yZGVycyBpbnRvIGl0cyBvZmZzZXQsIHNpbmNlIHRoZXkgYXJlIG91dHNpZGUgaXRzIGNvbnRlbnQgb3JpZ2luCiAgICAgICAgICBwYXJlbnRPZmZzZXQgPSBqUXVlcnkob2Zmc2V0UGFyZW50KS5vZmZzZXQoKTsKICAgICAgICAgIHBhcmVudE9mZnNldC50b3AgKz0galF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJib3JkZXJUb3BXaWR0aCIsIHRydWUpOwogICAgICAgICAgcGFyZW50T2Zmc2V0LmxlZnQgKz0galF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFN1YnRyYWN0IHBhcmVudCBvZmZzZXRzIGFuZCBlbGVtZW50IG1hcmdpbnMKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IG9mZnNldC50b3AgLSBwYXJlbnRPZmZzZXQudG9wIC0galF1ZXJ5LmNzcyhlbGVtLCAibWFyZ2luVG9wIiwgdHJ1ZSksCiAgICAgICAgbGVmdDogb2Zmc2V0LmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdCAtIGpRdWVyeS5jc3MoZWxlbSwgIm1hcmdpbkxlZnQiLCB0cnVlKQogICAgICB9OwogICAgfSwKICAgIC8vIFRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGRvY3VtZW50RWxlbWVudCBpbiB0aGUgZm9sbG93aW5nIGNhc2VzOgogICAgLy8gMSkgRm9yIHRoZSBlbGVtZW50IGluc2lkZSB0aGUgaWZyYW1lIHdpdGhvdXQgb2Zmc2V0UGFyZW50LCB0aGlzIG1ldGhvZCB3aWxsIHJldHVybgogICAgLy8gICAgZG9jdW1lbnRFbGVtZW50IG9mIHRoZSBwYXJlbnQgd2luZG93CiAgICAvLyAyKSBGb3IgdGhlIGhpZGRlbiBvciBkZXRhY2hlZCBlbGVtZW50CiAgICAvLyAzKSBGb3IgYm9keSBvciBodG1sIGVsZW1lbnQsIGkuZS4gaW4gY2FzZSBvZiB0aGUgaHRtbCBub2RlIC0gaXQgd2lsbCByZXR1cm4gaXRzZWxmCiAgICAvLwogICAgLy8gYnV0IHRob3NlIGV4Y2VwdGlvbnMgd2VyZSBuZXZlciBwcmVzZW50ZWQgYXMgYSByZWFsIGxpZmUgdXNlLWNhc2VzCiAgICAvLyBhbmQgbWlnaHQgYmUgY29uc2lkZXJlZCBhcyBtb3JlIHByZWZlcmFibGUgcmVzdWx0cy4KICAgIC8vCiAgICAvLyBUaGlzIGxvZ2ljLCBob3dldmVyLCBpcyBub3QgZ3VhcmFudGVlZCBhbmQgY2FuIGNoYW5nZSBhdCBhbnkgcG9pbnQgaW4gdGhlIGZ1dHVyZQogICAgb2Zmc2V0UGFyZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50OwogICAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikgewogICAgICAgICAgb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudEVsZW1lbnQ7CiAgICAgIH0pOwogICAgfQogIH0pOwoKICAvLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKICBqUXVlcnkuZWFjaCh7CiAgICBzY3JvbGxMZWZ0OiAicGFnZVhPZmZzZXQiLAogICAgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQiCiAgfSwgZnVuY3Rpb24gKG1ldGhvZCwgcHJvcCkgewogICAgdmFyIHRvcCA9ICJwYWdlWU9mZnNldCIgPT09IHByb3A7CiAgICBqUXVlcnkuZm5bbWV0aG9kXSA9IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgbWV0aG9kLCB2YWwpIHsKICAgICAgICAvLyBDb2FsZXNjZSBkb2N1bWVudHMgYW5kIHdpbmRvd3MKICAgICAgICB2YXIgd2luOwogICAgICAgIGlmIChpc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgd2luID0gZWxlbTsKICAgICAgICB9IGVsc2UgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgIHdpbiA9IGVsZW0uZGVmYXVsdFZpZXc7CiAgICAgICAgfQogICAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHdpbiA/IHdpbltwcm9wXSA6IGVsZW1bbWV0aG9kXTsKICAgICAgICB9CiAgICAgICAgaWYgKHdpbikgewogICAgICAgICAgd2luLnNjcm9sbFRvKCF0b3AgPyB2YWwgOiB3aW4ucGFnZVhPZmZzZXQsIHRvcCA/IHZhbCA6IHdpbi5wYWdlWU9mZnNldCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1bbWV0aG9kXSA9IHZhbDsKICAgICAgICB9CiAgICAgIH0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH07CiAgfSk7CgogIC8vIFN1cHBvcnQ6IFNhZmFyaSA8PTcgLSA5LjEsIENocm9tZSA8PTM3IC0gNDkKICAvLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgogIC8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NAogIC8vIEJsaW5rIGJ1ZzogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NTg5MzQ3CiAgLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodDsKICAvLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwganVzdCBjaGVjayBmb3IgaXQgaGVyZQogIGpRdWVyeS5lYWNoKFsidG9wIiwgImxlZnQiXSwgZnVuY3Rpb24gKF9pLCBwcm9wKSB7CiAgICBqUXVlcnkuY3NzSG9va3NbcHJvcF0gPSBhZGRHZXRIb29rSWYoc3VwcG9ydC5waXhlbFBvc2l0aW9uLCBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgY29tcHV0ZWQgPSBjdXJDU1MoZWxlbSwgcHJvcCk7CgogICAgICAgIC8vIElmIGN1ckNTUyByZXR1cm5zIHBlcmNlbnRhZ2UsIGZhbGxiYWNrIHRvIG9mZnNldAogICAgICAgIHJldHVybiBybnVtbm9ucHgudGVzdChjb21wdXRlZCkgPyBqUXVlcnkoZWxlbSkucG9zaXRpb24oKVtwcm9wXSArICJweCIgOiBjb21wdXRlZDsKICAgICAgfQogICAgfSk7CiAgfSk7CgogIC8vIENyZWF0ZSBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCwgaGVpZ2h0LCB3aWR0aCwgb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGggbWV0aG9kcwogIGpRdWVyeS5lYWNoKHsKICAgIEhlaWdodDogImhlaWdodCIsCiAgICBXaWR0aDogIndpZHRoIgogIH0sIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICBqUXVlcnkuZWFjaCh7CiAgICAgIHBhZGRpbmc6ICJpbm5lciIgKyBuYW1lLAogICAgICBjb250ZW50OiB0eXBlLAogICAgICAiIjogIm91dGVyIiArIG5hbWUKICAgIH0sIGZ1bmN0aW9uIChkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lKSB7CiAgICAgIC8vIE1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAogICAgICBqUXVlcnkuZm5bZnVuY05hbWVdID0gZnVuY3Rpb24gKG1hcmdpbiwgdmFsdWUpIHsKICAgICAgICB2YXIgY2hhaW5hYmxlID0gYXJndW1lbnRzLmxlbmd0aCAmJiAoZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICJib29sZWFuIiksCiAgICAgICAgICBleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAobWFyZ2luID09PSB0cnVlIHx8IHZhbHVlID09PSB0cnVlID8gIm1hcmdpbiIgOiAiYm9yZGVyIik7CiAgICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBkb2M7CiAgICAgICAgICBpZiAoaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgICAgLy8gJCggd2luZG93ICkub3V0ZXJXaWR0aC9IZWlnaHQgcmV0dXJuIHcvaCBpbmNsdWRpbmcgc2Nyb2xsYmFycyAoZ2gtMTcyOSkKICAgICAgICAgICAgcmV0dXJuIGZ1bmNOYW1lLmluZGV4T2YoIm91dGVyIikgPT09IDAgPyBlbGVtWyJpbm5lciIgKyBuYW1lXSA6IGVsZW0uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgbmFtZV07CiAgICAgICAgICB9CgogICAgICAgICAgLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7CgogICAgICAgICAgICAvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0gb3IgY2xpZW50W1dpZHRoL0hlaWdodF0sCiAgICAgICAgICAgIC8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoZWxlbS5ib2R5WyJzY3JvbGwiICsgbmFtZV0sIGRvY1sic2Nyb2xsIiArIG5hbWVdLCBlbGVtLmJvZHlbIm9mZnNldCIgKyBuYW1lXSwgZG9jWyJvZmZzZXQiICsgbmFtZV0sIGRvY1siY2xpZW50IiArIG5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KICAgICAgICAgIC8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQsIHJlcXVlc3RpbmcgYnV0IG5vdCBmb3JjaW5nIHBhcnNlRmxvYXQKICAgICAgICAgIGpRdWVyeS5jc3MoZWxlbSwgdHlwZSwgZXh0cmEpIDoKICAgICAgICAgIC8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEpOwogICAgICAgIH0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlKTsKICAgICAgfTsKICAgIH0pOwogIH0pOwogIGpRdWVyeS5lYWNoKFsiYWpheFN0YXJ0IiwgImFqYXhTdG9wIiwgImFqYXhDb21wbGV0ZSIsICJhamF4RXJyb3IiLCAiYWpheFN1Y2Nlc3MiLCAiYWpheFNlbmQiXSwgZnVuY3Rpb24gKF9pLCB0eXBlKSB7CiAgICBqUXVlcnkuZm5bdHlwZV0gPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub24odHlwZSwgZm4pOwogICAgfTsKICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZGF0YSwgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub24odHlwZXMsIG51bGwsIGRhdGEsIGZuKTsKICAgIH0sCiAgICB1bmJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub2ZmKHR5cGVzLCBudWxsLCBmbik7CiAgICB9LAogICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4pOwogICAgfSwKICAgIHVuZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGZuKSB7CiAgICAgIC8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyB0aGlzLm9mZihzZWxlY3RvciwgIioqIikgOiB0aGlzLm9mZih0eXBlcywgc2VsZWN0b3IgfHwgIioqIiwgZm4pOwogICAgfSwKICAgIGhvdmVyOiBmdW5jdGlvbiAoZm5PdmVyLCBmbk91dCkgewogICAgICByZXR1cm4gdGhpcy5vbigibW91c2VlbnRlciIsIGZuT3Zlcikub24oIm1vdXNlbGVhdmUiLCBmbk91dCB8fCBmbk92ZXIpOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKCgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IHJlc2l6ZSBzY3JvbGwgY2xpY2sgZGJsY2xpY2sgIiArICJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsgImNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgY29udGV4dG1lbnUiKS5zcGxpdCgiICIpLCBmdW5jdGlvbiAoX2ksIG5hbWUpIHsKICAgIC8vIEhhbmRsZSBldmVudCBiaW5kaW5nCiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAoZGF0YSwgZm4pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8gdGhpcy5vbihuYW1lLCBudWxsLCBkYXRhLCBmbikgOiB0aGlzLnRyaWdnZXIobmFtZSk7CiAgICB9OwogIH0pOwoKICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHkKICAvLyBNYWtlIHN1cmUgd2UgdHJpbSBCT00gYW5kIE5CU1AKICAvLyBSZXF1aXJlIHRoYXQgdGhlICJ3aGl0ZXNwYWNlIHJ1biIgc3RhcnRzIGZyb20gYSBub24td2hpdGVzcGFjZQogIC8vIHRvIGF2b2lkIE8oTl4yKSBiZWhhdmlvciB3aGVuIHRoZSBlbmdpbmUgd291bGQgdHJ5IG1hdGNoaW5nICJccyskIiBhdCBlYWNoIHNwYWNlIHBvc2l0aW9uLgogIHZhciBydHJpbSA9IC9eW1xzXHVGRUZGXHhBMF0rfChbXlxzXHVGRUZGXHhBMF0pW1xzXHVGRUZGXHhBMF0rJC9nOwoKICAvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKICAvLyBhcmd1bWVudHMuCiAgLy8galF1ZXJ5LnByb3h5IGlzIGRlcHJlY2F0ZWQgdG8gcHJvbW90ZSBzdGFuZGFyZHMgKHNwZWNpZmljYWxseSBGdW5jdGlvbiNiaW5kKQogIC8vIEhvd2V2ZXIsIGl0IGlzIG5vdCBzbGF0ZWQgZm9yIHJlbW92YWwgYW55IHRpbWUgc29vbgogIGpRdWVyeS5wcm94eSA9IGZ1bmN0aW9uIChmbiwgY29udGV4dCkgewogICAgdmFyIHRtcCwgYXJncywgcHJveHk7CiAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICJzdHJpbmciKSB7CiAgICAgIHRtcCA9IGZuW2NvbnRleHRdOwogICAgICBjb250ZXh0ID0gZm47CiAgICAgIGZuID0gdG1wOwogICAgfQoKICAgIC8vIFF1aWNrIGNoZWNrIHRvIGRldGVybWluZSBpZiB0YXJnZXQgaXMgY2FsbGFibGUsIGluIHRoZSBzcGVjCiAgICAvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgogICAgaWYgKCFpc0Z1bmN0aW9uKGZuKSkgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQoKICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcHJveHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgfTsKCiAgICAvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKICAgIHByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwogICAgcmV0dXJuIHByb3h5OwogIH07CiAgalF1ZXJ5LmhvbGRSZWFkeSA9IGZ1bmN0aW9uIChob2xkKSB7CiAgICBpZiAoaG9sZCkgewogICAgICBqUXVlcnkucmVhZHlXYWl0Kys7CiAgICB9IGVsc2UgewogICAgICBqUXVlcnkucmVhZHkodHJ1ZSk7CiAgICB9CiAgfTsKICBqUXVlcnkuaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CiAgalF1ZXJ5LnBhcnNlSlNPTiA9IEpTT04ucGFyc2U7CiAgalF1ZXJ5Lm5vZGVOYW1lID0gbm9kZU5hbWU7CiAgalF1ZXJ5LmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogIGpRdWVyeS5pc1dpbmRvdyA9IGlzV2luZG93OwogIGpRdWVyeS5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgalF1ZXJ5LnR5cGUgPSB0b1R5cGU7CiAgalF1ZXJ5Lm5vdyA9IERhdGUubm93OwogIGpRdWVyeS5pc051bWVyaWMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAvLyBBcyBvZiBqUXVlcnkgMy4wLCBpc051bWVyaWMgaXMgbGltaXRlZCB0bwogICAgLy8gc3RyaW5ncyBhbmQgbnVtYmVycyAocHJpbWl0aXZlcyBvciBvYmplY3RzKQogICAgLy8gdGhhdCBjYW4gYmUgY29lcmNlZCB0byBmaW5pdGUgbnVtYmVycyAoZ2gtMjY2MikKICAgIHZhciB0eXBlID0galF1ZXJ5LnR5cGUob2JqKTsKICAgIHJldHVybiAodHlwZSA9PT0gIm51bWJlciIgfHwgdHlwZSA9PT0gInN0cmluZyIpICYmCiAgICAvLyBwYXJzZUZsb2F0IE5hTnMgbnVtZXJpYy1jYXN0IGZhbHNlIHBvc2l0aXZlcyAoIiIpCiAgICAvLyAuLi5idXQgbWlzaW50ZXJwcmV0cyBsZWFkaW5nLW51bWJlciBzdHJpbmdzLCBwYXJ0aWN1bGFybHkgaGV4IGxpdGVyYWxzICgiMHguLi4iKQogICAgLy8gc3VidHJhY3Rpb24gZm9yY2VzIGluZmluaXRpZXMgdG8gTmFOCiAgICAhaXNOYU4ob2JqIC0gcGFyc2VGbG9hdChvYmopKTsKICB9OwogIGpRdWVyeS50cmltID0gZnVuY3Rpb24gKHRleHQpIHsKICAgIHJldHVybiB0ZXh0ID09IG51bGwgPyAiIiA6ICh0ZXh0ICsgIiIpLnJlcGxhY2UocnRyaW0sICIkMSIpOwogIH07CgogIC8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlcgogIC8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKICAvLyB1bmRlcnN0YW5kcyBhbm9ueW1vdXMgQU1EIG1vZHVsZXMuIEEgbmFtZWQgQU1EIGlzIHNhZmVzdCBhbmQgbW9zdCByb2J1c3QKICAvLyB3YXkgdG8gcmVnaXN0ZXIuIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlCiAgLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCiAgLy8gZmlsZSBuYW1lLiBEbyB0aGlzIGFmdGVyIGNyZWF0aW5nIHRoZSBnbG9iYWwgc28gdGhhdCBpZiBhbiBBTUQgbW9kdWxlIHdhbnRzCiAgLy8gdG8gY2FsbCBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgoKICAvLyBOb3RlIHRoYXQgZm9yIG1heGltdW0gcG9ydGFiaWxpdHksIGxpYnJhcmllcyB0aGF0IGFyZSBub3QgalF1ZXJ5IHNob3VsZAogIC8vIGRlY2xhcmUgdGhlbXNlbHZlcyBhcyBhbm9ueW1vdXMgbW9kdWxlcywgYW5kIGF2b2lkIHNldHRpbmcgYSBnbG9iYWwgaWYgYW4KICAvLyBBTUQgbG9hZGVyIGlzIHByZXNlbnQuIGpRdWVyeSBpcyBhIHNwZWNpYWwgY2FzZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQogIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcmJ1cmtlL3JlcXVpcmVqcy93aWtpL1VwZGF0aW5nLWV4aXN0aW5nLWxpYnJhcmllcyN3aWtpLWFub24KCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKCJqcXVlcnkiLCBbXSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5OwogICAgfSk7CiAgfQogIHZhcgogICAgLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfalF1ZXJ5ID0gd2luZG93LmpRdWVyeSwKICAgIC8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfJCA9IHdpbmRvdy4kOwogIGpRdWVyeS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKGRlZXApIHsKICAgIGlmICh3aW5kb3cuJCA9PT0galF1ZXJ5KSB7CiAgICAgIHdpbmRvdy4kID0gXyQ7CiAgICB9CiAgICBpZiAoZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkpIHsKICAgICAgd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5OwogIH07CgogIC8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4gQU1ECiAgLy8gKHRyYWMtNzEwMiNjb21tZW50OjEwLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzU1NykKICAvLyBhbmQgQ29tbW9uSlMgZm9yIGJyb3dzZXIgZW11bGF0b3JzICh0cmFjLTEzNTY2KQogIGlmICh0eXBlb2Ygbm9HbG9iYWwgPT09ICJ1bmRlZmluZWQiKSB7CiAgICB3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7CiAgfQogIHJldHVybiBqUXVlcnk7Cn0pOw=="},null]}